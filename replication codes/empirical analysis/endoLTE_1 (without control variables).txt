

#1990-2021  32 years#

library(haven)
#data_new<-read_dta("E:\\treatment effects vs structure change\\updated\\empiricis\\结婚离婚\\DivorceData(QJE)\\1976 & 1985 data, combined.dta")

data_new<-read_dta("E:\\treatment effects vs structure change\\updated\\empiricis\\结婚离婚\\1949-2020年各省gdp，人均gdp、固定投资、财政收支等面板dta数据.dta")


library(openxlsx)
data<-read.xlsx("E:\\treatment effects vs structure change\\updated\\empiricis\\结婚离婚\\marriage-divorce-remarriage.xlsx")

library("readxl")
data1<-read_xls("E:\\treatment effects vs structure change\\updated\\empiricis\\结婚离婚\\1990-2021年全国30省城镇登记失业率.xls")




#内地居民初婚登记（万对）#
firstm1<-rev(data[which(data[,2]=="北京"),][,9][3:32])
firstm2<-rev(data[which(data[,2]=="天津"),][,9][3:32])
firstm3<-rev(data[which(data[,2]=="河北"),][,9][3:32])
firstm4<-rev(data[which(data[,2]=="山西"),][,9][3:32])
firstm5<-rev(data[which(data[,2]=="内蒙古"),][,9][3:32])
firstm6<-rev(data[which(data[,2]=="辽宁"),][,9][3:32])
firstm7<-rev(data[which(data[,2]=="吉林"),][,9][3:32])
firstm8<-rev(data[which(data[,2]=="黑龙江"),][,9][3:32])
firstm9<-rev(data[which(data[,2]=="上海"),][,9][3:32])
firstm10<-rev(data[which(data[,2]=="江苏"),][,9][3:32])
firstm11<-rev(data[which(data[,2]=="浙江"),][,9][3:32])
firstm12<-rev(data[which(data[,2]=="安徽"),][,9][3:32])
firstm13<-rev(data[which(data[,2]=="福建"),][,9][3:32])
firstm14<-rev(data[which(data[,2]=="江西"),][,9][3:32])
firstm15<-rev(data[which(data[,2]=="山东"),][,9][3:32])
firstm16<-rev(data[which(data[,2]=="河南"),][,9][3:32])
firstm17<-rev(data[which(data[,2]=="湖北"),][,9][3:32])
firstm18<-rev(data[which(data[,2]=="湖南"),][,9][3:32])
firstm19<-rev(data[which(data[,2]=="广东"),][,9][3:32])
firstm20<-rev(data[which(data[,2]=="广西"),][,9][3:32])
firstm21<-rev(data[which(data[,2]=="海南"),][,9][3:32])
firstm22<-rev(data[which(data[,2]=="四川"),][,9][3:32])
firstm23<-rev(data[which(data[,2]=="贵州"),][,9][3:32])
firstm24<-rev(data[which(data[,2]=="云南"),][,9][3:32])
firstm25<-rev(data[which(data[,2]=="西藏"),][,9][3:32])
firstm26<-rev(data[which(data[,2]=="陕西"),][,9][3:32])
firstm27<-rev(data[which(data[,2]=="甘肃"),][,9][3:32])
firstm28<-rev(data[which(data[,2]=="青海"),][,9][3:32])
firstm29<-rev(data[which(data[,2]=="宁夏"),][,9][3:32])
firstm30<-rev(data[which(data[,2]=="新疆"),][,9][3:32])

#内地居民再婚登记（万对）#
secondm1<-rev(data[which(data[,2]=="北京"),][,10][3:32])
secondm2<-rev(data[which(data[,2]=="天津"),][,10][3:32])
secondm3<-rev(data[which(data[,2]=="河北"),][,10][3:32])
secondm4<-rev(data[which(data[,2]=="山西"),][,10][3:32])
secondm5<-rev(data[which(data[,2]=="内蒙古"),][,10][3:32])
secondm6<-rev(data[which(data[,2]=="辽宁"),][,10][3:32])
secondm7<-rev(data[which(data[,2]=="吉林"),][,10][3:32])
secondm8<-rev(data[which(data[,2]=="黑龙江"),][,10][3:32])
secondm9<-rev(data[which(data[,2]=="上海"),][,10][3:32])
secondm10<-rev(data[which(data[,2]=="江苏"),][,10][3:32])
secondm11<-rev(data[which(data[,2]=="浙江"),][,10][3:32])
secondm12<-rev(data[which(data[,2]=="安徽"),][,10][3:32])
secondm13<-rev(data[which(data[,2]=="福建"),][,10][3:32])
secondm14<-rev(data[which(data[,2]=="江西"),][,10][3:32])
secondm15<-rev(data[which(data[,2]=="山东"),][,10][3:32])
secondm16<-rev(data[which(data[,2]=="河南"),][,10][3:32])
secondm17<-rev(data[which(data[,2]=="湖北"),][,10][3:32])
secondm18<-rev(data[which(data[,2]=="湖南"),][,10][3:32])
secondm19<-rev(data[which(data[,2]=="广东"),][,10][3:32])
secondm20<-rev(data[which(data[,2]=="广西"),][,10][3:32])
secondm21<-rev(data[which(data[,2]=="海南"),][,10][3:32])
secondm22<-rev(data[which(data[,2]=="四川"),][,10][3:32])
secondm23<-rev(data[which(data[,2]=="贵州"),][,10][3:32])
secondm24<-rev(data[which(data[,2]=="云南"),][,10][3:32])
secondm25<-rev(data[which(data[,2]=="西藏"),][,10][3:32])
secondm26<-rev(data[which(data[,2]=="陕西"),][,10][3:32])
secondm27<-rev(data[which(data[,2]=="甘肃"),][,10][3:32])
secondm28<-rev(data[which(data[,2]=="青海"),][,10][3:32])
secondm29<-rev(data[which(data[,2]=="宁夏"),][,10][3:32])
secondm30<-rev(data[which(data[,2]=="新疆"),][,10][3:32])

#涉外及港澳台居民登记结婚（万对）#
xiangm1<-rev(data[which(data[,2]=="北京"),][,11][3:32])
xiangm2<-rev(data[which(data[,2]=="天津"),][,11][3:32])
xiangm3<-rev(data[which(data[,2]=="河北"),][,11][3:32])
xiangm4<-rev(data[which(data[,2]=="山西"),][,11][3:32])
xiangm5<-rev(data[which(data[,2]=="内蒙古"),][,11][3:32])
xiangm6<-rev(data[which(data[,2]=="辽宁"),][,11][3:32])
xiangm7<-rev(data[which(data[,2]=="吉林"),][,11][3:32])
xiangm8<-rev(data[which(data[,2]=="黑龙江"),][,11][3:32])
xiangm9<-rev(data[which(data[,2]=="上海"),][,11][3:32])
xiangm10<-rev(data[which(data[,2]=="江苏"),][,11][3:32])
xiangm11<-rev(data[which(data[,2]=="浙江"),][,11][3:32])
xiangm12<-rev(data[which(data[,2]=="安徽"),][,11][3:32])
xiangm13<-rev(data[which(data[,2]=="福建"),][,11][3:32])
xiangm14<-rev(data[which(data[,2]=="江西"),][,11][3:32])
xiangm15<-rev(data[which(data[,2]=="山东"),][,11][3:32])
xiangm16<-rev(data[which(data[,2]=="河南"),][,11][3:32])
xiangm17<-rev(data[which(data[,2]=="湖北"),][,11][3:32])
xiangm18<-rev(data[which(data[,2]=="湖南"),][,11][3:32])
xiangm19<-rev(data[which(data[,2]=="广东"),][,11][3:32])
xiangm20<-rev(data[which(data[,2]=="广西"),][,11][3:32])
xiangm21<-rev(data[which(data[,2]=="海南"),][,11][3:32])
xiangm22<-rev(data[which(data[,2]=="四川"),][,11][3:32])
xiangm23<-rev(data[which(data[,2]=="贵州"),][,11][3:32])
xiangm24<-rev(data[which(data[,2]=="云南"),][,11][3:32])
xiangm25<-rev(data[which(data[,2]=="西藏"),][,11][3:32])
xiangm26<-rev(data[which(data[,2]=="陕西"),][,11][3:32])
xiangm27<-rev(data[which(data[,2]=="甘肃"),][,11][3:32])
xiangm28<-rev(data[which(data[,2]=="青海"),][,11][3:32])
xiangm29<-rev(data[which(data[,2]=="宁夏"),][,11][3:32])
xiangm30<-rev(data[which(data[,2]=="新疆"),][,11][3:32])


#离婚登记（万对）#
d1<-rev(data[which(data[,2]=="北京"),][,12][3:32])
d2<-rev(data[which(data[,2]=="天津"),][,12][3:32])
d3<-rev(data[which(data[,2]=="河北"),][,12][3:32])
d4<-rev(data[which(data[,2]=="山西"),][,12][3:32])
d5<-rev(data[which(data[,2]=="内蒙古"),][,12][3:32])
d6<-rev(data[which(data[,2]=="辽宁"),][,12][3:32])
d7<-rev(data[which(data[,2]=="吉林"),][,12][3:32])
d8<-rev(data[which(data[,2]=="黑龙江"),][,12][3:32])
d9<-rev(data[which(data[,2]=="上海"),][,12][3:32])
d10<-rev(data[which(data[,2]=="江苏"),][,12][3:32])
d11<-rev(data[which(data[,2]=="浙江"),][,12][3:32])
d12<-rev(data[which(data[,2]=="安徽"),][,12][3:32])
d13<-rev(data[which(data[,2]=="福建"),][,12][3:32])
d14<-rev(data[which(data[,2]=="江西"),][,12][3:32])
d15<-rev(data[which(data[,2]=="山东"),][,12][3:32])
d16<-rev(data[which(data[,2]=="河南"),][,12][3:32])
d17<-rev(data[which(data[,2]=="湖北"),][,12][3:32])
d18<-rev(data[which(data[,2]=="湖南"),][,12][3:32])
d19<-rev(data[which(data[,2]=="广东"),][,12][3:32])
d20<-rev(data[which(data[,2]=="广西"),][,12][3:32])
d21<-rev(data[which(data[,2]=="海南"),][,12][3:32])
d22<-rev(data[which(data[,2]=="四川"),][,12][3:32])
d23<-rev(data[which(data[,2]=="贵州"),][,12][3:32])
d24<-rev(data[which(data[,2]=="云南"),][,12][3:32])
d25<-rev(data[which(data[,2]=="西藏"),][,12][3:32])
d26<-rev(data[which(data[,2]=="陕西"),][,12][3:32])
d27<-rev(data[which(data[,2]=="甘肃"),][,12][3:32])
d28<-rev(data[which(data[,2]=="青海"),][,12][3:32])
d29<-rev(data[which(data[,2]=="宁夏"),][,12][3:32])
d30<-rev(data[which(data[,2]=="新疆"),][,12][3:32])

d<-rbind(d1,d2,d3,d4,d5,d6,d7,d8,d9,d10,d11,d12,d13,d14,d15,d16,d17,d18,d19,d20,d21,d22,d23,d24,d25,d26,d27,d28,d29,d30)

year<-c(1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019)

#structure change point#
out<-c()
for (j in 1:30){
test<-c()
for(i in 3:6){
library(strucchange)
test[i]<-c(sctest(d[j,][5:13] ~ year[5:13], type = "Chow",point=i)$p.value)
}
out[j]<-which(test<=0.1)[1]
}
out[is.na(out)]<-0

out1<-out+4-1   #T0#


D1<-ifelse(out1[1]!=3,1,0)*c(rep(0,out1[1]),rep(1,(30-out1[1])))+ifelse(out1[1]==3,1,0)*rep(0,30)
D2<-ifelse(out1[2]!=3,1,0)*c(rep(0,out1[2]),rep(1,(30-out1[2])))+ifelse(out1[2]==3,1,0)*rep(0,30)
D3<-ifelse(out1[3]!=3,1,0)*c(rep(0,out1[3]),rep(1,(30-out1[3])))+ifelse(out1[3]==3,1,0)*rep(0,30)
D4<-ifelse(out1[4]!=3,1,0)*c(rep(0,out1[4]),rep(1,(30-out1[4])))+ifelse(out1[4]==3,1,0)*rep(0,30)
D5<-ifelse(out1[5]!=3,1,0)*c(rep(0,out1[5]),rep(1,(30-out1[5])))+ifelse(out1[5]==3,1,0)*rep(0,30)
D6<-ifelse(out1[6]!=3,1,0)*c(rep(0,out1[6]),rep(1,(30-out1[6])))+ifelse(out1[6]==3,1,0)*rep(0,30)
D7<-ifelse(out1[7]!=3,1,0)*c(rep(0,out1[7]),rep(1,(30-out1[7])))+ifelse(out1[7]==3,1,0)*rep(0,30)
D8<-ifelse(out1[8]!=3,1,0)*c(rep(0,out1[8]),rep(1,(30-out1[8])))+ifelse(out1[8]==3,1,0)*rep(0,30)
D9<-ifelse(out1[9]!=3,1,0)*c(rep(0,out1[9]),rep(1,(30-out1[9])))+ifelse(out1[9]==3,1,0)*rep(0,30)
D10<-ifelse(out1[10]!=3,1,0)*c(rep(0,out1[10]),rep(1,(30-out1[10])))+ifelse(out1[10]==3,1,0)*rep(0,30)
D11<-ifelse(out1[11]!=3,1,0)*c(rep(0,out1[11]),rep(1,(30-out1[11])))+ifelse(out1[11]==3,1,0)*rep(0,30)
D12<-ifelse(out1[12]!=3,1,0)*c(rep(0,out1[12]),rep(1,(30-out1[12])))+ifelse(out1[12]==3,1,0)*rep(0,30)
D13<-ifelse(out1[13]!=3,1,0)*c(rep(0,out1[13]),rep(1,(30-out1[13])))+ifelse(out1[13]==3,1,0)*rep(0,30)
D14<-ifelse(out1[14]!=3,1,0)*c(rep(0,out1[14]),rep(1,(30-out1[14])))+ifelse(out1[14]==3,1,0)*rep(0,30)
D15<-ifelse(out1[15]!=3,1,0)*c(rep(0,out1[15]),rep(1,(30-out1[15])))+ifelse(out1[15]==3,1,0)*rep(0,30)
D16<-ifelse(out1[16]!=3,1,0)*c(rep(0,out1[16]),rep(1,(30-out1[16])))+ifelse(out1[16]==3,1,0)*rep(0,30)
D17<-ifelse(out1[17]!=3,1,0)*c(rep(0,out1[17]),rep(1,(30-out1[17])))+ifelse(out1[17]==3,1,0)*rep(0,30)
D18<-ifelse(out1[18]!=3,1,0)*c(rep(0,out1[18]),rep(1,(30-out1[18])))+ifelse(out1[18]==3,1,0)*rep(0,30)
D19<-ifelse(out1[19]!=3,1,0)*c(rep(0,out1[19]),rep(1,(30-out1[19])))+ifelse(out1[19]==3,1,0)*rep(0,30)
D20<-ifelse(out1[20]!=3,1,0)*c(rep(0,out1[20]),rep(1,(30-out1[20])))+ifelse(out1[20]==3,1,0)*rep(0,30)
D21<-ifelse(out1[21]!=3,1,0)*c(rep(0,out1[21]),rep(1,(30-out1[21])))+ifelse(out1[21]==3,1,0)*rep(0,30)
D22<-ifelse(out1[22]!=3,1,0)*c(rep(0,out1[22]),rep(1,(30-out1[22])))+ifelse(out1[22]==3,1,0)*rep(0,30)
D23<-ifelse(out1[23]!=3,1,0)*c(rep(0,out1[23]),rep(1,(30-out1[23])))+ifelse(out1[23]==3,1,0)*rep(0,30)
D24<-ifelse(out1[24]!=3,1,0)*c(rep(0,out1[24]),rep(1,(30-out1[24])))+ifelse(out1[24]==3,1,0)*rep(0,30)
D25<-ifelse(out1[25]!=3,1,0)*c(rep(0,out1[25]),rep(1,(30-out1[25])))+ifelse(out1[25]==3,1,0)*rep(0,30)
D26<-ifelse(out1[26]!=3,1,0)*c(rep(0,out1[26]),rep(1,(30-out1[26])))+ifelse(out1[26]==3,1,0)*rep(0,30)
D27<-ifelse(out1[27]!=3,1,0)*c(rep(0,out1[27]),rep(1,(30-out1[27])))+ifelse(out1[27]==3,1,0)*rep(0,30)
D28<-ifelse(out1[28]!=3,1,0)*c(rep(0,out1[28]),rep(1,(30-out1[28])))+ifelse(out1[28]==3,1,0)*rep(0,30)
D29<-ifelse(out1[29]!=3,1,0)*c(rep(0,out1[29]),rep(1,(30-out1[29])))+ifelse(out1[29]==3,1,0)*rep(0,30)
D30<-ifelse(out1[30]!=3,1,0)*c(rep(0,out1[30]),rep(1,(30-out1[30])))+ifelse(out1[30]==3,1,0)*rep(0,30)

q2<-c(rep(0,13),rep(1,17))
Tr1<-c(D1,D2,D3,D4+q2,D5,D6+q2,D7+q2,D8,D9,D10,D11,D12,D13+q2,D14+q2,D15,D16,D17,D18,D19+q2,D20+q2,D21,D22,D23+q2,D24+q2,D25+q2,D26,D27,D28,D29,D30)
Tr2<-rep(q2,30)
q3<-c(rep(0,21),rep(1,9))
Tr3<-rep(q3,30)
Y<-c(d1,d2,d3,d4,d5,d6,d7,d8,d9,d10,d11,d12,d13,d14,d15,d16,d17,d18,d19,d20,d21,d22,d23,d24,d25,d26,d27,d28,d29,d30)
abb<-c(rep(1,30),rep(2,30),rep(3,30),rep(4,30),rep(5,30),rep(6,30),rep(7,30),rep(8,30),rep(9,30),rep(10,30),rep(11,30),rep(12,30),rep(13,30),rep(14,30),rep(15,30),rep(16,30),rep(17,30),rep(18,30),rep(19,30),rep(20,30),rep(21,30),rep(22,30),rep(23,30),rep(24,30),rep(25,30),rep(26,30),rep(27,30),rep(28,30),rep(29,30),rep(30,30))
time<-rep(year,30)
Tr<-Tr1+Tr2+Tr3

data_panel<-data.frame(Y,Tr1,Tr2,Tr3,abb,time,Tr)

library(panelView)
panelview(Y ~ Tr, data = data_panel,  index = c("abb","time"), pre.post = TRUE) 









#gdp per people#

x1<-(data_new[which(data_new$prov=="北京"),])$pergdp[42:71]
x2<-(data_new[which(data_new$prov=="天津"),])$pergdp[42:71]
x3<-(data_new[which(data_new$prov=="河北"),])$pergdp[42:71]
x4<-(data_new[which(data_new$prov=="山西"),])$pergdp[42:71]
x5<-(data_new[which(data_new$prov=="内蒙古"),])$pergdp[42:71]
x6<-(data_new[which(data_new$prov=="辽宁"),])$pergdp[42:71]
x7<-(data_new[which(data_new$prov=="吉林"),])$pergdp[42:71]
x8<-(data_new[which(data_new$prov=="黑龙江"),])$pergdp[42:71]
x9<-(data_new[which(data_new$prov=="上海"),])$pergdp[42:71]
x10<-(data_new[which(data_new$prov=="江苏"),])$pergdp[42:71]
x11<-(data_new[which(data_new$prov=="浙江"),])$pergdp[42:71]
x12<-(data_new[which(data_new$prov=="安徽"),])$pergdp[42:71]
x13<-(data_new[which(data_new$prov=="福建"),])$pergdp[42:71]
x14<-(data_new[which(data_new$prov=="江西"),])$pergdp[42:71]
x15<-(data_new[which(data_new$prov=="山东"),])$pergdp[42:71]
x16<-(data_new[which(data_new$prov=="河南"),])$pergdp[42:71]
x17<-(data_new[which(data_new$prov=="湖北"),])$pergdp[42:71]
x18<-(data_new[which(data_new$prov=="湖南"),])$pergdp[42:71]
x19<-(data_new[which(data_new$prov=="广东"),])$pergdp[42:71]
x20<-(data_new[which(data_new$prov=="广西"),])$pergdp[42:71]
x21<-(data_new[which(data_new$prov=="海南"),])$pergdp[42:71]
x22<-(data_new[which(data_new$prov=="四川"),])$pergdp[42:71]
x23<-(data_new[which(data_new$prov=="贵州"),])$pergdp[42:71]
x24<-(data_new[which(data_new$prov=="云南"),])$pergdp[42:71]
x25<-(data_new[which(data_new$prov=="西藏"),])$pergdp[42:71]  
x26<-(data_new[which(data_new$prov=="陕西"),])$pergdp[42:71]
x27<-(data_new[which(data_new$prov=="甘肃"),])$pergdp[42:71]
x28<-(data_new[which(data_new$prov=="青海"),])$pergdp[42:71]
x29<-(data_new[which(data_new$prov=="宁夏"),])$pergdp[42:71]
x30<-(data_new[which(data_new$prov=="新疆"),])$pergdp[42:71]
x<-c(x1,x2,x3,x4,x5,x6,x7,x8,x9,x10,x11,x12,x13,x14,x15,x16,x17,x18,x19,x20,x21,x22,x23,x24,x25,x26,x27,x28,x29,x30)

#population#

z1<-(data_new[which(data_new$prov=="北京"),])$pop[42:71]
z2<-(data_new[which(data_new$prov=="天津"),])$pop[42:71]
z3<-(data_new[which(data_new$prov=="河北"),])$pop[42:71]
z4<-(data_new[which(data_new$prov=="山西"),])$pop[42:71]
z5<-(data_new[which(data_new$prov=="内蒙古"),])$pop[42:71]
z6<-(data_new[which(data_new$prov=="辽宁"),])$pop[42:71]
z7<-(data_new[which(data_new$prov=="吉林"),])$pop[42:71]
z8<-(data_new[which(data_new$prov=="黑龙江"),])$pop[42:71]
z9<-(data_new[which(data_new$prov=="上海"),])$pop[42:71]
z10<-(data_new[which(data_new$prov=="江苏"),])$pop[42:71]
z11<-(data_new[which(data_new$prov=="浙江"),])$pop[42:71]
z12<-(data_new[which(data_new$prov=="安徽"),])$pop[42:71]
z13<-(data_new[which(data_new$prov=="福建"),])$pop[42:71]
z14<-(data_new[which(data_new$prov=="江西"),])$pop[42:71]
z15<-(data_new[which(data_new$prov=="山东"),])$pop[42:71]
z16<-(data_new[which(data_new$prov=="河南"),])$pop[42:71]
z17<-(data_new[which(data_new$prov=="湖北"),])$pop[42:71]
z18<-(data_new[which(data_new$prov=="湖南"),])$pop[42:71]
z19<-(data_new[which(data_new$prov=="广东"),])$pop[42:71]
z20<-(data_new[which(data_new$prov=="广西"),])$pop[42:71]
z21<-(data_new[which(data_new$prov=="海南"),])$pop[42:71]
z22<-(data_new[which(data_new$prov=="四川"),])$pop[42:71]
z23<-(data_new[which(data_new$prov=="贵州"),])$pop[42:71]
z24<-(data_new[which(data_new$prov=="云南"),])$pop[42:71]
z25<-(data_new[which(data_new$prov=="西藏"),])$pop[42:71] 
z26<-(data_new[which(data_new$prov=="陕西"),])$pop[42:71]
z27<-(data_new[which(data_new$prov=="甘肃"),])$pop[42:71]
z28<-(data_new[which(data_new$prov=="青海"),])$pop[42:71]
z29<-(data_new[which(data_new$prov=="宁夏"),])$pop[42:71]
z30<-(data_new[which(data_new$prov=="新疆"),])$pop[42:71]
z<-c(z1,z2,z3,z4,z5,z6,z7,z8,z9,z10,z11,z12,z13,z14,z15,z16,z17,z18,z19,z20,z21,z22,z23,z24,z25,z26,z27,z28,z29,z30)

#unemployment#

w1<-as.numeric(unlist(data1[which(data1[,3]=="北京"),][,7]))[1:30]
w2<-as.numeric(unlist(data1[which(data1[,3]=="天津"),][,7]))[1:30]
w3<-as.numeric(unlist(data1[which(data1[,3]=="河北"),][,7]))[1:30]
w4<-as.numeric(unlist(data1[which(data1[,3]=="山西"),][,7]))[1:30]
w5<-as.numeric(unlist(data1[which(data1[,3]=="内蒙古"),][,7]))[1:30]
w6<-as.numeric(unlist(data1[which(data1[,3]=="辽宁"),][,7]))[1:30]
w7<-as.numeric(unlist(data1[which(data1[,3]=="吉林"),][,7]))[1:30]
w8<-as.numeric(unlist(data1[which(data1[,3]=="黑龙江"),][,7]))[1:30]
w9<-as.numeric(unlist(data1[which(data1[,3]=="上海"),][,7]))[1:30]
w10<-as.numeric(unlist(data1[which(data1[,3]=="江苏"),][,7]))[1:30]
w11<-as.numeric(unlist(data1[which(data1[,3]=="浙江"),][,7]))[1:30]
w12<-as.numeric(unlist(data1[which(data1[,3]=="安徽"),][,7]))[1:30]
w13<-as.numeric(unlist(data1[which(data1[,3]=="福建"),][,7]))[1:30]
w14<-as.numeric(unlist(data1[which(data1[,3]=="江西"),][,7]))[1:30]
w15<-as.numeric(unlist(data1[which(data1[,3]=="山东"),][,7]))[1:30]
w16<-as.numeric(unlist(data1[which(data1[,3]=="河南"),][,7]))[1:30]
w17<-as.numeric(unlist(data1[which(data1[,3]=="湖北"),][,7]))[1:30]
w18<-as.numeric(unlist(data1[which(data1[,3]=="湖南"),][,7]))[1:30]
w19<-as.numeric(unlist(data1[which(data1[,3]=="广东"),][,7]))[1:30]
w20<-as.numeric(unlist(data1[which(data1[,3]=="广西"),][,7]))[1:30]
w21<-as.numeric(unlist(data1[which(data1[,3]=="海南"),][,7]))[1:30]
w22<-as.numeric(unlist(data1[which(data1[,3]=="四川"),][,7]))[1:30]
w23<-as.numeric(unlist(data1[which(data1[,3]=="贵州"),][,7]))[1:30]
w24<-as.numeric(unlist(data1[which(data1[,3]=="云南"),][,7]))[1:30]
w25<-as.numeric(unlist(data1[which(data1[,3]=="西藏"),][,7]))[1:30]
w26<-as.numeric(unlist(data1[which(data1[,3]=="陕西"),][,7]))[1:30]
w27<-as.numeric(unlist(data1[which(data1[,3]=="甘肃"),][,7]))[1:30]
w28<-as.numeric(unlist(data1[which(data1[,3]=="青海"),][,7]))[1:30]
w29<-as.numeric(unlist(data1[which(data1[,3]=="宁夏"),][,7]))[1:30]
w30<-as.numeric(unlist(data1[which(data1[,3]=="新疆"),][,7]))[1:30]
w<-c(w1,w2,w3,w4,w5,w6,w7,w8,w9,w10,w11,w12,w13,w14,w15,w16,w17,w18,w19,w20,w21,w22,w23,w24,w25,w26,w27,w28,w29,w30)




year<-time


data_twfe<-data.frame(Y,Tr1,Tr2,Tr3,abb,year,Tr,w,x,z)

plm<-(plm(Y~Tr1+Tr2,data=data_twfe,model="within",effect="time",index = c("year")))
summary(plm)





Tr1<-rbind(D1,D2,D3,D4+q2,D5,D6+q2,D7+q2,D8,D9,D10,D11,D12,D13+q2,D14+q2,D15,D16,D17,D18,D19+q2,D20+q2,D21,D22,D23+q2,D24+q2,D25+q2,D26,D27,D28,D29,D30)
Tr2<-rbind(rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1))
q3<-c(rep(0,21),rep(1,9))
Tr3<-rbind(rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1))







##===================================================================================================================================================
##===================================================================================================================================================


# The EFFECT OF THE FIRST WAVE  27 treated units#
## pp7,pp17,pp32,pp33,pp37,pp38,pp41,pp42,pp49,pp53,pp55,pp63,pp66,pp76,pp77,pp83,pp86,pp91,pp95,pp96,pp97,pp100,pp108,pp113,pp123,pp124,pp125


TT0<-c( sum(Tr1[1,]==0),sum(Tr1[2,]==0),sum(Tr1[3,]==0),sum(Tr1[4,]==0),sum(Tr1[5,]==0),sum(Tr1[6,]==0),sum(Tr1[7,]==0),sum(Tr1[8,]==0),sum(Tr1[9,]==0),sum(Tr1[10,]==0),sum(Tr1[11,]==0),sum(Tr1[12,]==0),sum(Tr1[13,]==0),sum(Tr1[14,]==0),sum(Tr1[15,]==0),sum(Tr1[16,]==0),sum(Tr1[17,]==0),sum(Tr1[18,]==0),sum(Tr1[19,]==0),sum(Tr1[20,]==0),sum(Tr1[21,]==0),sum(Tr1[22,]==0),sum(Tr1[23,]==0),sum(Tr1[24,]==0),sum(Tr1[25,]==0),sum(Tr1[26,]==0),sum(Tr1[27,]==0),sum(Tr1[28,]==0),sum(Tr1[29,]==0),sum(Tr1[30,]==0) )
TT1<-TT0+1    #treatment date#


T0<-min(TT0)
T1<-min(TT0)+1

T=30
t1<-sort(sample(300:330,T))
t2<-t1^2



#step 1: s=1#
s=1

j=1

DD<-c(Tr1[1,][1:(T0+j)],Tr1[2,][1:(T0+j)],Tr1[3,][1:(T0+j)],Tr1[4,][1:(T0+j)],Tr1[5,][1:(T0+j)],Tr1[6,][1:(T0+j)],Tr1[7,][1:(T0+j)],Tr1[8,][1:(T0+j)],Tr1[9,][1:(T0+j)],Tr1[10,][1:(T0+j)],Tr1[11,][1:(T0+j)],Tr1[12,][1:(T0+j)],Tr1[13,][1:(T0+j)],Tr1[14,][1:(T0+j)],Tr1[15,][1:(T0+j)],Tr1[16,][1:(T0+j)],Tr1[17,][1:(T0+j)],Tr1[18,][1:(T0+j)],Tr1[19,][1:(T0+j)],Tr1[20,][1:(T0+j)],Tr1[21,][1:(T0+j)],Tr1[22,][1:(T0+j)],Tr1[23,][1:(T0+j)],Tr1[24,][1:(T0+j)],Tr1[25,][1:(T0+j)],Tr1[26,][1:(T0+j)],Tr1[27,][1:(T0+j)],Tr1[28,][1:(T0+j)],Tr1[29,][1:(T0+j)],Tr1[30,][1:(T0+j)] )

yy<-c(d1[1:(T0+j)],d2[1:(T0+j)],d3[1:(T0+j)],d4[1:(T0+j)],d5[1:(T0+j)],d6[1:(T0+j)],d7[1:(T0+j)],d8[1:(T0+j)],d9[1:(T0+j)],d10[1:(T0+j)],d11[1:(T0+j)],d12[1:(T0+j)],d13[1:(T0+j)],d14[1:(T0+j)],d15[1:(T0+j)],d16[1:(T0+j)],d17[1:(T0+j)],d18[1:(T0+j)],d19[1:(T0+j)],d20[1:(T0+j)],d21[1:(T0+j)],d22[1:(T0+j)],d23[1:(T0+j)],d24[1:(T0+j)],d25[1:(T0+j)],d26[1:(T0+j)],d27[1:(T0+j)],d28[1:(T0+j)],d29[1:(T0+j)],d30[1:(T0+j)] )


tt1<-c(rep(t1[1:(T0+j)],30))
tt2<-c(rep(t2[1:(T0+j)],30))

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )

zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )

zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)


library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind(Tr1[1,][1:(T0+j)],Tr1[2,][1:(T0+j)],Tr1[3,][1:(T0+j)],Tr1[4,][1:(T0+j)],Tr1[5,][1:(T0+j)],Tr1[6,][1:(T0+j)],Tr1[7,][1:(T0+j)],Tr1[8,][1:(T0+j)],Tr1[9,][1:(T0+j)],Tr1[10,][1:(T0+j)],Tr1[11,][1:(T0+j)],Tr1[12,][1:(T0+j)],Tr1[13,][1:(T0+j)],Tr1[14,][1:(T0+j)],Tr1[15,][1:(T0+j)],Tr1[16,][1:(T0+j)],Tr1[17,][1:(T0+j)],Tr1[18,][1:(T0+j)],Tr1[19,][1:(T0+j)],Tr1[20,][1:(T0+j)],Tr1[21,][1:(T0+j)],Tr1[22,][1:(T0+j)],Tr1[23,][1:(T0+j)],Tr1[24,][1:(T0+j)],Tr1[25,][1:(T0+j)],Tr1[26,][1:(T0+j)],Tr1[27,][1:(T0+j)],Tr1[28,][1:(T0+j)],Tr1[29,][1:(T0+j)],Tr1[30,][1:(T0+j)] )


zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )

zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )

zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][1:(T0+j)],Tr1[2,][1:(T0+j)],Tr1[3,][1:(T0+j)],Tr1[4,][1:(T0+j)],Tr1[5,][1:(T0+j)],Tr1[6,][1:(T0+j)],Tr1[7,][1:(T0+j)],Tr1[8,][1:(T0+j)],Tr1[9,][1:(T0+j)],Tr1[10,][1:(T0+j)],Tr1[11,][1:(T0+j)],Tr1[12,][1:(T0+j)],Tr1[13,][1:(T0+j)],Tr1[14,][1:(T0+j)],Tr1[15,][1:(T0+j)],Tr1[16,][1:(T0+j)],Tr1[17,][1:(T0+j)],Tr1[18,][1:(T0+j)],Tr1[19,][1:(T0+j)],Tr1[20,][1:(T0+j)],Tr1[21,][1:(T0+j)],Tr1[22,][1:(T0+j)],Tr1[23,][1:(T0+j)],Tr1[24,][1:(T0+j)],Tr1[25,][1:(T0+j)],Tr1[26,][1:(T0+j)],Tr1[27,][1:(T0+j)],Tr1[28,][1:(T0+j)],Tr1[29,][1:(T0+j)],Tr1[30,][1:(T0+j)] )

yy<-c(d1[1:(T0+j)],d2[1:(T0+j)],d3[1:(T0+j)],d4[1:(T0+j)],d5[1:(T0+j)],d6[1:(T0+j)],d7[1:(T0+j)],d8[1:(T0+j)],d9[1:(T0+j)],d10[1:(T0+j)],d11[1:(T0+j)],d12[1:(T0+j)],d13[1:(T0+j)],d14[1:(T0+j)],d15[1:(T0+j)],d16[1:(T0+j)],d17[1:(T0+j)],d18[1:(T0+j)],d19[1:(T0+j)],d20[1:(T0+j)],d21[1:(T0+j)],d22[1:(T0+j)],d23[1:(T0+j)],d24[1:(T0+j)],d25[1:(T0+j)],d26[1:(T0+j)],d27[1:(T0+j)],d28[1:(T0+j)],d29[1:(T0+j)],d30[1:(T0+j)] )

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )

zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )

zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment11<-new_treatment[1]
new_treatment12<-new_treatment[2]
new_treatment13<-new_treatment[3]
new_treatment14<-new_treatment[4]
new_treatment15<-new_treatment[5]
new_treatment16<-new_treatment[6]
new_treatment17<-new_treatment[7]
new_treatment18<-new_treatment[8]
new_treatment19<-new_treatment[9]
new_treatment110<-new_treatment[10]
new_treatment111<-new_treatment[11]
new_treatment112<-new_treatment[12]
new_treatment113<-new_treatment[13]
new_treatment114<-new_treatment[14]
new_treatment115<-new_treatment[15]
new_treatment116<-new_treatment[16]
new_treatment117<-new_treatment[17]
new_treatment118<-new_treatment[18]
new_treatment119<-new_treatment[19]
new_treatment120<-new_treatment[20]
new_treatment121<-new_treatment[21]
new_treatment122<-new_treatment[22]
new_treatment123<-new_treatment[23]
new_treatment124<-new_treatment[24]
new_treatment125<-new_treatment[25]
new_treatment126<-new_treatment[26]
new_treatment127<-new_treatment[27]
new_treatment128<-new_treatment[28]
new_treatment129<-new_treatment[29]
new_treatment130<-new_treatment[30]

new_treatment1<-new_treatment




##====================================

#bootstrap 1#
#sd 1#

SS<-c()  #bootstrap sample size#
SSS<-c() #bootstrap sample size share#
boot1<-list()
for (b in 1:100){



T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-4),1)

#step 1: s=1#
s=1

j=1

SS[b]<-(T0+j)-S0+1
SSS[b]<-((T0+j)-S0+1)/((T0+j)-1+1)


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3_2[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)



var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment11_sd<-var[1]^0.5
new_treatment12_sd<-var[2]^0.5
new_treatment13_sd<-var[3]^0.5
new_treatment14_sd<-var[4]^0.5
new_treatment15_sd<-var[5]^0.5
new_treatment16_sd<-var[6]^0.5
new_treatment17_sd<-var[7]^0.5
new_treatment18_sd<-var[8]^0.5
new_treatment19_sd<-var[9]^0.5
new_treatment110_sd<-var[10]^0.5
new_treatment111_sd<-var[11]^0.5
new_treatment112_sd<-var[12]^0.5
new_treatment113_sd<-var[13]^0.5
new_treatment114_sd<-var[14]^0.5
new_treatment115_sd<-var[15]^0.5
new_treatment116_sd<-var[16]^0.5
new_treatment117_sd<-var[17]^0.5
new_treatment118_sd<-var[18]^0.5
new_treatment119_sd<-var[19]^0.5
new_treatment120_sd<-var[20]^0.5
new_treatment121_sd<-var[21]^0.5
new_treatment122_sd<-var[22]^0.5
new_treatment123_sd<-var[23]^0.5
new_treatment124_sd<-var[24]^0.5
new_treatment125_sd<-var[25]^0.5
new_treatment126_sd<-var[26]^0.5
new_treatment127_sd<-var[27]^0.5
new_treatment128_sd<-var[28]^0.5
new_treatment129_sd<-var[29]^0.5
new_treatment130_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper1<-c()
lower1<-c()
for(i in 1:30){
upper1[i]<-new_treatment1[i]-Quantile_upper[i]*(var[i]^0.5)
lower1[i]<-new_treatment1[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper1
lower1





#step 2: s=2#

T0<-min(TT0)

s=2

DDD<-rbind(Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment21<-new_treatment[1]
new_treatment22<-new_treatment[2]
new_treatment23<-new_treatment[3]
new_treatment24<-new_treatment[4]
new_treatment25<-new_treatment[5]
new_treatment26<-new_treatment[6]
new_treatment27<-new_treatment[7]
new_treatment28<-new_treatment[8]
new_treatment29<-new_treatment[9]
new_treatment210<-new_treatment[10]
new_treatment211<-new_treatment[11]
new_treatment212<-new_treatment[12]
new_treatment213<-new_treatment[13]
new_treatment214<-new_treatment[14]
new_treatment215<-new_treatment[15]
new_treatment216<-new_treatment[16]
new_treatment217<-new_treatment[17]
new_treatment218<-new_treatment[18]
new_treatment219<-new_treatment[19]
new_treatment220<-new_treatment[20]
new_treatment221<-new_treatment[21]
new_treatment222<-new_treatment[22]
new_treatment223<-new_treatment[23]
new_treatment224<-new_treatment[24]
new_treatment225<-new_treatment[25]
new_treatment226<-new_treatment[26]
new_treatment227<-new_treatment[27]
new_treatment228<-new_treatment[28]
new_treatment229<-new_treatment[29]
new_treatment230<-new_treatment[30]

new_treatment2<-new_treatment





##====================================

#bootstrap 2#
#sd 2#

#step 2: s=2#
s=2

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=2

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment21_sd<-var[1]^0.5
new_treatment22_sd<-var[2]^0.5
new_treatment23_sd<-var[3]^0.5
new_treatment24_sd<-var[4]^0.5
new_treatment25_sd<-var[5]^0.5
new_treatment26_sd<-var[6]^0.5
new_treatment27_sd<-var[7]^0.5
new_treatment28_sd<-var[8]^0.5
new_treatment29_sd<-var[9]^0.5
new_treatment210_sd<-var[10]^0.5
new_treatment211_sd<-var[11]^0.5
new_treatment212_sd<-var[12]^0.5
new_treatment213_sd<-var[13]^0.5
new_treatment214_sd<-var[14]^0.5
new_treatment215_sd<-var[15]^0.5
new_treatment216_sd<-var[16]^0.5
new_treatment217_sd<-var[17]^0.5
new_treatment218_sd<-var[18]^0.5
new_treatment219_sd<-var[19]^0.5
new_treatment220_sd<-var[20]^0.5
new_treatment221_sd<-var[21]^0.5
new_treatment222_sd<-var[22]^0.5
new_treatment223_sd<-var[23]^0.5
new_treatment224_sd<-var[24]^0.5
new_treatment225_sd<-var[25]^0.5
new_treatment226_sd<-var[26]^0.5
new_treatment227_sd<-var[27]^0.5
new_treatment228_sd<-var[28]^0.5
new_treatment229_sd<-var[29]^0.5
new_treatment230_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper2<-c()
lower2<-c()
for(i in 1:30){
upper2[i]<-new_treatment2[i]-Quantile_upper[i]*(var[i]^0.5)
lower2[i]<-new_treatment2[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper2
lower2






#step 3: s=3#

T0<-min(TT0)

s=3

DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment31<-new_treatment[1]
new_treatment32<-new_treatment[2]
new_treatment33<-new_treatment[3]
new_treatment34<-new_treatment[4]
new_treatment35<-new_treatment[5]
new_treatment36<-new_treatment[6]
new_treatment37<-new_treatment[7]
new_treatment38<-new_treatment[8]
new_treatment39<-new_treatment[9]
new_treatment310<-new_treatment[10]
new_treatment311<-new_treatment[11]
new_treatment312<-new_treatment[12]
new_treatment313<-new_treatment[13]
new_treatment314<-new_treatment[14]
new_treatment315<-new_treatment[15]
new_treatment316<-new_treatment[16]
new_treatment317<-new_treatment[17]
new_treatment318<-new_treatment[18]
new_treatment319<-new_treatment[19]
new_treatment320<-new_treatment[20]
new_treatment321<-new_treatment[21]
new_treatment322<-new_treatment[22]
new_treatment323<-new_treatment[23]
new_treatment324<-new_treatment[24]
new_treatment325<-new_treatment[25]
new_treatment326<-new_treatment[26]
new_treatment327<-new_treatment[27]
new_treatment328<-new_treatment[28]
new_treatment329<-new_treatment[29]
new_treatment330<-new_treatment[30]

new_treatment3<-new_treatment





##====================================

#bootstrap 3#
#sd 3#

#step 3: s=3#
s=3

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=3

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment31_sd<-var[1]^0.5
new_treatment32_sd<-var[2]^0.5
new_treatment33_sd<-var[3]^0.5
new_treatment34_sd<-var[4]^0.5
new_treatment35_sd<-var[5]^0.5
new_treatment36_sd<-var[6]^0.5
new_treatment37_sd<-var[7]^0.5
new_treatment38_sd<-var[8]^0.5
new_treatment39_sd<-var[9]^0.5
new_treatment310_sd<-var[10]^0.5
new_treatment311_sd<-var[11]^0.5
new_treatment312_sd<-var[12]^0.5
new_treatment313_sd<-var[13]^0.5
new_treatment314_sd<-var[14]^0.5
new_treatment315_sd<-var[15]^0.5
new_treatment316_sd<-var[16]^0.5
new_treatment317_sd<-var[17]^0.5
new_treatment318_sd<-var[18]^0.5
new_treatment319_sd<-var[19]^0.5
new_treatment320_sd<-var[20]^0.5
new_treatment321_sd<-var[21]^0.5
new_treatment322_sd<-var[22]^0.5
new_treatment323_sd<-var[23]^0.5
new_treatment324_sd<-var[24]^0.5
new_treatment325_sd<-var[25]^0.5
new_treatment326_sd<-var[26]^0.5
new_treatment327_sd<-var[27]^0.5
new_treatment328_sd<-var[28]^0.5
new_treatment329_sd<-var[29]^0.5
new_treatment330_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper3<-c()
lower3<-c()
for(i in 1:30){
upper3[i]<-new_treatment3[i]-Quantile_upper[i]*(var[i]^0.5)
lower3[i]<-new_treatment3[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper3
lower3







#step 4: s=4#

T0<-min(TT0)

s=4

DDD<-rbind(Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment41<-new_treatment[1]
new_treatment42<-new_treatment[2]
new_treatment43<-new_treatment[3]
new_treatment44<-new_treatment[4]
new_treatment45<-new_treatment[5]
new_treatment46<-new_treatment[6]
new_treatment47<-new_treatment[7]
new_treatment48<-new_treatment[8]
new_treatment49<-new_treatment[9]
new_treatment410<-new_treatment[10]
new_treatment411<-new_treatment[11]
new_treatment412<-new_treatment[12]
new_treatment413<-new_treatment[13]
new_treatment414<-new_treatment[14]
new_treatment415<-new_treatment[15]
new_treatment416<-new_treatment[16]
new_treatment417<-new_treatment[17]
new_treatment418<-new_treatment[18]
new_treatment419<-new_treatment[19]
new_treatment420<-new_treatment[20]
new_treatment421<-new_treatment[21]
new_treatment422<-new_treatment[22]
new_treatment423<-new_treatment[23]
new_treatment424<-new_treatment[24]
new_treatment425<-new_treatment[25]
new_treatment426<-new_treatment[26]
new_treatment427<-new_treatment[27]
new_treatment428<-new_treatment[28]
new_treatment429<-new_treatment[29]
new_treatment430<-new_treatment[30]

new_treatment4<-new_treatment





##====================================

#bootstrap 4#
#sd 4#

#step 4: s=4#
s=4

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=4

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment41_sd<-var[1]^0.5
new_treatment42_sd<-var[2]^0.5
new_treatment43_sd<-var[3]^0.5
new_treatment44_sd<-var[4]^0.5
new_treatment45_sd<-var[5]^0.5
new_treatment46_sd<-var[6]^0.5
new_treatment47_sd<-var[7]^0.5
new_treatment48_sd<-var[8]^0.5
new_treatment49_sd<-var[9]^0.5
new_treatment410_sd<-var[10]^0.5
new_treatment411_sd<-var[11]^0.5
new_treatment412_sd<-var[12]^0.5
new_treatment413_sd<-var[13]^0.5
new_treatment414_sd<-var[14]^0.5
new_treatment415_sd<-var[15]^0.5
new_treatment416_sd<-var[16]^0.5
new_treatment417_sd<-var[17]^0.5
new_treatment418_sd<-var[18]^0.5
new_treatment419_sd<-var[19]^0.5
new_treatment420_sd<-var[20]^0.5
new_treatment421_sd<-var[21]^0.5
new_treatment422_sd<-var[22]^0.5
new_treatment423_sd<-var[23]^0.5
new_treatment424_sd<-var[24]^0.5
new_treatment425_sd<-var[25]^0.5
new_treatment426_sd<-var[26]^0.5
new_treatment427_sd<-var[27]^0.5
new_treatment428_sd<-var[28]^0.5
new_treatment429_sd<-var[29]^0.5
new_treatment430_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper4<-c()
lower4<-c()
for(i in 1:30){
upper4[i]<-new_treatment4[i]-Quantile_upper[i]*(var[i]^0.5)
lower4[i]<-new_treatment4[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper4
lower4









#step 5: s=5#

T0<-min(TT0)

s=5

DDD<-rbind(Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+zz3+zz4+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment51<-new_treatment[1]
new_treatment52<-new_treatment[2]
new_treatment53<-new_treatment[3]
new_treatment54<-new_treatment[4]
new_treatment55<-new_treatment[5]
new_treatment56<-new_treatment[6]
new_treatment57<-new_treatment[7]
new_treatment58<-new_treatment[8]
new_treatment59<-new_treatment[9]
new_treatment510<-new_treatment[10]
new_treatment511<-new_treatment[11]
new_treatment512<-new_treatment[12]
new_treatment513<-new_treatment[13]
new_treatment514<-new_treatment[14]
new_treatment515<-new_treatment[15]
new_treatment516<-new_treatment[16]
new_treatment517<-new_treatment[17]
new_treatment518<-new_treatment[18]
new_treatment519<-new_treatment[19]
new_treatment520<-new_treatment[20]
new_treatment521<-new_treatment[21]
new_treatment522<-new_treatment[22]
new_treatment523<-new_treatment[23]
new_treatment524<-new_treatment[24]
new_treatment525<-new_treatment[25]
new_treatment526<-new_treatment[26]
new_treatment527<-new_treatment[27]
new_treatment528<-new_treatment[28]
new_treatment529<-new_treatment[29]
new_treatment530<-new_treatment[30]

new_treatment5<-new_treatment





##====================================

#bootstrap 5#
#sd 5#

#step 5: s=5#
s=5

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=5

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment51_sd<-var[1]^0.5
new_treatment52_sd<-var[2]^0.5
new_treatment53_sd<-var[3]^0.5
new_treatment54_sd<-var[4]^0.5
new_treatment55_sd<-var[5]^0.5
new_treatment56_sd<-var[6]^0.5
new_treatment57_sd<-var[7]^0.5
new_treatment58_sd<-var[8]^0.5
new_treatment59_sd<-var[9]^0.5
new_treatment510_sd<-var[10]^0.5
new_treatment511_sd<-var[11]^0.5
new_treatment512_sd<-var[12]^0.5
new_treatment513_sd<-var[13]^0.5
new_treatment514_sd<-var[14]^0.5
new_treatment515_sd<-var[15]^0.5
new_treatment516_sd<-var[16]^0.5
new_treatment517_sd<-var[17]^0.5
new_treatment518_sd<-var[18]^0.5
new_treatment519_sd<-var[19]^0.5
new_treatment520_sd<-var[20]^0.5
new_treatment521_sd<-var[21]^0.5
new_treatment522_sd<-var[22]^0.5
new_treatment523_sd<-var[23]^0.5
new_treatment524_sd<-var[24]^0.5
new_treatment525_sd<-var[25]^0.5
new_treatment526_sd<-var[26]^0.5
new_treatment527_sd<-var[27]^0.5
new_treatment528_sd<-var[28]^0.5
new_treatment529_sd<-var[29]^0.5
new_treatment530_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper5<-c()
lower5<-c()
for(i in 1:30){
upper5[i]<-new_treatment5[i]-Quantile_upper[i]*(var[i]^0.5)
lower5[i]<-new_treatment5[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper5
lower5








#step 6: s=6#

T0<-min(TT0)

s=6

DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment61<-new_treatment[1]
new_treatment62<-new_treatment[2]
new_treatment63<-new_treatment[3]
new_treatment64<-new_treatment[4]
new_treatment65<-new_treatment[5]
new_treatment66<-new_treatment[6]
new_treatment67<-new_treatment[7]
new_treatment68<-new_treatment[8]
new_treatment69<-new_treatment[9]
new_treatment610<-new_treatment[10]
new_treatment611<-new_treatment[11]
new_treatment612<-new_treatment[12]
new_treatment613<-new_treatment[13]
new_treatment614<-new_treatment[14]
new_treatment615<-new_treatment[15]
new_treatment616<-new_treatment[16]
new_treatment617<-new_treatment[17]
new_treatment618<-new_treatment[18]
new_treatment619<-new_treatment[19]
new_treatment620<-new_treatment[20]
new_treatment621<-new_treatment[21]
new_treatment622<-new_treatment[22]
new_treatment623<-new_treatment[23]
new_treatment624<-new_treatment[24]
new_treatment625<-new_treatment[25]
new_treatment626<-new_treatment[26]
new_treatment627<-new_treatment[27]
new_treatment628<-new_treatment[28]
new_treatment629<-new_treatment[29]
new_treatment630<-new_treatment[30]

new_treatment6<-new_treatment





##====================================

#bootstrap 6#
#sd 6#

#step 6: s=6#
s=6

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=6

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment61_sd<-var[1]^0.5
new_treatment62_sd<-var[2]^0.5
new_treatment63_sd<-var[3]^0.5
new_treatment64_sd<-var[4]^0.5
new_treatment65_sd<-var[5]^0.5
new_treatment66_sd<-var[6]^0.5
new_treatment67_sd<-var[7]^0.5
new_treatment68_sd<-var[8]^0.5
new_treatment69_sd<-var[9]^0.5
new_treatment610_sd<-var[10]^0.5
new_treatment611_sd<-var[11]^0.5
new_treatment612_sd<-var[12]^0.5
new_treatment613_sd<-var[13]^0.5
new_treatment614_sd<-var[14]^0.5
new_treatment615_sd<-var[15]^0.5
new_treatment616_sd<-var[16]^0.5
new_treatment617_sd<-var[17]^0.5
new_treatment618_sd<-var[18]^0.5
new_treatment619_sd<-var[19]^0.5
new_treatment620_sd<-var[20]^0.5
new_treatment621_sd<-var[21]^0.5
new_treatment622_sd<-var[22]^0.5
new_treatment623_sd<-var[23]^0.5
new_treatment624_sd<-var[24]^0.5
new_treatment625_sd<-var[25]^0.5
new_treatment626_sd<-var[26]^0.5
new_treatment627_sd<-var[27]^0.5
new_treatment628_sd<-var[28]^0.5
new_treatment629_sd<-var[29]^0.5
new_treatment630_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper6<-c()
lower6<-c()
for(i in 1:30){
upper6[i]<-new_treatment6[i]-Quantile_upper[i]*(var[i]^0.5)
lower6[i]<-new_treatment6[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper6
lower6







#step 7: s=7#

T0<-min(TT0)

s=7

DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment71<-new_treatment[1]
new_treatment72<-new_treatment[2]
new_treatment73<-new_treatment[3]
new_treatment74<-new_treatment[4]
new_treatment75<-new_treatment[5]
new_treatment76<-new_treatment[6]
new_treatment77<-new_treatment[7]
new_treatment78<-new_treatment[8]
new_treatment79<-new_treatment[9]
new_treatment710<-new_treatment[10]
new_treatment711<-new_treatment[11]
new_treatment712<-new_treatment[12]
new_treatment713<-new_treatment[13]
new_treatment714<-new_treatment[14]
new_treatment715<-new_treatment[15]
new_treatment716<-new_treatment[16]
new_treatment717<-new_treatment[17]
new_treatment718<-new_treatment[18]
new_treatment719<-new_treatment[19]
new_treatment720<-new_treatment[20]
new_treatment721<-new_treatment[21]
new_treatment722<-new_treatment[22]
new_treatment723<-new_treatment[23]
new_treatment724<-new_treatment[24]
new_treatment725<-new_treatment[25]
new_treatment726<-new_treatment[26]
new_treatment727<-new_treatment[27]
new_treatment728<-new_treatment[28]
new_treatment729<-new_treatment[29]
new_treatment730<-new_treatment[30]

new_treatment7<-new_treatment





##====================================

#bootstrap 7#
#sd 7#

#step 7: s=7#
s=7

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=7

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment71_sd<-var[1]^0.5
new_treatment72_sd<-var[2]^0.5
new_treatment73_sd<-var[3]^0.5
new_treatment74_sd<-var[4]^0.5
new_treatment75_sd<-var[5]^0.5
new_treatment76_sd<-var[6]^0.5
new_treatment77_sd<-var[7]^0.5
new_treatment78_sd<-var[8]^0.5
new_treatment79_sd<-var[9]^0.5
new_treatment710_sd<-var[10]^0.5
new_treatment711_sd<-var[11]^0.5
new_treatment712_sd<-var[12]^0.5
new_treatment713_sd<-var[13]^0.5
new_treatment714_sd<-var[14]^0.5
new_treatment715_sd<-var[15]^0.5
new_treatment716_sd<-var[16]^0.5
new_treatment717_sd<-var[17]^0.5
new_treatment718_sd<-var[18]^0.5
new_treatment719_sd<-var[19]^0.5
new_treatment720_sd<-var[20]^0.5
new_treatment721_sd<-var[21]^0.5
new_treatment722_sd<-var[22]^0.5
new_treatment723_sd<-var[23]^0.5
new_treatment724_sd<-var[24]^0.5
new_treatment725_sd<-var[25]^0.5
new_treatment726_sd<-var[26]^0.5
new_treatment727_sd<-var[27]^0.5
new_treatment728_sd<-var[28]^0.5
new_treatment729_sd<-var[29]^0.5
new_treatment730_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper7<-c()
lower7<-c()
for(i in 1:30){
upper7[i]<-new_treatment7[i]-Quantile_upper[i]*(var[i]^0.5)
lower7[i]<-new_treatment7[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper7
lower7







#step 8: s=8#

T0<-min(TT0)

s=8

DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment81<-new_treatment[1]
new_treatment82<-new_treatment[2]
new_treatment83<-new_treatment[3]
new_treatment84<-new_treatment[4]
new_treatment85<-new_treatment[5]
new_treatment86<-new_treatment[6]
new_treatment87<-new_treatment[7]
new_treatment88<-new_treatment[8]
new_treatment89<-new_treatment[9]
new_treatment810<-new_treatment[10]
new_treatment811<-new_treatment[11]
new_treatment812<-new_treatment[12]
new_treatment813<-new_treatment[13]
new_treatment814<-new_treatment[14]
new_treatment815<-new_treatment[15]
new_treatment816<-new_treatment[16]
new_treatment817<-new_treatment[17]
new_treatment818<-new_treatment[18]
new_treatment819<-new_treatment[19]
new_treatment820<-new_treatment[20]
new_treatment821<-new_treatment[21]
new_treatment822<-new_treatment[22]
new_treatment823<-new_treatment[23]
new_treatment824<-new_treatment[24]
new_treatment825<-new_treatment[25]
new_treatment826<-new_treatment[26]
new_treatment827<-new_treatment[27]
new_treatment828<-new_treatment[28]
new_treatment829<-new_treatment[29]
new_treatment830<-new_treatment[30]

new_treatment8<-new_treatment





##====================================

#bootstrap 8#
#sd 8#

#step 8: s=8#
s=8

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=8

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[14,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment81_sd<-var[1]^0.5
new_treatment82_sd<-var[2]^0.5
new_treatment83_sd<-var[3]^0.5
new_treatment84_sd<-var[4]^0.5
new_treatment85_sd<-var[5]^0.5
new_treatment86_sd<-var[6]^0.5
new_treatment87_sd<-var[7]^0.5
new_treatment88_sd<-var[8]^0.5
new_treatment89_sd<-var[9]^0.5
new_treatment810_sd<-var[10]^0.5
new_treatment811_sd<-var[11]^0.5
new_treatment812_sd<-var[12]^0.5
new_treatment813_sd<-var[13]^0.5
new_treatment814_sd<-var[14]^0.5
new_treatment815_sd<-var[15]^0.5
new_treatment816_sd<-var[16]^0.5
new_treatment817_sd<-var[17]^0.5
new_treatment818_sd<-var[18]^0.5
new_treatment819_sd<-var[19]^0.5
new_treatment820_sd<-var[20]^0.5
new_treatment821_sd<-var[21]^0.5
new_treatment822_sd<-var[22]^0.5
new_treatment823_sd<-var[23]^0.5
new_treatment824_sd<-var[24]^0.5
new_treatment825_sd<-var[25]^0.5
new_treatment826_sd<-var[26]^0.5
new_treatment827_sd<-var[27]^0.5
new_treatment828_sd<-var[28]^0.5
new_treatment829_sd<-var[29]^0.5
new_treatment830_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper8<-c()
lower8<-c()
for(i in 1:30){
upper8[i]<-new_treatment8[i]-Quantile_upper[i]*(var[i]^0.5)
lower8[i]<-new_treatment8[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper8
lower8








#step 9: s=9#

T0<-min(TT0)

s=9

DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment91<-new_treatment[1]
new_treatment92<-new_treatment[2]
new_treatment93<-new_treatment[3]
new_treatment94<-new_treatment[4]
new_treatment95<-new_treatment[5]
new_treatment96<-new_treatment[6]
new_treatment97<-new_treatment[7]
new_treatment98<-new_treatment[8]
new_treatment99<-new_treatment[9]
new_treatment910<-new_treatment[10]
new_treatment911<-new_treatment[11]
new_treatment912<-new_treatment[12]
new_treatment913<-new_treatment[13]
new_treatment914<-new_treatment[14]
new_treatment915<-new_treatment[15]
new_treatment916<-new_treatment[16]
new_treatment917<-new_treatment[17]
new_treatment918<-new_treatment[18]
new_treatment919<-new_treatment[19]
new_treatment920<-new_treatment[20]
new_treatment921<-new_treatment[21]
new_treatment922<-new_treatment[22]
new_treatment923<-new_treatment[23]
new_treatment924<-new_treatment[24]
new_treatment925<-new_treatment[25]
new_treatment926<-new_treatment[26]
new_treatment927<-new_treatment[27]
new_treatment928<-new_treatment[28]
new_treatment929<-new_treatment[29]
new_treatment930<-new_treatment[30]

new_treatment9<-new_treatment





##====================================

#bootstrap 9#
#sd 9#

#step 9: s=9#
s=9

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=9

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment91_sd<-var[1]^0.5
new_treatment92_sd<-var[2]^0.5
new_treatment93_sd<-var[3]^0.5
new_treatment94_sd<-var[4]^0.5
new_treatment95_sd<-var[5]^0.5
new_treatment96_sd<-var[6]^0.5
new_treatment97_sd<-var[7]^0.5
new_treatment98_sd<-var[8]^0.5
new_treatment99_sd<-var[9]^0.5
new_treatment910_sd<-var[10]^0.5
new_treatment911_sd<-var[11]^0.5
new_treatment912_sd<-var[12]^0.5
new_treatment913_sd<-var[13]^0.5
new_treatment914_sd<-var[14]^0.5
new_treatment915_sd<-var[15]^0.5
new_treatment916_sd<-var[16]^0.5
new_treatment917_sd<-var[17]^0.5
new_treatment918_sd<-var[18]^0.5
new_treatment919_sd<-var[19]^0.5
new_treatment920_sd<-var[20]^0.5
new_treatment921_sd<-var[21]^0.5
new_treatment922_sd<-var[22]^0.5
new_treatment923_sd<-var[23]^0.5
new_treatment924_sd<-var[24]^0.5
new_treatment925_sd<-var[25]^0.5
new_treatment926_sd<-var[26]^0.5
new_treatment927_sd<-var[27]^0.5
new_treatment928_sd<-var[28]^0.5
new_treatment929_sd<-var[29]^0.5
new_treatment930_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper9<-c()
lower9<-c()
for(i in 1:30){
upper9[i]<-new_treatment9[i]-Quantile_upper[i]*(var[i]^0.5)
lower9[i]<-new_treatment9[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper9
lower9









#step 10: s=10#

T0<-min(TT0)

s=10

DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],Tr1[1,][T0+9],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],Tr1[2,][T0+9],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],Tr1[3,][T0+9],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],Tr1[4,][T0+9],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],Tr1[5,][T0+9],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],Tr1[6,][T0+9],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],Tr1[7,][T0+9],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],Tr1[8,][T0+9],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],Tr1[9,][T0+9],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],Tr1[10,][T0+9],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],Tr1[11,][T0+9],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],Tr1[12,][T0+9],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],Tr1[13,][T0+9],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],Tr1[14,][T0+9],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],Tr1[15,][T0+9],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],Tr1[16,][T0+9],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],Tr1[17,][T0+9],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],Tr1[18,][T0+9],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],Tr1[19,][T0+9],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],Tr1[20,][T0+9],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],Tr1[21,][T0+9],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],Tr1[22,][T0+9],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],Tr1[23,][T0+9],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],Tr1[24,][T0+9],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],Tr1[25,][T0+9],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],Tr1[26,][T0+9],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],Tr1[27,][T0+9],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],Tr1[28,][T0+9],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],Tr1[29,][T0+9],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],Tr1[30,][T0+9],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,new_treatment96,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,new_treatment97,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,new_treatment98,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,new_treatment99,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,new_treatment910,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,new_treatment911,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,new_treatment912,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,new_treatment913,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,new_treatment914,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,new_treatment915,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,new_treatment916,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,new_treatment917,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,new_treatment918,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,new_treatment919,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,new_treatment920,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,new_treatment921,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,new_treatment922,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,new_treatment923,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,new_treatment924,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,new_treatment925,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,new_treatment926,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,new_treatment927,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,new_treatment928,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,new_treatment929,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,new_treatment930,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment101<-new_treatment[1]
new_treatment102<-new_treatment[2]
new_treatment103<-new_treatment[3]
new_treatment104<-new_treatment[4]
new_treatment105<-new_treatment[5]
new_treatment106<-new_treatment[6]
new_treatment107<-new_treatment[7]
new_treatment108<-new_treatment[8]
new_treatment109<-new_treatment[9]
new_treatment1010<-new_treatment[10]
new_treatment1011<-new_treatment[11]
new_treatment1012<-new_treatment[12]
new_treatment1013<-new_treatment[13]
new_treatment1014<-new_treatment[14]
new_treatment1015<-new_treatment[15]
new_treatment1016<-new_treatment[16]
new_treatment1017<-new_treatment[17]
new_treatment1018<-new_treatment[18]
new_treatment1019<-new_treatment[19]
new_treatment1020<-new_treatment[20]
new_treatment1021<-new_treatment[21]
new_treatment1022<-new_treatment[22]
new_treatment1023<-new_treatment[23]
new_treatment1024<-new_treatment[24]
new_treatment1025<-new_treatment[25]
new_treatment1026<-new_treatment[26]
new_treatment1027<-new_treatment[27]
new_treatment1028<-new_treatment[28]
new_treatment1029<-new_treatment[29]
new_treatment1030<-new_treatment[30]

new_treatment10<-new_treatment





##====================================

#bootstrap 10#
#sd 10#

#step 10: s=10#
s=10

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=10

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],Tr1[1,][T0+9],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],Tr1[2,][T0+9],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],Tr1[3,][T0+9],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],Tr1[4,][T0+9],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],Tr1[5,][T0+9],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],Tr1[6,][T0+9],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],Tr1[7,][T0+9],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],Tr1[8,][T0+9],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],Tr1[9,][T0+9],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],Tr1[10,][T0+9],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],Tr1[11,][T0+9],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],Tr1[12,][T0+9],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],Tr1[13,][T0+9],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],Tr1[14,][T0+9],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],Tr1[15,][T0+9],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],Tr1[16,][T0+9],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],Tr1[17,][T0+9],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],Tr1[18,][T0+9],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],Tr1[19,][T0+9],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],Tr1[20,][T0+9],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],Tr1[21,][T0+9],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],Tr1[22,][T0+9],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],Tr1[23,][T0+9],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],Tr1[24,][T0+9],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],Tr1[25,][T0+9],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],Tr1[26,][T0+9],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],Tr1[27,][T0+9],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],Tr1[28,][T0+9],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],Tr1[29,][T0+9],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],Tr1[30,][T0+9],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,new_treatment96,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,new_treatment97,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,new_treatment98,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,new_treatment99,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,new_treatment910,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,new_treatment911,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,new_treatment912,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,new_treatment913,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,new_treatment914,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,new_treatment915,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,new_treatment916,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,new_treatment917,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,new_treatment918,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,new_treatment919,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,new_treatment920,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,new_treatment921,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,new_treatment922,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,new_treatment923,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,new_treatment924,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,new_treatment925,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,new_treatment926,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,new_treatment927,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,new_treatment928,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,new_treatment929,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,new_treatment930,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment101_sd<-var[1]^0.5
new_treatment102_sd<-var[2]^0.5
new_treatment103_sd<-var[3]^0.5
new_treatment104_sd<-var[4]^0.5
new_treatment105_sd<-var[5]^0.5
new_treatment106_sd<-var[6]^0.5
new_treatment107_sd<-var[7]^0.5
new_treatment108_sd<-var[8]^0.5
new_treatment109_sd<-var[9]^0.5
new_treatment1010_sd<-var[10]^0.5
new_treatment1011_sd<-var[11]^0.5
new_treatment1012_sd<-var[12]^0.5
new_treatment1013_sd<-var[13]^0.5
new_treatment1014_sd<-var[14]^0.5
new_treatment1015_sd<-var[15]^0.5
new_treatment1016_sd<-var[16]^0.5
new_treatment1017_sd<-var[17]^0.5
new_treatment1018_sd<-var[18]^0.5
new_treatment1019_sd<-var[19]^0.5
new_treatment1020_sd<-var[20]^0.5
new_treatment1021_sd<-var[21]^0.5
new_treatment1022_sd<-var[22]^0.5
new_treatment1023_sd<-var[23]^0.5
new_treatment1024_sd<-var[24]^0.5
new_treatment1025_sd<-var[25]^0.5
new_treatment1026_sd<-var[26]^0.5
new_treatment1027_sd<-var[27]^0.5
new_treatment1028_sd<-var[28]^0.5
new_treatment1029_sd<-var[29]^0.5
new_treatment1030_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper10<-c()
lower10<-c()
for(i in 1:30){
upper10[i]<-new_treatment10[i]-Quantile_upper[i]*(var[i]^0.5)
lower10[i]<-new_treatment10[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper10
lower10















#step 11: s=11#

T0<-min(TT0)

s=11

DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],Tr1[1,][T0+9],Tr1[1,][T0+10],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],Tr1[2,][T0+9],Tr1[2,][T0+10],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],Tr1[3,][T0+9],Tr1[3,][T0+10],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],Tr1[4,][T0+9],Tr1[4,][T0+10],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],Tr1[5,][T0+9],Tr1[5,][T0+10],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],Tr1[6,][T0+9],Tr1[6,][T0+10],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],Tr1[7,][T0+9],Tr1[7,][T0+10],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],Tr1[8,][T0+9],Tr1[8,][T0+10],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],Tr1[9,][T0+9],Tr1[9,][T0+10],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],Tr1[10,][T0+9],Tr1[10,][T0+10],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],Tr1[11,][T0+9],Tr1[11,][T0+10],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],Tr1[12,][T0+9],Tr1[12,][T0+10],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],Tr1[13,][T0+9],Tr1[13,][T0+10],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],Tr1[14,][T0+9],Tr1[14,][T0+10],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],Tr1[15,][T0+9],Tr1[15,][T0+10],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],Tr1[16,][T0+9],Tr1[16,][T0+10],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],Tr1[17,][T0+9],Tr1[17,][T0+10],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],Tr1[18,][T0+9],Tr1[18,][T0+10],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],Tr1[19,][T0+9],Tr1[19,][T0+10],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],Tr1[20,][T0+9],Tr1[20,][T0+10],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],Tr1[21,][T0+9],Tr1[21,][T0+10],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],Tr1[22,][T0+9],Tr1[22,][T0+10],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],Tr1[23,][T0+9],Tr1[23,][T0+10],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],Tr1[24,][T0+9],Tr1[24,][T0+10],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],Tr1[25,][T0+9],Tr1[25,][T0+10],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],Tr1[26,][T0+9],Tr1[26,][T0+10],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],Tr1[27,][T0+9],Tr1[27,][T0+10],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],Tr1[28,][T0+9],Tr1[28,][T0+10],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],Tr1[29,][T0+9],Tr1[29,][T0+10],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],Tr1[30,][T0+9],Tr1[30,][T0+10],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,new_treatment96,new_treatment106,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,new_treatment97,new_treatment107,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,new_treatment98,new_treatment108,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,new_treatment99,new_treatment109,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,new_treatment910,new_treatment1010,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,new_treatment911,new_treatment1011,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,new_treatment912,new_treatment1012,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,new_treatment913,new_treatment1013,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,new_treatment914,new_treatment1014,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,new_treatment915,new_treatment1015,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,new_treatment916,new_treatment1016,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,new_treatment917,new_treatment1017,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,new_treatment918,new_treatment1018,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,new_treatment919,new_treatment1019,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,new_treatment920,new_treatment1020,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,new_treatment921,new_treatment1021,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,new_treatment922,new_treatment1022,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,new_treatment923,new_treatment1023,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,new_treatment924,new_treatment1024,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,new_treatment925,new_treatment1025,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,new_treatment926,new_treatment1026,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,new_treatment927,new_treatment1027,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,new_treatment928,new_treatment1028,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,new_treatment929,new_treatment1029,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,new_treatment930,new_treatment1030,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment_111<-new_treatment[1]
new_treatment_112<-new_treatment[2]
new_treatment_113<-new_treatment[3]
new_treatment_114<-new_treatment[4]
new_treatment_115<-new_treatment[5]
new_treatment_116<-new_treatment[6]
new_treatment_117<-new_treatment[7]
new_treatment_118<-new_treatment[8]
new_treatment_119<-new_treatment[9]
new_treatment_1110<-new_treatment[10]
new_treatment_1111<-new_treatment[11]
new_treatment_1112<-new_treatment[12]
new_treatment_1113<-new_treatment[13]
new_treatment_1114<-new_treatment[14]
new_treatment_1115<-new_treatment[15]
new_treatment_1116<-new_treatment[16]
new_treatment_1117<-new_treatment[17]
new_treatment_1118<-new_treatment[18]
new_treatment_1119<-new_treatment[19]
new_treatment_1120<-new_treatment[20]
new_treatment_1121<-new_treatment[21]
new_treatment_1122<-new_treatment[22]
new_treatment_1123<-new_treatment[23]
new_treatment_1124<-new_treatment[24]
new_treatment_1125<-new_treatment[25]
new_treatment_1126<-new_treatment[26]
new_treatment_1127<-new_treatment[27]
new_treatment_1128<-new_treatment[28]
new_treatment_1129<-new_treatment[29]
new_treatment_1130<-new_treatment[30]

new_treatment_11<-new_treatment





##====================================

#bootstrap 11#
#sd 11#

#step 11: s=11#
s=11

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=11

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


#step 11: s=11#

T0<-min(TT0)

s=11

DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],Tr1[1,][T0+9],Tr1[1,][T0+10],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],Tr1[2,][T0+9],Tr1[2,][T0+10],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],Tr1[3,][T0+9],Tr1[3,][T0+10],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],Tr1[4,][T0+9],Tr1[4,][T0+10],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],Tr1[5,][T0+9],Tr1[5,][T0+10],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],Tr1[6,][T0+9],Tr1[6,][T0+10],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],Tr1[7,][T0+9],Tr1[7,][T0+10],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],Tr1[8,][T0+9],Tr1[8,][T0+10],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],Tr1[9,][T0+9],Tr1[9,][T0+10],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],Tr1[10,][T0+9],Tr1[10,][T0+10],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],Tr1[11,][T0+9],Tr1[11,][T0+10],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],Tr1[12,][T0+9],Tr1[12,][T0+10],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],Tr1[13,][T0+9],Tr1[13,][T0+10],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],Tr1[14,][T0+9],Tr1[14,][T0+10],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],Tr1[15,][T0+9],Tr1[15,][T0+10],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],Tr1[16,][T0+9],Tr1[16,][T0+10],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],Tr1[17,][T0+9],Tr1[17,][T0+10],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],Tr1[18,][T0+9],Tr1[18,][T0+10],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],Tr1[19,][T0+9],Tr1[19,][T0+10],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],Tr1[20,][T0+9],Tr1[20,][T0+10],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],Tr1[21,][T0+9],Tr1[21,][T0+10],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],Tr1[22,][T0+9],Tr1[22,][T0+10],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],Tr1[23,][T0+9],Tr1[23,][T0+10],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],Tr1[24,][T0+9],Tr1[24,][T0+10],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],Tr1[25,][T0+9],Tr1[25,][T0+10],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],Tr1[26,][T0+9],Tr1[26,][T0+10],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],Tr1[27,][T0+9],Tr1[27,][T0+10],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],Tr1[28,][T0+9],Tr1[28,][T0+10],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],Tr1[29,][T0+9],Tr1[29,][T0+10],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],Tr1[30,][T0+9],Tr1[30,][T0+10],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,new_treatment96,new_treatment106,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,new_treatment97,new_treatment107,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,new_treatment98,new_treatment108,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,new_treatment99,new_treatment109,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,new_treatment910,new_treatment1010,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,new_treatment911,new_treatment1011,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,new_treatment912,new_treatment1012,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,new_treatment913,new_treatment1013,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,new_treatment914,new_treatment1014,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,new_treatment915,new_treatment1015,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,new_treatment916,new_treatment1016,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,new_treatment917,new_treatment1017,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,new_treatment918,new_treatment1018,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,new_treatment919,new_treatment1019,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,new_treatment920,new_treatment1020,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,new_treatment921,new_treatment1021,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,new_treatment922,new_treatment1022,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,new_treatment923,new_treatment1023,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,new_treatment924,new_treatment1024,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,new_treatment925,new_treatment1025,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,new_treatment926,new_treatment1026,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,new_treatment927,new_treatment1027,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,new_treatment928,new_treatment1028,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,new_treatment929,new_treatment1029,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,new_treatment930,new_treatment1030,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment_111_sd<-var[1]^0.5
new_treatment_112_sd<-var[2]^0.5
new_treatment_113_sd<-var[3]^0.5
new_treatment_114_sd<-var[4]^0.5
new_treatment_115_sd<-var[5]^0.5
new_treatment_116_sd<-var[6]^0.5
new_treatment_117_sd<-var[7]^0.5
new_treatment_118_sd<-var[8]^0.5
new_treatment_119_sd<-var[9]^0.5
new_treatment_1110_sd<-var[10]^0.5
new_treatment_1111_sd<-var[11]^0.5
new_treatment_1112_sd<-var[12]^0.5
new_treatment_1113_sd<-var[13]^0.5
new_treatment_1114_sd<-var[14]^0.5
new_treatment_1115_sd<-var[15]^0.5
new_treatment_1116_sd<-var[16]^0.5
new_treatment_1117_sd<-var[17]^0.5
new_treatment_1118_sd<-var[18]^0.5
new_treatment_1119_sd<-var[19]^0.5
new_treatment_1120_sd<-var[20]^0.5
new_treatment_1121_sd<-var[21]^0.5
new_treatment_1122_sd<-var[22]^0.5
new_treatment_1123_sd<-var[23]^0.5
new_treatment_1124_sd<-var[24]^0.5
new_treatment_1125_sd<-var[25]^0.5
new_treatment_1126_sd<-var[26]^0.5
new_treatment_1127_sd<-var[27]^0.5
new_treatment_1128_sd<-var[28]^0.5
new_treatment_1129_sd<-var[29]^0.5
new_treatment_1130_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper11<-c()
lower11<-c()
for(i in 1:30){
upper11[i]<-new_treatment_11[i]-Quantile_upper[i]*(var[i]^0.5)
lower11[i]<-new_treatment_11[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper11
lower11












#step 12: s=12#

T0<-min(TT0)

s=12

DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],Tr1[1,][T0+9],Tr1[1,][T0+10],Tr1[1,][T0+11],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],Tr1[2,][T0+9],Tr1[2,][T0+10],Tr1[2,][T0+11],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],Tr1[3,][T0+9],Tr1[3,][T0+10],Tr1[3,][T0+11],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],Tr1[4,][T0+9],Tr1[4,][T0+10],Tr1[4,][T0+11],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],Tr1[5,][T0+9],Tr1[5,][T0+10],Tr1[5,][T0+11],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],Tr1[6,][T0+9],Tr1[6,][T0+10],Tr1[6,][T0+11],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],Tr1[7,][T0+9],Tr1[7,][T0+10],Tr1[7,][T0+11],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],Tr1[8,][T0+9],Tr1[8,][T0+10],Tr1[8,][T0+11],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],Tr1[9,][T0+9],Tr1[9,][T0+10],Tr1[9,][T0+11],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],Tr1[10,][T0+9],Tr1[10,][T0+10],Tr1[10,][T0+11],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],Tr1[11,][T0+9],Tr1[11,][T0+10],Tr1[11,][T0+11],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],Tr1[12,][T0+9],Tr1[12,][T0+10],Tr1[12,][T0+11],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],Tr1[13,][T0+9],Tr1[13,][T0+10],Tr1[13,][T0+11],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],Tr1[14,][T0+9],Tr1[14,][T0+10],Tr1[14,][T0+11],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],Tr1[15,][T0+9],Tr1[15,][T0+10],Tr1[15,][T0+11],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],Tr1[16,][T0+9],Tr1[16,][T0+10],Tr1[16,][T0+11],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],Tr1[17,][T0+9],Tr1[17,][T0+10],Tr1[17,][T0+11],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],Tr1[18,][T0+9],Tr1[18,][T0+10],Tr1[18,][T0+11],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],Tr1[19,][T0+9],Tr1[19,][T0+10],Tr1[19,][T0+11],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],Tr1[20,][T0+9],Tr1[20,][T0+10],Tr1[20,][T0+11],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],Tr1[21,][T0+9],Tr1[21,][T0+10],Tr1[21,][T0+11],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],Tr1[22,][T0+9],Tr1[22,][T0+10],Tr1[22,][T0+11],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],Tr1[23,][T0+9],Tr1[23,][T0+10],Tr1[23,][T0+11],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],Tr1[24,][T0+9],Tr1[24,][T0+10],Tr1[24,][T0+11],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],Tr1[25,][T0+9],Tr1[25,][T0+10],Tr1[24,][T0+11],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],Tr1[26,][T0+9],Tr1[26,][T0+10],Tr1[26,][T0+11],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],Tr1[27,][T0+9],Tr1[27,][T0+10],Tr1[27,][T0+11],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],Tr1[28,][T0+9],Tr1[28,][T0+10],Tr1[28,][T0+11],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],Tr1[29,][T0+9],Tr1[29,][T0+10],Tr1[29,][T0+11],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],Tr1[30,][T0+9],Tr1[30,][T0+10],Tr1[30,][T0+11],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment_111,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment_112,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment_113,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment_114,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment_115,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,new_treatment96,new_treatment106,new_treatment_116,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,new_treatment97,new_treatment107,new_treatment_117,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,new_treatment98,new_treatment108,new_treatment_118,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,new_treatment99,new_treatment109,new_treatment_119,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,new_treatment910,new_treatment1010,new_treatment_1110,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,new_treatment911,new_treatment1011,new_treatment_1111,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,new_treatment912,new_treatment1012,new_treatment_1112,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,new_treatment913,new_treatment1013,new_treatment_1113,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,new_treatment914,new_treatment1014,new_treatment_1114,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,new_treatment915,new_treatment1015,new_treatment_1115,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,new_treatment916,new_treatment1016,new_treatment_1116,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,new_treatment917,new_treatment1017,new_treatment_1117,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,new_treatment918,new_treatment1018,new_treatment_1118,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,new_treatment919,new_treatment1019,new_treatment_1119,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,new_treatment920,new_treatment1020,new_treatment_1120,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,new_treatment921,new_treatment1021,new_treatment_1121,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,new_treatment922,new_treatment1022,new_treatment_1122,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,new_treatment923,new_treatment1023,new_treatment_1123,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,new_treatment924,new_treatment1024,new_treatment_1124,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,new_treatment925,new_treatment1025,new_treatment_1125,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,new_treatment926,new_treatment1026,new_treatment_1126,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,new_treatment927,new_treatment1027,new_treatment_1127,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,new_treatment928,new_treatment1028,new_treatment_1128,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,new_treatment929,new_treatment1029,new_treatment_1129,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,new_treatment930,new_treatment1030,new_treatment_1130,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment_121<-new_treatment[1]
new_treatment_122<-new_treatment[2]
new_treatment_123<-new_treatment[3]
new_treatment_124<-new_treatment[4]
new_treatment_125<-new_treatment[5]
new_treatment_126<-new_treatment[6]
new_treatment_127<-new_treatment[7]
new_treatment_128<-new_treatment[8]
new_treatment_129<-new_treatment[9]
new_treatment_1210<-new_treatment[10]
new_treatment_1211<-new_treatment[11]
new_treatment_1212<-new_treatment[12]
new_treatment_1213<-new_treatment[13]
new_treatment_1214<-new_treatment[14]
new_treatment_1215<-new_treatment[15]
new_treatment_1216<-new_treatment[16]
new_treatment_1217<-new_treatment[17]
new_treatment_1218<-new_treatment[18]
new_treatment_1219<-new_treatment[19]
new_treatment_1220<-new_treatment[20]
new_treatment_1221<-new_treatment[21]
new_treatment_1222<-new_treatment[22]
new_treatment_1223<-new_treatment[23]
new_treatment_1224<-new_treatment[24]
new_treatment_1225<-new_treatment[25]
new_treatment_1226<-new_treatment[26]
new_treatment_1227<-new_treatment[27]
new_treatment_1228<-new_treatment[28]
new_treatment_1229<-new_treatment[29]
new_treatment_1230<-new_treatment[30]

new_treatment_12<-new_treatment





##====================================

#bootstrap 12#
#sd 12#

#step 12: s=12#
s=12

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=12

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],Tr1[1,][T0+9],Tr1[1,][T0+10],Tr1[1,][T0+11],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],Tr1[2,][T0+9],Tr1[2,][T0+10],Tr1[2,][T0+11],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],Tr1[3,][T0+9],Tr1[3,][T0+10],Tr1[3,][T0+11],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],Tr1[4,][T0+9],Tr1[4,][T0+10],Tr1[4,][T0+11],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],Tr1[5,][T0+9],Tr1[5,][T0+10],Tr1[5,][T0+11],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],Tr1[6,][T0+9],Tr1[6,][T0+10],Tr1[6,][T0+11],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],Tr1[7,][T0+9],Tr1[7,][T0+10],Tr1[7,][T0+11],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],Tr1[8,][T0+9],Tr1[8,][T0+10],Tr1[8,][T0+11],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],Tr1[9,][T0+9],Tr1[9,][T0+10],Tr1[9,][T0+11],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],Tr1[10,][T0+9],Tr1[10,][T0+10],Tr1[10,][T0+11],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],Tr1[11,][T0+9],Tr1[11,][T0+10],Tr1[11,][T0+11],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],Tr1[12,][T0+9],Tr1[12,][T0+10],Tr1[12,][T0+11],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],Tr1[13,][T0+9],Tr1[13,][T0+10],Tr1[13,][T0+11],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],Tr1[14,][T0+9],Tr1[14,][T0+10],Tr1[14,][T0+11],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],Tr1[15,][T0+9],Tr1[15,][T0+10],Tr1[15,][T0+11],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],Tr1[16,][T0+9],Tr1[16,][T0+10],Tr1[16,][T0+11],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],Tr1[17,][T0+9],Tr1[17,][T0+10],Tr1[17,][T0+11],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],Tr1[18,][T0+9],Tr1[18,][T0+10],Tr1[18,][T0+11],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],Tr1[19,][T0+9],Tr1[19,][T0+10],Tr1[19,][T0+11],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],Tr1[20,][T0+9],Tr1[20,][T0+10],Tr1[20,][T0+11],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],Tr1[21,][T0+9],Tr1[21,][T0+10],Tr1[21,][T0+11],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],Tr1[22,][T0+9],Tr1[22,][T0+10],Tr1[22,][T0+11],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],Tr1[23,][T0+9],Tr1[23,][T0+10],Tr1[23,][T0+11],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],Tr1[24,][T0+9],Tr1[24,][T0+10],Tr1[24,][T0+11],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],Tr1[25,][T0+9],Tr1[25,][T0+10],Tr1[24,][T0+11],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],Tr1[26,][T0+9],Tr1[26,][T0+10],Tr1[26,][T0+11],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],Tr1[27,][T0+9],Tr1[27,][T0+10],Tr1[27,][T0+11],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],Tr1[28,][T0+9],Tr1[28,][T0+10],Tr1[28,][T0+11],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],Tr1[29,][T0+9],Tr1[29,][T0+10],Tr1[29,][T0+11],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],Tr1[30,][T0+9],Tr1[30,][T0+10],Tr1[30,][T0+11],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment_111,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment_112,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment_113,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment_114,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment_115,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,new_treatment96,new_treatment106,new_treatment_116,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,new_treatment97,new_treatment107,new_treatment_117,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,new_treatment98,new_treatment108,new_treatment_118,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,new_treatment99,new_treatment109,new_treatment_119,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,new_treatment910,new_treatment1010,new_treatment_1110,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,new_treatment911,new_treatment1011,new_treatment_1111,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,new_treatment912,new_treatment1012,new_treatment_1112,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,new_treatment913,new_treatment1013,new_treatment_1113,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,new_treatment914,new_treatment1014,new_treatment_1114,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,new_treatment915,new_treatment1015,new_treatment_1115,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,new_treatment916,new_treatment1016,new_treatment_1116,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,new_treatment917,new_treatment1017,new_treatment_1117,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,new_treatment918,new_treatment1018,new_treatment_1118,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,new_treatment919,new_treatment1019,new_treatment_1119,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,new_treatment920,new_treatment1020,new_treatment_1120,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,new_treatment921,new_treatment1021,new_treatment_1121,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,new_treatment922,new_treatment1022,new_treatment_1122,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,new_treatment923,new_treatment1023,new_treatment_1123,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,new_treatment924,new_treatment1024,new_treatment_1124,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,new_treatment925,new_treatment1025,new_treatment_1125,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,new_treatment926,new_treatment1026,new_treatment_1126,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,new_treatment927,new_treatment1027,new_treatment_1127,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,new_treatment928,new_treatment1028,new_treatment_1128,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,new_treatment929,new_treatment1029,new_treatment_1129,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,new_treatment930,new_treatment1030,new_treatment_1130,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment_121_sd<-var[1]^0.5
new_treatment_122_sd<-var[2]^0.5
new_treatment_123_sd<-var[3]^0.5
new_treatment_124_sd<-var[4]^0.5
new_treatment_125_sd<-var[5]^0.5
new_treatment_126_sd<-var[6]^0.5
new_treatment_127_sd<-var[7]^0.5
new_treatment_128_sd<-var[8]^0.5
new_treatment_129_sd<-var[9]^0.5
new_treatment_1210_sd<-var[10]^0.5
new_treatment_1211_sd<-var[11]^0.5
new_treatment_1212_sd<-var[12]^0.5
new_treatment_1213_sd<-var[13]^0.5
new_treatment_1214_sd<-var[14]^0.5
new_treatment_1215_sd<-var[15]^0.5
new_treatment_1216_sd<-var[16]^0.5
new_treatment_1217_sd<-var[17]^0.5
new_treatment_1218_sd<-var[18]^0.5
new_treatment_1219_sd<-var[19]^0.5
new_treatment_1220_sd<-var[20]^0.5
new_treatment_1221_sd<-var[21]^0.5
new_treatment_1222_sd<-var[22]^0.5
new_treatment_1223_sd<-var[23]^0.5
new_treatment_1224_sd<-var[24]^0.5
new_treatment_1225_sd<-var[25]^0.5
new_treatment_1226_sd<-var[26]^0.5
new_treatment_1227_sd<-var[27]^0.5
new_treatment_1228_sd<-var[28]^0.5
new_treatment_1229_sd<-var[29]^0.5
new_treatment_1230_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper12<-c()
lower12<-c()
for(i in 1:30){
upper12[i]<-new_treatment_12[i]-Quantile_upper[i]*(var[i]^0.5)
lower12[i]<-new_treatment_12[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper12
lower12












#step 13: s=13#

T0<-min(TT0)

s=13

DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],Tr1[1,][T0+9],Tr1[1,][T0+10],Tr1[1,][T0+11],Tr1[1,][T0+12],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],Tr1[2,][T0+9],Tr1[2,][T0+10],Tr1[2,][T0+11],Tr1[2,][T0+12],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],Tr1[3,][T0+9],Tr1[3,][T0+10],Tr1[3,][T0+11],Tr1[3,][T0+12],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],Tr1[4,][T0+9],Tr1[4,][T0+10],Tr1[4,][T0+11],Tr1[4,][T0+12],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],Tr1[5,][T0+9],Tr1[5,][T0+10],Tr1[5,][T0+11],Tr1[5,][T0+12],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],Tr1[6,][T0+9],Tr1[6,][T0+10],Tr1[6,][T0+11],Tr1[6,][T0+12],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],Tr1[7,][T0+9],Tr1[7,][T0+10],Tr1[7,][T0+11],Tr1[7,][T0+12],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],Tr1[8,][T0+9],Tr1[8,][T0+10],Tr1[8,][T0+11],Tr1[8,][T0+12],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],Tr1[9,][T0+9],Tr1[9,][T0+10],Tr1[9,][T0+11],Tr1[9,][T0+12],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],Tr1[10,][T0+9],Tr1[10,][T0+10],Tr1[10,][T0+11],Tr1[10,][T0+12],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],Tr1[11,][T0+9],Tr1[11,][T0+10],Tr1[11,][T0+11],Tr1[11,][T0+12],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],Tr1[12,][T0+9],Tr1[12,][T0+10],Tr1[12,][T0+11],Tr1[12,][T0+12],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],Tr1[13,][T0+9],Tr1[13,][T0+10],Tr1[13,][T0+11],Tr1[13,][T0+12],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],Tr1[14,][T0+9],Tr1[14,][T0+10],Tr1[14,][T0+11],Tr1[14,][T0+12],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],Tr1[15,][T0+9],Tr1[15,][T0+10],Tr1[15,][T0+11],Tr1[15,][T0+12],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],Tr1[16,][T0+9],Tr1[16,][T0+10],Tr1[16,][T0+11],Tr1[16,][T0+12],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],Tr1[17,][T0+9],Tr1[17,][T0+10],Tr1[17,][T0+11],Tr1[17,][T0+12],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],Tr1[18,][T0+9],Tr1[18,][T0+10],Tr1[18,][T0+11],Tr1[18,][T0+12],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],Tr1[19,][T0+9],Tr1[19,][T0+10],Tr1[19,][T0+11],Tr1[19,][T0+12],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],Tr1[20,][T0+9],Tr1[20,][T0+10],Tr1[20,][T0+11],Tr1[20,][T0+12],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],Tr1[21,][T0+9],Tr1[21,][T0+10],Tr1[21,][T0+11],Tr1[21,][T0+12],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],Tr1[22,][T0+9],Tr1[22,][T0+10],Tr1[22,][T0+11],Tr1[22,][T0+12],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],Tr1[23,][T0+9],Tr1[23,][T0+10],Tr1[23,][T0+11],Tr1[23,][T0+12],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],Tr1[24,][T0+9],Tr1[24,][T0+10],Tr1[24,][T0+11],Tr1[24,][T0+12],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],Tr1[25,][T0+9],Tr1[25,][T0+10],Tr1[24,][T0+11],Tr1[24,][T0+12],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],Tr1[26,][T0+9],Tr1[26,][T0+10],Tr1[26,][T0+11],Tr1[26,][T0+12],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],Tr1[27,][T0+9],Tr1[27,][T0+10],Tr1[27,][T0+11],Tr1[27,][T0+12],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],Tr1[28,][T0+9],Tr1[28,][T0+10],Tr1[28,][T0+11],Tr1[28,][T0+12],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],Tr1[29,][T0+9],Tr1[29,][T0+10],Tr1[29,][T0+11],Tr1[29,][T0+12],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],Tr1[30,][T0+9],Tr1[30,][T0+10],Tr1[30,][T0+11],Tr1[30,][T0+12],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment_111,new_treatment_121,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment_112,new_treatment_122,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment_113,new_treatment_123,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment_114,new_treatment_124,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment_115,new_treatment_125,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,new_treatment96,new_treatment106,new_treatment_116,new_treatment_126,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,new_treatment97,new_treatment107,new_treatment_117,new_treatment_127,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,new_treatment98,new_treatment108,new_treatment_118,new_treatment_128,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,new_treatment99,new_treatment109,new_treatment_119,new_treatment_129,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,new_treatment910,new_treatment1010,new_treatment_1110,new_treatment_1210,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,new_treatment911,new_treatment1011,new_treatment_1111,new_treatment_1211,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,new_treatment912,new_treatment1012,new_treatment_1112,new_treatment_1212,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,new_treatment913,new_treatment1013,new_treatment_1113,new_treatment_1213,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,new_treatment914,new_treatment1014,new_treatment_1114,new_treatment_1214,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,new_treatment915,new_treatment1015,new_treatment_1115,new_treatment_1215,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,new_treatment916,new_treatment1016,new_treatment_1116,new_treatment_1216,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,new_treatment917,new_treatment1017,new_treatment_1117,new_treatment_1217,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,new_treatment918,new_treatment1018,new_treatment_1118,new_treatment_1218,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,new_treatment919,new_treatment1019,new_treatment_1119,new_treatment_1219,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,new_treatment920,new_treatment1020,new_treatment_1120,new_treatment_1220,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,new_treatment921,new_treatment1021,new_treatment_1121,new_treatment_1221,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,new_treatment922,new_treatment1022,new_treatment_1122,new_treatment_1222,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,new_treatment923,new_treatment1023,new_treatment_1123,new_treatment_1223,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,new_treatment924,new_treatment1024,new_treatment_1124,new_treatment_1224,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,new_treatment925,new_treatment1025,new_treatment_1125,new_treatment_1225,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,new_treatment926,new_treatment1026,new_treatment_1126,new_treatment_1226,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,new_treatment927,new_treatment1027,new_treatment_1127,new_treatment_1227,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,new_treatment928,new_treatment1028,new_treatment_1128,new_treatment_1228,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,new_treatment929,new_treatment1029,new_treatment_1129,new_treatment_1229,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,new_treatment930,new_treatment1030,new_treatment_1130,new_treatment_1230,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment_131<-new_treatment[1]
new_treatment_132<-new_treatment[2]
new_treatment_133<-new_treatment[3]
new_treatment_134<-new_treatment[4]
new_treatment_135<-new_treatment[5]
new_treatment_136<-new_treatment[6]
new_treatment_137<-new_treatment[7]
new_treatment_138<-new_treatment[8]
new_treatment_139<-new_treatment[9]
new_treatment_1310<-new_treatment[10]
new_treatment_1311<-new_treatment[11]
new_treatment_1312<-new_treatment[12]
new_treatment_1313<-new_treatment[13]
new_treatment_1314<-new_treatment[14]
new_treatment_1315<-new_treatment[15]
new_treatment_1316<-new_treatment[16]
new_treatment_1317<-new_treatment[17]
new_treatment_1318<-new_treatment[18]
new_treatment_1319<-new_treatment[19]
new_treatment_1320<-new_treatment[20]
new_treatment_1321<-new_treatment[21]
new_treatment_1322<-new_treatment[22]
new_treatment_1323<-new_treatment[23]
new_treatment_1324<-new_treatment[24]
new_treatment_1325<-new_treatment[25]
new_treatment_1326<-new_treatment[26]
new_treatment_1327<-new_treatment[27]
new_treatment_1328<-new_treatment[28]
new_treatment_1329<-new_treatment[29]
new_treatment_1330<-new_treatment[30]

new_treatment_13<-new_treatment





##====================================

#bootstrap 13#
#sd 13#

#step 13: s=13#
s=13

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=13

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],Tr1[1,][T0+9],Tr1[1,][T0+10],Tr1[1,][T0+11],Tr1[1,][T0+12],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],Tr1[2,][T0+9],Tr1[2,][T0+10],Tr1[2,][T0+11],Tr1[2,][T0+12],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],Tr1[3,][T0+9],Tr1[3,][T0+10],Tr1[3,][T0+11],Tr1[3,][T0+12],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],Tr1[4,][T0+9],Tr1[4,][T0+10],Tr1[4,][T0+11],Tr1[4,][T0+12],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],Tr1[5,][T0+9],Tr1[5,][T0+10],Tr1[5,][T0+11],Tr1[5,][T0+12],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],Tr1[6,][T0+9],Tr1[6,][T0+10],Tr1[6,][T0+11],Tr1[6,][T0+12],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],Tr1[7,][T0+9],Tr1[7,][T0+10],Tr1[7,][T0+11],Tr1[7,][T0+12],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],Tr1[8,][T0+9],Tr1[8,][T0+10],Tr1[8,][T0+11],Tr1[8,][T0+12],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],Tr1[9,][T0+9],Tr1[9,][T0+10],Tr1[9,][T0+11],Tr1[9,][T0+12],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],Tr1[10,][T0+9],Tr1[10,][T0+10],Tr1[10,][T0+11],Tr1[10,][T0+12],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],Tr1[11,][T0+9],Tr1[11,][T0+10],Tr1[11,][T0+11],Tr1[11,][T0+12],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],Tr1[12,][T0+9],Tr1[12,][T0+10],Tr1[12,][T0+11],Tr1[12,][T0+12],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],Tr1[13,][T0+9],Tr1[13,][T0+10],Tr1[13,][T0+11],Tr1[13,][T0+12],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],Tr1[14,][T0+9],Tr1[14,][T0+10],Tr1[14,][T0+11],Tr1[14,][T0+12],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],Tr1[15,][T0+9],Tr1[15,][T0+10],Tr1[15,][T0+11],Tr1[15,][T0+12],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],Tr1[16,][T0+9],Tr1[16,][T0+10],Tr1[16,][T0+11],Tr1[16,][T0+12],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],Tr1[17,][T0+9],Tr1[17,][T0+10],Tr1[17,][T0+11],Tr1[17,][T0+12],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],Tr1[18,][T0+9],Tr1[18,][T0+10],Tr1[18,][T0+11],Tr1[18,][T0+12],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],Tr1[19,][T0+9],Tr1[19,][T0+10],Tr1[19,][T0+11],Tr1[19,][T0+12],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],Tr1[20,][T0+9],Tr1[20,][T0+10],Tr1[20,][T0+11],Tr1[20,][T0+12],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],Tr1[21,][T0+9],Tr1[21,][T0+10],Tr1[21,][T0+11],Tr1[21,][T0+12],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],Tr1[22,][T0+9],Tr1[22,][T0+10],Tr1[22,][T0+11],Tr1[22,][T0+12],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],Tr1[23,][T0+9],Tr1[23,][T0+10],Tr1[23,][T0+11],Tr1[23,][T0+12],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],Tr1[24,][T0+9],Tr1[24,][T0+10],Tr1[24,][T0+11],Tr1[24,][T0+12],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],Tr1[25,][T0+9],Tr1[25,][T0+10],Tr1[24,][T0+11],Tr1[24,][T0+12],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],Tr1[26,][T0+9],Tr1[26,][T0+10],Tr1[26,][T0+11],Tr1[26,][T0+12],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],Tr1[27,][T0+9],Tr1[27,][T0+10],Tr1[27,][T0+11],Tr1[27,][T0+12],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],Tr1[28,][T0+9],Tr1[28,][T0+10],Tr1[28,][T0+11],Tr1[28,][T0+12],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],Tr1[29,][T0+9],Tr1[29,][T0+10],Tr1[29,][T0+11],Tr1[29,][T0+12],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],Tr1[30,][T0+9],Tr1[30,][T0+10],Tr1[30,][T0+11],Tr1[30,][T0+12],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment_111,new_treatment_121,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment_112,new_treatment_122,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment_113,new_treatment_123,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment_114,new_treatment_124,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment_115,new_treatment_125,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,new_treatment96,new_treatment106,new_treatment_116,new_treatment_126,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,new_treatment97,new_treatment107,new_treatment_117,new_treatment_127,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,new_treatment98,new_treatment108,new_treatment_118,new_treatment_128,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,new_treatment99,new_treatment109,new_treatment_119,new_treatment_129,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,new_treatment910,new_treatment1010,new_treatment_1110,new_treatment_1210,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,new_treatment911,new_treatment1011,new_treatment_1111,new_treatment_1211,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,new_treatment912,new_treatment1012,new_treatment_1112,new_treatment_1212,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,new_treatment913,new_treatment1013,new_treatment_1113,new_treatment_1213,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,new_treatment914,new_treatment1014,new_treatment_1114,new_treatment_1214,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,new_treatment915,new_treatment1015,new_treatment_1115,new_treatment_1215,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,new_treatment916,new_treatment1016,new_treatment_1116,new_treatment_1216,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,new_treatment917,new_treatment1017,new_treatment_1117,new_treatment_1217,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,new_treatment918,new_treatment1018,new_treatment_1118,new_treatment_1218,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,new_treatment919,new_treatment1019,new_treatment_1119,new_treatment_1219,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,new_treatment920,new_treatment1020,new_treatment_1120,new_treatment_1220,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,new_treatment921,new_treatment1021,new_treatment_1121,new_treatment_1221,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,new_treatment922,new_treatment1022,new_treatment_1122,new_treatment_1222,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,new_treatment923,new_treatment1023,new_treatment_1123,new_treatment_1223,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,new_treatment924,new_treatment1024,new_treatment_1124,new_treatment_1224,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,new_treatment925,new_treatment1025,new_treatment_1125,new_treatment_1225,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,new_treatment926,new_treatment1026,new_treatment_1126,new_treatment_1226,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,new_treatment927,new_treatment1027,new_treatment_1127,new_treatment_1227,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,new_treatment928,new_treatment1028,new_treatment_1128,new_treatment_1228,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,new_treatment929,new_treatment1029,new_treatment_1129,new_treatment_1229,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,new_treatment930,new_treatment1030,new_treatment_1130,new_treatment_1230,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment_131_sd<-var[1]^0.5
new_treatment_132_sd<-var[2]^0.5
new_treatment_133_sd<-var[3]^0.5
new_treatment_134_sd<-var[4]^0.5
new_treatment_135_sd<-var[5]^0.5
new_treatment_136_sd<-var[6]^0.5
new_treatment_137_sd<-var[7]^0.5
new_treatment_138_sd<-var[8]^0.5
new_treatment_139_sd<-var[9]^0.5
new_treatment_1310_sd<-var[10]^0.5
new_treatment_1311_sd<-var[11]^0.5
new_treatment_1312_sd<-var[12]^0.5
new_treatment_1313_sd<-var[13]^0.5
new_treatment_1314_sd<-var[14]^0.5
new_treatment_1315_sd<-var[15]^0.5
new_treatment_1316_sd<-var[16]^0.5
new_treatment_1317_sd<-var[17]^0.5
new_treatment_1318_sd<-var[18]^0.5
new_treatment_1319_sd<-var[19]^0.5
new_treatment_1320_sd<-var[20]^0.5
new_treatment_1321_sd<-var[21]^0.5
new_treatment_1322_sd<-var[22]^0.5
new_treatment_1323_sd<-var[23]^0.5
new_treatment_1324_sd<-var[24]^0.5
new_treatment_1325_sd<-var[25]^0.5
new_treatment_1326_sd<-var[26]^0.5
new_treatment_1327_sd<-var[27]^0.5
new_treatment_1328_sd<-var[28]^0.5
new_treatment_1329_sd<-var[29]^0.5
new_treatment_1330_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper13<-c()
lower13<-c()
for(i in 1:30){
upper13[i]<-new_treatment_13[i]-Quantile_upper[i]*(var[i]^0.5)
lower13[i]<-new_treatment_13[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper13
lower13









#step 14: s=14#

T0<-min(TT0)

s=14

DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],Tr1[1,][T0+9],Tr1[1,][T0+10],Tr1[1,][T0+11],Tr1[1,][T0+12],Tr1[1,][T0+13],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],Tr1[2,][T0+9],Tr1[2,][T0+10],Tr1[2,][T0+11],Tr1[2,][T0+12],Tr1[2,][T0+13],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],Tr1[3,][T0+9],Tr1[3,][T0+10],Tr1[3,][T0+11],Tr1[3,][T0+12],Tr1[3,][T0+13],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],Tr1[4,][T0+9],Tr1[4,][T0+10],Tr1[4,][T0+11],Tr1[4,][T0+12],Tr1[4,][T0+13],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],Tr1[5,][T0+9],Tr1[5,][T0+10],Tr1[5,][T0+11],Tr1[5,][T0+12],Tr1[5,][T0+13],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],Tr1[6,][T0+9],Tr1[6,][T0+10],Tr1[6,][T0+11],Tr1[6,][T0+12],Tr1[6,][T0+13],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],Tr1[7,][T0+9],Tr1[7,][T0+10],Tr1[7,][T0+11],Tr1[7,][T0+12],Tr1[7,][T0+13],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],Tr1[8,][T0+9],Tr1[8,][T0+10],Tr1[8,][T0+11],Tr1[8,][T0+12],Tr1[8,][T0+13],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],Tr1[9,][T0+9],Tr1[9,][T0+10],Tr1[9,][T0+11],Tr1[9,][T0+12],Tr1[9,][T0+13],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],Tr1[10,][T0+9],Tr1[10,][T0+10],Tr1[10,][T0+11],Tr1[10,][T0+12],Tr1[10,][T0+13],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],Tr1[11,][T0+9],Tr1[11,][T0+10],Tr1[11,][T0+11],Tr1[11,][T0+12],Tr1[11,][T0+13],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],Tr1[12,][T0+9],Tr1[12,][T0+10],Tr1[12,][T0+11],Tr1[12,][T0+12],Tr1[12,][T0+13],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],Tr1[13,][T0+9],Tr1[13,][T0+10],Tr1[13,][T0+11],Tr1[13,][T0+12],Tr1[13,][T0+13],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],Tr1[14,][T0+9],Tr1[14,][T0+10],Tr1[14,][T0+11],Tr1[14,][T0+12],Tr1[14,][T0+13],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],Tr1[15,][T0+9],Tr1[15,][T0+10],Tr1[15,][T0+11],Tr1[15,][T0+12],Tr1[15,][T0+13],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],Tr1[16,][T0+9],Tr1[16,][T0+10],Tr1[16,][T0+11],Tr1[16,][T0+12],Tr1[16,][T0+13],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],Tr1[17,][T0+9],Tr1[17,][T0+10],Tr1[17,][T0+11],Tr1[17,][T0+12],Tr1[17,][T0+13],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],Tr1[18,][T0+9],Tr1[18,][T0+10],Tr1[18,][T0+11],Tr1[18,][T0+12],Tr1[18,][T0+13],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],Tr1[19,][T0+9],Tr1[19,][T0+10],Tr1[19,][T0+11],Tr1[19,][T0+12],Tr1[19,][T0+13],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],Tr1[20,][T0+9],Tr1[20,][T0+10],Tr1[20,][T0+11],Tr1[20,][T0+12],Tr1[20,][T0+13],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],Tr1[21,][T0+9],Tr1[21,][T0+10],Tr1[21,][T0+11],Tr1[21,][T0+12],Tr1[21,][T0+13],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],Tr1[22,][T0+9],Tr1[22,][T0+10],Tr1[22,][T0+11],Tr1[22,][T0+12],Tr1[22,][T0+13],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],Tr1[23,][T0+9],Tr1[23,][T0+10],Tr1[23,][T0+11],Tr1[23,][T0+12],Tr1[23,][T0+13],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],Tr1[24,][T0+9],Tr1[24,][T0+10],Tr1[24,][T0+11],Tr1[24,][T0+12],Tr1[23,][T0+13],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],Tr1[25,][T0+9],Tr1[25,][T0+10],Tr1[24,][T0+11],Tr1[24,][T0+12],Tr1[24,][T0+13],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],Tr1[26,][T0+9],Tr1[26,][T0+10],Tr1[26,][T0+11],Tr1[26,][T0+12],Tr1[26,][T0+13],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],Tr1[27,][T0+9],Tr1[27,][T0+10],Tr1[27,][T0+11],Tr1[27,][T0+12],Tr1[26,][T0+13],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],Tr1[28,][T0+9],Tr1[28,][T0+10],Tr1[28,][T0+11],Tr1[28,][T0+12],Tr1[28,][T0+13],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],Tr1[29,][T0+9],Tr1[29,][T0+10],Tr1[29,][T0+11],Tr1[29,][T0+12],Tr1[29,][T0+13],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],Tr1[30,][T0+9],Tr1[30,][T0+10],Tr1[30,][T0+11],Tr1[30,][T0+12],Tr1[30,][T0+13],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment_111,new_treatment_121,new_treatment_131,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment_112,new_treatment_122,new_treatment_132,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment_113,new_treatment_123,new_treatment_133,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment_114,new_treatment_124,new_treatment_134,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment_115,new_treatment_125,new_treatment_135,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,new_treatment96,new_treatment106,new_treatment_116,new_treatment_126,new_treatment_136,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,new_treatment97,new_treatment107,new_treatment_117,new_treatment_127,new_treatment_137,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,new_treatment98,new_treatment108,new_treatment_118,new_treatment_128,new_treatment_138,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,new_treatment99,new_treatment109,new_treatment_119,new_treatment_129,new_treatment_139,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,new_treatment910,new_treatment1010,new_treatment_1110,new_treatment_1210,new_treatment_1310,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,new_treatment911,new_treatment1011,new_treatment_1111,new_treatment_1211,new_treatment_1311,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,new_treatment912,new_treatment1012,new_treatment_1112,new_treatment_1212,new_treatment_1312,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,new_treatment913,new_treatment1013,new_treatment_1113,new_treatment_1213,new_treatment_1313,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,new_treatment914,new_treatment1014,new_treatment_1114,new_treatment_1214,new_treatment_1314,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,new_treatment915,new_treatment1015,new_treatment_1115,new_treatment_1215,new_treatment_1315,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,new_treatment916,new_treatment1016,new_treatment_1116,new_treatment_1216,new_treatment_1316,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,new_treatment917,new_treatment1017,new_treatment_1117,new_treatment_1217,new_treatment_1317,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,new_treatment918,new_treatment1018,new_treatment_1118,new_treatment_1218,new_treatment_1318,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,new_treatment919,new_treatment1019,new_treatment_1119,new_treatment_1219,new_treatment_1319,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,new_treatment920,new_treatment1020,new_treatment_1120,new_treatment_1220,new_treatment_1320,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,new_treatment921,new_treatment1021,new_treatment_1121,new_treatment_1221,new_treatment_1321,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,new_treatment922,new_treatment1022,new_treatment_1122,new_treatment_1222,new_treatment_1322,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,new_treatment923,new_treatment1023,new_treatment_1123,new_treatment_1223,new_treatment_1323,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,new_treatment924,new_treatment1024,new_treatment_1124,new_treatment_1224,new_treatment_1324,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,new_treatment925,new_treatment1025,new_treatment_1125,new_treatment_1225,new_treatment_1325,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,new_treatment926,new_treatment1026,new_treatment_1126,new_treatment_1226,new_treatment_1326,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,new_treatment927,new_treatment1027,new_treatment_1127,new_treatment_1227,new_treatment_1327,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,new_treatment928,new_treatment1028,new_treatment_1128,new_treatment_1228,new_treatment_1328,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,new_treatment929,new_treatment1029,new_treatment_1129,new_treatment_1229,new_treatment_1329,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,new_treatment930,new_treatment1030,new_treatment_1130,new_treatment_1230,new_treatment_1330,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment_141<-new_treatment[1]
new_treatment_142<-new_treatment[2]
new_treatment_143<-new_treatment[3]
new_treatment_144<-new_treatment[4]
new_treatment_145<-new_treatment[5]
new_treatment_146<-new_treatment[6]
new_treatment_147<-new_treatment[7]
new_treatment_148<-new_treatment[8]
new_treatment_149<-new_treatment[9]
new_treatment_1410<-new_treatment[10]
new_treatment_1411<-new_treatment[11]
new_treatment_1412<-new_treatment[12]
new_treatment_1413<-new_treatment[13]
new_treatment_1414<-new_treatment[14]
new_treatment_1415<-new_treatment[15]
new_treatment_1416<-new_treatment[16]
new_treatment_1417<-new_treatment[17]
new_treatment_1418<-new_treatment[18]
new_treatment_1419<-new_treatment[19]
new_treatment_1420<-new_treatment[20]
new_treatment_1421<-new_treatment[21]
new_treatment_1422<-new_treatment[22]
new_treatment_1423<-new_treatment[23]
new_treatment_1424<-new_treatment[24]
new_treatment_1425<-new_treatment[25]
new_treatment_1426<-new_treatment[26]
new_treatment_1427<-new_treatment[27]
new_treatment_1428<-new_treatment[28]
new_treatment_1429<-new_treatment[29]
new_treatment_1430<-new_treatment[30]

new_treatment_14<-new_treatment





##====================================

#bootstrap 14#
#sd 14#

#step 14: s=14#
s=14

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=14

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],Tr1[1,][T0+9],Tr1[1,][T0+10],Tr1[1,][T0+11],Tr1[1,][T0+12],Tr1[1,][T0+13],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],Tr1[2,][T0+9],Tr1[2,][T0+10],Tr1[2,][T0+11],Tr1[2,][T0+12],Tr1[2,][T0+13],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],Tr1[3,][T0+9],Tr1[3,][T0+10],Tr1[3,][T0+11],Tr1[3,][T0+12],Tr1[3,][T0+13],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],Tr1[4,][T0+9],Tr1[4,][T0+10],Tr1[4,][T0+11],Tr1[4,][T0+12],Tr1[4,][T0+13],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],Tr1[5,][T0+9],Tr1[5,][T0+10],Tr1[5,][T0+11],Tr1[5,][T0+12],Tr1[5,][T0+13],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],Tr1[6,][T0+9],Tr1[6,][T0+10],Tr1[6,][T0+11],Tr1[6,][T0+12],Tr1[6,][T0+13],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],Tr1[7,][T0+9],Tr1[7,][T0+10],Tr1[7,][T0+11],Tr1[7,][T0+12],Tr1[7,][T0+13],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],Tr1[8,][T0+9],Tr1[8,][T0+10],Tr1[8,][T0+11],Tr1[8,][T0+12],Tr1[8,][T0+13],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],Tr1[9,][T0+9],Tr1[9,][T0+10],Tr1[9,][T0+11],Tr1[9,][T0+12],Tr1[9,][T0+13],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],Tr1[10,][T0+9],Tr1[10,][T0+10],Tr1[10,][T0+11],Tr1[10,][T0+12],Tr1[10,][T0+13],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],Tr1[11,][T0+9],Tr1[11,][T0+10],Tr1[11,][T0+11],Tr1[11,][T0+12],Tr1[11,][T0+13],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],Tr1[12,][T0+9],Tr1[12,][T0+10],Tr1[12,][T0+11],Tr1[12,][T0+12],Tr1[12,][T0+13],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],Tr1[13,][T0+9],Tr1[13,][T0+10],Tr1[13,][T0+11],Tr1[13,][T0+12],Tr1[13,][T0+13],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],Tr1[14,][T0+9],Tr1[14,][T0+10],Tr1[14,][T0+11],Tr1[14,][T0+12],Tr1[14,][T0+13],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],Tr1[15,][T0+9],Tr1[15,][T0+10],Tr1[15,][T0+11],Tr1[15,][T0+12],Tr1[15,][T0+13],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],Tr1[16,][T0+9],Tr1[16,][T0+10],Tr1[16,][T0+11],Tr1[16,][T0+12],Tr1[16,][T0+13],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],Tr1[17,][T0+9],Tr1[17,][T0+10],Tr1[17,][T0+11],Tr1[17,][T0+12],Tr1[17,][T0+13],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],Tr1[18,][T0+9],Tr1[18,][T0+10],Tr1[18,][T0+11],Tr1[18,][T0+12],Tr1[18,][T0+13],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],Tr1[19,][T0+9],Tr1[19,][T0+10],Tr1[19,][T0+11],Tr1[19,][T0+12],Tr1[19,][T0+13],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],Tr1[20,][T0+9],Tr1[20,][T0+10],Tr1[20,][T0+11],Tr1[20,][T0+12],Tr1[20,][T0+13],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],Tr1[21,][T0+9],Tr1[21,][T0+10],Tr1[21,][T0+11],Tr1[21,][T0+12],Tr1[21,][T0+13],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],Tr1[22,][T0+9],Tr1[22,][T0+10],Tr1[22,][T0+11],Tr1[22,][T0+12],Tr1[22,][T0+13],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],Tr1[23,][T0+9],Tr1[23,][T0+10],Tr1[23,][T0+11],Tr1[23,][T0+12],Tr1[23,][T0+13],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],Tr1[24,][T0+9],Tr1[24,][T0+10],Tr1[24,][T0+11],Tr1[24,][T0+12],Tr1[23,][T0+13],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],Tr1[25,][T0+9],Tr1[25,][T0+10],Tr1[24,][T0+11],Tr1[24,][T0+12],Tr1[24,][T0+13],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],Tr1[26,][T0+9],Tr1[26,][T0+10],Tr1[26,][T0+11],Tr1[26,][T0+12],Tr1[26,][T0+13],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],Tr1[27,][T0+9],Tr1[27,][T0+10],Tr1[27,][T0+11],Tr1[27,][T0+12],Tr1[26,][T0+13],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],Tr1[28,][T0+9],Tr1[28,][T0+10],Tr1[28,][T0+11],Tr1[28,][T0+12],Tr1[28,][T0+13],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],Tr1[29,][T0+9],Tr1[29,][T0+10],Tr1[29,][T0+11],Tr1[29,][T0+12],Tr1[29,][T0+13],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],Tr1[30,][T0+9],Tr1[30,][T0+10],Tr1[30,][T0+11],Tr1[30,][T0+12],Tr1[30,][T0+13],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment_111,new_treatment_121,new_treatment_131,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment_112,new_treatment_122,new_treatment_132,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment_113,new_treatment_123,new_treatment_133,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment_114,new_treatment_124,new_treatment_134,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment_115,new_treatment_125,new_treatment_135,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,new_treatment96,new_treatment106,new_treatment_116,new_treatment_126,new_treatment_136,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,new_treatment97,new_treatment107,new_treatment_117,new_treatment_127,new_treatment_137,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,new_treatment98,new_treatment108,new_treatment_118,new_treatment_128,new_treatment_138,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,new_treatment99,new_treatment109,new_treatment_119,new_treatment_129,new_treatment_139,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,new_treatment910,new_treatment1010,new_treatment_1110,new_treatment_1210,new_treatment_1310,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,new_treatment911,new_treatment1011,new_treatment_1111,new_treatment_1211,new_treatment_1311,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,new_treatment912,new_treatment1012,new_treatment_1112,new_treatment_1212,new_treatment_1312,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,new_treatment913,new_treatment1013,new_treatment_1113,new_treatment_1213,new_treatment_1313,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,new_treatment914,new_treatment1014,new_treatment_1114,new_treatment_1214,new_treatment_1314,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,new_treatment915,new_treatment1015,new_treatment_1115,new_treatment_1215,new_treatment_1315,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,new_treatment916,new_treatment1016,new_treatment_1116,new_treatment_1216,new_treatment_1316,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,new_treatment917,new_treatment1017,new_treatment_1117,new_treatment_1217,new_treatment_1317,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,new_treatment918,new_treatment1018,new_treatment_1118,new_treatment_1218,new_treatment_1318,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,new_treatment919,new_treatment1019,new_treatment_1119,new_treatment_1219,new_treatment_1319,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,new_treatment920,new_treatment1020,new_treatment_1120,new_treatment_1220,new_treatment_1320,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,new_treatment921,new_treatment1021,new_treatment_1121,new_treatment_1221,new_treatment_1321,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,new_treatment922,new_treatment1022,new_treatment_1122,new_treatment_1222,new_treatment_1322,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,new_treatment923,new_treatment1023,new_treatment_1123,new_treatment_1223,new_treatment_1323,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,new_treatment924,new_treatment1024,new_treatment_1124,new_treatment_1224,new_treatment_1324,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,new_treatment925,new_treatment1025,new_treatment_1125,new_treatment_1225,new_treatment_1325,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,new_treatment926,new_treatment1026,new_treatment_1126,new_treatment_1226,new_treatment_1326,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,new_treatment927,new_treatment1027,new_treatment_1127,new_treatment_1227,new_treatment_1327,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,new_treatment928,new_treatment1028,new_treatment_1128,new_treatment_1228,new_treatment_1328,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,new_treatment929,new_treatment1029,new_treatment_1129,new_treatment_1229,new_treatment_1329,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,new_treatment930,new_treatment1030,new_treatment_1130,new_treatment_1230,new_treatment_1330,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment_141_sd<-var[1]^0.5
new_treatment_142_sd<-var[2]^0.5
new_treatment_143_sd<-var[3]^0.5
new_treatment_144_sd<-var[4]^0.5
new_treatment_145_sd<-var[5]^0.5
new_treatment_146_sd<-var[6]^0.5
new_treatment_147_sd<-var[7]^0.5
new_treatment_148_sd<-var[8]^0.5
new_treatment_149_sd<-var[9]^0.5
new_treatment_1410_sd<-var[10]^0.5
new_treatment_1411_sd<-var[11]^0.5
new_treatment_1412_sd<-var[12]^0.5
new_treatment_1413_sd<-var[13]^0.5
new_treatment_1414_sd<-var[14]^0.5
new_treatment_1415_sd<-var[15]^0.5
new_treatment_1416_sd<-var[16]^0.5
new_treatment_1417_sd<-var[17]^0.5
new_treatment_1418_sd<-var[18]^0.5
new_treatment_1419_sd<-var[19]^0.5
new_treatment_1420_sd<-var[20]^0.5
new_treatment_1421_sd<-var[21]^0.5
new_treatment_1422_sd<-var[22]^0.5
new_treatment_1423_sd<-var[23]^0.5
new_treatment_1424_sd<-var[24]^0.5
new_treatment_1425_sd<-var[25]^0.5
new_treatment_1426_sd<-var[26]^0.5
new_treatment_1427_sd<-var[27]^0.5
new_treatment_1428_sd<-var[28]^0.5
new_treatment_1429_sd<-var[29]^0.5
new_treatment_1430_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper14<-c()
lower14<-c()
for(i in 1:30){
upper14[i]<-new_treatment_14[i]-Quantile_upper[i]*(var[i]^0.5)
lower14[i]<-new_treatment_14[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper14
lower14







#step 15: s=15#

T0<-min(TT0)

s=15

DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],Tr1[1,][T0+9],Tr1[1,][T0+10],Tr1[1,][T0+11],Tr1[1,][T0+12],Tr1[1,][T0+13],Tr1[1,][T0+14],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],Tr1[2,][T0+9],Tr1[2,][T0+10],Tr1[2,][T0+11],Tr1[2,][T0+12],Tr1[2,][T0+13],Tr1[2,][T0+14],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],Tr1[3,][T0+9],Tr1[3,][T0+10],Tr1[3,][T0+11],Tr1[3,][T0+12],Tr1[3,][T0+13],Tr1[3,][T0+14],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],Tr1[4,][T0+9],Tr1[4,][T0+10],Tr1[4,][T0+11],Tr1[4,][T0+12],Tr1[4,][T0+13],Tr1[4,][T0+14],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],Tr1[5,][T0+9],Tr1[5,][T0+10],Tr1[5,][T0+11],Tr1[5,][T0+12],Tr1[5,][T0+13],Tr1[5,][T0+14],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],Tr1[6,][T0+9],Tr1[6,][T0+10],Tr1[6,][T0+11],Tr1[6,][T0+12],Tr1[6,][T0+13],Tr1[5,][T0+14],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],Tr1[7,][T0+9],Tr1[7,][T0+10],Tr1[7,][T0+11],Tr1[7,][T0+12],Tr1[7,][T0+13],Tr1[7,][T0+14],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],Tr1[8,][T0+9],Tr1[8,][T0+10],Tr1[8,][T0+11],Tr1[8,][T0+12],Tr1[8,][T0+13],Tr1[8,][T0+14],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],Tr1[9,][T0+9],Tr1[9,][T0+10],Tr1[9,][T0+11],Tr1[9,][T0+12],Tr1[9,][T0+13],Tr1[9,][T0+14],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],Tr1[10,][T0+9],Tr1[10,][T0+10],Tr1[10,][T0+11],Tr1[10,][T0+12],Tr1[10,][T0+13],Tr1[10,][T0+14],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],Tr1[11,][T0+9],Tr1[11,][T0+10],Tr1[11,][T0+11],Tr1[11,][T0+12],Tr1[11,][T0+13],Tr1[11,][T0+14],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],Tr1[12,][T0+9],Tr1[12,][T0+10],Tr1[12,][T0+11],Tr1[12,][T0+12],Tr1[12,][T0+13],Tr1[12,][T0+14],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],Tr1[13,][T0+9],Tr1[13,][T0+10],Tr1[13,][T0+11],Tr1[13,][T0+12],Tr1[13,][T0+13],Tr1[13,][T0+14],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],Tr1[14,][T0+9],Tr1[14,][T0+10],Tr1[14,][T0+11],Tr1[14,][T0+12],Tr1[14,][T0+13],Tr1[14,][T0+14],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],Tr1[15,][T0+9],Tr1[15,][T0+10],Tr1[15,][T0+11],Tr1[15,][T0+12],Tr1[15,][T0+13],Tr1[15,][T0+14],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],Tr1[16,][T0+9],Tr1[16,][T0+10],Tr1[16,][T0+11],Tr1[16,][T0+12],Tr1[16,][T0+13],Tr1[16,][T0+14],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],Tr1[17,][T0+9],Tr1[17,][T0+10],Tr1[17,][T0+11],Tr1[17,][T0+12],Tr1[17,][T0+13],Tr1[17,][T0+14],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],Tr1[18,][T0+9],Tr1[18,][T0+10],Tr1[18,][T0+11],Tr1[18,][T0+12],Tr1[18,][T0+13],Tr1[18,][T0+14],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],Tr1[19,][T0+9],Tr1[19,][T0+10],Tr1[19,][T0+11],Tr1[19,][T0+12],Tr1[19,][T0+13],Tr1[19,][T0+14],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],Tr1[20,][T0+9],Tr1[20,][T0+10],Tr1[20,][T0+11],Tr1[20,][T0+12],Tr1[20,][T0+13],Tr1[20,][T0+14],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],Tr1[21,][T0+9],Tr1[21,][T0+10],Tr1[21,][T0+11],Tr1[21,][T0+12],Tr1[21,][T0+13],Tr1[21,][T0+14],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],Tr1[22,][T0+9],Tr1[22,][T0+10],Tr1[22,][T0+11],Tr1[22,][T0+12],Tr1[22,][T0+13],Tr1[22,][T0+14],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],Tr1[23,][T0+9],Tr1[23,][T0+10],Tr1[23,][T0+11],Tr1[23,][T0+12],Tr1[23,][T0+13],Tr1[22,][T0+14],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],Tr1[24,][T0+9],Tr1[24,][T0+10],Tr1[24,][T0+11],Tr1[24,][T0+12],Tr1[23,][T0+13],Tr1[23,][T0+14],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],Tr1[25,][T0+9],Tr1[25,][T0+10],Tr1[24,][T0+11],Tr1[24,][T0+12],Tr1[24,][T0+13],Tr1[24,][T0+14],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],Tr1[26,][T0+9],Tr1[26,][T0+10],Tr1[26,][T0+11],Tr1[26,][T0+12],Tr1[26,][T0+13],Tr1[26,][T0+14],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],Tr1[27,][T0+9],Tr1[27,][T0+10],Tr1[27,][T0+11],Tr1[27,][T0+12],Tr1[26,][T0+13],Tr1[26,][T0+14],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],Tr1[28,][T0+9],Tr1[28,][T0+10],Tr1[28,][T0+11],Tr1[28,][T0+12],Tr1[28,][T0+13],Tr1[28,][T0+14],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],Tr1[29,][T0+9],Tr1[29,][T0+10],Tr1[29,][T0+11],Tr1[29,][T0+12],Tr1[29,][T0+13],Tr1[29,][T0+14],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],Tr1[30,][T0+9],Tr1[30,][T0+10],Tr1[30,][T0+11],Tr1[30,][T0+12],Tr1[30,][T0+13],Tr1[30,][T0+14],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment_111,new_treatment_121,new_treatment_131,new_treatment_141,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment_112,new_treatment_122,new_treatment_132,new_treatment_142,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment_113,new_treatment_123,new_treatment_133,new_treatment_143,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment_114,new_treatment_124,new_treatment_134,new_treatment_144,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment_115,new_treatment_125,new_treatment_135,new_treatment_145,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,new_treatment96,new_treatment106,new_treatment_116,new_treatment_126,new_treatment_136,new_treatment_146,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,new_treatment97,new_treatment107,new_treatment_117,new_treatment_127,new_treatment_137,new_treatment_147,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,new_treatment98,new_treatment108,new_treatment_118,new_treatment_128,new_treatment_138,new_treatment_148,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,new_treatment99,new_treatment109,new_treatment_119,new_treatment_129,new_treatment_139,new_treatment_149,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,new_treatment910,new_treatment1010,new_treatment_1110,new_treatment_1210,new_treatment_1310,new_treatment_1410,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,new_treatment911,new_treatment1011,new_treatment_1111,new_treatment_1211,new_treatment_1311,new_treatment_1411,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,new_treatment912,new_treatment1012,new_treatment_1112,new_treatment_1212,new_treatment_1312,new_treatment_1412,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,new_treatment913,new_treatment1013,new_treatment_1113,new_treatment_1213,new_treatment_1313,new_treatment_1413,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,new_treatment914,new_treatment1014,new_treatment_1114,new_treatment_1214,new_treatment_1314,new_treatment_1414,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,new_treatment915,new_treatment1015,new_treatment_1115,new_treatment_1215,new_treatment_1315,new_treatment_1415,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,new_treatment916,new_treatment1016,new_treatment_1116,new_treatment_1216,new_treatment_1316,new_treatment_1416,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,new_treatment917,new_treatment1017,new_treatment_1117,new_treatment_1217,new_treatment_1317,new_treatment_1417,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,new_treatment918,new_treatment1018,new_treatment_1118,new_treatment_1218,new_treatment_1318,new_treatment_1418,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,new_treatment919,new_treatment1019,new_treatment_1119,new_treatment_1219,new_treatment_1319,new_treatment_1419,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,new_treatment920,new_treatment1020,new_treatment_1120,new_treatment_1220,new_treatment_1320,new_treatment_1420,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,new_treatment921,new_treatment1021,new_treatment_1121,new_treatment_1221,new_treatment_1321,new_treatment_1421,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,new_treatment922,new_treatment1022,new_treatment_1122,new_treatment_1222,new_treatment_1322,new_treatment_1422,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,new_treatment923,new_treatment1023,new_treatment_1123,new_treatment_1223,new_treatment_1323,new_treatment_1423,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,new_treatment924,new_treatment1024,new_treatment_1124,new_treatment_1224,new_treatment_1324,new_treatment_1424,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,new_treatment925,new_treatment1025,new_treatment_1125,new_treatment_1225,new_treatment_1325,new_treatment_1425,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,new_treatment926,new_treatment1026,new_treatment_1126,new_treatment_1226,new_treatment_1326,new_treatment_1426,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,new_treatment927,new_treatment1027,new_treatment_1127,new_treatment_1227,new_treatment_1327,new_treatment_1427,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,new_treatment928,new_treatment1028,new_treatment_1128,new_treatment_1228,new_treatment_1328,new_treatment_1428,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,new_treatment929,new_treatment1029,new_treatment_1129,new_treatment_1229,new_treatment_1329,new_treatment_1429,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,new_treatment930,new_treatment1030,new_treatment_1130,new_treatment_1230,new_treatment_1330,new_treatment_1430,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-rbind( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-rbind( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-rbind( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])

zz2<-c( x1[1:(T0+j)],x2[1:(T0+j)],x3[1:(T0+j)],x4[1:(T0+j)],x5[1:(T0+j)],x6[1:(T0+j)],x7[1:(T0+j)],x8[1:(T0+j)],x9[1:(T0+j)],x10[1:(T0+j)],x11[1:(T0+j)],x12[1:(T0+j)],x13[1:(T0+j)],x14[1:(T0+j)],x15[1:(T0+j)],x16[1:(T0+j)],x17[1:(T0+j)],x18[1:(T0+j)],x19[1:(T0+j)],x20[1:(T0+j)],x21[1:(T0+j)],x22[1:(T0+j)],x23[1:(T0+j)],x24[1:(T0+j)],x25[1:(T0+j)],x26[1:(T0+j)],x27[1:(T0+j)],x28[1:(T0+j)],x29[1:(T0+j)],x30[1:(T0+j)] )
 
zz3<-c( z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)],z6[1:(T0+j)],z7[1:(T0+j)],z8[1:(T0+j)],z9[1:(T0+j)],z10[1:(T0+j)],z11[1:(T0+j)],z12[1:(T0+j)],z13[1:(T0+j)],z14[1:(T0+j)],z15[1:(T0+j)],z16[1:(T0+j)],z17[1:(T0+j)],z18[1:(T0+j)],z19[1:(T0+j)],z20[1:(T0+j)],z21[1:(T0+j)],z22[1:(T0+j)],z23[1:(T0+j)],z24[1:(T0+j)],z25[1:(T0+j)],z26[1:(T0+j)],z27[1:(T0+j)],z28[1:(T0+j)],z29[1:(T0+j)],z30[1:(T0+j)] )
 
zz4<-c( w1[1:(T0+j)],w2[1:(T0+j)],w3[1:(T0+j)],w4[1:(T0+j)],w5[1:(T0+j)],w6[1:(T0+j)],w7[1:(T0+j)],w8[1:(T0+j)],w9[1:(T0+j)],w10[1:(T0+j)],w11[1:(T0+j)],w12[1:(T0+j)],w13[1:(T0+j)],w14[1:(T0+j)],w15[1:(T0+j)],w16[1:(T0+j)],w17[1:(T0+j)],w18[1:(T0+j)],w19[1:(T0+j)],w20[1:(T0+j)],w21[1:(T0+j)],w22[1:(T0+j)],w23[1:(T0+j)],w24[1:(T0+j)],w25[1:(T0+j)],w26[1:(T0+j)],w27[1:(T0+j)],w28[1:(T0+j)],w29[1:(T0+j)],w30[1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment_151<-new_treatment[1]
new_treatment_152<-new_treatment[2]
new_treatment_153<-new_treatment[3]
new_treatment_154<-new_treatment[4]
new_treatment_155<-new_treatment[5]
new_treatment_156<-new_treatment[6]
new_treatment_157<-new_treatment[7]
new_treatment_158<-new_treatment[8]
new_treatment_159<-new_treatment[9]
new_treatment_1510<-new_treatment[10]
new_treatment_1511<-new_treatment[11]
new_treatment_1512<-new_treatment[12]
new_treatment_1513<-new_treatment[13]
new_treatment_1514<-new_treatment[14]
new_treatment_1515<-new_treatment[15]
new_treatment_1516<-new_treatment[16]
new_treatment_1517<-new_treatment[17]
new_treatment_1518<-new_treatment[18]
new_treatment_1519<-new_treatment[19]
new_treatment_1520<-new_treatment[20]
new_treatment_1521<-new_treatment[21]
new_treatment_1522<-new_treatment[22]
new_treatment_1523<-new_treatment[23]
new_treatment_1524<-new_treatment[24]
new_treatment_1525<-new_treatment[25]
new_treatment_1526<-new_treatment[26]
new_treatment_1527<-new_treatment[27]
new_treatment_1528<-new_treatment[28]
new_treatment_1529<-new_treatment[29]
new_treatment_1530<-new_treatment[30]

new_treatment_15<-new_treatment





##====================================

#bootstrap 15#
#sd 15#

#step 15: s=15#
s=15

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=15

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)



DDD<-rbind(
Tr1[1,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[1,][T0+1],Tr1[1,][T0+2],Tr1[1,][T0+3],Tr1[1,][T0+4],Tr1[1,][T0+5],Tr1[1,][T0+6],Tr1[1,][T0+7],Tr1[1,][T0+8],Tr1[1,][T0+9],Tr1[1,][T0+10],Tr1[1,][T0+11],Tr1[1,][T0+12],Tr1[1,][T0+13],Tr1[1,][T0+14],0)*ifelse(TT0[1]<=T0,0,1),
Tr1[2,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[2,][T0+1],Tr1[2,][T0+2],Tr1[2,][T0+3],Tr1[2,][T0+4],Tr1[2,][T0+5],Tr1[2,][T0+6],Tr1[2,][T0+7],Tr1[2,][T0+8],Tr1[2,][T0+9],Tr1[2,][T0+10],Tr1[2,][T0+11],Tr1[2,][T0+12],Tr1[2,][T0+13],Tr1[2,][T0+14],0)*ifelse(TT0[2]<=T0,0,1),
Tr1[3,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[3,][T0+1],Tr1[3,][T0+2],Tr1[3,][T0+3],Tr1[3,][T0+4],Tr1[3,][T0+5],Tr1[3,][T0+6],Tr1[3,][T0+7],Tr1[3,][T0+8],Tr1[3,][T0+9],Tr1[3,][T0+10],Tr1[3,][T0+11],Tr1[3,][T0+12],Tr1[3,][T0+13],Tr1[3,][T0+14],0)*ifelse(TT0[3]<=T0,0,1),
Tr1[4,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[4,][T0+1],Tr1[4,][T0+2],Tr1[4,][T0+3],Tr1[4,][T0+4],Tr1[4,][T0+5],Tr1[4,][T0+6],Tr1[4,][T0+7],Tr1[4,][T0+8],Tr1[4,][T0+9],Tr1[4,][T0+10],Tr1[4,][T0+11],Tr1[4,][T0+12],Tr1[4,][T0+13],Tr1[4,][T0+14],0)*ifelse(TT0[4]<=T0,0,1),
Tr1[5,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[5,][T0+1],Tr1[5,][T0+2],Tr1[5,][T0+3],Tr1[5,][T0+4],Tr1[5,][T0+5],Tr1[5,][T0+6],Tr1[5,][T0+7],Tr1[5,][T0+8],Tr1[5,][T0+9],Tr1[5,][T0+10],Tr1[5,][T0+11],Tr1[5,][T0+12],Tr1[5,][T0+13],Tr1[5,][T0+14],0)*ifelse(TT0[5]<=T0,0,1),
Tr1[6,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[6,][T0+1],Tr1[6,][T0+2],Tr1[6,][T0+3],Tr1[6,][T0+4],Tr1[6,][T0+5],Tr1[6,][T0+6],Tr1[6,][T0+7],Tr1[6,][T0+8],Tr1[6,][T0+9],Tr1[6,][T0+10],Tr1[6,][T0+11],Tr1[6,][T0+12],Tr1[6,][T0+13],Tr1[5,][T0+14],0)*ifelse(TT0[6]<=T0,0,1),
Tr1[7,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[7,][T0+1],Tr1[7,][T0+2],Tr1[7,][T0+3],Tr1[7,][T0+4],Tr1[7,][T0+5],Tr1[7,][T0+6],Tr1[7,][T0+7],Tr1[7,][T0+8],Tr1[7,][T0+9],Tr1[7,][T0+10],Tr1[7,][T0+11],Tr1[7,][T0+12],Tr1[7,][T0+13],Tr1[7,][T0+14],0)*ifelse(TT0[7]<=T0,0,1),
Tr1[8,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[8,][T0+1],Tr1[8,][T0+2],Tr1[8,][T0+3],Tr1[8,][T0+4],Tr1[8,][T0+5],Tr1[8,][T0+6],Tr1[8,][T0+7],Tr1[8,][T0+8],Tr1[8,][T0+9],Tr1[8,][T0+10],Tr1[8,][T0+11],Tr1[8,][T0+12],Tr1[8,][T0+13],Tr1[8,][T0+14],0)*ifelse(TT0[8]<=T0,0,1),
Tr1[9,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[9,][T0+1],Tr1[9,][T0+2],Tr1[9,][T0+3],Tr1[9,][T0+4],Tr1[9,][T0+5],Tr1[9,][T0+6],Tr1[9,][T0+7],Tr1[9,][T0+8],Tr1[9,][T0+9],Tr1[9,][T0+10],Tr1[9,][T0+11],Tr1[9,][T0+12],Tr1[9,][T0+13],Tr1[9,][T0+14],0)*ifelse(TT0[9]<=T0,0,1),
Tr1[10,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[10,][T0+1],Tr1[10,][T0+2],Tr1[10,][T0+3],Tr1[10,][T0+4],Tr1[10,][T0+5],Tr1[10,][T0+6],Tr1[10,][T0+7],Tr1[10,][T0+8],Tr1[10,][T0+9],Tr1[10,][T0+10],Tr1[10,][T0+11],Tr1[10,][T0+12],Tr1[10,][T0+13],Tr1[10,][T0+14],0)*ifelse(TT0[10]<=T0,0,1),
Tr1[11,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[11,][T0+1],Tr1[11,][T0+2],Tr1[11,][T0+3],Tr1[11,][T0+4],Tr1[11,][T0+5],Tr1[11,][T0+6],Tr1[11,][T0+7],Tr1[11,][T0+8],Tr1[11,][T0+9],Tr1[11,][T0+10],Tr1[11,][T0+11],Tr1[11,][T0+12],Tr1[11,][T0+13],Tr1[11,][T0+14],0)*ifelse(TT0[11]<=T0,0,1),
Tr1[12,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[12,][T0+1],Tr1[12,][T0+2],Tr1[12,][T0+3],Tr1[12,][T0+4],Tr1[12,][T0+5],Tr1[12,][T0+6],Tr1[12,][T0+7],Tr1[12,][T0+8],Tr1[12,][T0+9],Tr1[12,][T0+10],Tr1[12,][T0+11],Tr1[12,][T0+12],Tr1[12,][T0+13],Tr1[12,][T0+14],0)*ifelse(TT0[12]<=T0,0,1),
Tr1[13,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[13,][T0+1],Tr1[13,][T0+2],Tr1[13,][T0+3],Tr1[13,][T0+4],Tr1[13,][T0+5],Tr1[13,][T0+6],Tr1[13,][T0+7],Tr1[13,][T0+8],Tr1[13,][T0+9],Tr1[13,][T0+10],Tr1[13,][T0+11],Tr1[13,][T0+12],Tr1[13,][T0+13],Tr1[13,][T0+14],0)*ifelse(TT0[13]<=T0,0,1),
Tr1[14,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[14,][T0+1],Tr1[14,][T0+2],Tr1[14,][T0+3],Tr1[14,][T0+4],Tr1[14,][T0+5],Tr1[14,][T0+6],Tr1[14,][T0+7],Tr1[14,][T0+8],Tr1[14,][T0+9],Tr1[14,][T0+10],Tr1[14,][T0+11],Tr1[14,][T0+12],Tr1[14,][T0+13],Tr1[14,][T0+14],0)*ifelse(TT0[14]<=T0,0,1),
Tr1[15,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[15,][T0+1],Tr1[15,][T0+2],Tr1[15,][T0+3],Tr1[15,][T0+4],Tr1[15,][T0+5],Tr1[15,][T0+6],Tr1[15,][T0+7],Tr1[15,][T0+8],Tr1[15,][T0+9],Tr1[15,][T0+10],Tr1[15,][T0+11],Tr1[15,][T0+12],Tr1[15,][T0+13],Tr1[15,][T0+14],0)*ifelse(TT0[15]<=T0,0,1),
Tr1[16,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[16,][T0+1],Tr1[16,][T0+2],Tr1[16,][T0+3],Tr1[16,][T0+4],Tr1[16,][T0+5],Tr1[16,][T0+6],Tr1[16,][T0+7],Tr1[16,][T0+8],Tr1[16,][T0+9],Tr1[16,][T0+10],Tr1[16,][T0+11],Tr1[16,][T0+12],Tr1[16,][T0+13],Tr1[16,][T0+14],0)*ifelse(TT0[16]<=T0,0,1),
Tr1[17,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[17,][T0+1],Tr1[17,][T0+2],Tr1[17,][T0+3],Tr1[17,][T0+4],Tr1[17,][T0+5],Tr1[17,][T0+6],Tr1[17,][T0+7],Tr1[17,][T0+8],Tr1[17,][T0+9],Tr1[17,][T0+10],Tr1[17,][T0+11],Tr1[17,][T0+12],Tr1[17,][T0+13],Tr1[17,][T0+14],0)*ifelse(TT0[17]<=T0,0,1),
Tr1[18,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[18,][T0+1],Tr1[18,][T0+2],Tr1[18,][T0+3],Tr1[18,][T0+4],Tr1[18,][T0+5],Tr1[18,][T0+6],Tr1[18,][T0+7],Tr1[18,][T0+8],Tr1[18,][T0+9],Tr1[18,][T0+10],Tr1[18,][T0+11],Tr1[18,][T0+12],Tr1[18,][T0+13],Tr1[18,][T0+14],0)*ifelse(TT0[18]<=T0,0,1),
Tr1[19,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[19,][T0+1],Tr1[19,][T0+2],Tr1[19,][T0+3],Tr1[19,][T0+4],Tr1[19,][T0+5],Tr1[19,][T0+6],Tr1[19,][T0+7],Tr1[19,][T0+8],Tr1[19,][T0+9],Tr1[19,][T0+10],Tr1[19,][T0+11],Tr1[19,][T0+12],Tr1[19,][T0+13],Tr1[19,][T0+14],0)*ifelse(TT0[19]<=T0,0,1),
Tr1[20,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[20,][T0+1],Tr1[20,][T0+2],Tr1[20,][T0+3],Tr1[20,][T0+4],Tr1[20,][T0+5],Tr1[20,][T0+6],Tr1[20,][T0+7],Tr1[20,][T0+8],Tr1[20,][T0+9],Tr1[20,][T0+10],Tr1[20,][T0+11],Tr1[20,][T0+12],Tr1[20,][T0+13],Tr1[20,][T0+14],0)*ifelse(TT0[20]<=T0,0,1),
Tr1[21,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[21,][T0+1],Tr1[21,][T0+2],Tr1[21,][T0+3],Tr1[21,][T0+4],Tr1[21,][T0+5],Tr1[21,][T0+6],Tr1[21,][T0+7],Tr1[21,][T0+8],Tr1[21,][T0+9],Tr1[21,][T0+10],Tr1[21,][T0+11],Tr1[21,][T0+12],Tr1[21,][T0+13],Tr1[21,][T0+14],0)*ifelse(TT0[21]<=T0,0,1),
Tr1[22,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[22,][T0+1],Tr1[22,][T0+2],Tr1[22,][T0+3],Tr1[22,][T0+4],Tr1[22,][T0+5],Tr1[22,][T0+6],Tr1[22,][T0+7],Tr1[22,][T0+8],Tr1[22,][T0+9],Tr1[22,][T0+10],Tr1[22,][T0+11],Tr1[22,][T0+12],Tr1[22,][T0+13],Tr1[22,][T0+14],0)*ifelse(TT0[22]<=T0,0,1),
Tr1[23,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[23,][T0+1],Tr1[23,][T0+2],Tr1[23,][T0+3],Tr1[23,][T0+4],Tr1[23,][T0+5],Tr1[23,][T0+6],Tr1[23,][T0+7],Tr1[23,][T0+8],Tr1[23,][T0+9],Tr1[23,][T0+10],Tr1[23,][T0+11],Tr1[23,][T0+12],Tr1[23,][T0+13],Tr1[22,][T0+14],0)*ifelse(TT0[23]<=T0,0,1),
Tr1[24,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[24,][T0+1],Tr1[24,][T0+2],Tr1[24,][T0+3],Tr1[24,][T0+4],Tr1[24,][T0+5],Tr1[24,][T0+6],Tr1[24,][T0+7],Tr1[24,][T0+8],Tr1[24,][T0+9],Tr1[24,][T0+10],Tr1[24,][T0+11],Tr1[24,][T0+12],Tr1[23,][T0+13],Tr1[23,][T0+14],0)*ifelse(TT0[24]<=T0,0,1),
Tr1[25,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[25,][T0+1],Tr1[25,][T0+2],Tr1[25,][T0+3],Tr1[25,][T0+4],Tr1[25,][T0+5],Tr1[25,][T0+6],Tr1[25,][T0+7],Tr1[25,][T0+8],Tr1[25,][T0+9],Tr1[25,][T0+10],Tr1[24,][T0+11],Tr1[24,][T0+12],Tr1[24,][T0+13],Tr1[24,][T0+14],0)*ifelse(TT0[25]<=T0,0,1),
Tr1[26,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[26,][T0+1],Tr1[26,][T0+2],Tr1[26,][T0+3],Tr1[26,][T0+4],Tr1[26,][T0+5],Tr1[26,][T0+6],Tr1[26,][T0+7],Tr1[26,][T0+8],Tr1[26,][T0+9],Tr1[26,][T0+10],Tr1[26,][T0+11],Tr1[26,][T0+12],Tr1[26,][T0+13],Tr1[26,][T0+14],0)*ifelse(TT0[26]<=T0,0,1),
Tr1[27,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[27,][T0+1],Tr1[27,][T0+2],Tr1[27,][T0+3],Tr1[27,][T0+4],Tr1[27,][T0+5],Tr1[27,][T0+6],Tr1[27,][T0+7],Tr1[27,][T0+8],Tr1[27,][T0+9],Tr1[27,][T0+10],Tr1[27,][T0+11],Tr1[27,][T0+12],Tr1[26,][T0+13],Tr1[26,][T0+14],0)*ifelse(TT0[27]<=T0,0,1),
Tr1[28,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[28,][T0+1],Tr1[28,][T0+2],Tr1[28,][T0+3],Tr1[28,][T0+4],Tr1[28,][T0+5],Tr1[28,][T0+6],Tr1[28,][T0+7],Tr1[28,][T0+8],Tr1[28,][T0+9],Tr1[28,][T0+10],Tr1[28,][T0+11],Tr1[28,][T0+12],Tr1[28,][T0+13],Tr1[28,][T0+14],0)*ifelse(TT0[28]<=T0,0,1),
Tr1[29,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[29,][T0+1],Tr1[29,][T0+2],Tr1[29,][T0+3],Tr1[29,][T0+4],Tr1[29,][T0+5],Tr1[29,][T0+6],Tr1[29,][T0+7],Tr1[29,][T0+8],Tr1[29,][T0+9],Tr1[29,][T0+10],Tr1[29,][T0+11],Tr1[29,][T0+12],Tr1[29,][T0+13],Tr1[29,][T0+14],0)*ifelse(TT0[29]<=T0,0,1),
Tr1[30,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[30,][T0+1],Tr1[30,][T0+2],Tr1[30,][T0+3],Tr1[30,][T0+4],Tr1[30,][T0+5],Tr1[30,][T0+6],Tr1[30,][T0+7],Tr1[30,][T0+8],Tr1[30,][T0+9],Tr1[30,][T0+10],Tr1[30,][T0+11],Tr1[30,][T0+12],Tr1[30,][T0+13],Tr1[30,][T0+14],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment_111,new_treatment_121,new_treatment_131,new_treatment_141,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment_112,new_treatment_122,new_treatment_132,new_treatment_142,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment_113,new_treatment_123,new_treatment_133,new_treatment_143,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment_114,new_treatment_124,new_treatment_134,new_treatment_144,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment_115,new_treatment_125,new_treatment_135,new_treatment_145,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[1:(T0+s)]-c(rep(0,T0),new_treatment16,new_treatment26,new_treatment36,new_treatment46,new_treatment56,new_treatment66,new_treatment76,new_treatment86,new_treatment96,new_treatment106,new_treatment_116,new_treatment_126,new_treatment_136,new_treatment_146,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[1:(T0+s)]-c(rep(0,T0),new_treatment17,new_treatment27,new_treatment37,new_treatment47,new_treatment57,new_treatment67,new_treatment77,new_treatment87,new_treatment97,new_treatment107,new_treatment_117,new_treatment_127,new_treatment_137,new_treatment_147,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[1:(T0+s)]-c(rep(0,T0),new_treatment18,new_treatment28,new_treatment38,new_treatment48,new_treatment58,new_treatment68,new_treatment78,new_treatment88,new_treatment98,new_treatment108,new_treatment_118,new_treatment_128,new_treatment_138,new_treatment_148,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[1:(T0+s)]-c(rep(0,T0),new_treatment19,new_treatment29,new_treatment39,new_treatment49,new_treatment59,new_treatment69,new_treatment79,new_treatment89,new_treatment99,new_treatment109,new_treatment_119,new_treatment_129,new_treatment_139,new_treatment_149,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[1:(T0+s)]-c(rep(0,T0),new_treatment110,new_treatment210,new_treatment310,new_treatment410,new_treatment510,new_treatment610,new_treatment710,new_treatment810,new_treatment910,new_treatment1010,new_treatment_1110,new_treatment_1210,new_treatment_1310,new_treatment_1410,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[1:(T0+s)]-c(rep(0,T0),new_treatment111,new_treatment211,new_treatment311,new_treatment411,new_treatment511,new_treatment611,new_treatment711,new_treatment811,new_treatment911,new_treatment1011,new_treatment_1111,new_treatment_1211,new_treatment_1311,new_treatment_1411,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[1:(T0+s)]-c(rep(0,T0),new_treatment112,new_treatment212,new_treatment312,new_treatment412,new_treatment512,new_treatment612,new_treatment712,new_treatment812,new_treatment912,new_treatment1012,new_treatment_1112,new_treatment_1212,new_treatment_1312,new_treatment_1412,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[1:(T0+s)]-c(rep(0,T0),new_treatment113,new_treatment213,new_treatment313,new_treatment413,new_treatment513,new_treatment613,new_treatment713,new_treatment813,new_treatment913,new_treatment1013,new_treatment_1113,new_treatment_1213,new_treatment_1313,new_treatment_1413,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[1:(T0+s)]-c(rep(0,T0),new_treatment114,new_treatment214,new_treatment314,new_treatment414,new_treatment514,new_treatment614,new_treatment714,new_treatment814,new_treatment914,new_treatment1014,new_treatment_1114,new_treatment_1214,new_treatment_1314,new_treatment_1414,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[1:(T0+s)]-c(rep(0,T0),new_treatment115,new_treatment215,new_treatment315,new_treatment415,new_treatment515,new_treatment615,new_treatment715,new_treatment815,new_treatment915,new_treatment1015,new_treatment_1115,new_treatment_1215,new_treatment_1315,new_treatment_1415,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[1:(T0+s)]-c(rep(0,T0),new_treatment116,new_treatment216,new_treatment316,new_treatment416,new_treatment516,new_treatment616,new_treatment716,new_treatment816,new_treatment916,new_treatment1016,new_treatment_1116,new_treatment_1216,new_treatment_1316,new_treatment_1416,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[1:(T0+s)]-c(rep(0,T0),new_treatment117,new_treatment217,new_treatment317,new_treatment417,new_treatment517,new_treatment617,new_treatment717,new_treatment817,new_treatment917,new_treatment1017,new_treatment_1117,new_treatment_1217,new_treatment_1317,new_treatment_1417,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[1:(T0+s)]-c(rep(0,T0),new_treatment118,new_treatment218,new_treatment318,new_treatment418,new_treatment518,new_treatment618,new_treatment718,new_treatment818,new_treatment918,new_treatment1018,new_treatment_1118,new_treatment_1218,new_treatment_1318,new_treatment_1418,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[1:(T0+s)]-c(rep(0,T0),new_treatment119,new_treatment219,new_treatment319,new_treatment419,new_treatment519,new_treatment619,new_treatment719,new_treatment819,new_treatment919,new_treatment1019,new_treatment_1119,new_treatment_1219,new_treatment_1319,new_treatment_1419,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[1:(T0+s)]-c(rep(0,T0),new_treatment120,new_treatment220,new_treatment320,new_treatment420,new_treatment520,new_treatment620,new_treatment720,new_treatment820,new_treatment920,new_treatment1020,new_treatment_1120,new_treatment_1220,new_treatment_1320,new_treatment_1420,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[1:(T0+s)]-c(rep(0,T0),new_treatment121,new_treatment221,new_treatment321,new_treatment421,new_treatment521,new_treatment621,new_treatment721,new_treatment821,new_treatment921,new_treatment1021,new_treatment_1121,new_treatment_1221,new_treatment_1321,new_treatment_1421,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[1:(T0+s)]-c(rep(0,T0),new_treatment122,new_treatment222,new_treatment322,new_treatment422,new_treatment522,new_treatment622,new_treatment722,new_treatment822,new_treatment922,new_treatment1022,new_treatment_1122,new_treatment_1222,new_treatment_1322,new_treatment_1422,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[1:(T0+s)]-c(rep(0,T0),new_treatment123,new_treatment223,new_treatment323,new_treatment423,new_treatment523,new_treatment623,new_treatment723,new_treatment823,new_treatment923,new_treatment1023,new_treatment_1123,new_treatment_1223,new_treatment_1323,new_treatment_1423,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[1:(T0+s)]-c(rep(0,T0),new_treatment124,new_treatment224,new_treatment324,new_treatment424,new_treatment524,new_treatment624,new_treatment724,new_treatment824,new_treatment924,new_treatment1024,new_treatment_1124,new_treatment_1224,new_treatment_1324,new_treatment_1424,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[1:(T0+s)]-c(rep(0,T0),new_treatment125,new_treatment225,new_treatment325,new_treatment425,new_treatment525,new_treatment625,new_treatment725,new_treatment825,new_treatment925,new_treatment1025,new_treatment_1125,new_treatment_1225,new_treatment_1325,new_treatment_1425,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[1:(T0+s)]-c(rep(0,T0),new_treatment126,new_treatment226,new_treatment326,new_treatment426,new_treatment526,new_treatment626,new_treatment726,new_treatment826,new_treatment926,new_treatment1026,new_treatment_1126,new_treatment_1226,new_treatment_1326,new_treatment_1426,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[1:(T0+s)]-c(rep(0,T0),new_treatment127,new_treatment227,new_treatment327,new_treatment427,new_treatment527,new_treatment627,new_treatment727,new_treatment827,new_treatment927,new_treatment1027,new_treatment_1127,new_treatment_1227,new_treatment_1327,new_treatment_1427,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[1:(T0+s)]-c(rep(0,T0),new_treatment128,new_treatment228,new_treatment328,new_treatment428,new_treatment528,new_treatment628,new_treatment728,new_treatment828,new_treatment928,new_treatment1028,new_treatment_1128,new_treatment_1228,new_treatment_1328,new_treatment_1428,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[1:(T0+s)]-c(rep(0,T0),new_treatment129,new_treatment229,new_treatment329,new_treatment429,new_treatment529,new_treatment629,new_treatment729,new_treatment829,new_treatment929,new_treatment1029,new_treatment_1129,new_treatment_1229,new_treatment_1329,new_treatment_1429,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[1:(T0+s)]-c(rep(0,T0),new_treatment130,new_treatment230,new_treatment330,new_treatment430,new_treatment530,new_treatment630,new_treatment730,new_treatment830,new_treatment930,new_treatment1030,new_treatment_1130,new_treatment_1230,new_treatment_1330,new_treatment_1430,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

zz2<-rbind( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-rbind( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-rbind( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[1,][S0:(T0+j)],Tr1[2,][S0:(T0+j)],Tr1[3,][S0:(T0+j)],Tr1[4,][S0:(T0+j)],Tr1[5,][S0:(T0+j)],Tr1[6,][S0:(T0+j)],Tr1[7,][S0:(T0+j)],Tr1[8,][S0:(T0+j)],Tr1[9,][S0:(T0+j)],Tr1[10,][S0:(T0+j)],Tr1[11,][S0:(T0+j)],Tr1[12,][S0:(T0+j)],Tr1[13,][S0:(T0+j)],Tr1[14,][S0:(T0+j)],Tr1[15,][S0:(T0+j)],Tr1[16,][S0:(T0+j)],Tr1[17,][S0:(T0+j)],Tr1[18,][S0:(T0+j)],Tr1[19,][S0:(T0+j)],Tr1[20,][S0:(T0+j)],Tr1[21,][S0:(T0+j)],Tr1[22,][S0:(T0+j)],Tr1[23,][S0:(T0+j)],Tr1[24,][S0:(T0+j)],Tr1[25,][S0:(T0+j)],Tr1[26,][S0:(T0+j)],Tr1[27,][S0:(T0+j)],Tr1[28,][S0:(T0+j)],Tr1[29,][S0:(T0+j)],Tr1[30,][S0:(T0+j)] )

yy<-c(d1[S0:(T0+j)],d2[S0:(T0+j)],d3[S0:(T0+j)],d4[S0:(T0+j)],d5[S0:(T0+j)],d6[S0:(T0+j)],d7[S0:(T0+j)],d8[S0:(T0+j)],d9[S0:(T0+j)],d10[S0:(T0+j)],d11[S0:(T0+j)],d12[S0:(T0+j)],d13[S0:(T0+j)],d14[S0:(T0+j)],d15[S0:(T0+j)],d16[S0:(T0+j)],d17[S0:(T0+j)],d18[S0:(T0+j)],d19[S0:(T0+j)],d20[S0:(T0+j)],d21[S0:(T0+j)],d22[S0:(T0+j)],d23[S0:(T0+j)],d24[S0:(T0+j)],d25[S0:(T0+j)],d26[S0:(T0+j)],d27[S0:(T0+j)],d28[S0:(T0+j)],d29[S0:(T0+j)],d30[S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],30))
tt2<-c(rep(t2[S0:(T0+j)],30))

zz2<-c( x1[S0:(T0+j)],x2[S0:(T0+j)],x3[S0:(T0+j)],x4[S0:(T0+j)],x5[S0:(T0+j)],x6[S0:(T0+j)],x7[S0:(T0+j)],x8[S0:(T0+j)],x9[S0:(T0+j)],x10[S0:(T0+j)],x11[S0:(T0+j)],x12[S0:(T0+j)],x13[S0:(T0+j)],x14[S0:(T0+j)],x15[S0:(T0+j)],x16[S0:(T0+j)],x17[S0:(T0+j)],x18[S0:(T0+j)],x19[S0:(T0+j)],x20[S0:(T0+j)],x21[S0:(T0+j)],x22[S0:(T0+j)],x23[S0:(T0+j)],x24[S0:(T0+j)],x25[S0:(T0+j)],x26[S0:(T0+j)],x27[S0:(T0+j)],x28[S0:(T0+j)],x29[S0:(T0+j)],x30[S0:(T0+j)] )

zz3<-c( z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)],z6[S0:(T0+j)],z7[S0:(T0+j)],z8[S0:(T0+j)],z9[S0:(T0+j)],z10[S0:(T0+j)],z11[S0:(T0+j)],z12[S0:(T0+j)],z13[S0:(T0+j)],z14[S0:(T0+j)],z15[S0:(T0+j)],z16[S0:(T0+j)],z17[S0:(T0+j)],z18[S0:(T0+j)],z19[S0:(T0+j)],z20[S0:(T0+j)],z21[S0:(T0+j)],z22[S0:(T0+j)],z23[S0:(T0+j)],z24[S0:(T0+j)],z25[S0:(T0+j)],z26[S0:(T0+j)],z27[S0:(T0+j)],z28[S0:(T0+j)],z29[S0:(T0+j)],z30[S0:(T0+j)] )

zz4<-c( w1[S0:(T0+j)],w2[S0:(T0+j)],w3[S0:(T0+j)],w4[S0:(T0+j)],w5[S0:(T0+j)],w6[S0:(T0+j)],w7[S0:(T0+j)],w8[S0:(T0+j)],w9[S0:(T0+j)],w10[S0:(T0+j)],w11[S0:(T0+j)],w12[S0:(T0+j)],w13[S0:(T0+j)],w14[S0:(T0+j)],w15[S0:(T0+j)],w16[S0:(T0+j)],w17[S0:(T0+j)],w18[S0:(T0+j)],w19[S0:(T0+j)],w20[S0:(T0+j)],w21[S0:(T0+j)],w22[S0:(T0+j)],w23[S0:(T0+j)],w24[S0:(T0+j)],w25[S0:(T0+j)],w26[S0:(T0+j)],w27[S0:(T0+j)],w28[S0:(T0+j)],w29[S0:(T0+j)],w30[S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment_151_sd<-var[1]^0.5
new_treatment_152_sd<-var[2]^0.5
new_treatment_153_sd<-var[3]^0.5
new_treatment_154_sd<-var[4]^0.5
new_treatment_155_sd<-var[5]^0.5
new_treatment_156_sd<-var[6]^0.5
new_treatment_157_sd<-var[7]^0.5
new_treatment_158_sd<-var[8]^0.5
new_treatment_159_sd<-var[9]^0.5
new_treatment_1510_sd<-var[10]^0.5
new_treatment_1511_sd<-var[11]^0.5
new_treatment_1512_sd<-var[12]^0.5
new_treatment_1513_sd<-var[13]^0.5
new_treatment_1514_sd<-var[14]^0.5
new_treatment_1515_sd<-var[15]^0.5
new_treatment_1516_sd<-var[16]^0.5
new_treatment_1517_sd<-var[17]^0.5
new_treatment_1518_sd<-var[18]^0.5
new_treatment_1519_sd<-var[19]^0.5
new_treatment_1520_sd<-var[20]^0.5
new_treatment_1521_sd<-var[21]^0.5
new_treatment_1522_sd<-var[22]^0.5
new_treatment_1523_sd<-var[23]^0.5
new_treatment_1524_sd<-var[24]^0.5
new_treatment_1525_sd<-var[25]^0.5
new_treatment_1526_sd<-var[26]^0.5
new_treatment_1527_sd<-var[27]^0.5
new_treatment_1528_sd<-var[28]^0.5
new_treatment_1529_sd<-var[29]^0.5
new_treatment_1530_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper15<-c()
lower15<-c()
for(i in 1:30){
upper15[i]<-new_treatment_15[i]-Quantile_upper[i]*(var[i]^0.5)
lower15[i]<-new_treatment_15[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper15
lower15






upper<-list(upper1,upper2,upper3,upper4,upper5,upper6,upper7,upper8,upper9,upper10,upper11,upper12,upper13,upper14,upper15)

upper<-data.frame(upper)
new1_upper<-as.numeric(upper[1,])
new2_upper<-as.numeric(upper[2,])
new3_upper<-as.numeric(upper[3,])
new4_upper<-as.numeric(upper[4,])
new5_upper<-as.numeric(upper[5,])
new6_upper<-as.numeric(upper[6,])
new7_upper<-as.numeric(upper[7,])
new8_upper<-as.numeric(upper[8,])
new9_upper<-as.numeric(upper[9,])
new10_upper<-as.numeric(upper[10,])
new11_upper<-as.numeric(upper[11,])
new12_upper<-as.numeric(upper[12,])
new13_upper<-as.numeric(upper[13,])
new14_upper<-as.numeric(upper[14,])
new15_upper<-as.numeric(upper[15,])
new16_upper<-as.numeric(upper[16,])
new17_upper<-as.numeric(upper[17,])
new18_upper<-as.numeric(upper[18,])
new19_upper<-as.numeric(upper[19,])
new20_upper<-as.numeric(upper[20,])
new21_upper<-as.numeric(upper[21,])
new22_upper<-as.numeric(upper[22,])
new23_upper<-as.numeric(upper[23,])
new24_upper<-as.numeric(upper[24,])
new25_upper<-as.numeric(upper[25,])
new26_upper<-as.numeric(upper[26,])
new27_upper<-as.numeric(upper[27,])
new28_upper<-as.numeric(upper[28,])
new29_upper<-as.numeric(upper[29,])
new30_upper<-as.numeric(upper[30,])


lower<-list(lower1,lower2,lower3,lower4,lower5,lower6,lower7,lower8,lower9,lower10,lower11,lower12,lower13,lower14,lower15)

lower<-data.frame(lower)
new1_lower<-as.numeric(lower[1,])
new2_lower<-as.numeric(lower[2,])
new3_lower<-as.numeric(lower[3,])
new4_lower<-as.numeric(lower[4,])
new5_lower<-as.numeric(lower[5,])
new6_lower<-as.numeric(lower[6,])
new7_lower<-as.numeric(lower[7,])
new8_lower<-as.numeric(lower[8,])
new9_lower<-as.numeric(lower[9,])
new10_lower<-as.numeric(lower[10,])
new11_lower<-as.numeric(lower[11,])
new12_lower<-as.numeric(lower[12,])
new13_lower<-as.numeric(lower[13,])
new14_lower<-as.numeric(lower[14,])
new15_lower<-as.numeric(lower[15,])
new16_lower<-as.numeric(lower[16,])
new17_lower<-as.numeric(lower[17,])
new18_lower<-as.numeric(lower[18,])
new19_lower<-as.numeric(lower[19,])
new20_lower<-as.numeric(lower[20,])
new21_lower<-as.numeric(lower[21,])
new22_lower<-as.numeric(lower[22,])
new23_lower<-as.numeric(lower[23,])
new24_lower<-as.numeric(lower[24,])
new25_lower<-as.numeric(lower[25,])
new26_lower<-as.numeric(lower[26,])
new27_lower<-as.numeric(lower[27,])
new28_lower<-as.numeric(lower[28,])
new29_lower<-as.numeric(lower[29,])
new30_lower<-as.numeric(lower[30,])





final_treatment<-list(new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment_11,new_treatment_12,new_treatment_13,new_treatment_14,new_treatment_15)

final_treatment<-data.frame(final_treatment)
new1<-as.numeric(final_treatment[1,])
new2<-as.numeric(final_treatment[2,])
new3<-as.numeric(final_treatment[3,])
new4<-as.numeric(final_treatment[4,])
new5<-as.numeric(final_treatment[5,])
new6<-as.numeric(final_treatment[6,])
new7<-as.numeric(final_treatment[7,])
new8<-as.numeric(final_treatment[8,])
new9<-as.numeric(final_treatment[9,])
new10<-as.numeric(final_treatment[10,])
new11<-as.numeric(final_treatment[11,])
new12<-as.numeric(final_treatment[12,])
new13<-as.numeric(final_treatment[13,])
new14<-as.numeric(final_treatment[14,])
new15<-as.numeric(final_treatment[15,])
new16<-as.numeric(final_treatment[16,])
new17<-as.numeric(final_treatment[17,])
new18<-as.numeric(final_treatment[18,])
new19<-as.numeric(final_treatment[19,])
new20<-as.numeric(final_treatment[20,])
new21<-as.numeric(final_treatment[21,])
new22<-as.numeric(final_treatment[22,])
new23<-as.numeric(final_treatment[23,])
new24<-as.numeric(final_treatment[24,])
new25<-as.numeric(final_treatment[25,])
new26<-as.numeric(final_treatment[26,])
new27<-as.numeric(final_treatment[27,])
new28<-as.numeric(final_treatment[28,])
new29<-as.numeric(final_treatment[29,])
new30<-as.numeric(final_treatment[30,])


average<-(new1+new2+new3+new4+new5+new6+new7+new8+new9+new10+new11+new12+new13+new14+new15+new16+new17+new18+new19+new20+new21+new22+new23+new24+new25+new26+new27+new28+new29+new30)/30

average_upper<-(new1_upper+new2_upper+new3_upper+new4_upper+new5_upper+new6_upper+new7_upper+new8_upper+new9_upper+new10_upper+new11_upper+new12_upper+new13_upper+new14_upper+new15_upper+new16_upper+new17_upper+new18_upper+new19_upper+new20_upper+new21_upper+new22_upper+new23_upper+new24_upper+new25_upper+new26_upper+new27_upper+new28_upper+new29_upper+new30_upper)/30

average_lower<-(new1_lower+new2_lower+new3_lower+new4_lower+new5_lower+new6_lower+new7_lower+new8_lower+new9_lower+new10_lower+new11_lower+new12_lower+new13_lower+new14_lower+new15_lower+new16_lower+new17_lower+new18_lower+new19_lower+new20_lower+new21_lower+new22_lower+new23_lower+new24_lower+new25_lower+new26_lower+new27_lower+new28_lower+new29_lower+new30_lower)/30

min<-min(average,average_upper,average_lower)
max<-max(average,average_upper,average_lower)
plot(average,ylim=c(min,max))
par(new=T)
plot(average_upper,pch="",ylim=c(min,max))
lines(average_upper)
par(new=T)
plot(average_lower,pch="",ylim=c(min,max))
lines(average_lower)
abline(h=0,lty=3,col="lightgrey")
abline(h=mean(average),lty=3)

















































































##===================================================================================================================================================
##===================================================================================================================================================


# The EFFECT OF THE SECOND WAVE  27 treated units#
## pp7,pp17,pp32,pp33,pp37,pp38,pp41,pp42,pp49,pp53,pp55,pp63,pp66,pp76,pp77,pp83,pp86,pp91,pp95,pp96,pp97,pp100,pp108,pp113,pp123,pp124,pp125


TT0<-c( sum(Tr2[1,][10:21]==0),sum(Tr2[2,][10:21]==0),sum(Tr2[3,][10:21]==0),sum(Tr2[4,][10:21]==0),sum(Tr2[5,][10:21]==0),sum(Tr2[6,][10:21]==0),sum(Tr2[7,][10:21]==0),sum(Tr2[8,][10:21]==0),sum(Tr2[9,][10:21]==0),sum(Tr2[10,][10:21]==0),sum(Tr2[11,][10:21]==0),sum(Tr2[12,][10:21]==0),sum(Tr2[13,][10:21]==0),sum(Tr2[14,][10:21]==0),sum(Tr2[15,][10:21]==0),sum(Tr2[16,][10:21]==0),sum(Tr2[17,][10:21]==0),sum(Tr2[18,][10:21]==0),sum(Tr2[19,][10:21]==0),sum(Tr2[20,][10:21]==0),sum(Tr2[21,][10:21]==0),sum(Tr2[22,][10:21]==0),sum(Tr2[23,][10:21]==0),sum(Tr2[24,][10:21]==0),sum(Tr2[25,][10:21]==0),sum(Tr2[26,][10:21]==0),sum(Tr2[27,][10:21]==0),sum(Tr2[28,][10:21]==0),sum(Tr2[29,][10:21]==0),sum(Tr2[30,][10:21]==0) )
TT1<-TT0+1    #treatment date#


T0<-min(TT0)
T1<-min(TT0)+1

T=30
t1<-sort(sample(300:330,T))
t2<-t1^2



#step 1: s=1#
s=1

j=1

DD<-c(Tr2[1,][10:21][1:(T0+j)],Tr2[2,][10:21][1:(T0+j)],Tr2[3,][10:21][1:(T0+j)],Tr2[4,][10:21][1:(T0+j)],Tr2[5,][10:21][1:(T0+j)],Tr2[6,][10:21][1:(T0+j)],Tr2[7,][10:21][1:(T0+j)],Tr2[8,][10:21][1:(T0+j)],Tr2[9,][10:21][1:(T0+j)],Tr2[10,][10:21][1:(T0+j)],Tr2[11,][10:21][1:(T0+j)],Tr2[12,][10:21][1:(T0+j)],Tr2[13,][10:21][1:(T0+j)],Tr2[14,][10:21][1:(T0+j)],Tr2[15,][10:21][1:(T0+j)],Tr2[16,][10:21][1:(T0+j)],Tr2[17,][10:21][1:(T0+j)],Tr2[18,][10:21][1:(T0+j)],Tr2[19,][10:21][1:(T0+j)],Tr2[20,][10:21][1:(T0+j)],Tr2[21,][10:21][1:(T0+j)],Tr2[22,][10:21][1:(T0+j)],Tr2[23,][10:21][1:(T0+j)],Tr2[24,][10:21][1:(T0+j)],Tr2[25,][10:21][1:(T0+j)],Tr2[26,][10:21][1:(T0+j)],Tr2[27,][10:21][1:(T0+j)],Tr2[28,][10:21][1:(T0+j)],Tr2[29,][10:21][1:(T0+j)],Tr2[30,][10:21][1:(T0+j)] )

yy<-c(d1[10:21][1:(T0+j)],d2[10:21][1:(T0+j)],d3[10:21][1:(T0+j)],d4[10:21][1:(T0+j)],d5[10:21][1:(T0+j)],d6[10:21][1:(T0+j)],d7[10:21][1:(T0+j)],d8[10:21][1:(T0+j)],d9[10:21][1:(T0+j)],d10[10:21][1:(T0+j)],d11[10:21][1:(T0+j)],d12[10:21][1:(T0+j)],d13[10:21][1:(T0+j)],d14[10:21][1:(T0+j)],d15[10:21][1:(T0+j)],d16[10:21][1:(T0+j)],d17[10:21][1:(T0+j)],d18[10:21][1:(T0+j)],d19[10:21][1:(T0+j)],d20[10:21][1:(T0+j)],d21[10:21][1:(T0+j)],d22[10:21][1:(T0+j)],d23[10:21][1:(T0+j)],d24[10:21][1:(T0+j)],d25[10:21][1:(T0+j)],d26[10:21][1:(T0+j)],d27[10:21][1:(T0+j)],d28[10:21][1:(T0+j)],d29[10:21][1:(T0+j)],d30[10:21][1:(T0+j)] )


tt1<-c(rep(t1[10:21][1:(T0+j)],30))
tt2<-c(rep(t2[10:21][1:(T0+j)],30))

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)


library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[10:21][1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind(Tr2[1,][10:21][1:(T0+j)],Tr2[2,][10:21][1:(T0+j)],Tr2[3,][10:21][1:(T0+j)],Tr2[4,][10:21][1:(T0+j)],Tr2[5,][10:21][1:(T0+j)],Tr2[6,][10:21][1:(T0+j)],Tr2[7,][10:21][1:(T0+j)],Tr2[8,][10:21][1:(T0+j)],Tr2[9,][10:21][1:(T0+j)],Tr2[10,][10:21][1:(T0+j)],Tr2[11,][10:21][1:(T0+j)],Tr2[12,][10:21][1:(T0+j)],Tr2[13,][10:21][1:(T0+j)],Tr2[14,][10:21][1:(T0+j)],Tr2[15,][10:21][1:(T0+j)],Tr2[16,][10:21][1:(T0+j)],Tr2[17,][10:21][1:(T0+j)],Tr2[18,][10:21][1:(T0+j)],Tr2[19,][10:21][1:(T0+j)],Tr2[20,][10:21][1:(T0+j)],Tr2[21,][10:21][1:(T0+j)],Tr2[22,][10:21][1:(T0+j)],Tr2[23,][10:21][1:(T0+j)],Tr2[24,][10:21][1:(T0+j)],Tr2[25,][10:21][1:(T0+j)],Tr2[26,][10:21][1:(T0+j)],Tr2[27,][10:21][1:(T0+j)],Tr2[28,][10:21][1:(T0+j)],Tr2[29,][10:21][1:(T0+j)],Tr2[30,][10:21][1:(T0+j)] )

yy<-rbind(d1[10:21][1:(T0+j)],d2[10:21][1:(T0+j)],d3[10:21][1:(T0+j)],d4[10:21][1:(T0+j)],d5[10:21][1:(T0+j)],d6[10:21][1:(T0+j)],d7[10:21][1:(T0+j)],d8[10:21][1:(T0+j)],d9[10:21][1:(T0+j)],d10[10:21][1:(T0+j)],d11[10:21][1:(T0+j)],d12[10:21][1:(T0+j)],d13[10:21][1:(T0+j)],d14[10:21][1:(T0+j)],d15[10:21][1:(T0+j)],d16[10:21][1:(T0+j)],d17[10:21][1:(T0+j)],d18[10:21][1:(T0+j)],d19[10:21][1:(T0+j)],d20[10:21][1:(T0+j)],d21[10:21][1:(T0+j)],d22[10:21][1:(T0+j)],d23[10:21][1:(T0+j)],d24[10:21][1:(T0+j)],d25[10:21][1:(T0+j)],d26[10:21][1:(T0+j)],d27[10:21][1:(T0+j)],d28[10:21][1:(T0+j)],d29[10:21][1:(T0+j)],d30[10:21][1:(T0+j)] )

zz2<-rbind( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-rbind( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-rbind( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr2[1,][10:21][1:(T0+j)],Tr2[2,][10:21][1:(T0+j)],Tr2[3,][10:21][1:(T0+j)],Tr2[4,][10:21][1:(T0+j)],Tr2[5,][10:21][1:(T0+j)],Tr2[6,][10:21][1:(T0+j)],Tr2[7,][10:21][1:(T0+j)],Tr2[8,][10:21][1:(T0+j)],Tr2[9,][10:21][1:(T0+j)],Tr2[10,][10:21][1:(T0+j)],Tr2[11,][10:21][1:(T0+j)],Tr2[12,][10:21][1:(T0+j)],Tr2[13,][10:21][1:(T0+j)],Tr2[14,][10:21][1:(T0+j)],Tr2[15,][10:21][1:(T0+j)],Tr2[16,][10:21][1:(T0+j)],Tr2[17,][10:21][1:(T0+j)],Tr2[18,][10:21][1:(T0+j)],Tr2[19,][10:21][1:(T0+j)],Tr2[20,][10:21][1:(T0+j)],Tr2[21,][10:21][1:(T0+j)],Tr2[22,][10:21][1:(T0+j)],Tr2[23,][10:21][1:(T0+j)],Tr2[24,][10:21][1:(T0+j)],Tr2[25,][10:21][1:(T0+j)],Tr2[26,][10:21][1:(T0+j)],Tr2[27,][10:21][1:(T0+j)],Tr2[28,][10:21][1:(T0+j)],Tr2[29,][10:21][1:(T0+j)],Tr2[30,][10:21][1:(T0+j)] )

yy<-c(d1[10:21][1:(T0+j)],d2[10:21][1:(T0+j)],d3[10:21][1:(T0+j)],d4[10:21][1:(T0+j)],d5[10:21][1:(T0+j)],d6[10:21][1:(T0+j)],d7[10:21][1:(T0+j)],d8[10:21][1:(T0+j)],d9[10:21][1:(T0+j)],d10[10:21][1:(T0+j)],d11[10:21][1:(T0+j)],d12[10:21][1:(T0+j)],d13[10:21][1:(T0+j)],d14[10:21][1:(T0+j)],d15[10:21][1:(T0+j)],d16[10:21][1:(T0+j)],d17[10:21][1:(T0+j)],d18[10:21][1:(T0+j)],d19[10:21][1:(T0+j)],d20[10:21][1:(T0+j)],d21[10:21][1:(T0+j)],d22[10:21][1:(T0+j)],d23[10:21][1:(T0+j)],d24[10:21][1:(T0+j)],d25[10:21][1:(T0+j)],d26[10:21][1:(T0+j)],d27[10:21][1:(T0+j)],d28[10:21][1:(T0+j)],d29[10:21][1:(T0+j)],d30[10:21][1:(T0+j)] )


tt1<-c(rep(t1[10:21][1:(T0+j)],30))
tt2<-c(rep(t2[10:21][1:(T0+j)],30))

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

second_treatment11<-new_treatment[1]
second_treatment12<-new_treatment[2]
second_treatment13<-new_treatment[3]
second_treatment14<-new_treatment[4]
second_treatment15<-new_treatment[5]
second_treatment16<-new_treatment[6]
second_treatment17<-new_treatment[7]
second_treatment18<-new_treatment[8]
second_treatment19<-new_treatment[9]
second_treatment110<-new_treatment[10]
second_treatment111<-new_treatment[11]
second_treatment112<-new_treatment[12]
second_treatment113<-new_treatment[13]
second_treatment114<-new_treatment[14]
second_treatment115<-new_treatment[15]
second_treatment116<-new_treatment[16]
second_treatment117<-new_treatment[17]
second_treatment118<-new_treatment[18]
second_treatment119<-new_treatment[19]
second_treatment120<-new_treatment[20]
second_treatment121<-new_treatment[21]
second_treatment122<-new_treatment[22]
second_treatment123<-new_treatment[23]
second_treatment124<-new_treatment[24]
second_treatment125<-new_treatment[25]
second_treatment126<-new_treatment[26]
second_treatment127<-new_treatment[27]
second_treatment128<-new_treatment[28]
second_treatment129<-new_treatment[29]
second_treatment130<-new_treatment[30]

second_treatment1<-new_treatment




##====================================

#bootstrap 1#
#sd 1#

SS<-c()  #bootstrap sample size#
SSS<-c() #bootstrap sample size share#
boot1<-list()
for (b in 1:100){



T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-2),1)

#step 1: s=1#
s=1

j=1

SS[b]<-(T0+j)-S0+1
SSS[b]<-((T0+j)-S0+1)/((T0+j)-1+1)


DD<-c(Tr2[1,][10:21][S0:(T0+j)],Tr2[2,][10:21][S0:(T0+j)],Tr2[3,][10:21][S0:(T0+j)],Tr2[4,][10:21][S0:(T0+j)],Tr2[5,][10:21][S0:(T0+j)],Tr2[6,][10:21][S0:(T0+j)],Tr2[7,][10:21][S0:(T0+j)],Tr2[8,][10:21][S0:(T0+j)],Tr2[9,][10:21][S0:(T0+j)],Tr2[10,][10:21][S0:(T0+j)],Tr2[11,][10:21][S0:(T0+j)],Tr2[12,][10:21][S0:(T0+j)],Tr2[13,][10:21][S0:(T0+j)],Tr2[14,][10:21][S0:(T0+j)],Tr2[15,][10:21][S0:(T0+j)],Tr2[16,][10:21][S0:(T0+j)],Tr2[17,][10:21][S0:(T0+j)],Tr2[18,][10:21][S0:(T0+j)],Tr2[19,][10:21][S0:(T0+j)],Tr2[20,][10:21][S0:(T0+j)],Tr2[21,][10:21][S0:(T0+j)],Tr2[22,][10:21][S0:(T0+j)],Tr2[23,][10:21][S0:(T0+j)],Tr2[24,][10:21][S0:(T0+j)],Tr2[25,][10:21][S0:(T0+j)],Tr2[26,][10:21][S0:(T0+j)],Tr2[27,][10:21][S0:(T0+j)],Tr2[28,][10:21][S0:(T0+j)],Tr2[29,][10:21][S0:(T0+j)],Tr2[30,][10:21][S0:(T0+j)] )

yy<-c(d1[10:21][S0:(T0+j)],d2[10:21][S0:(T0+j)],d3[10:21][S0:(T0+j)],d4[10:21][S0:(T0+j)],d5[10:21][S0:(T0+j)],d6[10:21][S0:(T0+j)],d7[10:21][S0:(T0+j)],d8[10:21][S0:(T0+j)],d9[10:21][S0:(T0+j)],d10[10:21][S0:(T0+j)],d11[10:21][S0:(T0+j)],d12[10:21][S0:(T0+j)],d13[10:21][S0:(T0+j)],d14[10:21][S0:(T0+j)],d15[10:21][S0:(T0+j)],d16[10:21][S0:(T0+j)],d17[10:21][S0:(T0+j)],d18[10:21][S0:(T0+j)],d19[10:21][S0:(T0+j)],d20[10:21][S0:(T0+j)],d21[10:21][S0:(T0+j)],d22[10:21][S0:(T0+j)],d23[10:21][S0:(T0+j)],d24[10:21][S0:(T0+j)],d25[10:21][S0:(T0+j)],d26[10:21][S0:(T0+j)],d27[10:21][S0:(T0+j)],d28[10:21][S0:(T0+j)],d29[10:21][S0:(T0+j)],d30[10:21][S0:(T0+j)] )


tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr2[1,][10:21][S0:(T0+j)],Tr2[2,][10:21][S0:(T0+j)],Tr2[3,][10:21][S0:(T0+j)],Tr2[4,][10:21][S0:(T0+j)],Tr2[5,][10:21][S0:(T0+j)],Tr2[6,][10:21][S0:(T0+j)],Tr2[7,][10:21][S0:(T0+j)],Tr2[8,][10:21][S0:(T0+j)],Tr2[9,][10:21][S0:(T0+j)],Tr2[10,][10:21][S0:(T0+j)],Tr2[11,][10:21][S0:(T0+j)],Tr2[12,][10:21][S0:(T0+j)],Tr2[13,][10:21][S0:(T0+j)],Tr2[14,][10:21][S0:(T0+j)],Tr2[15,][10:21][S0:(T0+j)],Tr2[16,][10:21][S0:(T0+j)],Tr2[17,][10:21][S0:(T0+j)],Tr2[18,][10:21][S0:(T0+j)],Tr2[19,][10:21][S0:(T0+j)],Tr2[20,][10:21][S0:(T0+j)],Tr2[21,][10:21][S0:(T0+j)],Tr2[22,][10:21][S0:(T0+j)],Tr2[23,][10:21][S0:(T0+j)],Tr2[24,][10:21][S0:(T0+j)],Tr2[25,][10:21][S0:(T0+j)],Tr2[26,][10:21][S0:(T0+j)],Tr2[27,][10:21][S0:(T0+j)],Tr2[28,][10:21][S0:(T0+j)],Tr2[29,][10:21][S0:(T0+j)],Tr2[30,][10:21][S0:(T0+j)] )

yy<-rbind(d1[10:21][S0:(T0+j)],d2[10:21][S0:(T0+j)],d3[10:21][S0:(T0+j)],d4[10:21][S0:(T0+j)],d5[10:21][S0:(T0+j)],d6[10:21][S0:(T0+j)],d7[10:21][S0:(T0+j)],d8[10:21][S0:(T0+j)],d9[10:21][S0:(T0+j)],d10[10:21][S0:(T0+j)],d11[10:21][S0:(T0+j)],d12[10:21][S0:(T0+j)],d13[10:21][S0:(T0+j)],d14[10:21][S0:(T0+j)],d15[10:21][S0:(T0+j)],d16[10:21][S0:(T0+j)],d17[10:21][S0:(T0+j)],d18[10:21][S0:(T0+j)],d19[10:21][S0:(T0+j)],d20[10:21][S0:(T0+j)],d21[10:21][S0:(T0+j)],d22[10:21][S0:(T0+j)],d23[10:21][S0:(T0+j)],d24[10:21][S0:(T0+j)],d25[10:21][S0:(T0+j)],d26[10:21][S0:(T0+j)],d27[10:21][S0:(T0+j)],d28[10:21][S0:(T0+j)],d29[10:21][S0:(T0+j)],d30[10:21][S0:(T0+j)] )


zz2<-rbind( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-rbind( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-rbind( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr2[1,][10:21][S0:(T0+j)],Tr2[2,][10:21][S0:(T0+j)],Tr2[3,][10:21][S0:(T0+j)],Tr2[4,][10:21][S0:(T0+j)],Tr2[5,][10:21][S0:(T0+j)],Tr2[6,][10:21][S0:(T0+j)],Tr2[7,][10:21][S0:(T0+j)],Tr2[8,][10:21][S0:(T0+j)],Tr2[9,][10:21][S0:(T0+j)],Tr2[10,][10:21][S0:(T0+j)],Tr2[11,][10:21][S0:(T0+j)],Tr2[12,][10:21][S0:(T0+j)],Tr2[13,][10:21][S0:(T0+j)],Tr2[14,][10:21][S0:(T0+j)],Tr2[15,][10:21][S0:(T0+j)],Tr2[16,][10:21][S0:(T0+j)],Tr2[17,][10:21][S0:(T0+j)],Tr2[18,][10:21][S0:(T0+j)],Tr2[19,][10:21][S0:(T0+j)],Tr2[20,][10:21][S0:(T0+j)],Tr2[21,][10:21][S0:(T0+j)],Tr2[22,][10:21][S0:(T0+j)],Tr2[23,][10:21][S0:(T0+j)],Tr2[24,][10:21][S0:(T0+j)],Tr2[25,][10:21][S0:(T0+j)],Tr2[26,][10:21][S0:(T0+j)],Tr2[27,][10:21][S0:(T0+j)],Tr2[28,][10:21][S0:(T0+j)],Tr2[29,][10:21][S0:(T0+j)],Tr2[30,][10:21][S0:(T0+j)] )

yy<-c(d1[10:21][S0:(T0+j)],d2[10:21][S0:(T0+j)],d3[10:21][S0:(T0+j)],d4[10:21][S0:(T0+j)],d5[10:21][S0:(T0+j)],d6[10:21][S0:(T0+j)],d7[10:21][S0:(T0+j)],d8[10:21][S0:(T0+j)],d9[10:21][S0:(T0+j)],d10[10:21][S0:(T0+j)],d11[10:21][S0:(T0+j)],d12[10:21][S0:(T0+j)],d13[10:21][S0:(T0+j)],d14[10:21][S0:(T0+j)],d15[10:21][S0:(T0+j)],d16[10:21][S0:(T0+j)],d17[10:21][S0:(T0+j)],d18[10:21][S0:(T0+j)],d19[10:21][S0:(T0+j)],d20[10:21][S0:(T0+j)],d21[10:21][S0:(T0+j)],d22[10:21][S0:(T0+j)],d23[10:21][S0:(T0+j)],d24[10:21][S0:(T0+j)],d25[10:21][S0:(T0+j)],d26[10:21][S0:(T0+j)],d27[10:21][S0:(T0+j)],d28[10:21][S0:(T0+j)],d29[10:21][S0:(T0+j)],d30[10:21][S0:(T0+j)] )


tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)



var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


second_treatment11_sd<-var[1]^0.5
second_treatment12_sd<-var[2]^0.5
second_treatment13_sd<-var[3]^0.5
second_treatment14_sd<-var[4]^0.5
second_treatment15_sd<-var[5]^0.5
second_treatment16_sd<-var[6]^0.5
second_treatment17_sd<-var[7]^0.5
second_treatment18_sd<-var[8]^0.5
second_treatment19_sd<-var[9]^0.5
second_treatment110_sd<-var[10]^0.5
second_treatment111_sd<-var[11]^0.5
second_treatment112_sd<-var[12]^0.5
second_treatment113_sd<-var[13]^0.5
second_treatment114_sd<-var[14]^0.5
second_treatment115_sd<-var[15]^0.5
second_treatment116_sd<-var[16]^0.5
second_treatment117_sd<-var[17]^0.5
second_treatment118_sd<-var[18]^0.5
second_treatment119_sd<-var[19]^0.5
second_treatment120_sd<-var[20]^0.5
second_treatment121_sd<-var[21]^0.5
second_treatment122_sd<-var[22]^0.5
second_treatment123_sd<-var[23]^0.5
second_treatment124_sd<-var[24]^0.5
second_treatment125_sd<-var[25]^0.5
second_treatment126_sd<-var[26]^0.5
second_treatment127_sd<-var[27]^0.5
second_treatment128_sd<-var[28]^0.5
second_treatment129_sd<-var[29]^0.5
second_treatment130_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper1<-c()
second_lower1<-c()
for(i in 1:30){
second_upper1[i]<-second_treatment1[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower1[i]<-second_treatment1[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper1
second_lower1

mean(second_treatment1)/(sum(var)/900)^0.5




#step 2: s=2#

T0<-min(TT0)

s=2

DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],30))
tt2<-c(rep(t2[10:21][1:(T0+j)],30))

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-rbind( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-rbind( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-rbind( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

second_treatment21<-new_treatment[1]
second_treatment22<-new_treatment[2]
second_treatment23<-new_treatment[3]
second_treatment24<-new_treatment[4]
second_treatment25<-new_treatment[5]
second_treatment26<-new_treatment[6]
second_treatment27<-new_treatment[7]
second_treatment28<-new_treatment[8]
second_treatment29<-new_treatment[9]
second_treatment210<-new_treatment[10]
second_treatment211<-new_treatment[11]
second_treatment212<-new_treatment[12]
second_treatment213<-new_treatment[13]
second_treatment214<-new_treatment[14]
second_treatment215<-new_treatment[15]
second_treatment216<-new_treatment[16]
second_treatment217<-new_treatment[17]
second_treatment218<-new_treatment[18]
second_treatment219<-new_treatment[19]
second_treatment220<-new_treatment[20]
second_treatment221<-new_treatment[21]
second_treatment222<-new_treatment[22]
second_treatment223<-new_treatment[23]
second_treatment224<-new_treatment[24]
second_treatment225<-new_treatment[25]
second_treatment226<-new_treatment[26]
second_treatment227<-new_treatment[27]
second_treatment228<-new_treatment[28]
second_treatment229<-new_treatment[29]
second_treatment230<-new_treatment[30]

second_treatment2<-new_treatment





##====================================

#bootstrap 2#
#sd 2#

#step 2: s=2#
s=2

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=2

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

zz2<-rbind( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-rbind( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-rbind( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


second_treatment21_sd<-var[1]^0.5
second_treatment22_sd<-var[2]^0.5
second_treatment23_sd<-var[3]^0.5
second_treatment24_sd<-var[4]^0.5
second_treatment25_sd<-var[5]^0.5
second_treatment26_sd<-var[6]^0.5
second_treatment27_sd<-var[7]^0.5
second_treatment28_sd<-var[8]^0.5
second_treatment29_sd<-var[9]^0.5
second_treatment210_sd<-var[10]^0.5
second_treatment211_sd<-var[11]^0.5
second_treatment212_sd<-var[12]^0.5
second_treatment213_sd<-var[13]^0.5
second_treatment214_sd<-var[14]^0.5
second_treatment215_sd<-var[15]^0.5
second_treatment216_sd<-var[16]^0.5
second_treatment217_sd<-var[17]^0.5
second_treatment218_sd<-var[18]^0.5
second_treatment219_sd<-var[19]^0.5
second_treatment220_sd<-var[20]^0.5
second_treatment221_sd<-var[21]^0.5
second_treatment222_sd<-var[22]^0.5
second_treatment223_sd<-var[23]^0.5
second_treatment224_sd<-var[24]^0.5
second_treatment225_sd<-var[25]^0.5
second_treatment226_sd<-var[26]^0.5
second_treatment227_sd<-var[27]^0.5
second_treatment228_sd<-var[28]^0.5
second_treatment229_sd<-var[29]^0.5
second_treatment230_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper2<-c()
second_lower2<-c()
for(i in 1:30){
second_upper2[i]<-second_treatment2[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower2[i]<-second_treatment2[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper2
second_lower2

mean(second_treatment2)/(sum(var)/900)^0.5







#step 3: s=3#

T0<-min(TT0)

s=3

DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],Tr2[1,][10:21][T0+2],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],Tr2[2,][10:21][T0+2],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],Tr2[3,][10:21][T0+2],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],Tr2[4,][10:21][T0+2],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],Tr2[5,][10:21][T0+2],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],Tr2[6,][10:21][T0+2],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],Tr2[7,][10:21][T0+2],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],Tr2[8,][10:21][T0+2],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],Tr2[9,][10:21][T0+2],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],Tr2[10,][10:21][T0+2],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],Tr2[11,][10:21][T0+2],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],Tr2[12,][10:21][T0+2],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],Tr2[13,][10:21][T0+2],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],Tr2[14,][10:21][T0+2],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],Tr2[15,][10:21][T0+2],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],Tr2[16,][10:21][T0+2],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],Tr2[17,][10:21][T0+2],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],Tr2[18,][10:21][T0+2],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],Tr2[19,][10:21][T0+2],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],Tr2[20,][10:21][T0+2],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],Tr2[21,][10:21][T0+2],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],Tr2[22,][10:21][T0+2],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],Tr2[23,][10:21][T0+2],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],Tr2[24,][10:21][T0+2],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],Tr2[25,][10:21][T0+2],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],Tr2[26,][10:21][T0+2],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],Tr2[27,][10:21][T0+2],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],Tr2[28,][10:21][T0+2],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],Tr2[29,][10:21][T0+2],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],Tr2[30,][10:21][T0+2],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,second_treatment21,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,second_treatment22,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,second_treatment23,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,second_treatment24,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,second_treatment25,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,second_treatment26,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,second_treatment27,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,second_treatment28,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,second_treatment29,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,second_treatment210,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,second_treatment211,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,second_treatment212,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,second_treatment213,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,second_treatment214,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,second_treatment215,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,second_treatment216,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,second_treatment217,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,second_treatment218,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,second_treatment219,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,second_treatment220,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,second_treatment221,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,second_treatment222,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,second_treatment223,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,second_treatment224,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,second_treatment225,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,second_treatment226,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,second_treatment227,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,second_treatment228,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,second_treatment229,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,second_treatment230,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],30))
tt2<-c(rep(t2[10:21][1:(T0+j)],30))

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-rbind( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-rbind( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-rbind( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

second_treatment31<-new_treatment[1]
second_treatment32<-new_treatment[2]
second_treatment33<-new_treatment[3]
second_treatment34<-new_treatment[4]
second_treatment35<-new_treatment[5]
second_treatment36<-new_treatment[6]
second_treatment37<-new_treatment[7]
second_treatment38<-new_treatment[8]
second_treatment39<-new_treatment[9]
second_treatment310<-new_treatment[10]
second_treatment311<-new_treatment[11]
second_treatment312<-new_treatment[12]
second_treatment313<-new_treatment[13]
second_treatment314<-new_treatment[14]
second_treatment315<-new_treatment[15]
second_treatment316<-new_treatment[16]
second_treatment317<-new_treatment[17]
second_treatment318<-new_treatment[18]
second_treatment319<-new_treatment[19]
second_treatment320<-new_treatment[20]
second_treatment321<-new_treatment[21]
second_treatment322<-new_treatment[22]
second_treatment323<-new_treatment[23]
second_treatment324<-new_treatment[24]
second_treatment325<-new_treatment[25]
second_treatment326<-new_treatment[26]
second_treatment327<-new_treatment[27]
second_treatment328<-new_treatment[28]
second_treatment329<-new_treatment[29]
second_treatment330<-new_treatment[30]

second_treatment3<-new_treatment





##====================================

#bootstrap 3#
#sd 3#

#step 3: s=3#
s=3

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=3

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],Tr2[1,][10:21][T0+2],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],Tr2[2,][10:21][T0+2],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],Tr2[3,][10:21][T0+2],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],Tr2[4,][10:21][T0+2],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],Tr2[5,][10:21][T0+2],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],Tr2[6,][10:21][T0+2],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],Tr2[7,][10:21][T0+2],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],Tr2[8,][10:21][T0+2],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],Tr2[9,][10:21][T0+2],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],Tr2[10,][10:21][T0+2],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],Tr2[11,][10:21][T0+2],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],Tr2[12,][10:21][T0+2],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],Tr2[13,][10:21][T0+2],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],Tr2[14,][10:21][T0+2],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],Tr2[15,][10:21][T0+2],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],Tr2[16,][10:21][T0+2],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],Tr2[17,][10:21][T0+2],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],Tr2[18,][10:21][T0+2],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],Tr2[19,][10:21][T0+2],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],Tr2[20,][10:21][T0+2],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],Tr2[21,][10:21][T0+2],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],Tr2[22,][10:21][T0+2],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],Tr2[23,][10:21][T0+2],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],Tr2[24,][10:21][T0+2],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],Tr2[25,][10:21][T0+2],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],Tr2[26,][10:21][T0+2],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],Tr2[27,][10:21][T0+2],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],Tr2[28,][10:21][T0+2],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],Tr2[29,][10:21][T0+2],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],Tr2[30,][10:21][T0+2],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,second_treatment21,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,second_treatment22,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,second_treatment23,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,second_treatment24,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,second_treatment25,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,second_treatment26,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,second_treatment27,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,second_treatment28,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,second_treatment29,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,second_treatment210,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,second_treatment211,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,second_treatment212,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,second_treatment213,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,second_treatment214,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,second_treatment215,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,second_treatment216,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,second_treatment217,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,second_treatment218,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,second_treatment219,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,second_treatment220,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,second_treatment221,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,second_treatment222,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,second_treatment223,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,second_treatment224,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,second_treatment225,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,second_treatment226,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,second_treatment227,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,second_treatment228,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,second_treatment229,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,second_treatment230,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

zz2<-rbind( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-rbind( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-rbind( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


second_treatment31_sd<-var[1]^0.5
second_treatment32_sd<-var[2]^0.5
second_treatment33_sd<-var[3]^0.5
second_treatment34_sd<-var[4]^0.5
second_treatment35_sd<-var[5]^0.5
second_treatment36_sd<-var[6]^0.5
second_treatment37_sd<-var[7]^0.5
second_treatment38_sd<-var[8]^0.5
second_treatment39_sd<-var[9]^0.5
second_treatment310_sd<-var[10]^0.5
second_treatment311_sd<-var[11]^0.5
second_treatment312_sd<-var[12]^0.5
second_treatment313_sd<-var[13]^0.5
second_treatment314_sd<-var[14]^0.5
second_treatment315_sd<-var[15]^0.5
second_treatment316_sd<-var[16]^0.5
second_treatment317_sd<-var[17]^0.5
second_treatment318_sd<-var[18]^0.5
second_treatment319_sd<-var[19]^0.5
second_treatment320_sd<-var[20]^0.5
second_treatment321_sd<-var[21]^0.5
second_treatment322_sd<-var[22]^0.5
second_treatment323_sd<-var[23]^0.5
second_treatment324_sd<-var[24]^0.5
second_treatment325_sd<-var[25]^0.5
second_treatment326_sd<-var[26]^0.5
second_treatment327_sd<-var[27]^0.5
second_treatment328_sd<-var[28]^0.5
second_treatment329_sd<-var[29]^0.5
second_treatment330_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper3<-c()
second_lower3<-c()
for(i in 1:30){
second_upper3[i]<-second_treatment3[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower3[i]<-second_treatment3[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper3
second_lower3

mean(second_treatment3)/(sum(var)/900)^0.5









#step 4: s=4#

T0<-min(TT0)

s=4

DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],Tr2[1,][10:21][T0+2],Tr2[1,][10:21][T0+3],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],Tr2[2,][10:21][T0+2],Tr2[2,][10:21][T0+3],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],Tr2[3,][10:21][T0+2],Tr2[3,][10:21][T0+3],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],Tr2[4,][10:21][T0+2],Tr2[4,][10:21][T0+3],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],Tr2[5,][10:21][T0+2],Tr2[5,][10:21][T0+3],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],Tr2[6,][10:21][T0+2],Tr2[6,][10:21][T0+3],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],Tr2[7,][10:21][T0+2],Tr2[7,][10:21][T0+3],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],Tr2[8,][10:21][T0+2],Tr2[8,][10:21][T0+3],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],Tr2[9,][10:21][T0+2],Tr2[9,][10:21][T0+3],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],Tr2[10,][10:21][T0+2],Tr2[10,][10:21][T0+3],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],Tr2[11,][10:21][T0+2],Tr2[11,][10:21][T0+3],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],Tr2[12,][10:21][T0+2],Tr2[12,][10:21][T0+3],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],Tr2[13,][10:21][T0+2],Tr2[13,][10:21][T0+3],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],Tr2[14,][10:21][T0+2],Tr2[14,][10:21][T0+3],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],Tr2[15,][10:21][T0+2],Tr2[15,][10:21][T0+3],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],Tr2[16,][10:21][T0+2],Tr2[16,][10:21][T0+3],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],Tr2[17,][10:21][T0+2],Tr2[17,][10:21][T0+3],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],Tr2[18,][10:21][T0+2],Tr2[18,][10:21][T0+3],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],Tr2[19,][10:21][T0+2],Tr2[19,][10:21][T0+3],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],Tr2[20,][10:21][T0+2],Tr2[20,][10:21][T0+3],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],Tr2[21,][10:21][T0+2],Tr2[21,][10:21][T0+3],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],Tr2[22,][10:21][T0+2],Tr2[22,][10:21][T0+3],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],Tr2[23,][10:21][T0+2],Tr2[23,][10:21][T0+3],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],Tr2[24,][10:21][T0+2],Tr2[24,][10:21][T0+3],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],Tr2[25,][10:21][T0+2],Tr2[25,][10:21][T0+3],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],Tr2[26,][10:21][T0+2],Tr2[26,][10:21][T0+3],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],Tr2[27,][10:21][T0+2],Tr2[27,][10:21][T0+3],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],Tr2[28,][10:21][T0+2],Tr2[28,][10:21][T0+3],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],Tr2[29,][10:21][T0+2],Tr2[29,][10:21][T0+3],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],Tr2[30,][10:21][T0+2],Tr2[30,][10:21][T0+3],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,second_treatment21,second_treatment31,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,second_treatment22,second_treatment32,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,second_treatment23,second_treatment33,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,second_treatment24,second_treatment34,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,second_treatment25,second_treatment35,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,second_treatment26,second_treatment36,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,second_treatment27,second_treatment37,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,second_treatment28,second_treatment38,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,second_treatment29,second_treatment39,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,second_treatment210,second_treatment310,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,second_treatment211,second_treatment311,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,second_treatment212,second_treatment312,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,second_treatment213,second_treatment313,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,second_treatment214,second_treatment314,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,second_treatment215,second_treatment315,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,second_treatment216,second_treatment316,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,second_treatment217,second_treatment317,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,second_treatment218,second_treatment318,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,second_treatment219,second_treatment319,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,second_treatment220,second_treatment320,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,second_treatment221,second_treatment321,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,second_treatment222,second_treatment322,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,second_treatment223,second_treatment323,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,second_treatment224,second_treatment324,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,second_treatment225,second_treatment325,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,second_treatment226,second_treatment326,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,second_treatment227,second_treatment327,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,second_treatment228,second_treatment328,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,second_treatment229,second_treatment329,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,second_treatment230,second_treatment330,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],30))
tt2<-c(rep(t2[10:21][1:(T0+j)],30))

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-rbind( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-rbind( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-rbind( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

second_treatment41<-new_treatment[1]
second_treatment42<-new_treatment[2]
second_treatment43<-new_treatment[3]
second_treatment44<-new_treatment[4]
second_treatment45<-new_treatment[5]
second_treatment46<-new_treatment[6]
second_treatment47<-new_treatment[7]
second_treatment48<-new_treatment[8]
second_treatment49<-new_treatment[9]
second_treatment410<-new_treatment[10]
second_treatment411<-new_treatment[11]
second_treatment412<-new_treatment[12]
second_treatment413<-new_treatment[13]
second_treatment414<-new_treatment[14]
second_treatment415<-new_treatment[15]
second_treatment416<-new_treatment[16]
second_treatment417<-new_treatment[17]
second_treatment418<-new_treatment[18]
second_treatment419<-new_treatment[19]
second_treatment420<-new_treatment[20]
second_treatment421<-new_treatment[21]
second_treatment422<-new_treatment[22]
second_treatment423<-new_treatment[23]
second_treatment424<-new_treatment[24]
second_treatment425<-new_treatment[25]
second_treatment426<-new_treatment[26]
second_treatment427<-new_treatment[27]
second_treatment428<-new_treatment[28]
second_treatment429<-new_treatment[29]
second_treatment430<-new_treatment[30]

second_treatment4<-new_treatment





##====================================

#bootstrap 4#
#sd 4#

#step 4: s=4#
s=4

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=4

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],Tr2[1,][10:21][T0+2],Tr2[1,][10:21][T0+3],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],Tr2[2,][10:21][T0+2],Tr2[2,][10:21][T0+3],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],Tr2[3,][10:21][T0+2],Tr2[3,][10:21][T0+3],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],Tr2[4,][10:21][T0+2],Tr2[4,][10:21][T0+3],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],Tr2[5,][10:21][T0+2],Tr2[5,][10:21][T0+3],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],Tr2[6,][10:21][T0+2],Tr2[6,][10:21][T0+3],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],Tr2[7,][10:21][T0+2],Tr2[7,][10:21][T0+3],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],Tr2[8,][10:21][T0+2],Tr2[8,][10:21][T0+3],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],Tr2[9,][10:21][T0+2],Tr2[9,][10:21][T0+3],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],Tr2[10,][10:21][T0+2],Tr2[10,][10:21][T0+3],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],Tr2[11,][10:21][T0+2],Tr2[11,][10:21][T0+3],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],Tr2[12,][10:21][T0+2],Tr2[12,][10:21][T0+3],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],Tr2[13,][10:21][T0+2],Tr2[13,][10:21][T0+3],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],Tr2[14,][10:21][T0+2],Tr2[14,][10:21][T0+3],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],Tr2[15,][10:21][T0+2],Tr2[15,][10:21][T0+3],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],Tr2[16,][10:21][T0+2],Tr2[16,][10:21][T0+3],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],Tr2[17,][10:21][T0+2],Tr2[17,][10:21][T0+3],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],Tr2[18,][10:21][T0+2],Tr2[18,][10:21][T0+3],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],Tr2[19,][10:21][T0+2],Tr2[19,][10:21][T0+3],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],Tr2[20,][10:21][T0+2],Tr2[20,][10:21][T0+3],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],Tr2[21,][10:21][T0+2],Tr2[21,][10:21][T0+3],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],Tr2[22,][10:21][T0+2],Tr2[22,][10:21][T0+3],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],Tr2[23,][10:21][T0+2],Tr2[23,][10:21][T0+3],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],Tr2[24,][10:21][T0+2],Tr2[24,][10:21][T0+3],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],Tr2[25,][10:21][T0+2],Tr2[25,][10:21][T0+3],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],Tr2[26,][10:21][T0+2],Tr2[26,][10:21][T0+3],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],Tr2[27,][10:21][T0+2],Tr2[27,][10:21][T0+3],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],Tr2[28,][10:21][T0+2],Tr2[28,][10:21][T0+3],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],Tr2[29,][10:21][T0+2],Tr2[29,][10:21][T0+3],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],Tr2[30,][10:21][T0+2],Tr2[30,][10:21][T0+3],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,second_treatment21,second_treatment31,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,second_treatment22,second_treatment32,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,second_treatment23,second_treatment33,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,second_treatment24,second_treatment34,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,second_treatment25,second_treatment35,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,second_treatment26,second_treatment36,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,second_treatment27,second_treatment37,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,second_treatment28,second_treatment38,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,second_treatment29,second_treatment39,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,second_treatment210,second_treatment310,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,second_treatment211,second_treatment311,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,second_treatment212,second_treatment312,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,second_treatment213,second_treatment313,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,second_treatment214,second_treatment314,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,second_treatment215,second_treatment315,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,second_treatment216,second_treatment316,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,second_treatment217,second_treatment317,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,second_treatment218,second_treatment318,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,second_treatment219,second_treatment319,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,second_treatment220,second_treatment320,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,second_treatment221,second_treatment321,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,second_treatment222,second_treatment322,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,second_treatment223,second_treatment323,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,second_treatment224,second_treatment324,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,second_treatment225,second_treatment325,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,second_treatment226,second_treatment326,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,second_treatment227,second_treatment327,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,second_treatment228,second_treatment328,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,second_treatment229,second_treatment329,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,second_treatment230,second_treatment330,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

zz2<-rbind( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-rbind( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-rbind( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


second_treatment41_sd<-var[1]^0.5
second_treatment42_sd<-var[2]^0.5
second_treatment43_sd<-var[3]^0.5
second_treatment44_sd<-var[4]^0.5
second_treatment45_sd<-var[5]^0.5
second_treatment46_sd<-var[6]^0.5
second_treatment47_sd<-var[7]^0.5
second_treatment48_sd<-var[8]^0.5
second_treatment49_sd<-var[9]^0.5
second_treatment410_sd<-var[10]^0.5
second_treatment411_sd<-var[11]^0.5
second_treatment412_sd<-var[12]^0.5
second_treatment413_sd<-var[13]^0.5
second_treatment414_sd<-var[14]^0.5
second_treatment415_sd<-var[15]^0.5
second_treatment416_sd<-var[16]^0.5
second_treatment417_sd<-var[17]^0.5
second_treatment418_sd<-var[18]^0.5
second_treatment419_sd<-var[19]^0.5
second_treatment420_sd<-var[20]^0.5
second_treatment421_sd<-var[21]^0.5
second_treatment422_sd<-var[22]^0.5
second_treatment423_sd<-var[23]^0.5
second_treatment424_sd<-var[24]^0.5
second_treatment425_sd<-var[25]^0.5
second_treatment426_sd<-var[26]^0.5
second_treatment427_sd<-var[27]^0.5
second_treatment428_sd<-var[28]^0.5
second_treatment439_sd<-var[29]^0.5
second_treatment430_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper4<-c()
second_lower4<-c()
for(i in 1:30){
second_upper4[i]<-second_treatment4[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower4[i]<-second_treatment4[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper4
second_lower4

mean(second_treatment4)/(sum(var)/900)^0.5










#step 5: s=5#

T0<-min(TT0)

s=5

DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],Tr2[1,][10:21][T0+2],Tr2[1,][10:21][T0+3],Tr2[1,][10:21][T0+4],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],Tr2[2,][10:21][T0+2],Tr2[2,][10:21][T0+3],Tr2[2,][10:21][T0+4],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],Tr2[3,][10:21][T0+2],Tr2[3,][10:21][T0+3],Tr2[3,][10:21][T0+4],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],Tr2[4,][10:21][T0+2],Tr2[4,][10:21][T0+3],Tr2[4,][10:21][T0+4],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],Tr2[5,][10:21][T0+2],Tr2[5,][10:21][T0+3],Tr2[5,][10:21][T0+4],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],Tr2[6,][10:21][T0+2],Tr2[6,][10:21][T0+3],Tr2[6,][10:21][T0+4],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],Tr2[7,][10:21][T0+2],Tr2[7,][10:21][T0+3],Tr2[7,][10:21][T0+4],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],Tr2[8,][10:21][T0+2],Tr2[8,][10:21][T0+3],Tr2[8,][10:21][T0+4],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],Tr2[9,][10:21][T0+2],Tr2[9,][10:21][T0+3],Tr2[9,][10:21][T0+4],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],Tr2[10,][10:21][T0+2],Tr2[10,][10:21][T0+3],Tr2[10,][10:21][T0+4],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],Tr2[11,][10:21][T0+2],Tr2[11,][10:21][T0+3],Tr2[11,][10:21][T0+4],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],Tr2[12,][10:21][T0+2],Tr2[12,][10:21][T0+3],Tr2[12,][10:21][T0+4],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],Tr2[13,][10:21][T0+2],Tr2[13,][10:21][T0+3],Tr2[13,][10:21][T0+4],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],Tr2[14,][10:21][T0+2],Tr2[14,][10:21][T0+3],Tr2[14,][10:21][T0+4],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],Tr2[15,][10:21][T0+2],Tr2[15,][10:21][T0+3],Tr2[15,][10:21][T0+4],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],Tr2[16,][10:21][T0+2],Tr2[16,][10:21][T0+3],Tr2[16,][10:21][T0+4],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],Tr2[17,][10:21][T0+2],Tr2[17,][10:21][T0+3],Tr2[17,][10:21][T0+4],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],Tr2[18,][10:21][T0+2],Tr2[18,][10:21][T0+3],Tr2[18,][10:21][T0+4],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],Tr2[19,][10:21][T0+2],Tr2[19,][10:21][T0+3],Tr2[19,][10:21][T0+4],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],Tr2[20,][10:21][T0+2],Tr2[20,][10:21][T0+3],Tr2[20,][10:21][T0+4],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],Tr2[21,][10:21][T0+2],Tr2[21,][10:21][T0+3],Tr2[21,][10:21][T0+4],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],Tr2[22,][10:21][T0+2],Tr2[22,][10:21][T0+3],Tr2[22,][10:21][T0+4],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],Tr2[23,][10:21][T0+2],Tr2[23,][10:21][T0+3],Tr2[23,][10:21][T0+4],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],Tr2[24,][10:21][T0+2],Tr2[24,][10:21][T0+3],Tr2[24,][10:21][T0+4],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],Tr2[25,][10:21][T0+2],Tr2[25,][10:21][T0+3],Tr2[25,][10:21][T0+4],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],Tr2[26,][10:21][T0+2],Tr2[26,][10:21][T0+3],Tr2[26,][10:21][T0+4],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],Tr2[27,][10:21][T0+2],Tr2[27,][10:21][T0+3],Tr2[27,][10:21][T0+4],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],Tr2[28,][10:21][T0+2],Tr2[28,][10:21][T0+3],Tr2[28,][10:21][T0+4],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],Tr2[29,][10:21][T0+2],Tr2[29,][10:21][T0+3],Tr2[29,][10:21][T0+4],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],Tr2[30,][10:21][T0+2],Tr2[30,][10:21][T0+3],Tr2[30,][10:21][T0+4],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,second_treatment21,second_treatment31,second_treatment41,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,second_treatment22,second_treatment32,second_treatment42,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,second_treatment23,second_treatment33,second_treatment43,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,second_treatment24,second_treatment34,second_treatment44,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,second_treatment25,second_treatment35,second_treatment45,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,second_treatment26,second_treatment36,second_treatment46,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,second_treatment27,second_treatment37,second_treatment47,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,second_treatment28,second_treatment38,second_treatment48,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,second_treatment29,second_treatment39,second_treatment49,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,second_treatment210,second_treatment310,second_treatment410,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,second_treatment211,second_treatment311,second_treatment411,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,second_treatment212,second_treatment312,second_treatment412,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,second_treatment213,second_treatment313,second_treatment413,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,second_treatment214,second_treatment314,second_treatment414,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,second_treatment215,second_treatment315,second_treatment415,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,second_treatment216,second_treatment316,second_treatment416,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,second_treatment217,second_treatment317,second_treatment417,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,second_treatment218,second_treatment318,second_treatment418,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,second_treatment219,second_treatment319,second_treatment419,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,second_treatment220,second_treatment320,second_treatment420,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,second_treatment221,second_treatment321,second_treatment421,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,second_treatment222,second_treatment322,second_treatment422,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,second_treatment223,second_treatment323,second_treatment423,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,second_treatment224,second_treatment324,second_treatment424,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,second_treatment225,second_treatment325,second_treatment425,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,second_treatment226,second_treatment326,second_treatment426,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,second_treatment227,second_treatment327,second_treatment427,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,second_treatment228,second_treatment328,second_treatment428,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,second_treatment229,second_treatment329,second_treatment429,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,second_treatment230,second_treatment330,second_treatment430,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],30))
tt2<-c(rep(t2[10:21][1:(T0+j)],30))

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-rbind( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-rbind( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-rbind( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

second_treatment51<-new_treatment[1]
second_treatment52<-new_treatment[2]
second_treatment53<-new_treatment[3]
second_treatment54<-new_treatment[4]
second_treatment55<-new_treatment[5]
second_treatment56<-new_treatment[6]
second_treatment57<-new_treatment[7]
second_treatment58<-new_treatment[8]
second_treatment59<-new_treatment[9]
second_treatment510<-new_treatment[10]
second_treatment511<-new_treatment[11]
second_treatment512<-new_treatment[12]
second_treatment513<-new_treatment[13]
second_treatment514<-new_treatment[14]
second_treatment515<-new_treatment[15]
second_treatment516<-new_treatment[16]
second_treatment517<-new_treatment[17]
second_treatment518<-new_treatment[18]
second_treatment519<-new_treatment[19]
second_treatment520<-new_treatment[20]
second_treatment521<-new_treatment[21]
second_treatment522<-new_treatment[22]
second_treatment523<-new_treatment[23]
second_treatment524<-new_treatment[24]
second_treatment525<-new_treatment[25]
second_treatment526<-new_treatment[26]
second_treatment527<-new_treatment[27]
second_treatment528<-new_treatment[28]
second_treatment529<-new_treatment[29]
second_treatment530<-new_treatment[30]

second_treatment5<-new_treatment





##====================================

#bootstrap 5#
#sd 5#

#step 5: s=5#
s=5

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=5

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],Tr2[1,][10:21][T0+2],Tr2[1,][10:21][T0+3],Tr2[1,][10:21][T0+4],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],Tr2[2,][10:21][T0+2],Tr2[2,][10:21][T0+3],Tr2[2,][10:21][T0+4],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],Tr2[3,][10:21][T0+2],Tr2[3,][10:21][T0+3],Tr2[3,][10:21][T0+4],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],Tr2[4,][10:21][T0+2],Tr2[4,][10:21][T0+3],Tr2[4,][10:21][T0+4],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],Tr2[5,][10:21][T0+2],Tr2[5,][10:21][T0+3],Tr2[5,][10:21][T0+4],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],Tr2[6,][10:21][T0+2],Tr2[6,][10:21][T0+3],Tr2[6,][10:21][T0+4],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],Tr2[7,][10:21][T0+2],Tr2[7,][10:21][T0+3],Tr2[7,][10:21][T0+4],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],Tr2[8,][10:21][T0+2],Tr2[8,][10:21][T0+3],Tr2[8,][10:21][T0+4],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],Tr2[9,][10:21][T0+2],Tr2[9,][10:21][T0+3],Tr2[9,][10:21][T0+4],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],Tr2[10,][10:21][T0+2],Tr2[10,][10:21][T0+3],Tr2[10,][10:21][T0+4],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],Tr2[11,][10:21][T0+2],Tr2[11,][10:21][T0+3],Tr2[11,][10:21][T0+4],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],Tr2[12,][10:21][T0+2],Tr2[12,][10:21][T0+3],Tr2[12,][10:21][T0+4],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],Tr2[13,][10:21][T0+2],Tr2[13,][10:21][T0+3],Tr2[13,][10:21][T0+4],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],Tr2[14,][10:21][T0+2],Tr2[14,][10:21][T0+3],Tr2[14,][10:21][T0+4],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],Tr2[15,][10:21][T0+2],Tr2[15,][10:21][T0+3],Tr2[15,][10:21][T0+4],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],Tr2[16,][10:21][T0+2],Tr2[16,][10:21][T0+3],Tr2[16,][10:21][T0+4],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],Tr2[17,][10:21][T0+2],Tr2[17,][10:21][T0+3],Tr2[17,][10:21][T0+4],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],Tr2[18,][10:21][T0+2],Tr2[18,][10:21][T0+3],Tr2[18,][10:21][T0+4],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],Tr2[19,][10:21][T0+2],Tr2[19,][10:21][T0+3],Tr2[19,][10:21][T0+4],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],Tr2[20,][10:21][T0+2],Tr2[20,][10:21][T0+3],Tr2[20,][10:21][T0+4],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],Tr2[21,][10:21][T0+2],Tr2[21,][10:21][T0+3],Tr2[21,][10:21][T0+4],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],Tr2[22,][10:21][T0+2],Tr2[22,][10:21][T0+3],Tr2[22,][10:21][T0+4],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],Tr2[23,][10:21][T0+2],Tr2[23,][10:21][T0+3],Tr2[23,][10:21][T0+4],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],Tr2[24,][10:21][T0+2],Tr2[24,][10:21][T0+3],Tr2[24,][10:21][T0+4],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],Tr2[25,][10:21][T0+2],Tr2[25,][10:21][T0+3],Tr2[25,][10:21][T0+4],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],Tr2[26,][10:21][T0+2],Tr2[26,][10:21][T0+3],Tr2[26,][10:21][T0+4],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],Tr2[27,][10:21][T0+2],Tr2[27,][10:21][T0+3],Tr2[27,][10:21][T0+4],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],Tr2[28,][10:21][T0+2],Tr2[28,][10:21][T0+3],Tr2[28,][10:21][T0+4],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],Tr2[29,][10:21][T0+2],Tr2[29,][10:21][T0+3],Tr2[29,][10:21][T0+4],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],Tr2[30,][10:21][T0+2],Tr2[30,][10:21][T0+3],Tr2[30,][10:21][T0+4],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,second_treatment21,second_treatment31,second_treatment41,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,second_treatment22,second_treatment32,second_treatment42,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,second_treatment23,second_treatment33,second_treatment43,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,second_treatment24,second_treatment34,second_treatment44,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,second_treatment25,second_treatment35,second_treatment45,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,second_treatment26,second_treatment36,second_treatment46,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,second_treatment27,second_treatment37,second_treatment47,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,second_treatment28,second_treatment38,second_treatment48,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,second_treatment29,second_treatment39,second_treatment49,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,second_treatment210,second_treatment310,second_treatment410,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,second_treatment211,second_treatment311,second_treatment411,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,second_treatment212,second_treatment312,second_treatment412,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,second_treatment213,second_treatment313,second_treatment413,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,second_treatment214,second_treatment314,second_treatment414,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,second_treatment215,second_treatment315,second_treatment415,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,second_treatment216,second_treatment316,second_treatment416,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,second_treatment217,second_treatment317,second_treatment417,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,second_treatment218,second_treatment318,second_treatment418,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,second_treatment219,second_treatment319,second_treatment419,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,second_treatment220,second_treatment320,second_treatment420,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,second_treatment221,second_treatment321,second_treatment421,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,second_treatment222,second_treatment322,second_treatment422,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,second_treatment223,second_treatment323,second_treatment423,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,second_treatment224,second_treatment324,second_treatment424,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,second_treatment225,second_treatment325,second_treatment425,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,second_treatment226,second_treatment326,second_treatment426,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,second_treatment227,second_treatment327,second_treatment427,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,second_treatment228,second_treatment328,second_treatment428,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,second_treatment229,second_treatment329,second_treatment429,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,second_treatment230,second_treatment330,second_treatment430,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

zz2<-rbind( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-rbind( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-rbind( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


second_treatment51_sd<-var[1]^0.5
second_treatment52_sd<-var[2]^0.5
second_treatment53_sd<-var[3]^0.5
second_treatment54_sd<-var[4]^0.5
second_treatment55_sd<-var[5]^0.5
second_treatment56_sd<-var[6]^0.5
second_treatment57_sd<-var[7]^0.5
second_treatment58_sd<-var[8]^0.5
second_treatment59_sd<-var[9]^0.5
second_treatment510_sd<-var[10]^0.5
second_treatment511_sd<-var[11]^0.5
second_treatment512_sd<-var[12]^0.5
second_treatment513_sd<-var[13]^0.5
second_treatment514_sd<-var[14]^0.5
second_treatment515_sd<-var[15]^0.5
second_treatment516_sd<-var[16]^0.5
second_treatment517_sd<-var[17]^0.5
second_treatment518_sd<-var[18]^0.5
second_treatment519_sd<-var[19]^0.5
second_treatment520_sd<-var[20]^0.5
second_treatment521_sd<-var[21]^0.5
second_treatment522_sd<-var[22]^0.5
second_treatment523_sd<-var[23]^0.5
second_treatment524_sd<-var[24]^0.5
second_treatment525_sd<-var[25]^0.5
second_treatment526_sd<-var[26]^0.5
second_treatment527_sd<-var[27]^0.5
second_treatment528_sd<-var[28]^0.5
second_treatment539_sd<-var[29]^0.5
second_treatment530_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper5<-c()
second_lower5<-c()
for(i in 1:30){
second_upper5[i]<-second_treatment5[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower5[i]<-second_treatment5[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper5
second_lower5

mean(second_treatment5)/(sum(var)/900)^0.5








#step 6: s=6#

T0<-min(TT0)

s=6

DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],Tr2[1,][10:21][T0+2],Tr2[1,][10:21][T0+3],Tr2[1,][10:21][T0+4],Tr2[1,][10:21][T0+5],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],Tr2[2,][10:21][T0+2],Tr2[2,][10:21][T0+3],Tr2[2,][10:21][T0+4],Tr2[2,][10:21][T0+5],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],Tr2[3,][10:21][T0+2],Tr2[3,][10:21][T0+3],Tr2[3,][10:21][T0+4],Tr2[3,][10:21][T0+5],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],Tr2[4,][10:21][T0+2],Tr2[4,][10:21][T0+3],Tr2[4,][10:21][T0+4],Tr2[4,][10:21][T0+5],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],Tr2[5,][10:21][T0+2],Tr2[5,][10:21][T0+3],Tr2[5,][10:21][T0+4],Tr2[5,][10:21][T0+5],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],Tr2[6,][10:21][T0+2],Tr2[6,][10:21][T0+3],Tr2[6,][10:21][T0+4],Tr2[6,][10:21][T0+5],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],Tr2[7,][10:21][T0+2],Tr2[7,][10:21][T0+3],Tr2[7,][10:21][T0+4],Tr2[7,][10:21][T0+5],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],Tr2[8,][10:21][T0+2],Tr2[8,][10:21][T0+3],Tr2[8,][10:21][T0+4],Tr2[8,][10:21][T0+5],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],Tr2[9,][10:21][T0+2],Tr2[9,][10:21][T0+3],Tr2[9,][10:21][T0+4],Tr2[9,][10:21][T0+5],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],Tr2[10,][10:21][T0+2],Tr2[10,][10:21][T0+3],Tr2[10,][10:21][T0+4],Tr2[10,][10:21][T0+5],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],Tr2[11,][10:21][T0+2],Tr2[11,][10:21][T0+3],Tr2[11,][10:21][T0+4],Tr2[11,][10:21][T0+5],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],Tr2[12,][10:21][T0+2],Tr2[12,][10:21][T0+3],Tr2[12,][10:21][T0+4],Tr2[12,][10:21][T0+5],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],Tr2[13,][10:21][T0+2],Tr2[13,][10:21][T0+3],Tr2[13,][10:21][T0+4],Tr2[13,][10:21][T0+5],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],Tr2[14,][10:21][T0+2],Tr2[14,][10:21][T0+3],Tr2[14,][10:21][T0+4],Tr2[14,][10:21][T0+5],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],Tr2[15,][10:21][T0+2],Tr2[15,][10:21][T0+3],Tr2[15,][10:21][T0+4],Tr2[15,][10:21][T0+5],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],Tr2[16,][10:21][T0+2],Tr2[16,][10:21][T0+3],Tr2[16,][10:21][T0+4],Tr2[16,][10:21][T0+5],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],Tr2[17,][10:21][T0+2],Tr2[17,][10:21][T0+3],Tr2[17,][10:21][T0+4],Tr2[17,][10:21][T0+5],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],Tr2[18,][10:21][T0+2],Tr2[18,][10:21][T0+3],Tr2[18,][10:21][T0+4],Tr2[18,][10:21][T0+5],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],Tr2[19,][10:21][T0+2],Tr2[19,][10:21][T0+3],Tr2[19,][10:21][T0+4],Tr2[19,][10:21][T0+5],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],Tr2[20,][10:21][T0+2],Tr2[20,][10:21][T0+3],Tr2[20,][10:21][T0+4],Tr2[20,][10:21][T0+5],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],Tr2[21,][10:21][T0+2],Tr2[21,][10:21][T0+3],Tr2[21,][10:21][T0+4],Tr2[21,][10:21][T0+5],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],Tr2[22,][10:21][T0+2],Tr2[22,][10:21][T0+3],Tr2[22,][10:21][T0+4],Tr2[22,][10:21][T0+5],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],Tr2[23,][10:21][T0+2],Tr2[23,][10:21][T0+3],Tr2[23,][10:21][T0+4],Tr2[23,][10:21][T0+5],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],Tr2[24,][10:21][T0+2],Tr2[24,][10:21][T0+3],Tr2[24,][10:21][T0+4],Tr2[24,][10:21][T0+5],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],Tr2[25,][10:21][T0+2],Tr2[25,][10:21][T0+3],Tr2[25,][10:21][T0+4],Tr2[25,][10:21][T0+5],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],Tr2[26,][10:21][T0+2],Tr2[26,][10:21][T0+3],Tr2[26,][10:21][T0+4],Tr2[26,][10:21][T0+5],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],Tr2[27,][10:21][T0+2],Tr2[27,][10:21][T0+3],Tr2[27,][10:21][T0+4],Tr2[27,][10:21][T0+5],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],Tr2[28,][10:21][T0+2],Tr2[28,][10:21][T0+3],Tr2[28,][10:21][T0+4],Tr2[28,][10:21][T0+5],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],Tr2[29,][10:21][T0+2],Tr2[29,][10:21][T0+3],Tr2[29,][10:21][T0+4],Tr2[29,][10:21][T0+5],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],Tr2[30,][10:21][T0+2],Tr2[30,][10:21][T0+3],Tr2[30,][10:21][T0+4],Tr2[30,][10:21][T0+5],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,second_treatment21,second_treatment31,second_treatment41,second_treatment51,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,second_treatment22,second_treatment32,second_treatment42,second_treatment52,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,second_treatment23,second_treatment33,second_treatment43,second_treatment53,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,second_treatment24,second_treatment34,second_treatment44,second_treatment54,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,second_treatment25,second_treatment35,second_treatment45,second_treatment55,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,second_treatment26,second_treatment36,second_treatment46,second_treatment56,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,second_treatment27,second_treatment37,second_treatment47,second_treatment57,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,second_treatment28,second_treatment38,second_treatment48,second_treatment58,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,second_treatment29,second_treatment39,second_treatment49,second_treatment59,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,second_treatment210,second_treatment310,second_treatment410,second_treatment510,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,second_treatment211,second_treatment311,second_treatment411,second_treatment511,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,second_treatment212,second_treatment312,second_treatment412,second_treatment512,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,second_treatment213,second_treatment313,second_treatment413,second_treatment513,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,second_treatment214,second_treatment314,second_treatment414,second_treatment514,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,second_treatment215,second_treatment315,second_treatment415,second_treatment515,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,second_treatment216,second_treatment316,second_treatment416,second_treatment516,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,second_treatment217,second_treatment317,second_treatment417,second_treatment517,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,second_treatment218,second_treatment318,second_treatment418,second_treatment518,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,second_treatment219,second_treatment319,second_treatment419,second_treatment519,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,second_treatment220,second_treatment320,second_treatment420,second_treatment520,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,second_treatment221,second_treatment321,second_treatment421,second_treatment521,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,second_treatment222,second_treatment322,second_treatment422,second_treatment522,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,second_treatment223,second_treatment323,second_treatment423,second_treatment523,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,second_treatment224,second_treatment324,second_treatment424,second_treatment524,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,second_treatment225,second_treatment325,second_treatment425,second_treatment525,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,second_treatment226,second_treatment326,second_treatment426,second_treatment526,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,second_treatment227,second_treatment327,second_treatment427,second_treatment527,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,second_treatment228,second_treatment328,second_treatment428,second_treatment528,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,second_treatment229,second_treatment329,second_treatment429,second_treatment529,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,second_treatment230,second_treatment330,second_treatment430,second_treatment530,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],30))
tt2<-c(rep(t2[10:21][1:(T0+j)],30))

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-rbind( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-rbind( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-rbind( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

second_treatment61<-new_treatment[1]
second_treatment62<-new_treatment[2]
second_treatment63<-new_treatment[3]
second_treatment64<-new_treatment[4]
second_treatment65<-new_treatment[5]
second_treatment66<-new_treatment[6]
second_treatment67<-new_treatment[7]
second_treatment68<-new_treatment[8]
second_treatment69<-new_treatment[9]
second_treatment610<-new_treatment[10]
second_treatment611<-new_treatment[11]
second_treatment612<-new_treatment[12]
second_treatment613<-new_treatment[13]
second_treatment614<-new_treatment[14]
second_treatment615<-new_treatment[15]
second_treatment616<-new_treatment[16]
second_treatment617<-new_treatment[17]
second_treatment618<-new_treatment[18]
second_treatment619<-new_treatment[19]
second_treatment620<-new_treatment[20]
second_treatment621<-new_treatment[21]
second_treatment622<-new_treatment[22]
second_treatment623<-new_treatment[23]
second_treatment624<-new_treatment[24]
second_treatment625<-new_treatment[25]
second_treatment626<-new_treatment[26]
second_treatment627<-new_treatment[27]
second_treatment628<-new_treatment[28]
second_treatment629<-new_treatment[29]
second_treatment630<-new_treatment[30]

second_treatment6<-new_treatment





##====================================

#bootstrap 6#
#sd 6#

#step 6: s=6#
s=6

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=6

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],Tr2[1,][10:21][T0+2],Tr2[1,][10:21][T0+3],Tr2[1,][10:21][T0+4],Tr2[1,][10:21][T0+5],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],Tr2[2,][10:21][T0+2],Tr2[2,][10:21][T0+3],Tr2[2,][10:21][T0+4],Tr2[2,][10:21][T0+5],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],Tr2[3,][10:21][T0+2],Tr2[3,][10:21][T0+3],Tr2[3,][10:21][T0+4],Tr2[3,][10:21][T0+5],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],Tr2[4,][10:21][T0+2],Tr2[4,][10:21][T0+3],Tr2[4,][10:21][T0+4],Tr2[4,][10:21][T0+5],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],Tr2[5,][10:21][T0+2],Tr2[5,][10:21][T0+3],Tr2[5,][10:21][T0+4],Tr2[5,][10:21][T0+5],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],Tr2[6,][10:21][T0+2],Tr2[6,][10:21][T0+3],Tr2[6,][10:21][T0+4],Tr2[6,][10:21][T0+5],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],Tr2[7,][10:21][T0+2],Tr2[7,][10:21][T0+3],Tr2[7,][10:21][T0+4],Tr2[7,][10:21][T0+5],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],Tr2[8,][10:21][T0+2],Tr2[8,][10:21][T0+3],Tr2[8,][10:21][T0+4],Tr2[8,][10:21][T0+5],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],Tr2[9,][10:21][T0+2],Tr2[9,][10:21][T0+3],Tr2[9,][10:21][T0+4],Tr2[9,][10:21][T0+5],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],Tr2[10,][10:21][T0+2],Tr2[10,][10:21][T0+3],Tr2[10,][10:21][T0+4],Tr2[10,][10:21][T0+5],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],Tr2[11,][10:21][T0+2],Tr2[11,][10:21][T0+3],Tr2[11,][10:21][T0+4],Tr2[11,][10:21][T0+5],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],Tr2[12,][10:21][T0+2],Tr2[12,][10:21][T0+3],Tr2[12,][10:21][T0+4],Tr2[12,][10:21][T0+5],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],Tr2[13,][10:21][T0+2],Tr2[13,][10:21][T0+3],Tr2[13,][10:21][T0+4],Tr2[13,][10:21][T0+5],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],Tr2[14,][10:21][T0+2],Tr2[14,][10:21][T0+3],Tr2[14,][10:21][T0+4],Tr2[14,][10:21][T0+5],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],Tr2[15,][10:21][T0+2],Tr2[15,][10:21][T0+3],Tr2[15,][10:21][T0+4],Tr2[15,][10:21][T0+5],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],Tr2[16,][10:21][T0+2],Tr2[16,][10:21][T0+3],Tr2[16,][10:21][T0+4],Tr2[16,][10:21][T0+5],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],Tr2[17,][10:21][T0+2],Tr2[17,][10:21][T0+3],Tr2[17,][10:21][T0+4],Tr2[17,][10:21][T0+5],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],Tr2[18,][10:21][T0+2],Tr2[18,][10:21][T0+3],Tr2[18,][10:21][T0+4],Tr2[18,][10:21][T0+5],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],Tr2[19,][10:21][T0+2],Tr2[19,][10:21][T0+3],Tr2[19,][10:21][T0+4],Tr2[19,][10:21][T0+5],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],Tr2[20,][10:21][T0+2],Tr2[20,][10:21][T0+3],Tr2[20,][10:21][T0+4],Tr2[20,][10:21][T0+5],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],Tr2[21,][10:21][T0+2],Tr2[21,][10:21][T0+3],Tr2[21,][10:21][T0+4],Tr2[21,][10:21][T0+5],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],Tr2[22,][10:21][T0+2],Tr2[22,][10:21][T0+3],Tr2[22,][10:21][T0+4],Tr2[22,][10:21][T0+5],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],Tr2[23,][10:21][T0+2],Tr2[23,][10:21][T0+3],Tr2[23,][10:21][T0+4],Tr2[23,][10:21][T0+5],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],Tr2[24,][10:21][T0+2],Tr2[24,][10:21][T0+3],Tr2[24,][10:21][T0+4],Tr2[24,][10:21][T0+5],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],Tr2[25,][10:21][T0+2],Tr2[25,][10:21][T0+3],Tr2[25,][10:21][T0+4],Tr2[25,][10:21][T0+5],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],Tr2[26,][10:21][T0+2],Tr2[26,][10:21][T0+3],Tr2[26,][10:21][T0+4],Tr2[26,][10:21][T0+5],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],Tr2[27,][10:21][T0+2],Tr2[27,][10:21][T0+3],Tr2[27,][10:21][T0+4],Tr2[27,][10:21][T0+5],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],Tr2[28,][10:21][T0+2],Tr2[28,][10:21][T0+3],Tr2[28,][10:21][T0+4],Tr2[28,][10:21][T0+5],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],Tr2[29,][10:21][T0+2],Tr2[29,][10:21][T0+3],Tr2[29,][10:21][T0+4],Tr2[29,][10:21][T0+5],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],Tr2[30,][10:21][T0+2],Tr2[30,][10:21][T0+3],Tr2[30,][10:21][T0+4],Tr2[30,][10:21][T0+5],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,second_treatment21,second_treatment31,second_treatment41,second_treatment51,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,second_treatment22,second_treatment32,second_treatment42,second_treatment52,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,second_treatment23,second_treatment33,second_treatment43,second_treatment53,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,second_treatment24,second_treatment34,second_treatment44,second_treatment54,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,second_treatment25,second_treatment35,second_treatment45,second_treatment55,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,second_treatment26,second_treatment36,second_treatment46,second_treatment56,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,second_treatment27,second_treatment37,second_treatment47,second_treatment57,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,second_treatment28,second_treatment38,second_treatment48,second_treatment58,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,second_treatment29,second_treatment39,second_treatment49,second_treatment59,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,second_treatment210,second_treatment310,second_treatment410,second_treatment510,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,second_treatment211,second_treatment311,second_treatment411,second_treatment511,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,second_treatment212,second_treatment312,second_treatment412,second_treatment512,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,second_treatment213,second_treatment313,second_treatment413,second_treatment513,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,second_treatment214,second_treatment314,second_treatment414,second_treatment514,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,second_treatment215,second_treatment315,second_treatment415,second_treatment515,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,second_treatment216,second_treatment316,second_treatment416,second_treatment516,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,second_treatment217,second_treatment317,second_treatment417,second_treatment517,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,second_treatment218,second_treatment318,second_treatment418,second_treatment518,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,second_treatment219,second_treatment319,second_treatment419,second_treatment519,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,second_treatment220,second_treatment320,second_treatment420,second_treatment520,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,second_treatment221,second_treatment321,second_treatment421,second_treatment521,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,second_treatment222,second_treatment322,second_treatment422,second_treatment522,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,second_treatment223,second_treatment323,second_treatment423,second_treatment523,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,second_treatment224,second_treatment324,second_treatment424,second_treatment524,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,second_treatment225,second_treatment325,second_treatment425,second_treatment525,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,second_treatment226,second_treatment326,second_treatment426,second_treatment526,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,second_treatment227,second_treatment327,second_treatment427,second_treatment527,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,second_treatment228,second_treatment328,second_treatment428,second_treatment528,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,second_treatment229,second_treatment329,second_treatment429,second_treatment529,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,second_treatment230,second_treatment330,second_treatment430,second_treatment530,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

zz2<-rbind( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-rbind( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-rbind( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


second_treatment61_sd<-var[1]^0.5
second_treatment62_sd<-var[2]^0.5
second_treatment63_sd<-var[3]^0.5
second_treatment64_sd<-var[4]^0.5
second_treatment65_sd<-var[5]^0.5
second_treatment66_sd<-var[6]^0.5
second_treatment67_sd<-var[7]^0.5
second_treatment68_sd<-var[8]^0.5
second_treatment69_sd<-var[9]^0.5
second_treatment610_sd<-var[10]^0.5
second_treatment611_sd<-var[11]^0.5
second_treatment612_sd<-var[12]^0.5
second_treatment613_sd<-var[13]^0.5
second_treatment614_sd<-var[14]^0.5
second_treatment615_sd<-var[15]^0.5
second_treatment616_sd<-var[16]^0.5
second_treatment617_sd<-var[17]^0.5
second_treatment618_sd<-var[18]^0.5
second_treatment619_sd<-var[19]^0.5
second_treatment620_sd<-var[20]^0.5
second_treatment621_sd<-var[21]^0.5
second_treatment622_sd<-var[22]^0.5
second_treatment623_sd<-var[23]^0.5
second_treatment624_sd<-var[24]^0.5
second_treatment625_sd<-var[25]^0.5
second_treatment626_sd<-var[26]^0.5
second_treatment627_sd<-var[27]^0.5
second_treatment628_sd<-var[28]^0.5
second_treatment639_sd<-var[29]^0.5
second_treatment630_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper6<-c()
second_lower6<-c()
for(i in 1:30){
second_upper6[i]<-second_treatment6[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower6[i]<-second_treatment6[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper6
second_lower6

mean(second_treatment6)/(sum(var)/900)^0.5










#step 7: s=7#

T0<-min(TT0)

s=7

DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],Tr1[1,][10:21][T0+2],Tr2[1,][10:21][T0+3],Tr2[1,][10:21][T0+4],Tr2[1,][10:21][T0+5],Tr2[1,][10:21][T0+6],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],Tr2[2,][10:21][T0+2],Tr2[2,][10:21][T0+3],Tr2[2,][10:21][T0+4],Tr2[2,][10:21][T0+5],Tr2[2,][10:21][T0+6],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],Tr2[3,][10:21][T0+2],Tr2[3,][10:21][T0+3],Tr2[3,][10:21][T0+4],Tr2[3,][10:21][T0+5],Tr2[3,][10:21][T0+6],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],Tr2[4,][10:21][T0+2],Tr2[4,][10:21][T0+3],Tr2[4,][10:21][T0+4],Tr2[4,][10:21][T0+5],Tr2[4,][10:21][T0+6],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],Tr2[5,][10:21][T0+2],Tr2[5,][10:21][T0+3],Tr2[5,][10:21][T0+4],Tr2[5,][10:21][T0+5],Tr2[5,][10:21][T0+6],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],Tr2[6,][10:21][T0+2],Tr2[6,][10:21][T0+3],Tr2[6,][10:21][T0+4],Tr2[6,][10:21][T0+5],Tr2[6,][10:21][T0+6],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],Tr2[7,][10:21][T0+2],Tr2[7,][10:21][T0+3],Tr2[7,][10:21][T0+4],Tr2[7,][10:21][T0+5],Tr2[7,][10:21][T0+6],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],Tr2[8,][10:21][T0+2],Tr2[8,][10:21][T0+3],Tr2[8,][10:21][T0+4],Tr2[8,][10:21][T0+5],Tr2[8,][10:21][T0+6],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],Tr2[9,][10:21][T0+2],Tr2[9,][10:21][T0+3],Tr2[9,][10:21][T0+4],Tr2[9,][10:21][T0+5],Tr2[9,][10:21][T0+6],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],Tr2[10,][10:21][T0+2],Tr2[10,][10:21][T0+3],Tr2[10,][10:21][T0+4],Tr2[10,][10:21][T0+5],Tr2[10,][10:21][T0+6],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],Tr2[11,][10:21][T0+2],Tr2[11,][10:21][T0+3],Tr2[11,][10:21][T0+4],Tr2[11,][10:21][T0+5],Tr2[11,][10:21][T0+6],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],Tr2[12,][10:21][T0+2],Tr2[12,][10:21][T0+3],Tr2[12,][10:21][T0+4],Tr2[12,][10:21][T0+5],Tr2[12,][10:21][T0+6],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],Tr2[13,][10:21][T0+2],Tr2[13,][10:21][T0+3],Tr2[13,][10:21][T0+4],Tr2[13,][10:21][T0+5],Tr2[13,][10:21][T0+6],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],Tr2[14,][10:21][T0+2],Tr2[14,][10:21][T0+3],Tr2[14,][10:21][T0+4],Tr2[14,][10:21][T0+5],Tr2[14,][10:21][T0+6],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],Tr2[15,][10:21][T0+2],Tr2[15,][10:21][T0+3],Tr2[15,][10:21][T0+4],Tr2[15,][10:21][T0+5],Tr2[15,][10:21][T0+6],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],Tr2[16,][10:21][T0+2],Tr2[16,][10:21][T0+3],Tr2[16,][10:21][T0+4],Tr2[16,][10:21][T0+5],Tr2[16,][10:21][T0+6],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],Tr2[17,][10:21][T0+2],Tr2[17,][10:21][T0+3],Tr2[17,][10:21][T0+4],Tr2[17,][10:21][T0+5],Tr2[17,][10:21][T0+6],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],Tr2[18,][10:21][T0+2],Tr2[18,][10:21][T0+3],Tr2[18,][10:21][T0+4],Tr2[18,][10:21][T0+5],Tr2[18,][10:21][T0+6],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],Tr2[19,][10:21][T0+2],Tr2[19,][10:21][T0+3],Tr2[19,][10:21][T0+4],Tr2[19,][10:21][T0+5],Tr2[19,][10:21][T0+6],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],Tr2[20,][10:21][T0+2],Tr2[20,][10:21][T0+3],Tr2[20,][10:21][T0+4],Tr2[20,][10:21][T0+5],Tr2[20,][10:21][T0+6],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],Tr2[21,][10:21][T0+2],Tr2[21,][10:21][T0+3],Tr2[21,][10:21][T0+4],Tr2[21,][10:21][T0+5],Tr2[21,][10:21][T0+6],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],Tr2[22,][10:21][T0+2],Tr2[22,][10:21][T0+3],Tr2[22,][10:21][T0+4],Tr2[22,][10:21][T0+5],Tr2[22,][10:21][T0+6],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],Tr2[23,][10:21][T0+2],Tr2[23,][10:21][T0+3],Tr2[23,][10:21][T0+4],Tr2[23,][10:21][T0+5],Tr2[23,][10:21][T0+6],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],Tr2[24,][10:21][T0+2],Tr2[24,][10:21][T0+3],Tr2[24,][10:21][T0+4],Tr2[24,][10:21][T0+5],Tr2[24,][10:21][T0+6],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],Tr2[25,][10:21][T0+2],Tr2[25,][10:21][T0+3],Tr2[25,][10:21][T0+4],Tr2[25,][10:21][T0+5],Tr2[25,][10:21][T0+6],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],Tr2[26,][10:21][T0+2],Tr2[26,][10:21][T0+3],Tr2[26,][10:21][T0+4],Tr2[26,][10:21][T0+5],Tr2[26,][10:21][T0+6],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],Tr2[27,][10:21][T0+2],Tr2[27,][10:21][T0+3],Tr2[27,][10:21][T0+4],Tr2[27,][10:21][T0+5],Tr2[27,][10:21][T0+6],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],Tr2[28,][10:21][T0+2],Tr2[28,][10:21][T0+3],Tr2[28,][10:21][T0+4],Tr2[28,][10:21][T0+5],Tr2[28,][10:21][T0+6],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],Tr2[29,][10:21][T0+2],Tr2[29,][10:21][T0+3],Tr2[29,][10:21][T0+4],Tr2[29,][10:21][T0+5],Tr2[29,][10:21][T0+6],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],Tr2[30,][10:21][T0+2],Tr2[30,][10:21][T0+3],Tr2[30,][10:21][T0+4],Tr2[30,][10:21][T0+5],Tr2[30,][10:21][T0+6],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,second_treatment21,second_treatment31,second_treatment41,second_treatment51,second_treatment61,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,second_treatment22,second_treatment32,second_treatment42,second_treatment52,second_treatment62,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,second_treatment23,second_treatment33,second_treatment43,second_treatment53,second_treatment63,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,second_treatment24,second_treatment34,second_treatment44,second_treatment54,second_treatment64,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,second_treatment25,second_treatment35,second_treatment45,second_treatment55,second_treatment65,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,second_treatment26,second_treatment36,second_treatment46,second_treatment56,second_treatment66,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,second_treatment27,second_treatment37,second_treatment47,second_treatment57,second_treatment67,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,second_treatment28,second_treatment38,second_treatment48,second_treatment58,second_treatment68,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,second_treatment29,second_treatment39,second_treatment49,second_treatment59,second_treatment69,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,second_treatment210,second_treatment310,second_treatment410,second_treatment510,second_treatment610,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,second_treatment211,second_treatment311,second_treatment411,second_treatment511,second_treatment611,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,second_treatment212,second_treatment312,second_treatment412,second_treatment512,second_treatment612,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,second_treatment213,second_treatment313,second_treatment413,second_treatment513,second_treatment613,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,second_treatment214,second_treatment314,second_treatment414,second_treatment514,second_treatment614,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,second_treatment215,second_treatment315,second_treatment415,second_treatment515,second_treatment615,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,second_treatment216,second_treatment316,second_treatment416,second_treatment516,second_treatment616,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,second_treatment217,second_treatment317,second_treatment417,second_treatment517,second_treatment617,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,second_treatment218,second_treatment318,second_treatment418,second_treatment518,second_treatment618,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,second_treatment219,second_treatment319,second_treatment419,second_treatment519,second_treatment619,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,second_treatment220,second_treatment320,second_treatment420,second_treatment520,second_treatment620,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,second_treatment221,second_treatment321,second_treatment421,second_treatment521,second_treatment621,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,second_treatment222,second_treatment322,second_treatment422,second_treatment522,second_treatment622,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,second_treatment223,second_treatment323,second_treatment423,second_treatment523,second_treatment623,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,second_treatment224,second_treatment324,second_treatment424,second_treatment524,second_treatment624,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,second_treatment225,second_treatment325,second_treatment425,second_treatment525,second_treatment625,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,second_treatment226,second_treatment326,second_treatment426,second_treatment526,second_treatment626,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,second_treatment227,second_treatment327,second_treatment427,second_treatment527,second_treatment627,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,second_treatment228,second_treatment328,second_treatment428,second_treatment528,second_treatment628,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,second_treatment229,second_treatment329,second_treatment429,second_treatment529,second_treatment629,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,second_treatment230,second_treatment330,second_treatment430,second_treatment530,second_treatment630,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],30))
tt2<-c(rep(t2[10:21][1:(T0+j)],30))

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-rbind( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-rbind( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-rbind( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

second_treatment71<-new_treatment[1]
second_treatment72<-new_treatment[2]
second_treatment73<-new_treatment[3]
second_treatment74<-new_treatment[4]
second_treatment75<-new_treatment[5]
second_treatment76<-new_treatment[6]
second_treatment77<-new_treatment[7]
second_treatment78<-new_treatment[8]
second_treatment79<-new_treatment[9]
second_treatment710<-new_treatment[10]
second_treatment711<-new_treatment[11]
second_treatment712<-new_treatment[12]
second_treatment713<-new_treatment[13]
second_treatment714<-new_treatment[14]
second_treatment715<-new_treatment[15]
second_treatment716<-new_treatment[16]
second_treatment717<-new_treatment[17]
second_treatment718<-new_treatment[18]
second_treatment719<-new_treatment[19]
second_treatment720<-new_treatment[20]
second_treatment721<-new_treatment[21]
second_treatment722<-new_treatment[22]
second_treatment723<-new_treatment[23]
second_treatment724<-new_treatment[24]
second_treatment725<-new_treatment[25]
second_treatment726<-new_treatment[26]
second_treatment727<-new_treatment[27]
second_treatment728<-new_treatment[28]
second_treatment729<-new_treatment[29]
second_treatment730<-new_treatment[30]

second_treatment7<-new_treatment





##====================================

#bootstrap 7#
#sd 7#

#step 7: s=7#
s=7

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=7

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],Tr1[1,][10:21][T0+2],Tr2[1,][10:21][T0+3],Tr2[1,][10:21][T0+4],Tr2[1,][10:21][T0+5],Tr2[1,][10:21][T0+6],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],Tr2[2,][10:21][T0+2],Tr2[2,][10:21][T0+3],Tr2[2,][10:21][T0+4],Tr2[2,][10:21][T0+5],Tr2[2,][10:21][T0+6],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],Tr2[3,][10:21][T0+2],Tr2[3,][10:21][T0+3],Tr2[3,][10:21][T0+4],Tr2[3,][10:21][T0+5],Tr2[3,][10:21][T0+6],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],Tr2[4,][10:21][T0+2],Tr2[4,][10:21][T0+3],Tr2[4,][10:21][T0+4],Tr2[4,][10:21][T0+5],Tr2[4,][10:21][T0+6],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],Tr2[5,][10:21][T0+2],Tr2[5,][10:21][T0+3],Tr2[5,][10:21][T0+4],Tr2[5,][10:21][T0+5],Tr2[5,][10:21][T0+6],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],Tr2[6,][10:21][T0+2],Tr2[6,][10:21][T0+3],Tr2[6,][10:21][T0+4],Tr2[6,][10:21][T0+5],Tr2[6,][10:21][T0+6],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],Tr2[7,][10:21][T0+2],Tr2[7,][10:21][T0+3],Tr2[7,][10:21][T0+4],Tr2[7,][10:21][T0+5],Tr2[7,][10:21][T0+6],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],Tr2[8,][10:21][T0+2],Tr2[8,][10:21][T0+3],Tr2[8,][10:21][T0+4],Tr2[8,][10:21][T0+5],Tr2[8,][10:21][T0+6],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],Tr2[9,][10:21][T0+2],Tr2[9,][10:21][T0+3],Tr2[9,][10:21][T0+4],Tr2[9,][10:21][T0+5],Tr2[9,][10:21][T0+6],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],Tr2[10,][10:21][T0+2],Tr2[10,][10:21][T0+3],Tr2[10,][10:21][T0+4],Tr2[10,][10:21][T0+5],Tr2[10,][10:21][T0+6],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],Tr2[11,][10:21][T0+2],Tr2[11,][10:21][T0+3],Tr2[11,][10:21][T0+4],Tr2[11,][10:21][T0+5],Tr2[11,][10:21][T0+6],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],Tr2[12,][10:21][T0+2],Tr2[12,][10:21][T0+3],Tr2[12,][10:21][T0+4],Tr2[12,][10:21][T0+5],Tr2[12,][10:21][T0+6],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],Tr2[13,][10:21][T0+2],Tr2[13,][10:21][T0+3],Tr2[13,][10:21][T0+4],Tr2[13,][10:21][T0+5],Tr2[13,][10:21][T0+6],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],Tr2[14,][10:21][T0+2],Tr2[14,][10:21][T0+3],Tr2[14,][10:21][T0+4],Tr2[14,][10:21][T0+5],Tr2[14,][10:21][T0+6],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],Tr2[15,][10:21][T0+2],Tr2[15,][10:21][T0+3],Tr2[15,][10:21][T0+4],Tr2[15,][10:21][T0+5],Tr2[15,][10:21][T0+6],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],Tr2[16,][10:21][T0+2],Tr2[16,][10:21][T0+3],Tr2[16,][10:21][T0+4],Tr2[16,][10:21][T0+5],Tr2[16,][10:21][T0+6],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],Tr2[17,][10:21][T0+2],Tr2[17,][10:21][T0+3],Tr2[17,][10:21][T0+4],Tr2[17,][10:21][T0+5],Tr2[17,][10:21][T0+6],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],Tr2[18,][10:21][T0+2],Tr2[18,][10:21][T0+3],Tr2[18,][10:21][T0+4],Tr2[18,][10:21][T0+5],Tr2[18,][10:21][T0+6],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],Tr2[19,][10:21][T0+2],Tr2[19,][10:21][T0+3],Tr2[19,][10:21][T0+4],Tr2[19,][10:21][T0+5],Tr2[19,][10:21][T0+6],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],Tr2[20,][10:21][T0+2],Tr2[20,][10:21][T0+3],Tr2[20,][10:21][T0+4],Tr2[20,][10:21][T0+5],Tr2[20,][10:21][T0+6],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],Tr2[21,][10:21][T0+2],Tr2[21,][10:21][T0+3],Tr2[21,][10:21][T0+4],Tr2[21,][10:21][T0+5],Tr2[21,][10:21][T0+6],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],Tr2[22,][10:21][T0+2],Tr2[22,][10:21][T0+3],Tr2[22,][10:21][T0+4],Tr2[22,][10:21][T0+5],Tr2[22,][10:21][T0+6],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],Tr2[23,][10:21][T0+2],Tr2[23,][10:21][T0+3],Tr2[23,][10:21][T0+4],Tr2[23,][10:21][T0+5],Tr2[23,][10:21][T0+6],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],Tr2[24,][10:21][T0+2],Tr2[24,][10:21][T0+3],Tr2[24,][10:21][T0+4],Tr2[24,][10:21][T0+5],Tr2[24,][10:21][T0+6],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],Tr2[25,][10:21][T0+2],Tr2[25,][10:21][T0+3],Tr2[25,][10:21][T0+4],Tr2[25,][10:21][T0+5],Tr2[25,][10:21][T0+6],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],Tr2[26,][10:21][T0+2],Tr2[26,][10:21][T0+3],Tr2[26,][10:21][T0+4],Tr2[26,][10:21][T0+5],Tr2[26,][10:21][T0+6],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],Tr2[27,][10:21][T0+2],Tr2[27,][10:21][T0+3],Tr2[27,][10:21][T0+4],Tr2[27,][10:21][T0+5],Tr2[27,][10:21][T0+6],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],Tr2[28,][10:21][T0+2],Tr2[28,][10:21][T0+3],Tr2[28,][10:21][T0+4],Tr2[28,][10:21][T0+5],Tr2[28,][10:21][T0+6],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],Tr2[29,][10:21][T0+2],Tr2[29,][10:21][T0+3],Tr2[29,][10:21][T0+4],Tr2[29,][10:21][T0+5],Tr2[29,][10:21][T0+6],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],Tr2[30,][10:21][T0+2],Tr2[30,][10:21][T0+3],Tr2[30,][10:21][T0+4],Tr2[30,][10:21][T0+5],Tr2[30,][10:21][T0+6],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,second_treatment21,second_treatment31,second_treatment41,second_treatment51,second_treatment61,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,second_treatment22,second_treatment32,second_treatment42,second_treatment52,second_treatment62,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,second_treatment23,second_treatment33,second_treatment43,second_treatment53,second_treatment63,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,second_treatment24,second_treatment34,second_treatment44,second_treatment54,second_treatment64,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,second_treatment25,second_treatment35,second_treatment45,second_treatment55,second_treatment65,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,second_treatment26,second_treatment36,second_treatment46,second_treatment56,second_treatment66,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,second_treatment27,second_treatment37,second_treatment47,second_treatment57,second_treatment67,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,second_treatment28,second_treatment38,second_treatment48,second_treatment58,second_treatment68,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,second_treatment29,second_treatment39,second_treatment49,second_treatment59,second_treatment69,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,second_treatment210,second_treatment310,second_treatment410,second_treatment510,second_treatment610,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,second_treatment211,second_treatment311,second_treatment411,second_treatment511,second_treatment611,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,second_treatment212,second_treatment312,second_treatment412,second_treatment512,second_treatment612,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,second_treatment213,second_treatment313,second_treatment413,second_treatment513,second_treatment613,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,second_treatment214,second_treatment314,second_treatment414,second_treatment514,second_treatment614,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,second_treatment215,second_treatment315,second_treatment415,second_treatment515,second_treatment615,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,second_treatment216,second_treatment316,second_treatment416,second_treatment516,second_treatment616,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,second_treatment217,second_treatment317,second_treatment417,second_treatment517,second_treatment617,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,second_treatment218,second_treatment318,second_treatment418,second_treatment518,second_treatment618,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,second_treatment219,second_treatment319,second_treatment419,second_treatment519,second_treatment619,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,second_treatment220,second_treatment320,second_treatment420,second_treatment520,second_treatment620,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,second_treatment221,second_treatment321,second_treatment421,second_treatment521,second_treatment621,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,second_treatment222,second_treatment322,second_treatment422,second_treatment522,second_treatment622,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,second_treatment223,second_treatment323,second_treatment423,second_treatment523,second_treatment623,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,second_treatment224,second_treatment324,second_treatment424,second_treatment524,second_treatment624,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,second_treatment225,second_treatment325,second_treatment425,second_treatment525,second_treatment625,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,second_treatment226,second_treatment326,second_treatment426,second_treatment526,second_treatment626,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,second_treatment227,second_treatment327,second_treatment427,second_treatment527,second_treatment627,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,second_treatment228,second_treatment328,second_treatment428,second_treatment528,second_treatment628,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,second_treatment229,second_treatment329,second_treatment429,second_treatment529,second_treatment629,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,second_treatment230,second_treatment330,second_treatment430,second_treatment530,second_treatment630,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

zz2<-rbind( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-rbind( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-rbind( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


second_treatment71_sd<-var[1]^0.5
second_treatment72_sd<-var[2]^0.5
second_treatment73_sd<-var[3]^0.5
second_treatment74_sd<-var[4]^0.5
second_treatment75_sd<-var[5]^0.5
second_treatment76_sd<-var[6]^0.5
second_treatment77_sd<-var[7]^0.5
second_treatment78_sd<-var[8]^0.5
second_treatment79_sd<-var[9]^0.5
second_treatment710_sd<-var[10]^0.5
second_treatment711_sd<-var[11]^0.5
second_treatment712_sd<-var[12]^0.5
second_treatment713_sd<-var[13]^0.5
second_treatment714_sd<-var[14]^0.5
second_treatment715_sd<-var[15]^0.5
second_treatment716_sd<-var[16]^0.5
second_treatment717_sd<-var[17]^0.5
second_treatment718_sd<-var[18]^0.5
second_treatment719_sd<-var[19]^0.5
second_treatment720_sd<-var[20]^0.5
second_treatment721_sd<-var[21]^0.5
second_treatment722_sd<-var[22]^0.5
second_treatment723_sd<-var[23]^0.5
second_treatment724_sd<-var[24]^0.5
second_treatment725_sd<-var[25]^0.5
second_treatment726_sd<-var[26]^0.5
second_treatment727_sd<-var[27]^0.5
second_treatment728_sd<-var[28]^0.5
second_treatment739_sd<-var[29]^0.5
second_treatment730_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper7<-c()
second_lower7<-c()
for(i in 1:30){
second_upper7[i]<-second_treatment7[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower7[i]<-second_treatment7[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper7
second_lower7

mean(second_treatment7)/(sum(var)/900)^0.5










#step 8: s=8#

T0<-min(TT0)

s=8

DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],Tr1[1,][10:21][T0+2],Tr2[1,][10:21][T0+3],Tr2[1,][10:21][T0+4],Tr2[1,][10:21][T0+5],Tr2[1,][10:21][T0+6],Tr2[1,][10:21][T0+7],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],Tr2[2,][10:21][T0+2],Tr2[2,][10:21][T0+3],Tr2[2,][10:21][T0+4],Tr2[2,][10:21][T0+5],Tr2[2,][10:21][T0+6],Tr2[2,][10:21][T0+7],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],Tr2[3,][10:21][T0+2],Tr2[3,][10:21][T0+3],Tr2[3,][10:21][T0+4],Tr2[3,][10:21][T0+5],Tr2[3,][10:21][T0+6],Tr2[3,][10:21][T0+7],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],Tr2[4,][10:21][T0+2],Tr2[4,][10:21][T0+3],Tr2[4,][10:21][T0+4],Tr2[4,][10:21][T0+5],Tr2[4,][10:21][T0+6],Tr2[4,][10:21][T0+7],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],Tr2[5,][10:21][T0+2],Tr2[5,][10:21][T0+3],Tr2[5,][10:21][T0+4],Tr2[5,][10:21][T0+5],Tr2[5,][10:21][T0+6],Tr2[5,][10:21][T0+7],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],Tr2[6,][10:21][T0+2],Tr2[6,][10:21][T0+3],Tr2[6,][10:21][T0+4],Tr2[6,][10:21][T0+5],Tr2[6,][10:21][T0+6],Tr2[6,][10:21][T0+7],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],Tr2[7,][10:21][T0+2],Tr2[7,][10:21][T0+3],Tr2[7,][10:21][T0+4],Tr2[7,][10:21][T0+5],Tr2[7,][10:21][T0+6],Tr2[7,][10:21][T0+7],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],Tr2[8,][10:21][T0+2],Tr2[8,][10:21][T0+3],Tr2[8,][10:21][T0+4],Tr2[8,][10:21][T0+5],Tr2[8,][10:21][T0+6],Tr2[8,][10:21][T0+7],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],Tr2[9,][10:21][T0+2],Tr2[9,][10:21][T0+3],Tr2[9,][10:21][T0+4],Tr2[9,][10:21][T0+5],Tr2[9,][10:21][T0+6],Tr2[9,][10:21][T0+7],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],Tr2[10,][10:21][T0+2],Tr2[10,][10:21][T0+3],Tr2[10,][10:21][T0+4],Tr2[10,][10:21][T0+5],Tr2[10,][10:21][T0+6],Tr2[10,][10:21][T0+7],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],Tr2[11,][10:21][T0+2],Tr2[11,][10:21][T0+3],Tr2[11,][10:21][T0+4],Tr2[11,][10:21][T0+5],Tr2[11,][10:21][T0+6],Tr2[11,][10:21][T0+7],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],Tr2[12,][10:21][T0+2],Tr2[12,][10:21][T0+3],Tr2[12,][10:21][T0+4],Tr2[12,][10:21][T0+5],Tr2[12,][10:21][T0+6],Tr2[12,][10:21][T0+7],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],Tr2[13,][10:21][T0+2],Tr2[13,][10:21][T0+3],Tr2[13,][10:21][T0+4],Tr2[13,][10:21][T0+5],Tr2[13,][10:21][T0+6],Tr2[13,][10:21][T0+7],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],Tr2[14,][10:21][T0+2],Tr2[14,][10:21][T0+3],Tr2[14,][10:21][T0+4],Tr2[14,][10:21][T0+5],Tr2[14,][10:21][T0+6],Tr2[14,][10:21][T0+7],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],Tr2[15,][10:21][T0+2],Tr2[15,][10:21][T0+3],Tr2[15,][10:21][T0+4],Tr2[15,][10:21][T0+5],Tr2[15,][10:21][T0+6],Tr2[15,][10:21][T0+7],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],Tr2[16,][10:21][T0+2],Tr2[16,][10:21][T0+3],Tr2[16,][10:21][T0+4],Tr2[16,][10:21][T0+5],Tr2[16,][10:21][T0+6],Tr2[16,][10:21][T0+7],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],Tr2[17,][10:21][T0+2],Tr2[17,][10:21][T0+3],Tr2[17,][10:21][T0+4],Tr2[17,][10:21][T0+5],Tr2[17,][10:21][T0+6],Tr2[17,][10:21][T0+7],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],Tr2[18,][10:21][T0+2],Tr2[18,][10:21][T0+3],Tr2[18,][10:21][T0+4],Tr2[18,][10:21][T0+5],Tr2[18,][10:21][T0+6],Tr2[18,][10:21][T0+7],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],Tr2[19,][10:21][T0+2],Tr2[19,][10:21][T0+3],Tr2[19,][10:21][T0+4],Tr2[19,][10:21][T0+5],Tr2[19,][10:21][T0+6],Tr2[19,][10:21][T0+7],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],Tr2[20,][10:21][T0+2],Tr2[20,][10:21][T0+3],Tr2[20,][10:21][T0+4],Tr2[20,][10:21][T0+5],Tr2[20,][10:21][T0+6],Tr2[20,][10:21][T0+7],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],Tr2[21,][10:21][T0+2],Tr2[21,][10:21][T0+3],Tr2[21,][10:21][T0+4],Tr2[21,][10:21][T0+5],Tr2[21,][10:21][T0+6],Tr2[21,][10:21][T0+7],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],Tr2[22,][10:21][T0+2],Tr2[22,][10:21][T0+3],Tr2[22,][10:21][T0+4],Tr2[22,][10:21][T0+5],Tr2[22,][10:21][T0+6],Tr2[22,][10:21][T0+7],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],Tr2[23,][10:21][T0+2],Tr2[23,][10:21][T0+3],Tr2[23,][10:21][T0+4],Tr2[23,][10:21][T0+5],Tr2[23,][10:21][T0+6],Tr2[23,][10:21][T0+7],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],Tr2[24,][10:21][T0+2],Tr2[24,][10:21][T0+3],Tr2[24,][10:21][T0+4],Tr2[24,][10:21][T0+5],Tr2[24,][10:21][T0+6],Tr2[24,][10:21][T0+7],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],Tr2[25,][10:21][T0+2],Tr2[25,][10:21][T0+3],Tr2[25,][10:21][T0+4],Tr2[25,][10:21][T0+5],Tr2[25,][10:21][T0+6],Tr2[25,][10:21][T0+7],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],Tr2[26,][10:21][T0+2],Tr2[26,][10:21][T0+3],Tr2[26,][10:21][T0+4],Tr2[26,][10:21][T0+5],Tr2[26,][10:21][T0+6],Tr2[26,][10:21][T0+7],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],Tr2[27,][10:21][T0+2],Tr2[27,][10:21][T0+3],Tr2[27,][10:21][T0+4],Tr2[27,][10:21][T0+5],Tr2[27,][10:21][T0+6],Tr2[27,][10:21][T0+7],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],Tr2[28,][10:21][T0+2],Tr2[28,][10:21][T0+3],Tr2[28,][10:21][T0+4],Tr2[28,][10:21][T0+5],Tr2[28,][10:21][T0+6],Tr2[28,][10:21][T0+7],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],Tr2[29,][10:21][T0+2],Tr2[29,][10:21][T0+3],Tr2[29,][10:21][T0+4],Tr2[29,][10:21][T0+5],Tr2[29,][10:21][T0+6],Tr2[29,][10:21][T0+7],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],Tr2[30,][10:21][T0+2],Tr2[30,][10:21][T0+3],Tr2[30,][10:21][T0+4],Tr2[30,][10:21][T0+5],Tr2[30,][10:21][T0+6],Tr2[30,][10:21][T0+7],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,second_treatment21,second_treatment31,second_treatment41,second_treatment51,second_treatment61,second_treatment71,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,second_treatment22,second_treatment32,second_treatment42,second_treatment52,second_treatment62,second_treatment72,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,second_treatment23,second_treatment33,second_treatment43,second_treatment53,second_treatment63,second_treatment73,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,second_treatment24,second_treatment34,second_treatment44,second_treatment54,second_treatment64,second_treatment74,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,second_treatment25,second_treatment35,second_treatment45,second_treatment55,second_treatment65,second_treatment75,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,second_treatment26,second_treatment36,second_treatment46,second_treatment56,second_treatment66,second_treatment76,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,second_treatment27,second_treatment37,second_treatment47,second_treatment57,second_treatment67,second_treatment77,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,second_treatment28,second_treatment38,second_treatment48,second_treatment58,second_treatment68,second_treatment78,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,second_treatment29,second_treatment39,second_treatment49,second_treatment59,second_treatment69,second_treatment79,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,second_treatment210,second_treatment310,second_treatment410,second_treatment510,second_treatment610,second_treatment710,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,second_treatment211,second_treatment311,second_treatment411,second_treatment511,second_treatment611,second_treatment711,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,second_treatment212,second_treatment312,second_treatment412,second_treatment512,second_treatment612,second_treatment712,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,second_treatment213,second_treatment313,second_treatment413,second_treatment513,second_treatment613,second_treatment713,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,second_treatment214,second_treatment314,second_treatment414,second_treatment514,second_treatment614,second_treatment714,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,second_treatment215,second_treatment315,second_treatment415,second_treatment515,second_treatment615,second_treatment715,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,second_treatment216,second_treatment316,second_treatment416,second_treatment516,second_treatment616,second_treatment716,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,second_treatment217,second_treatment317,second_treatment417,second_treatment517,second_treatment617,second_treatment717,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,second_treatment218,second_treatment318,second_treatment418,second_treatment518,second_treatment618,second_treatment718,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,second_treatment219,second_treatment319,second_treatment419,second_treatment519,second_treatment619,second_treatment719,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,second_treatment220,second_treatment320,second_treatment420,second_treatment520,second_treatment620,second_treatment720,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,second_treatment221,second_treatment321,second_treatment421,second_treatment521,second_treatment621,second_treatment721,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,second_treatment222,second_treatment322,second_treatment422,second_treatment522,second_treatment622,second_treatment722,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,second_treatment223,second_treatment323,second_treatment423,second_treatment523,second_treatment623,second_treatment723,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,second_treatment224,second_treatment324,second_treatment424,second_treatment524,second_treatment624,second_treatment724,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,second_treatment225,second_treatment325,second_treatment425,second_treatment525,second_treatment625,second_treatment725,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,second_treatment226,second_treatment326,second_treatment426,second_treatment526,second_treatment626,second_treatment726,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,second_treatment227,second_treatment327,second_treatment427,second_treatment527,second_treatment627,second_treatment727,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,second_treatment228,second_treatment328,second_treatment428,second_treatment528,second_treatment628,second_treatment728,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,second_treatment229,second_treatment329,second_treatment429,second_treatment529,second_treatment629,second_treatment729,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,second_treatment230,second_treatment330,second_treatment430,second_treatment530,second_treatment630,second_treatment730,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],30))
tt2<-c(rep(t2[10:21][1:(T0+j)],30))

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]),
mean(predict[6,][T1:(T0+j)])-mean(predict[6,][1:T0]),
mean(predict[7,][T1:(T0+j)])-mean(predict[7,][1:T0]),
mean(predict[8,][T1:(T0+j)])-mean(predict[8,][1:T0]),
mean(predict[9,][T1:(T0+j)])-mean(predict[9,][1:T0]),
mean(predict[10,][T1:(T0+j)])-mean(predict[10,][1:T0]),
mean(predict[11,][T1:(T0+j)])-mean(predict[11,][1:T0]),
mean(predict[12,][T1:(T0+j)])-mean(predict[12,][1:T0]),
mean(predict[13,][T1:(T0+j)])-mean(predict[13,][1:T0]),
mean(predict[14,][T1:(T0+j)])-mean(predict[14,][1:T0]),
mean(predict[15,][T1:(T0+j)])-mean(predict[15,][1:T0]),
mean(predict[16,][T1:(T0+j)])-mean(predict[16,][1:T0]),
mean(predict[17,][T1:(T0+j)])-mean(predict[17,][1:T0]),
mean(predict[18,][T1:(T0+j)])-mean(predict[18,][1:T0]),
mean(predict[19,][T1:(T0+j)])-mean(predict[19,][1:T0]),
mean(predict[20,][T1:(T0+j)])-mean(predict[20,][1:T0]),
mean(predict[21,][T1:(T0+j)])-mean(predict[21,][1:T0]),
mean(predict[22,][T1:(T0+j)])-mean(predict[22,][1:T0]),
mean(predict[23,][T1:(T0+j)])-mean(predict[23,][1:T0]),
mean(predict[24,][T1:(T0+j)])-mean(predict[24,][1:T0]),
mean(predict[25,][T1:(T0+j)])-mean(predict[25,][1:T0]),
mean(predict[26,][T1:(T0+j)])-mean(predict[26,][1:T0]),
mean(predict[27,][T1:(T0+j)])-mean(predict[27,][1:T0]),
mean(predict[28,][T1:(T0+j)])-mean(predict[28,][1:T0]),
mean(predict[29,][T1:(T0+j)])-mean(predict[29,][1:T0]),
mean(predict[30,][T1:(T0+j)])-mean(predict[30,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-rbind( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-rbind( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-rbind( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )


a1<-c()
for(i in 1:27){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:27){
a3_2[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz2[i,][1:(T0+j)]*Y_t[i,])-sum(zz2[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:27){
a3_3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz3[i,][1:(T0+j)]*Y_t[i,])-sum(zz3[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:27){
a3_4[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz4[i,][1:(T0+j)]*Y_t[i,])-sum(zz4[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)],DDD[2,][1:(T0+j)],DDD[3,][1:(T0+j)],DDD[4,][1:(T0+j)],DDD[5,][1:(T0+j)],DDD[6,][1:(T0+j)],DDD[7,][1:(T0+j)],DDD[8,][1:(T0+j)],DDD[9,][1:(T0+j)],DDD[10,][1:(T0+j)],DDD[11,][1:(T0+j)],DDD[12,][1:(T0+j)],DDD[13,][1:(T0+j)],DDD[14,][1:(T0+j)],DDD[15,][1:(T0+j)],DDD[16,][1:(T0+j)],DDD[17,][1:(T0+j)],DDD[18,][1:(T0+j)],DDD[19,][1:(T0+j)],DDD[20,][1:(T0+j)],DDD[21,][1:(T0+j)],DDD[22,][1:(T0+j)],DDD[23,][1:(T0+j)],DDD[24,][1:(T0+j)],DDD[25,][1:(T0+j)],DDD[26,][1:(T0+j)],DDD[27,][1:(T0+j)],DDD[28,][1:(T0+j)],DDD[29,][1:(T0+j)],DDD[30,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)],yyy[2,][1:(T0+j)],yyy[3,][1:(T0+j)],yyy[4,][1:(T0+j)],yyy[5,][1:(T0+j)],yyy[6,][1:(T0+j)],yyy[7,][1:(T0+j)],yyy[8,][1:(T0+j)],yyy[9,][1:(T0+j)],yyy[10,][1:(T0+j)],yyy[11,][1:(T0+j)],yyy[12,][1:(T0+j)],yyy[13,][1:(T0+j)],yyy[14,][1:(T0+j)],yyy[15,][1:(T0+j)],yyy[16,][1:(T0+j)],yyy[17,][1:(T0+j)],yyy[18,][1:(T0+j)],yyy[19,][1:(T0+j)],yyy[20,][1:(T0+j)],yyy[21,][1:(T0+j)],yyy[22,][1:(T0+j)],yyy[23,][1:(T0+j)],yyy[24,][1:(T0+j)],yyy[25,][1:(T0+j)],yyy[26,][1:(T0+j)],yyy[27,][1:(T0+j)],yyy[28,][1:(T0+j)],yyy[29,][1:(T0+j)],yyy[30,][1:(T0+j)])

zz2<-c( x1[10:21][1:(T0+j)],x2[10:21][1:(T0+j)],x3[10:21][1:(T0+j)],x4[10:21][1:(T0+j)],x5[10:21][1:(T0+j)],x6[10:21][1:(T0+j)],x7[10:21][1:(T0+j)],x8[10:21][1:(T0+j)],x9[10:21][1:(T0+j)],x10[10:21][1:(T0+j)],x11[10:21][1:(T0+j)],x12[10:21][1:(T0+j)],x13[10:21][1:(T0+j)],x14[10:21][1:(T0+j)],x15[10:21][1:(T0+j)],x16[10:21][1:(T0+j)],x17[10:21][1:(T0+j)],x18[10:21][1:(T0+j)],x19[10:21][1:(T0+j)],x20[10:21][1:(T0+j)],x21[10:21][1:(T0+j)],x22[10:21][1:(T0+j)],x23[10:21][1:(T0+j)],x24[10:21][1:(T0+j)],x25[10:21][1:(T0+j)],x26[10:21][1:(T0+j)],x27[10:21][1:(T0+j)],x28[10:21][1:(T0+j)],x29[10:21][1:(T0+j)],x30[10:21][1:(T0+j)] )

zz3<-c( z1[10:21][1:(T0+j)],z2[10:21][1:(T0+j)],z3[10:21][1:(T0+j)],z4[10:21][1:(T0+j)],z5[10:21][1:(T0+j)],z6[10:21][1:(T0+j)],z7[10:21][1:(T0+j)],z8[10:21][1:(T0+j)],z9[10:21][1:(T0+j)],z10[10:21][1:(T0+j)],z11[10:21][1:(T0+j)],z12[10:21][1:(T0+j)],z13[10:21][1:(T0+j)],z14[10:21][1:(T0+j)],z15[10:21][1:(T0+j)],z16[10:21][1:(T0+j)],z17[10:21][1:(T0+j)],z18[10:21][1:(T0+j)],z19[10:21][1:(T0+j)],z20[10:21][1:(T0+j)],z21[10:21][1:(T0+j)],z22[10:21][1:(T0+j)],z23[10:21][1:(T0+j)],z24[10:21][1:(T0+j)],z25[10:21][1:(T0+j)],z26[10:21][1:(T0+j)],z27[10:21][1:(T0+j)],z28[10:21][1:(T0+j)],z29[10:21][1:(T0+j)],z30[10:21][1:(T0+j)] )

zz4<-c( w1[10:21][1:(T0+j)],w2[10:21][1:(T0+j)],w3[10:21][1:(T0+j)],w4[10:21][1:(T0+j)],w5[10:21][1:(T0+j)],w6[10:21][1:(T0+j)],w7[10:21][1:(T0+j)],w8[10:21][1:(T0+j)],w9[10:21][1:(T0+j)],w10[10:21][1:(T0+j)],w11[10:21][1:(T0+j)],w12[10:21][1:(T0+j)],w13[10:21][1:(T0+j)],w14[10:21][1:(T0+j)],w15[10:21][1:(T0+j)],w16[10:21][1:(T0+j)],w17[10:21][1:(T0+j)],w18[10:21][1:(T0+j)],w19[10:21][1:(T0+j)],w20[10:21][1:(T0+j)],w21[10:21][1:(T0+j)],w22[10:21][1:(T0+j)],w23[10:21][1:(T0+j)],w24[10:21][1:(T0+j)],w25[10:21][1:(T0+j)],w26[10:21][1:(T0+j)],w27[10:21][1:(T0+j)],w28[10:21][1:(T0+j)],w29[10:21][1:(T0+j)],w30[10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)),rep(6,(T0+j)),rep(7,(T0+j)),rep(8,(T0+j)),rep(9,(T0+j)),rep(10,(T0+j)),rep(11,(T0+j)),rep(12,(T0+j)),rep(13,(T0+j)),rep(14,(T0+j)),rep(15,(T0+j)),rep(16,(T0+j)),rep(17,(T0+j)),rep(18,(T0+j)),rep(19,(T0+j)),rep(20,(T0+j)),rep(21,(T0+j)),rep(22,(T0+j)),rep(23,(T0+j)),rep(24,(T0+j)),rep(25,(T0+j)),rep(26,(T0+j)),rep(27,(T0+j)),rep(28,(T0+j)),rep(29,(T0+j)),rep(30,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

second_treatment81<-new_treatment[1]
second_treatment82<-new_treatment[2]
second_treatment83<-new_treatment[3]
second_treatment84<-new_treatment[4]
second_treatment85<-new_treatment[5]
second_treatment86<-new_treatment[6]
second_treatment87<-new_treatment[7]
second_treatment88<-new_treatment[8]
second_treatment89<-new_treatment[9]
second_treatment810<-new_treatment[10]
second_treatment811<-new_treatment[11]
second_treatment812<-new_treatment[12]
second_treatment813<-new_treatment[13]
second_treatment814<-new_treatment[14]
second_treatment815<-new_treatment[15]
second_treatment816<-new_treatment[16]
second_treatment817<-new_treatment[17]
second_treatment818<-new_treatment[18]
second_treatment819<-new_treatment[19]
second_treatment820<-new_treatment[20]
second_treatment821<-new_treatment[21]
second_treatment822<-new_treatment[22]
second_treatment823<-new_treatment[23]
second_treatment824<-new_treatment[24]
second_treatment825<-new_treatment[25]
second_treatment826<-new_treatment[26]
second_treatment827<-new_treatment[27]
second_treatment828<-new_treatment[28]
second_treatment829<-new_treatment[29]
second_treatment830<-new_treatment[30]

second_treatment8<-new_treatment





##====================================

#bootstrap 8#
#sd 8#

#step 8: s=8#
s=8

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=8

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[1,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[1,][10:21][T0+1],Tr1[1,][10:21][T0+2],Tr2[1,][10:21][T0+3],Tr2[1,][10:21][T0+4],Tr2[1,][10:21][T0+5],Tr2[1,][10:21][T0+6],Tr2[1,][10:21][T0+7],0)*ifelse(TT0[1]<=T0,0,1),
Tr2[2,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[2,][10:21][T0+1],Tr2[2,][10:21][T0+2],Tr2[2,][10:21][T0+3],Tr2[2,][10:21][T0+4],Tr2[2,][10:21][T0+5],Tr2[2,][10:21][T0+6],Tr2[2,][10:21][T0+7],0)*ifelse(TT0[2]<=T0,0,1),
Tr2[3,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[3,][10:21][T0+1],Tr2[3,][10:21][T0+2],Tr2[3,][10:21][T0+3],Tr2[3,][10:21][T0+4],Tr2[3,][10:21][T0+5],Tr2[3,][10:21][T0+6],Tr2[3,][10:21][T0+7],0)*ifelse(TT0[3]<=T0,0,1),
Tr2[4,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[4,][10:21][T0+1],Tr2[4,][10:21][T0+2],Tr2[4,][10:21][T0+3],Tr2[4,][10:21][T0+4],Tr2[4,][10:21][T0+5],Tr2[4,][10:21][T0+6],Tr2[4,][10:21][T0+7],0)*ifelse(TT0[4]<=T0,0,1),
Tr2[5,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[5,][10:21][T0+1],Tr2[5,][10:21][T0+2],Tr2[5,][10:21][T0+3],Tr2[5,][10:21][T0+4],Tr2[5,][10:21][T0+5],Tr2[5,][10:21][T0+6],Tr2[5,][10:21][T0+7],0)*ifelse(TT0[5]<=T0,0,1),
Tr2[6,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[6,][10:21][T0+1],Tr2[6,][10:21][T0+2],Tr2[6,][10:21][T0+3],Tr2[6,][10:21][T0+4],Tr2[6,][10:21][T0+5],Tr2[6,][10:21][T0+6],Tr2[6,][10:21][T0+7],0)*ifelse(TT0[6]<=T0,0,1),
Tr2[7,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[7,][10:21][T0+1],Tr2[7,][10:21][T0+2],Tr2[7,][10:21][T0+3],Tr2[7,][10:21][T0+4],Tr2[7,][10:21][T0+5],Tr2[7,][10:21][T0+6],Tr2[7,][10:21][T0+7],0)*ifelse(TT0[7]<=T0,0,1),
Tr2[8,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[8,][10:21][T0+1],Tr2[8,][10:21][T0+2],Tr2[8,][10:21][T0+3],Tr2[8,][10:21][T0+4],Tr2[8,][10:21][T0+5],Tr2[8,][10:21][T0+6],Tr2[8,][10:21][T0+7],0)*ifelse(TT0[8]<=T0,0,1),
Tr2[9,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[9,][10:21][T0+1],Tr2[9,][10:21][T0+2],Tr2[9,][10:21][T0+3],Tr2[9,][10:21][T0+4],Tr2[9,][10:21][T0+5],Tr2[9,][10:21][T0+6],Tr2[9,][10:21][T0+7],0)*ifelse(TT0[9]<=T0,0,1),
Tr2[10,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[10,][10:21][T0+1],Tr2[10,][10:21][T0+2],Tr2[10,][10:21][T0+3],Tr2[10,][10:21][T0+4],Tr2[10,][10:21][T0+5],Tr2[10,][10:21][T0+6],Tr2[10,][10:21][T0+7],0)*ifelse(TT0[10]<=T0,0,1),
Tr2[11,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[11,][10:21][T0+1],Tr2[11,][10:21][T0+2],Tr2[11,][10:21][T0+3],Tr2[11,][10:21][T0+4],Tr2[11,][10:21][T0+5],Tr2[11,][10:21][T0+6],Tr2[11,][10:21][T0+7],0)*ifelse(TT0[11]<=T0,0,1),
Tr2[12,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[12,][10:21][T0+1],Tr2[12,][10:21][T0+2],Tr2[12,][10:21][T0+3],Tr2[12,][10:21][T0+4],Tr2[12,][10:21][T0+5],Tr2[12,][10:21][T0+6],Tr2[12,][10:21][T0+7],0)*ifelse(TT0[12]<=T0,0,1),
Tr2[13,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[13,][10:21][T0+1],Tr2[13,][10:21][T0+2],Tr2[13,][10:21][T0+3],Tr2[13,][10:21][T0+4],Tr2[13,][10:21][T0+5],Tr2[13,][10:21][T0+6],Tr2[13,][10:21][T0+7],0)*ifelse(TT0[13]<=T0,0,1),
Tr2[14,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[14,][10:21][T0+1],Tr2[14,][10:21][T0+2],Tr2[14,][10:21][T0+3],Tr2[14,][10:21][T0+4],Tr2[14,][10:21][T0+5],Tr2[14,][10:21][T0+6],Tr2[14,][10:21][T0+7],0)*ifelse(TT0[14]<=T0,0,1),
Tr2[15,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[15,][10:21][T0+1],Tr2[15,][10:21][T0+2],Tr2[15,][10:21][T0+3],Tr2[15,][10:21][T0+4],Tr2[15,][10:21][T0+5],Tr2[15,][10:21][T0+6],Tr2[15,][10:21][T0+7],0)*ifelse(TT0[15]<=T0,0,1),
Tr2[16,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[16,][10:21][T0+1],Tr2[16,][10:21][T0+2],Tr2[16,][10:21][T0+3],Tr2[16,][10:21][T0+4],Tr2[16,][10:21][T0+5],Tr2[16,][10:21][T0+6],Tr2[16,][10:21][T0+7],0)*ifelse(TT0[16]<=T0,0,1),
Tr2[17,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[17,][10:21][T0+1],Tr2[17,][10:21][T0+2],Tr2[17,][10:21][T0+3],Tr2[17,][10:21][T0+4],Tr2[17,][10:21][T0+5],Tr2[17,][10:21][T0+6],Tr2[17,][10:21][T0+7],0)*ifelse(TT0[17]<=T0,0,1),
Tr2[18,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[18,][10:21][T0+1],Tr2[18,][10:21][T0+2],Tr2[18,][10:21][T0+3],Tr2[18,][10:21][T0+4],Tr2[18,][10:21][T0+5],Tr2[18,][10:21][T0+6],Tr2[18,][10:21][T0+7],0)*ifelse(TT0[18]<=T0,0,1),
Tr2[19,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[19,][10:21][T0+1],Tr2[19,][10:21][T0+2],Tr2[19,][10:21][T0+3],Tr2[19,][10:21][T0+4],Tr2[19,][10:21][T0+5],Tr2[19,][10:21][T0+6],Tr2[19,][10:21][T0+7],0)*ifelse(TT0[19]<=T0,0,1),
Tr2[20,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[20,][10:21][T0+1],Tr2[20,][10:21][T0+2],Tr2[20,][10:21][T0+3],Tr2[20,][10:21][T0+4],Tr2[20,][10:21][T0+5],Tr2[20,][10:21][T0+6],Tr2[20,][10:21][T0+7],0)*ifelse(TT0[20]<=T0,0,1),
Tr2[21,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[21,][10:21][T0+1],Tr2[21,][10:21][T0+2],Tr2[21,][10:21][T0+3],Tr2[21,][10:21][T0+4],Tr2[21,][10:21][T0+5],Tr2[21,][10:21][T0+6],Tr2[21,][10:21][T0+7],0)*ifelse(TT0[21]<=T0,0,1),
Tr2[22,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[22,][10:21][T0+1],Tr2[22,][10:21][T0+2],Tr2[22,][10:21][T0+3],Tr2[22,][10:21][T0+4],Tr2[22,][10:21][T0+5],Tr2[22,][10:21][T0+6],Tr2[22,][10:21][T0+7],0)*ifelse(TT0[22]<=T0,0,1),
Tr2[23,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[23,][10:21][T0+1],Tr2[23,][10:21][T0+2],Tr2[23,][10:21][T0+3],Tr2[23,][10:21][T0+4],Tr2[23,][10:21][T0+5],Tr2[23,][10:21][T0+6],Tr2[23,][10:21][T0+7],0)*ifelse(TT0[23]<=T0,0,1),
Tr2[24,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[24,][10:21][T0+1],Tr2[24,][10:21][T0+2],Tr2[24,][10:21][T0+3],Tr2[24,][10:21][T0+4],Tr2[24,][10:21][T0+5],Tr2[24,][10:21][T0+6],Tr2[24,][10:21][T0+7],0)*ifelse(TT0[24]<=T0,0,1),
Tr2[25,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[25,][10:21][T0+1],Tr2[25,][10:21][T0+2],Tr2[25,][10:21][T0+3],Tr2[25,][10:21][T0+4],Tr2[25,][10:21][T0+5],Tr2[25,][10:21][T0+6],Tr2[25,][10:21][T0+7],0)*ifelse(TT0[25]<=T0,0,1),
Tr2[26,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[26,][10:21][T0+1],Tr2[26,][10:21][T0+2],Tr2[26,][10:21][T0+3],Tr2[26,][10:21][T0+4],Tr2[26,][10:21][T0+5],Tr2[26,][10:21][T0+6],Tr2[26,][10:21][T0+7],0)*ifelse(TT0[26]<=T0,0,1),
Tr2[27,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[27,][10:21][T0+1],Tr2[27,][10:21][T0+2],Tr2[27,][10:21][T0+3],Tr2[27,][10:21][T0+4],Tr2[27,][10:21][T0+5],Tr2[27,][10:21][T0+6],Tr2[27,][10:21][T0+7],0)*ifelse(TT0[27]<=T0,0,1),
Tr2[28,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[28,][10:21][T0+1],Tr2[28,][10:21][T0+2],Tr2[28,][10:21][T0+3],Tr2[28,][10:21][T0+4],Tr2[28,][10:21][T0+5],Tr2[28,][10:21][T0+6],Tr2[28,][10:21][T0+7],0)*ifelse(TT0[28]<=T0,0,1),
Tr2[29,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[29,][10:21][T0+1],Tr2[29,][10:21][T0+2],Tr2[29,][10:21][T0+3],Tr2[29,][10:21][T0+4],Tr2[29,][10:21][T0+5],Tr2[29,][10:21][T0+6],Tr2[29,][10:21][T0+7],0)*ifelse(TT0[29]<=T0,0,1),
Tr2[30,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[30,][10:21][T0+1],Tr2[30,][10:21][T0+2],Tr2[30,][10:21][T0+3],Tr2[30,][10:21][T0+4],Tr2[30,][10:21][T0+5],Tr2[30,][10:21][T0+6],Tr2[30,][10:21][T0+7],0)*ifelse(TT0[30]<=T0,0,1) )

yyy<-rbind( 
d1[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment11,second_treatment21,second_treatment31,second_treatment41,second_treatment51,second_treatment61,second_treatment71,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)),
d2[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment12,second_treatment22,second_treatment32,second_treatment42,second_treatment52,second_treatment62,second_treatment72,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s)),
d3[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment13,second_treatment23,second_treatment33,second_treatment43,second_treatment53,second_treatment63,second_treatment73,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s)),
d4[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment14,second_treatment24,second_treatment34,second_treatment44,second_treatment54,second_treatment64,second_treatment74,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s)),
d5[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment15,second_treatment25,second_treatment35,second_treatment45,second_treatment55,second_treatment65,second_treatment75,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s)),
d6[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment16,second_treatment26,second_treatment36,second_treatment46,second_treatment56,second_treatment66,second_treatment76,rep(0,1))*rep(ifelse(TT0[6]<=T0,1,0),(T0+s)),
d7[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment17,second_treatment27,second_treatment37,second_treatment47,second_treatment57,second_treatment67,second_treatment77,rep(0,1))*rep(ifelse(TT0[7]<=T0,1,0),(T0+s)),
d8[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment18,second_treatment28,second_treatment38,second_treatment48,second_treatment58,second_treatment68,second_treatment78,rep(0,1))*rep(ifelse(TT0[8]<=T0,1,0),(T0+s)),
d9[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment19,second_treatment29,second_treatment39,second_treatment49,second_treatment59,second_treatment69,second_treatment79,rep(0,1))*rep(ifelse(TT0[9]<=T0,1,0),(T0+s)),
d10[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment110,second_treatment210,second_treatment310,second_treatment410,second_treatment510,second_treatment610,second_treatment710,rep(0,1))*rep(ifelse(TT0[10]<=T0,1,0),(T0+s)),
d11[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment111,second_treatment211,second_treatment311,second_treatment411,second_treatment511,second_treatment611,second_treatment711,rep(0,1))*rep(ifelse(TT0[11]<=T0,1,0),(T0+s)),
d12[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment112,second_treatment212,second_treatment312,second_treatment412,second_treatment512,second_treatment612,second_treatment712,rep(0,1))*rep(ifelse(TT0[12]<=T0,1,0),(T0+s)),
d13[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment113,second_treatment213,second_treatment313,second_treatment413,second_treatment513,second_treatment613,second_treatment713,rep(0,1))*rep(ifelse(TT0[13]<=T0,1,0),(T0+s)),
d14[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment114,second_treatment214,second_treatment314,second_treatment414,second_treatment514,second_treatment614,second_treatment714,rep(0,1))*rep(ifelse(TT0[14]<=T0,1,0),(T0+s)),
d15[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment115,second_treatment215,second_treatment315,second_treatment415,second_treatment515,second_treatment615,second_treatment715,rep(0,1))*rep(ifelse(TT0[15]<=T0,1,0),(T0+s)),
d16[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment116,second_treatment216,second_treatment316,second_treatment416,second_treatment516,second_treatment616,second_treatment716,rep(0,1))*rep(ifelse(TT0[16]<=T0,1,0),(T0+s)),
d17[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment117,second_treatment217,second_treatment317,second_treatment417,second_treatment517,second_treatment617,second_treatment717,rep(0,1))*rep(ifelse(TT0[17]<=T0,1,0),(T0+s)),
d18[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment118,second_treatment218,second_treatment318,second_treatment418,second_treatment518,second_treatment618,second_treatment718,rep(0,1))*rep(ifelse(TT0[18]<=T0,1,0),(T0+s)),
d19[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment119,second_treatment219,second_treatment319,second_treatment419,second_treatment519,second_treatment619,second_treatment719,rep(0,1))*rep(ifelse(TT0[19]<=T0,1,0),(T0+s)),
d20[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment120,second_treatment220,second_treatment320,second_treatment420,second_treatment520,second_treatment620,second_treatment720,rep(0,1))*rep(ifelse(TT0[20]<=T0,1,0),(T0+s)),
d21[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment121,second_treatment221,second_treatment321,second_treatment421,second_treatment521,second_treatment621,second_treatment721,rep(0,1))*rep(ifelse(TT0[21]<=T0,1,0),(T0+s)),
d22[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment122,second_treatment222,second_treatment322,second_treatment422,second_treatment522,second_treatment622,second_treatment722,rep(0,1))*rep(ifelse(TT0[22]<=T0,1,0),(T0+s)),
d23[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment123,second_treatment223,second_treatment323,second_treatment423,second_treatment523,second_treatment623,second_treatment723,rep(0,1))*rep(ifelse(TT0[23]<=T0,1,0),(T0+s)),
d24[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment124,second_treatment224,second_treatment324,second_treatment424,second_treatment524,second_treatment624,second_treatment724,rep(0,1))*rep(ifelse(TT0[24]<=T0,1,0),(T0+s)),
d25[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment125,second_treatment225,second_treatment325,second_treatment425,second_treatment525,second_treatment625,second_treatment725,rep(0,1))*rep(ifelse(TT0[25]<=T0,1,0),(T0+s)),
d26[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment126,second_treatment226,second_treatment326,second_treatment426,second_treatment526,second_treatment626,second_treatment726,rep(0,1))*rep(ifelse(TT0[26]<=T0,1,0),(T0+s)),
d27[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment127,second_treatment227,second_treatment327,second_treatment427,second_treatment527,second_treatment627,second_treatment727,rep(0,1))*rep(ifelse(TT0[27]<=T0,1,0),(T0+s)),
d28[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment128,second_treatment228,second_treatment328,second_treatment428,second_treatment528,second_treatment628,second_treatment728,rep(0,1))*rep(ifelse(TT0[28]<=T0,1,0),(T0+s)),
d29[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment129,second_treatment229,second_treatment329,second_treatment429,second_treatment529,second_treatment629,second_treatment729,rep(0,1))*rep(ifelse(TT0[29]<=T0,1,0),(T0+s)),
d30[10:21][1:(T0+s)]-c(rep(0,T0),second_treatment130,second_treatment230,second_treatment330,second_treatment430,second_treatment530,second_treatment630,second_treatment730,rep(0,1))*rep(ifelse(TT0[30]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0),sum(DDD[6,]==0),sum(DDD[7,]==0),sum(DDD[8,]==0),sum(DDD[9,]==0),sum(DDD[10,]==0),sum(DDD[11,]==0),sum(DDD[12,]==0),sum(DDD[13,]==0),sum(DDD[14,]==0),sum(DDD[15,]==0),sum(DDD[16,]==0),sum(DDD[17,]==0),sum(DDD[18,]==0),sum(DDD[19,]==0),sum(DDD[20,]==0),sum(DDD[21,]==0),sum(DDD[22,]==0),sum(DDD[23,]==0),sum(DDD[24,]==0),sum(DDD[25,]==0),sum(DDD[26,]==0),sum(DDD[27,]==0),sum(DDD[28,]==0),sum(DDD[29,]==0),sum(DDD[30,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5],2*(a_x[6])*tt1+b_x[6],2*(a_x[7])*tt1+b_x[7],2*(a_x[8])*tt1+b_x[8],2*(a_x[9])*tt1+b_x[9],2*(a_x[10])*tt1+b_x[10],2*(a_x[11])*tt1+b_x[11],2*(a_x[12])*tt1+b_x[12],2*(a_x[13])*tt1+b_x[13],2*(a_x[14])*tt1+b_x[14],2*(a_x[15])*tt1+b_x[15],2*(a_x[16])*tt1+b_x[16],2*(a_x[17])*tt1+b_x[17],2*(a_x[18])*tt1+b_x[18],2*(a_x[19])*tt1+b_x[19],2*(a_x[20])*tt1+b_x[20],2*(a_x[21])*tt1+b_x[21],2*(a_x[22])*tt1+b_x[22],2*(a_x[23])*tt1+b_x[23],2*(a_x[24])*tt1+b_x[24],2*(a_x[25])*tt1+b_x[25],2*(a_x[26])*tt1+b_x[26],2*(a_x[27])*tt1+b_x[27],2*(a_x[28])*tt1+b_x[28],2*(a_x[29])*tt1+b_x[29],2*(a_x[30])*tt1+b_x[30])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],
coe[6,1]+coe[6,2]*(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],
coe[7,1]+coe[7,2]*(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],
coe[8,1]+coe[8,2]*(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],
coe[9,1]+coe[9,2]*(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],
coe[10,1]+coe[10,2]*(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],
coe[11,1]+coe[11,2]*(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],
coe[12,1]+coe[12,2]*(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],
coe[13,1]+coe[13,2]*(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],
coe[14,1]+coe[14,2]*(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],
coe[15,1]+coe[15,2]*(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],
coe[16,1]+coe[16,2]*(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],
coe[17,1]+coe[17,2]*(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],
coe[18,1]+coe[18,2]*(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],
coe[19,1]+coe[19,2]*(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],
coe[20,1]+coe[20,2]*(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],
coe[21,1]+coe[21,2]*(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],
coe[22,1]+coe[22,2]*(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],
coe[23,1]+coe[23,2]*(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],
coe[24,1]+coe[24,2]*(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],
coe[25,1]+coe[25,2]*(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],
coe[26,1]+coe[26,2]*(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],
coe[27,1]+coe[27,2]*(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],
coe[28,1]+coe[28,2]*(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],
coe[29,1]+coe[29,2]*(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],
coe[30,1]+coe[30,2]*(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]),
mean(predict[6,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[6,][1:(T0-S0+1)]),
mean(predict[7,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[7,][1:(T0-S0+1)]),
mean(predict[8,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[8,][1:(T0-S0+1)]),
mean(predict[9,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[9,][1:(T0-S0+1)]),
mean(predict[10,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[10,][1:(T0-S0+1)]),
mean(predict[11,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[11,][1:(T0-S0+1)]),
mean(predict[12,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[12,][1:(T0-S0+1)]),
mean(predict[13,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[13,][1:(T0-S0+1)]),
mean(predict[14,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[14,][1:(T0-S0+1)]),
mean(predict[15,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[15,][1:(T0-S0+1)]),
mean(predict[16,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[16,][1:(T0-S0+1)]),
mean(predict[17,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[17,][1:(T0-S0+1)]),
mean(predict[18,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[18,][1:(T0-S0+1)]),
mean(predict[19,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[19,][1:(T0-S0+1)]),
mean(predict[20,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[20,][1:(T0-S0+1)]),
mean(predict[21,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[21,][1:(T0-S0+1)]),
mean(predict[22,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[22,][1:(T0-S0+1)]),
mean(predict[23,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[23,][1:(T0-S0+1)]),
mean(predict[24,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[24,][1:(T0-S0+1)]),
mean(predict[25,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[25,][1:(T0-S0+1)]),
mean(predict[26,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[26,][1:(T0-S0+1)]),
mean(predict[27,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[27,][1:(T0-S0+1)]),
mean(predict[28,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[28,][1:(T0-S0+1)]),
mean(predict[29,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[29,][1:(T0-S0+1)]),
mean(predict[30,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[30,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

zz2<-rbind( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-rbind( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-rbind( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )



a1<-c()
for(i in 1:30){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3_2<-c()
for(i in 1:30){
a3_2[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[i,]*Y_t[i,])-sum(zz2[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_2[is.nan(a3_2)]<-0

a3_3<-c()
for(i in 1:30){
a3_3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[i,]*Y_t[i,])-sum(zz3[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_3[is.nan(a3_3)]<-0

a3_4<-c()
for(i in 1:30){
a3_4[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[i,]*Y_t[i,])-sum(zz4[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)],DDD[6,][S0:(T0+j)],DDD[7,][S0:(T0+j)],DDD[8,][S0:(T0+j)],DDD[9,][S0:(T0+j)],DDD[10,][S0:(T0+j)],DDD[11,][S0:(T0+j)],DDD[12,][S0:(T0+j)],DDD[13,][S0:(T0+j)],DDD[14,][S0:(T0+j)],DDD[15,][S0:(T0+j)],DDD[16,][S0:(T0+j)],DDD[17,][S0:(T0+j)],DDD[18,][S0:(T0+j)],DDD[19,][S0:(T0+j)],DDD[20,][S0:(T0+j)],DDD[21,][S0:(T0+j)],DDD[22,][S0:(T0+j)],DDD[23,][S0:(T0+j)],DDD[24,][S0:(T0+j)],DDD[25,][S0:(T0+j)],DDD[26,][S0:(T0+j)],DDD[27,][S0:(T0+j)],DDD[28,][S0:(T0+j)],DDD[29,][S0:(T0+j)],DDD[30,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)],yyy[6,][S0:(T0+j)],yyy[7,][S0:(T0+j)],yyy[8,][S0:(T0+j)],yyy[9,][S0:(T0+j)],yyy[10,][S0:(T0+j)],yyy[11,][S0:(T0+j)],yyy[12,][S0:(T0+j)],yyy[13,][S0:(T0+j)],yyy[14,][S0:(T0+j)],yyy[15,][S0:(T0+j)],yyy[16,][S0:(T0+j)],yyy[17,][S0:(T0+j)],yyy[18,][S0:(T0+j)],yyy[19,][S0:(T0+j)],yyy[20,][S0:(T0+j)],yyy[21,][S0:(T0+j)],yyy[22,][S0:(T0+j)],yyy[23,][S0:(T0+j)],yyy[24,][S0:(T0+j)],yyy[25,][S0:(T0+j)],yyy[26,][S0:(T0+j)],yyy[27,][S0:(T0+j)],yyy[28,][S0:(T0+j)],yyy[29,][S0:(T0+j)],yyy[30,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],30))
tt2<-c(rep(t2[10:21][S0:(T0+j)],30))

zz2<-c( x1[10:21][S0:(T0+j)],x2[10:21][S0:(T0+j)],x3[10:21][S0:(T0+j)],x4[10:21][S0:(T0+j)],x5[10:21][S0:(T0+j)],x6[10:21][S0:(T0+j)],x7[10:21][S0:(T0+j)],x8[10:21][S0:(T0+j)],x9[10:21][S0:(T0+j)],x10[10:21][S0:(T0+j)],x11[10:21][S0:(T0+j)],x12[10:21][S0:(T0+j)],x13[10:21][S0:(T0+j)],x14[10:21][S0:(T0+j)],x15[10:21][S0:(T0+j)],x16[10:21][S0:(T0+j)],x17[10:21][S0:(T0+j)],x18[10:21][S0:(T0+j)],x19[10:21][S0:(T0+j)],x20[10:21][S0:(T0+j)],x21[10:21][S0:(T0+j)],x22[10:21][S0:(T0+j)],x23[10:21][S0:(T0+j)],x24[10:21][S0:(T0+j)],x25[10:21][S0:(T0+j)],x26[10:21][S0:(T0+j)],x27[10:21][S0:(T0+j)],x28[10:21][S0:(T0+j)],x29[10:21][S0:(T0+j)],x30[10:21][S0:(T0+j)] )

zz3<-c( z1[10:21][S0:(T0+j)],z2[10:21][S0:(T0+j)],z3[10:21][S0:(T0+j)],z4[10:21][S0:(T0+j)],z5[10:21][S0:(T0+j)],z6[10:21][S0:(T0+j)],z7[10:21][S0:(T0+j)],z8[10:21][S0:(T0+j)],z9[10:21][S0:(T0+j)],z10[10:21][S0:(T0+j)],z11[10:21][S0:(T0+j)],z12[10:21][S0:(T0+j)],z13[10:21][S0:(T0+j)],z14[10:21][S0:(T0+j)],z15[10:21][S0:(T0+j)],z16[10:21][S0:(T0+j)],z17[10:21][S0:(T0+j)],z18[10:21][S0:(T0+j)],z19[10:21][S0:(T0+j)],z20[10:21][S0:(T0+j)],z21[10:21][S0:(T0+j)],z22[10:21][S0:(T0+j)],z23[10:21][S0:(T0+j)],z24[10:21][S0:(T0+j)],z25[10:21][S0:(T0+j)],z26[10:21][S0:(T0+j)],z27[10:21][S0:(T0+j)],z28[10:21][S0:(T0+j)],z29[10:21][S0:(T0+j)],z30[10:21][S0:(T0+j)] )

zz4<-c( w1[10:21][S0:(T0+j)],w2[10:21][S0:(T0+j)],w3[10:21][S0:(T0+j)],w4[10:21][S0:(T0+j)],w5[10:21][S0:(T0+j)],w6[10:21][S0:(T0+j)],w7[10:21][S0:(T0+j)],w8[10:21][S0:(T0+j)],w9[10:21][S0:(T0+j)],w10[10:21][S0:(T0+j)],w11[10:21][S0:(T0+j)],w12[10:21][S0:(T0+j)],w13[10:21][S0:(T0+j)],w14[10:21][S0:(T0+j)],w15[10:21][S0:(T0+j)],w16[10:21][S0:(T0+j)],w17[10:21][S0:(T0+j)],w18[10:21][S0:(T0+j)],w19[10:21][S0:(T0+j)],w20[10:21][S0:(T0+j)],w21[10:21][S0:(T0+j)],w22[10:21][S0:(T0+j)],w23[10:21][S0:(T0+j)],w24[10:21][S0:(T0+j)],w25[10:21][S0:(T0+j)],w26[10:21][S0:(T0+j)],w27[10:21][S0:(T0+j)],w28[10:21][S0:(T0+j)],w29[10:21][S0:(T0+j)],w30[10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)),rep(6,(T0+j-S0+1)),rep(7,(T0+j-S0+1)),rep(8,(T0+j-S0+1)),rep(9,(T0+j-S0+1)),rep(10,(T0+j-S0+1)),rep(11,(T0+j-S0+1)),rep(12,(T0+j-S0+1)),rep(13,(T0+j-S0+1)),rep(14,(T0+j-S0+1)),rep(15,(T0+j-S0+1)),rep(16,(T0+j-S0+1)),rep(17,(T0+j-S0+1)),rep(18,(T0+j-S0+1)),rep(19,(T0+j-S0+1)),rep(20,(T0+j-S0+1)),rep(21,(T0+j-S0+1)),rep(22,(T0+j-S0+1)),rep(23,(T0+j-S0+1)),rep(24,(T0+j-S0+1)),rep(25,(T0+j-S0+1)),rep(26,(T0+j-S0+1)),rep(27,(T0+j-S0+1)),rep(28,(T0+j-S0+1)),rep(29,(T0+j-S0+1)),rep(30,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
#coes<-coefficients(pvcm(yy~Y_t+zz2+DD,data=data_final,index=c("abb"),model="within"))
coes<-coefficients(pvcm(yy~Y_t+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5],(a_y[6]*x_t[6,]+a_x[6]*b_y[6]-a_y[6]*b_x[6])/a_x[6],(a_y[7]*x_t[7,]+a_x[7]*b_y[7]-a_y[7]*b_x[7])/a_x[7],(a_y[8]*x_t[8,]+a_x[8]*b_y[8]-a_y[8]*b_x[8])/a_x[8],(a_y[9]*x_t[9,]+a_x[9]*b_y[9]-a_y[9]*b_x[9])/a_x[9],(a_y[10]*x_t[10,]+a_x[10]*b_y[10]-a_y[10]*b_x[10])/a_x[10],(a_y[11]*x_t[11,]+a_x[11]*b_y[11]-a_y[11]*b_x[11])/a_x[11],(a_y[12]*x_t[12,]+a_x[12]*b_y[12]-a_y[12]*b_x[12])/a_x[12],(a_y[13]*x_t[13,]+a_x[13]*b_y[13]-a_y[13]*b_x[13])/a_x[13],(a_y[14]*x_t[14,]+a_x[14]*b_y[14]-a_y[14]*b_x[14])/a_x[14],(a_y[15]*x_t[15,]+a_x[15]*b_y[15]-a_y[15]*b_x[15])/a_x[15],(a_y[16]*x_t[16,]+a_x[16]*b_y[16]-a_y[16]*b_x[16])/a_x[16],(a_y[17]*x_t[17,]+a_x[17]*b_y[17]-a_y[17]*b_x[17])/a_x[17],(a_y[18]*x_t[18,]+a_x[18]*b_y[18]-a_y[18]*b_x[18])/a_x[18],(a_y[19]*x_t[19,]+a_x[19]*b_y[19]-a_y[19]*b_x[19])/a_x[19],(a_y[20]*x_t[20,]+a_x[20]*b_y[20]-a_y[20]*b_x[20])/a_x[20],(a_y[21]*x_t[21,]+a_x[21]*b_y[21]-a_y[21]*b_x[21])/a_x[21],(a_y[22]*x_t[22,]+a_x[22]*b_y[22]-a_y[22]*b_x[22])/a_x[22],(a_y[23]*x_t[23,]+a_x[23]*b_y[23]-a_y[23]*b_x[23])/a_x[23],(a_y[24]*x_t[24,]+a_x[24]*b_y[24]-a_y[24]*b_x[24])/a_x[24],(a_y[25]*x_t[25,]+a_x[25]*b_y[25]-a_y[25]*b_x[25])/a_x[25],(a_y[26]*x_t[26,]+a_x[26]*b_y[26]-a_y[26]*b_x[26])/a_x[26],(a_y[27]*x_t[27,]+a_x[27]*b_y[27]-a_y[27]*b_x[27])/a_x[27],(a_y[28]*x_t[28,]+a_x[28]*b_y[28]-a_y[28]*b_x[28])/a_x[28],(a_y[29]*x_t[29,]+a_x[29]*b_y[29]-a_y[29]*b_x[29])/a_x[29],(a_y[30]*x_t[30,]+a_x[30]*b_y[30]-a_y[30]*b_x[30])/a_x[30]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:30){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)])) )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:30){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


second_treatment81_sd<-var[1]^0.5
second_treatment82_sd<-var[2]^0.5
second_treatment83_sd<-var[3]^0.5
second_treatment84_sd<-var[4]^0.5
second_treatment85_sd<-var[5]^0.5
second_treatment86_sd<-var[6]^0.5
second_treatment87_sd<-var[7]^0.5
second_treatment88_sd<-var[8]^0.5
second_treatment89_sd<-var[9]^0.5
second_treatment810_sd<-var[10]^0.5
second_treatment811_sd<-var[11]^0.5
second_treatment812_sd<-var[12]^0.5
second_treatment813_sd<-var[13]^0.5
second_treatment814_sd<-var[14]^0.5
second_treatment815_sd<-var[15]^0.5
second_treatment816_sd<-var[16]^0.5
second_treatment817_sd<-var[17]^0.5
second_treatment818_sd<-var[18]^0.5
second_treatment819_sd<-var[19]^0.5
second_treatment820_sd<-var[20]^0.5
second_treatment821_sd<-var[21]^0.5
second_treatment822_sd<-var[22]^0.5
second_treatment823_sd<-var[23]^0.5
second_treatment824_sd<-var[24]^0.5
second_treatment825_sd<-var[25]^0.5
second_treatment826_sd<-var[26]^0.5
second_treatment827_sd<-var[27]^0.5
second_treatment828_sd<-var[28]^0.5
second_treatment839_sd<-var[29]^0.5
second_treatment830_sd<-var[30]^0.5


R<-list()
for (i in 1:30){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:30){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:30){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:30){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper8<-c()
second_lower8<-c()
for(i in 1:30){
second_upper8[i]<-second_treatment8[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower8[i]<-second_treatment8[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper8
second_lower8

mean(second_treatment8)/(sum(var)/900)^0.5





mean(second_treatment1)
mean(second_treatment2)
mean(second_treatment3)
mean(second_treatment4)
mean(second_treatment5)
mean(second_treatment6)
mean(second_treatment7)
mean(second_treatment8)




upper<-list(second_upper1,second_upper2,second_upper3,second_upper4,second_upper5,second_upper6,second_upper7,second_upper8)

upper<-data.frame(upper)
new1_upper<-as.numeric(upper[1,])
new2_upper<-as.numeric(upper[2,])
new3_upper<-as.numeric(upper[3,])
new4_upper<-as.numeric(upper[4,])
new5_upper<-as.numeric(upper[5,])
new6_upper<-as.numeric(upper[6,])
new7_upper<-as.numeric(upper[7,])
new8_upper<-as.numeric(upper[8,])
new9_upper<-as.numeric(upper[9,])
new10_upper<-as.numeric(upper[10,])
new11_upper<-as.numeric(upper[11,])
new12_upper<-as.numeric(upper[12,])
new13_upper<-as.numeric(upper[13,])
new14_upper<-as.numeric(upper[14,])
new15_upper<-as.numeric(upper[15,])
new16_upper<-as.numeric(upper[16,])
new17_upper<-as.numeric(upper[17,])
new18_upper<-as.numeric(upper[18,])
new19_upper<-as.numeric(upper[19,])
new20_upper<-as.numeric(upper[20,])
new21_upper<-as.numeric(upper[21,])
new22_upper<-as.numeric(upper[22,])
new23_upper<-as.numeric(upper[23,])
new24_upper<-as.numeric(upper[24,])
new25_upper<-as.numeric(upper[25,])
new26_upper<-as.numeric(upper[26,])
new27_upper<-as.numeric(upper[27,])
new28_upper<-as.numeric(upper[28,])
new29_upper<-as.numeric(upper[29,])
new30_upper<-as.numeric(upper[30,])


lower<-list(second_lower1,second_lower2,second_lower3,second_lower4,second_lower5,second_lower6,second_lower7,second_lower8)

lower<-data.frame(lower)
new1_lower<-as.numeric(lower[1,])
new2_lower<-as.numeric(lower[2,])
new3_lower<-as.numeric(lower[3,])
new4_lower<-as.numeric(lower[4,])
new5_lower<-as.numeric(lower[5,])
new6_lower<-as.numeric(lower[6,])
new7_lower<-as.numeric(lower[7,])
new8_lower<-as.numeric(lower[8,])
new9_lower<-as.numeric(lower[9,])
new10_lower<-as.numeric(lower[10,])
new11_lower<-as.numeric(lower[11,])
new12_lower<-as.numeric(lower[12,])
new13_lower<-as.numeric(lower[13,])
new14_lower<-as.numeric(lower[14,])
new15_lower<-as.numeric(lower[15,])
new16_lower<-as.numeric(lower[16,])
new17_lower<-as.numeric(lower[17,])
new18_lower<-as.numeric(lower[18,])
new19_lower<-as.numeric(lower[19,])
new20_lower<-as.numeric(lower[20,])
new21_lower<-as.numeric(lower[21,])
new22_lower<-as.numeric(lower[22,])
new23_lower<-as.numeric(lower[23,])
new24_lower<-as.numeric(lower[24,])
new25_lower<-as.numeric(lower[25,])
new26_lower<-as.numeric(lower[26,])
new27_lower<-as.numeric(lower[27,])
new28_lower<-as.numeric(lower[28,])
new29_lower<-as.numeric(lower[29,])
new30_lower<-as.numeric(lower[30,])





final_treatment<-list(second_treatment1,second_treatment2,second_treatment3,second_treatment4,second_treatment5,second_treatment6,second_treatment7,second_treatment8)

final_treatment<-data.frame(final_treatment)
second1<-as.numeric(final_treatment[1,])
second2<-as.numeric(final_treatment[2,])
second3<-as.numeric(final_treatment[3,])
second4<-as.numeric(final_treatment[4,])
second5<-as.numeric(final_treatment[5,])
second6<-as.numeric(final_treatment[6,])
second7<-as.numeric(final_treatment[7,])
second8<-as.numeric(final_treatment[8,])
second9<-as.numeric(final_treatment[9,])
second10<-as.numeric(final_treatment[10,])
second11<-as.numeric(final_treatment[11,])
second12<-as.numeric(final_treatment[12,])
second13<-as.numeric(final_treatment[13,])
second14<-as.numeric(final_treatment[14,])
second15<-as.numeric(final_treatment[15,])
second16<-as.numeric(final_treatment[16,])
second17<-as.numeric(final_treatment[17,])
second18<-as.numeric(final_treatment[18,])
second19<-as.numeric(final_treatment[19,])
second20<-as.numeric(final_treatment[20,])
second21<-as.numeric(final_treatment[21,])
second22<-as.numeric(final_treatment[22,])
second23<-as.numeric(final_treatment[23,])
second24<-as.numeric(final_treatment[24,])
second25<-as.numeric(final_treatment[25,])
second26<-as.numeric(final_treatment[26,])
second27<-as.numeric(final_treatment[27,])
second28<-as.numeric(final_treatment[28,])
second29<-as.numeric(final_treatment[29,])
second30<-as.numeric(final_treatment[30,])


average<-(second1+second2+second3+second4+second5+second6+second7+second8+second9+second10+second11+second12+second13+second14+second15+second16+second17+second18+second19+second20+second21+second22+second23+second24+second25+second26+second27+second28+second29+second30)/30

average_upper<-(new1_upper+new2_upper+new3_upper+new4_upper+new5_upper+new6_upper+new7_upper+new8_upper+new9_upper+new10_upper+new11_upper+new12_upper+new13_upper+new14_upper+new15_upper+new16_upper+new17_upper+new18_upper+new19_upper+new20_upper+new21_upper+new22_upper+new23_upper+new24_upper+new25_upper+new26_upper+new27_upper+new28_upper+new29_upper+new30_upper)/30

average_lower<-(new1_lower+new2_lower+new3_lower+new4_lower+new5_lower+new6_lower+new7_lower+new8_lower+new9_lower+new10_lower+new11_lower+new12_lower+new13_lower+new14_lower+new15_lower+new16_lower+new17_lower+new18_lower+new19_lower+new20_lower+new21_lower+new22_lower+new23_lower+new24_lower+new25_lower+new26_lower+new27_lower+new28_lower+new29_lower+new30_lower)/30

min<-min(average,average_upper,average_lower)
max<-max(average,average_upper,average_lower)
plot(average,ylim=c(min,max))
par(new=T)
plot(average_upper,pch="",ylim=c(min,max))
lines(average_upper)
par(new=T)
plot(average_lower,pch="",ylim=c(min,max))
lines(average_lower)
abline(h=0,lty=3,col="lightgrey")
abline(h=mean(average),lty=3)










##============================================================================================================================================
##============================================================================================================================================




#the final results#




new_treatment151_var<-new_treatment_151_sd^2
new_treatment152_var<-new_treatment_152_sd^2
new_treatment153_var<-new_treatment_153_sd^2
new_treatment154_var<-new_treatment_154_sd^2
new_treatment155_var<-new_treatment_155_sd^2
new_treatment156_var<-new_treatment_156_sd^2
new_treatment157_var<-new_treatment_157_sd^2
new_treatment158_var<-new_treatment_158_sd^2
new_treatment159_var<-new_treatment_159_sd^2
new_treatment1510_var<-new_treatment_1510_sd^2
new_treatment1511_var<-new_treatment_1511_sd^2
new_treatment1512_var<-new_treatment_1512_sd^2
new_treatment1513_var<-new_treatment_1513_sd^2
new_treatment1514_var<-new_treatment_1514_sd^2
new_treatment1515_var<-new_treatment_1515_sd^2
new_treatment1516_var<-new_treatment_1516_sd^2
new_treatment1517_var<-new_treatment_1517_sd^2
new_treatment1518_var<-new_treatment_1518_sd^2
new_treatment1519_var<-new_treatment_1519_sd^2
new_treatment1520_var<-new_treatment_1520_sd^2
new_treatment1521_var<-new_treatment_1521_sd^2
new_treatment1522_var<-new_treatment_1522_sd^2
new_treatment1523_var<-new_treatment_1523_sd^2
new_treatment1524_var<-new_treatment_1524_sd^2
new_treatment1525_var<-new_treatment_1525_sd^2
new_treatment1526_var<-new_treatment_1526_sd^2
new_treatment1527_var<-new_treatment_1527_sd^2
new_treatment1528_var<-new_treatment_1528_sd^2
new_treatment1529_var<-new_treatment_1529_sd^2
new_treatment1530_var<-new_treatment_1530_sd^2

new_treatment141_var<-new_treatment_141_sd^2
new_treatment142_var<-new_treatment_142_sd^2
new_treatment143_var<-new_treatment_143_sd^2
new_treatment144_var<-new_treatment_144_sd^2
new_treatment145_var<-new_treatment_145_sd^2
new_treatment146_var<-new_treatment_146_sd^2
new_treatment147_var<-new_treatment_147_sd^2
new_treatment148_var<-new_treatment_148_sd^2
new_treatment149_var<-new_treatment_149_sd^2
new_treatment1410_var<-new_treatment_1410_sd^2
new_treatment1411_var<-new_treatment_1411_sd^2
new_treatment1412_var<-new_treatment_1412_sd^2
new_treatment1413_var<-new_treatment_1413_sd^2
new_treatment1414_var<-new_treatment_1414_sd^2
new_treatment1415_var<-new_treatment_1415_sd^2
new_treatment1416_var<-new_treatment_1416_sd^2
new_treatment1417_var<-new_treatment_1417_sd^2
new_treatment1418_var<-new_treatment_1418_sd^2
new_treatment1419_var<-new_treatment_1419_sd^2
new_treatment1420_var<-new_treatment_1420_sd^2
new_treatment1421_var<-new_treatment_1421_sd^2
new_treatment1422_var<-new_treatment_1422_sd^2
new_treatment1423_var<-new_treatment_1423_sd^2
new_treatment1424_var<-new_treatment_1424_sd^2
new_treatment1425_var<-new_treatment_1425_sd^2
new_treatment1426_var<-new_treatment_1426_sd^2
new_treatment1427_var<-new_treatment_1427_sd^2
new_treatment1428_var<-new_treatment_1428_sd^2
new_treatment1429_var<-new_treatment_1429_sd^2
new_treatment1430_var<-new_treatment_1430_sd^2

new_treatment131_var<-new_treatment_131_sd^2
new_treatment132_var<-new_treatment_132_sd^2
new_treatment133_var<-new_treatment_133_sd^2
new_treatment134_var<-new_treatment_134_sd^2
new_treatment135_var<-new_treatment_135_sd^2
new_treatment136_var<-new_treatment_136_sd^2
new_treatment137_var<-new_treatment_137_sd^2
new_treatment138_var<-new_treatment_138_sd^2
new_treatment139_var<-new_treatment_139_sd^2
new_treatment1310_var<-new_treatment_1310_sd^2
new_treatment1311_var<-new_treatment_1311_sd^2
new_treatment1312_var<-new_treatment_1312_sd^2
new_treatment1313_var<-new_treatment_1313_sd^2
new_treatment1314_var<-new_treatment_1314_sd^2
new_treatment1315_var<-new_treatment_1315_sd^2
new_treatment1316_var<-new_treatment_1316_sd^2
new_treatment1317_var<-new_treatment_1317_sd^2
new_treatment1318_var<-new_treatment_1318_sd^2
new_treatment1319_var<-new_treatment_1319_sd^2
new_treatment1320_var<-new_treatment_1320_sd^2
new_treatment1321_var<-new_treatment_1321_sd^2
new_treatment1322_var<-new_treatment_1322_sd^2
new_treatment1323_var<-new_treatment_1323_sd^2
new_treatment1324_var<-new_treatment_1324_sd^2
new_treatment1325_var<-new_treatment_1325_sd^2
new_treatment1326_var<-new_treatment_1326_sd^2
new_treatment1327_var<-new_treatment_1327_sd^2
new_treatment1328_var<-new_treatment_1328_sd^2
new_treatment1329_var<-new_treatment_1329_sd^2
new_treatment1330_var<-new_treatment_1330_sd^2

new_treatment121_var<-new_treatment_121_sd^2
new_treatment122_var<-new_treatment_122_sd^2
new_treatment123_var<-new_treatment_123_sd^2
new_treatment124_var<-new_treatment_124_sd^2
new_treatment125_var<-new_treatment_125_sd^2
new_treatment126_var<-new_treatment_126_sd^2
new_treatment127_var<-new_treatment_127_sd^2
new_treatment128_var<-new_treatment_128_sd^2
new_treatment129_var<-new_treatment_129_sd^2
new_treatment1210_var<-new_treatment_1210_sd^2
new_treatment1211_var<-new_treatment_1211_sd^2
new_treatment1212_var<-new_treatment_1212_sd^2
new_treatment1213_var<-new_treatment_1213_sd^2
new_treatment1214_var<-new_treatment_1214_sd^2
new_treatment1215_var<-new_treatment_1215_sd^2
new_treatment1216_var<-new_treatment_1216_sd^2
new_treatment1217_var<-new_treatment_1217_sd^2
new_treatment1218_var<-new_treatment_1218_sd^2
new_treatment1219_var<-new_treatment_1219_sd^2
new_treatment1220_var<-new_treatment_1220_sd^2
new_treatment1221_var<-new_treatment_1221_sd^2
new_treatment1222_var<-new_treatment_1222_sd^2
new_treatment1223_var<-new_treatment_1223_sd^2
new_treatment1224_var<-new_treatment_1224_sd^2
new_treatment1225_var<-new_treatment_1225_sd^2
new_treatment1226_var<-new_treatment_1226_sd^2
new_treatment1227_var<-new_treatment_1227_sd^2
new_treatment1228_var<-new_treatment_1228_sd^2
new_treatment1229_var<-new_treatment_1229_sd^2
new_treatment1230_var<-new_treatment_1230_sd^2

new_treatment111_var<-new_treatment_111_sd^2
new_treatment112_var<-new_treatment_112_sd^2
new_treatment113_var<-new_treatment_113_sd^2
new_treatment114_var<-new_treatment_114_sd^2
new_treatment115_var<-new_treatment_115_sd^2
new_treatment116_var<-new_treatment_116_sd^2
new_treatment117_var<-new_treatment_117_sd^2
new_treatment118_var<-new_treatment_118_sd^2
new_treatment119_var<-new_treatment_119_sd^2
new_treatment1110_var<-new_treatment_1110_sd^2
new_treatment1111_var<-new_treatment_1111_sd^2
new_treatment1112_var<-new_treatment_1112_sd^2
new_treatment1113_var<-new_treatment_1113_sd^2
new_treatment1114_var<-new_treatment_1114_sd^2
new_treatment1115_var<-new_treatment_1115_sd^2
new_treatment1116_var<-new_treatment_1116_sd^2
new_treatment1117_var<-new_treatment_1117_sd^2
new_treatment1118_var<-new_treatment_1118_sd^2
new_treatment1119_var<-new_treatment_1119_sd^2
new_treatment1120_var<-new_treatment_1120_sd^2
new_treatment1121_var<-new_treatment_1121_sd^2
new_treatment1122_var<-new_treatment_1122_sd^2
new_treatment1123_var<-new_treatment_1123_sd^2
new_treatment1124_var<-new_treatment_1124_sd^2
new_treatment1125_var<-new_treatment_1125_sd^2
new_treatment1126_var<-new_treatment_1126_sd^2
new_treatment1127_var<-new_treatment_1127_sd^2
new_treatment1128_var<-new_treatment_1128_sd^2
new_treatment1129_var<-new_treatment_1129_sd^2
new_treatment1130_var<-new_treatment_1130_sd^2

new_treatment101_var<-new_treatment101_sd^2
new_treatment102_var<-new_treatment102_sd^2
new_treatment103_var<-new_treatment103_sd^2
new_treatment104_var<-new_treatment104_sd^2
new_treatment105_var<-new_treatment105_sd^2
new_treatment106_var<-new_treatment106_sd^2
new_treatment107_var<-new_treatment107_sd^2
new_treatment108_var<-new_treatment108_sd^2
new_treatment109_var<-new_treatment109_sd^2
new_treatment1010_var<-new_treatment1010_sd^2
new_treatment1011_var<-new_treatment1011_sd^2
new_treatment1012_var<-new_treatment1012_sd^2
new_treatment1013_var<-new_treatment1013_sd^2
new_treatment1014_var<-new_treatment1014_sd^2
new_treatment1015_var<-new_treatment1015_sd^2
new_treatment1016_var<-new_treatment1016_sd^2
new_treatment1017_var<-new_treatment1017_sd^2
new_treatment1018_var<-new_treatment1018_sd^2
new_treatment1019_var<-new_treatment1019_sd^2
new_treatment1020_var<-new_treatment1020_sd^2
new_treatment1021_var<-new_treatment1021_sd^2
new_treatment1022_var<-new_treatment1022_sd^2
new_treatment1023_var<-new_treatment1023_sd^2
new_treatment1024_var<-new_treatment1024_sd^2
new_treatment1025_var<-new_treatment1025_sd^2
new_treatment1026_var<-new_treatment1026_sd^2
new_treatment1027_var<-new_treatment1027_sd^2
new_treatment1028_var<-new_treatment1028_sd^2
new_treatment1029_var<-new_treatment1029_sd^2
new_treatment1030_var<-new_treatment1030_sd^2

new_treatment91_var<-new_treatment91_sd^2
new_treatment92_var<-new_treatment92_sd^2
new_treatment93_var<-new_treatment93_sd^2
new_treatment94_var<-new_treatment94_sd^2
new_treatment95_var<-new_treatment95_sd^2
new_treatment96_var<-new_treatment96_sd^2
new_treatment97_var<-new_treatment97_sd^2
new_treatment98_var<-new_treatment98_sd^2
new_treatment99_var<-new_treatment99_sd^2
new_treatment910_var<-new_treatment910_sd^2
new_treatment911_var<-new_treatment911_sd^2
new_treatment912_var<-new_treatment912_sd^2
new_treatment913_var<-new_treatment913_sd^2
new_treatment914_var<-new_treatment914_sd^2
new_treatment915_var<-new_treatment915_sd^2
new_treatment916_var<-new_treatment916_sd^2
new_treatment917_var<-new_treatment917_sd^2
new_treatment918_var<-new_treatment918_sd^2
new_treatment919_var<-new_treatment919_sd^2
new_treatment920_var<-new_treatment920_sd^2
new_treatment921_var<-new_treatment921_sd^2
new_treatment922_var<-new_treatment922_sd^2
new_treatment923_var<-new_treatment923_sd^2
new_treatment924_var<-new_treatment924_sd^2
new_treatment925_var<-new_treatment925_sd^2
new_treatment926_var<-new_treatment926_sd^2
new_treatment927_var<-new_treatment927_sd^2
new_treatment928_var<-new_treatment928_sd^2
new_treatment929_var<-new_treatment929_sd^2
new_treatment930_var<-new_treatment930_sd^2

new_treatment81_var<-new_treatment81_sd^2
new_treatment82_var<-new_treatment82_sd^2
new_treatment83_var<-new_treatment83_sd^2
new_treatment84_var<-new_treatment84_sd^2
new_treatment85_var<-new_treatment85_sd^2
new_treatment86_var<-new_treatment86_sd^2
new_treatment87_var<-new_treatment87_sd^2
new_treatment88_var<-new_treatment88_sd^2
new_treatment89_var<-new_treatment89_sd^2
new_treatment810_var<-new_treatment810_sd^2
new_treatment811_var<-new_treatment811_sd^2
new_treatment812_var<-new_treatment812_sd^2
new_treatment813_var<-new_treatment813_sd^2
new_treatment814_var<-new_treatment814_sd^2
new_treatment815_var<-new_treatment815_sd^2
new_treatment816_var<-new_treatment816_sd^2
new_treatment817_var<-new_treatment817_sd^2
new_treatment818_var<-new_treatment818_sd^2
new_treatment819_var<-new_treatment819_sd^2
new_treatment820_var<-new_treatment820_sd^2
new_treatment821_var<-new_treatment821_sd^2
new_treatment822_var<-new_treatment822_sd^2
new_treatment823_var<-new_treatment823_sd^2
new_treatment824_var<-new_treatment824_sd^2
new_treatment825_var<-new_treatment825_sd^2
new_treatment826_var<-new_treatment826_sd^2
new_treatment827_var<-new_treatment827_sd^2
new_treatment828_var<-new_treatment828_sd^2
new_treatment829_var<-new_treatment829_sd^2
new_treatment830_var<-new_treatment830_sd^2

new_treatment71_var<-new_treatment71_sd^2
new_treatment72_var<-new_treatment72_sd^2
new_treatment73_var<-new_treatment73_sd^2
new_treatment74_var<-new_treatment74_sd^2
new_treatment75_var<-new_treatment75_sd^2
new_treatment76_var<-new_treatment76_sd^2
new_treatment77_var<-new_treatment77_sd^2
new_treatment78_var<-new_treatment78_sd^2
new_treatment79_var<-new_treatment79_sd^2
new_treatment710_var<-new_treatment710_sd^2
new_treatment711_var<-new_treatment711_sd^2
new_treatment712_var<-new_treatment712_sd^2
new_treatment713_var<-new_treatment713_sd^2
new_treatment714_var<-new_treatment714_sd^2
new_treatment715_var<-new_treatment715_sd^2
new_treatment716_var<-new_treatment716_sd^2
new_treatment717_var<-new_treatment717_sd^2
new_treatment718_var<-new_treatment718_sd^2
new_treatment719_var<-new_treatment719_sd^2
new_treatment720_var<-new_treatment720_sd^2
new_treatment721_var<-new_treatment721_sd^2
new_treatment722_var<-new_treatment722_sd^2
new_treatment723_var<-new_treatment723_sd^2
new_treatment724_var<-new_treatment724_sd^2
new_treatment725_var<-new_treatment725_sd^2
new_treatment726_var<-new_treatment726_sd^2
new_treatment727_var<-new_treatment727_sd^2
new_treatment728_var<-new_treatment728_sd^2
new_treatment729_var<-new_treatment729_sd^2
new_treatment730_var<-new_treatment730_sd^2

new_treatment61_var<-new_treatment61_sd^2
new_treatment62_var<-new_treatment62_sd^2
new_treatment63_var<-new_treatment63_sd^2
new_treatment64_var<-new_treatment64_sd^2
new_treatment65_var<-new_treatment65_sd^2
new_treatment66_var<-new_treatment66_sd^2
new_treatment67_var<-new_treatment67_sd^2
new_treatment68_var<-new_treatment68_sd^2
new_treatment69_var<-new_treatment69_sd^2
new_treatment610_var<-new_treatment610_sd^2
new_treatment611_var<-new_treatment611_sd^2
new_treatment612_var<-new_treatment612_sd^2
new_treatment613_var<-new_treatment613_sd^2
new_treatment614_var<-new_treatment614_sd^2
new_treatment615_var<-new_treatment615_sd^2
new_treatment616_var<-new_treatment616_sd^2
new_treatment617_var<-new_treatment617_sd^2
new_treatment618_var<-new_treatment618_sd^2
new_treatment619_var<-new_treatment619_sd^2
new_treatment620_var<-new_treatment620_sd^2
new_treatment621_var<-new_treatment621_sd^2
new_treatment622_var<-new_treatment622_sd^2
new_treatment623_var<-new_treatment623_sd^2
new_treatment624_var<-new_treatment624_sd^2
new_treatment625_var<-new_treatment625_sd^2
new_treatment626_var<-new_treatment626_sd^2
new_treatment627_var<-new_treatment627_sd^2
new_treatment628_var<-new_treatment628_sd^2
new_treatment629_var<-new_treatment629_sd^2
new_treatment630_var<-new_treatment630_sd^2

new_treatment51_var<-new_treatment51_sd^2
new_treatment52_var<-new_treatment52_sd^2
new_treatment53_var<-new_treatment53_sd^2
new_treatment54_var<-new_treatment54_sd^2
new_treatment55_var<-new_treatment55_sd^2
new_treatment56_var<-new_treatment56_sd^2
new_treatment57_var<-new_treatment57_sd^2
new_treatment58_var<-new_treatment58_sd^2
new_treatment59_var<-new_treatment59_sd^2
new_treatment510_var<-new_treatment510_sd^2
new_treatment511_var<-new_treatment511_sd^2
new_treatment512_var<-new_treatment512_sd^2
new_treatment513_var<-new_treatment513_sd^2
new_treatment514_var<-new_treatment514_sd^2
new_treatment515_var<-new_treatment515_sd^2
new_treatment516_var<-new_treatment516_sd^2
new_treatment517_var<-new_treatment517_sd^2
new_treatment518_var<-new_treatment518_sd^2
new_treatment519_var<-new_treatment519_sd^2
new_treatment520_var<-new_treatment520_sd^2
new_treatment521_var<-new_treatment521_sd^2
new_treatment522_var<-new_treatment522_sd^2
new_treatment523_var<-new_treatment523_sd^2
new_treatment524_var<-new_treatment524_sd^2
new_treatment525_var<-new_treatment525_sd^2
new_treatment526_var<-new_treatment526_sd^2
new_treatment527_var<-new_treatment527_sd^2
new_treatment528_var<-new_treatment528_sd^2
new_treatment529_var<-new_treatment529_sd^2
new_treatment530_var<-new_treatment530_sd^2

new_treatment41_var<-new_treatment41_sd^2
new_treatment42_var<-new_treatment42_sd^2
new_treatment43_var<-new_treatment43_sd^2
new_treatment44_var<-new_treatment44_sd^2
new_treatment45_var<-new_treatment45_sd^2
new_treatment46_var<-new_treatment46_sd^2
new_treatment47_var<-new_treatment47_sd^2
new_treatment48_var<-new_treatment48_sd^2
new_treatment49_var<-new_treatment49_sd^2
new_treatment410_var<-new_treatment410_sd^2
new_treatment411_var<-new_treatment411_sd^2
new_treatment412_var<-new_treatment412_sd^2
new_treatment413_var<-new_treatment413_sd^2
new_treatment414_var<-new_treatment414_sd^2
new_treatment415_var<-new_treatment415_sd^2
new_treatment416_var<-new_treatment416_sd^2
new_treatment417_var<-new_treatment417_sd^2
new_treatment418_var<-new_treatment418_sd^2
new_treatment419_var<-new_treatment419_sd^2
new_treatment420_var<-new_treatment420_sd^2
new_treatment421_var<-new_treatment421_sd^2
new_treatment422_var<-new_treatment422_sd^2
new_treatment423_var<-new_treatment423_sd^2
new_treatment424_var<-new_treatment424_sd^2
new_treatment425_var<-new_treatment425_sd^2
new_treatment426_var<-new_treatment426_sd^2
new_treatment427_var<-new_treatment427_sd^2
new_treatment428_var<-new_treatment428_sd^2
new_treatment429_var<-new_treatment429_sd^2
new_treatment430_var<-new_treatment430_sd^2

new_treatment31_var<-new_treatment31_sd^2
new_treatment32_var<-new_treatment32_sd^2
new_treatment33_var<-new_treatment33_sd^2
new_treatment34_var<-new_treatment34_sd^2
new_treatment35_var<-new_treatment35_sd^2
new_treatment36_var<-new_treatment36_sd^2
new_treatment37_var<-new_treatment37_sd^2
new_treatment38_var<-new_treatment38_sd^2
new_treatment39_var<-new_treatment39_sd^2
new_treatment310_var<-new_treatment310_sd^2
new_treatment311_var<-new_treatment311_sd^2
new_treatment312_var<-new_treatment312_sd^2
new_treatment313_var<-new_treatment313_sd^2
new_treatment314_var<-new_treatment314_sd^2
new_treatment315_var<-new_treatment315_sd^2
new_treatment316_var<-new_treatment316_sd^2
new_treatment317_var<-new_treatment317_sd^2
new_treatment318_var<-new_treatment318_sd^2
new_treatment319_var<-new_treatment319_sd^2
new_treatment320_var<-new_treatment320_sd^2
new_treatment321_var<-new_treatment321_sd^2
new_treatment322_var<-new_treatment322_sd^2
new_treatment323_var<-new_treatment323_sd^2
new_treatment324_var<-new_treatment324_sd^2
new_treatment325_var<-new_treatment325_sd^2
new_treatment326_var<-new_treatment326_sd^2
new_treatment327_var<-new_treatment327_sd^2
new_treatment328_var<-new_treatment328_sd^2
new_treatment329_var<-new_treatment329_sd^2
new_treatment330_var<-new_treatment330_sd^2

new_treatment21_var<-new_treatment21_sd^2
new_treatment22_var<-new_treatment22_sd^2
new_treatment23_var<-new_treatment23_sd^2
new_treatment24_var<-new_treatment24_sd^2
new_treatment25_var<-new_treatment25_sd^2
new_treatment26_var<-new_treatment26_sd^2
new_treatment27_var<-new_treatment27_sd^2
new_treatment28_var<-new_treatment28_sd^2
new_treatment29_var<-new_treatment29_sd^2
new_treatment210_var<-new_treatment210_sd^2
new_treatment211_var<-new_treatment211_sd^2
new_treatment212_var<-new_treatment212_sd^2
new_treatment213_var<-new_treatment213_sd^2
new_treatment214_var<-new_treatment214_sd^2
new_treatment215_var<-new_treatment215_sd^2
new_treatment216_var<-new_treatment216_sd^2
new_treatment217_var<-new_treatment217_sd^2
new_treatment218_var<-new_treatment218_sd^2
new_treatment219_var<-new_treatment219_sd^2
new_treatment220_var<-new_treatment220_sd^2
new_treatment221_var<-new_treatment221_sd^2
new_treatment222_var<-new_treatment222_sd^2
new_treatment223_var<-new_treatment223_sd^2
new_treatment224_var<-new_treatment224_sd^2
new_treatment225_var<-new_treatment225_sd^2
new_treatment226_var<-new_treatment226_sd^2
new_treatment227_var<-new_treatment227_sd^2
new_treatment228_var<-new_treatment228_sd^2
new_treatment229_var<-new_treatment229_sd^2
new_treatment230_var<-new_treatment230_sd^2

new_treatment11_var<-new_treatment11_sd^2
new_treatment12_var<-new_treatment12_sd^2
new_treatment13_var<-new_treatment13_sd^2
new_treatment14_var<-new_treatment14_sd^2
new_treatment15_var<-new_treatment15_sd^2
new_treatment16_var<-new_treatment16_sd^2
new_treatment17_var<-new_treatment17_sd^2
new_treatment18_var<-new_treatment18_sd^2
new_treatment19_var<-new_treatment19_sd^2
new_treatment110_var<-new_treatment110_sd^2
new_treatment111_var<-new_treatment111_sd^2
new_treatment112_var<-new_treatment112_sd^2
new_treatment113_var<-new_treatment113_sd^2
new_treatment114_var<-new_treatment114_sd^2
new_treatment115_var<-new_treatment115_sd^2
new_treatment116_var<-new_treatment116_sd^2
new_treatment117_var<-new_treatment117_sd^2
new_treatment118_var<-new_treatment118_sd^2
new_treatment119_var<-new_treatment119_sd^2
new_treatment120_var<-new_treatment120_sd^2
new_treatment121_var<-new_treatment121_sd^2
new_treatment122_var<-new_treatment122_sd^2
new_treatment123_var<-new_treatment123_sd^2
new_treatment124_var<-new_treatment124_sd^2
new_treatment125_var<-new_treatment125_sd^2
new_treatment126_var<-new_treatment126_sd^2
new_treatment127_var<-new_treatment127_sd^2
new_treatment128_var<-new_treatment128_sd^2
new_treatment129_var<-new_treatment129_sd^2
new_treatment130_var<-new_treatment130_sd^2



var1<-c(new_treatment11_var,new_treatment21_var,new_treatment31_var,new_treatment41_var,new_treatment51_var,new_treatment61_var,new_treatment71_var,new_treatment81_var,new_treatment91_var,new_treatment101_var,new_treatment111_var,new_treatment121_var,new_treatment131_var,new_treatment141_var,new_treatment151_var)
var2<-c(new_treatment12_var,new_treatment22_var,new_treatment32_var,new_treatment42_var,new_treatment52_var,new_treatment62_var,new_treatment72_var,new_treatment82_var,new_treatment92_var,new_treatment102_var,new_treatment112_var,new_treatment122_var,new_treatment132_var,new_treatment142_var,new_treatment152_var)
var3<-c(new_treatment13_var,new_treatment23_var,new_treatment33_var,new_treatment43_var,new_treatment53_var,new_treatment63_var,new_treatment73_var,new_treatment83_var,new_treatment93_var,new_treatment103_var,new_treatment113_var,new_treatment123_var,new_treatment133_var,new_treatment143_var,new_treatment153_var)
var4<-c(new_treatment14_var,new_treatment24_var,new_treatment34_var,new_treatment44_var,new_treatment54_var,new_treatment64_var,new_treatment74_var,new_treatment84_var,new_treatment94_var,new_treatment104_var,new_treatment114_var,new_treatment124_var,new_treatment134_var,new_treatment144_var,new_treatment154_var)
var5<-c(new_treatment15_var,new_treatment25_var,new_treatment35_var,new_treatment45_var,new_treatment55_var,new_treatment65_var,new_treatment75_var,new_treatment85_var,new_treatment95_var,new_treatment105_var,new_treatment115_var,new_treatment125_var,new_treatment135_var,new_treatment145_var,new_treatment155_var)
var6<-c(new_treatment16_var,new_treatment26_var,new_treatment36_var,new_treatment46_var,new_treatment56_var,new_treatment66_var,new_treatment76_var,new_treatment86_var,new_treatment96_var,new_treatment106_var,new_treatment116_var,new_treatment126_var,new_treatment136_var,new_treatment146_var,new_treatment156_var)
var7<-c(new_treatment17_var,new_treatment27_var,new_treatment37_var,new_treatment47_var,new_treatment57_var,new_treatment67_var,new_treatment77_var,new_treatment87_var,new_treatment97_var,new_treatment107_var,new_treatment117_var,new_treatment127_var,new_treatment137_var,new_treatment147_var,new_treatment157_var)
var8<-c(new_treatment18_var,new_treatment28_var,new_treatment38_var,new_treatment48_var,new_treatment58_var,new_treatment68_var,new_treatment78_var,new_treatment88_var,new_treatment98_var,new_treatment108_var,new_treatment118_var,new_treatment128_var,new_treatment138_var,new_treatment148_var,new_treatment158_var)
var9<-c(new_treatment19_var,new_treatment29_var,new_treatment39_var,new_treatment49_var,new_treatment59_var,new_treatment69_var,new_treatment79_var,new_treatment89_var,new_treatment99_var,new_treatment109_var,new_treatment119_var,new_treatment129_var,new_treatment139_var,new_treatment149_var,new_treatment159_var)
var10<-c(new_treatment110_var,new_treatment210_var,new_treatment310_var,new_treatment410_var,new_treatment510_var,new_treatment610_var,new_treatment710_var,new_treatment810_var,new_treatment910_var,new_treatment1010_var,new_treatment1110_var,new_treatment1210_var,new_treatment1310_var,new_treatment1410_var,new_treatment1510_var)
var11<-c(new_treatment111_var,new_treatment211_var,new_treatment311_var,new_treatment411_var,new_treatment511_var,new_treatment611_var,new_treatment711_var,new_treatment811_var,new_treatment911_var,new_treatment1011_var,new_treatment1111_var,new_treatment1211_var,new_treatment1311_var,new_treatment1411_var,new_treatment1511_var)
var12<-c(new_treatment112_var,new_treatment212_var,new_treatment312_var,new_treatment412_var,new_treatment512_var,new_treatment612_var,new_treatment712_var,new_treatment812_var,new_treatment912_var,new_treatment1012_var,new_treatment1112_var,new_treatment1212_var,new_treatment1312_var,new_treatment1412_var,new_treatment1512_var)
var13<-c(new_treatment113_var,new_treatment213_var,new_treatment313_var,new_treatment413_var,new_treatment513_var,new_treatment613_var,new_treatment713_var,new_treatment813_var,new_treatment913_var,new_treatment1013_var,new_treatment1113_var,new_treatment1213_var,new_treatment1313_var,new_treatment1413_var,new_treatment1513_var)
var14<-c(new_treatment114_var,new_treatment214_var,new_treatment314_var,new_treatment414_var,new_treatment514_var,new_treatment614_var,new_treatment714_var,new_treatment814_var,new_treatment914_var,new_treatment1014_var,new_treatment1114_var,new_treatment1214_var,new_treatment1314_var,new_treatment1414_var,new_treatment1514_var)
var15<-c(new_treatment115_var,new_treatment215_var,new_treatment315_var,new_treatment415_var,new_treatment515_var,new_treatment615_var,new_treatment715_var,new_treatment815_var,new_treatment915_var,new_treatment1015_var,new_treatment1115_var,new_treatment1215_var,new_treatment1315_var,new_treatment1415_var,new_treatment1515_var)
var16<-c(new_treatment116_var,new_treatment216_var,new_treatment316_var,new_treatment416_var,new_treatment516_var,new_treatment616_var,new_treatment716_var,new_treatment816_var,new_treatment916_var,new_treatment1016_var,new_treatment1116_var,new_treatment1216_var,new_treatment1316_var,new_treatment1416_var,new_treatment1516_var)
var17<-c(new_treatment117_var,new_treatment217_var,new_treatment317_var,new_treatment417_var,new_treatment517_var,new_treatment617_var,new_treatment717_var,new_treatment817_var,new_treatment917_var,new_treatment1017_var,new_treatment1117_var,new_treatment1217_var,new_treatment1317_var,new_treatment1417_var,new_treatment1517_var)
var18<-c(new_treatment118_var,new_treatment218_var,new_treatment318_var,new_treatment418_var,new_treatment518_var,new_treatment618_var,new_treatment718_var,new_treatment818_var,new_treatment918_var,new_treatment1018_var,new_treatment1118_var,new_treatment1218_var,new_treatment1318_var,new_treatment1418_var,new_treatment1518_var)
var19<-c(new_treatment119_var,new_treatment219_var,new_treatment319_var,new_treatment419_var,new_treatment519_var,new_treatment619_var,new_treatment719_var,new_treatment819_var,new_treatment919_var,new_treatment1019_var,new_treatment1119_var,new_treatment1219_var,new_treatment1319_var,new_treatment1419_var,new_treatment1519_var)
var20<-c(new_treatment120_var,new_treatment220_var,new_treatment320_var,new_treatment420_var,new_treatment520_var,new_treatment620_var,new_treatment720_var,new_treatment820_var,new_treatment920_var,new_treatment1020_var,new_treatment1120_var,new_treatment1220_var,new_treatment1320_var,new_treatment1420_var,new_treatment1520_var)
var21<-c(new_treatment121_var,new_treatment221_var,new_treatment321_var,new_treatment421_var,new_treatment521_var,new_treatment621_var,new_treatment721_var,new_treatment821_var,new_treatment921_var,new_treatment1021_var,new_treatment1121_var,new_treatment1221_var,new_treatment1321_var,new_treatment1421_var,new_treatment1521_var)
var22<-c(new_treatment122_var,new_treatment222_var,new_treatment322_var,new_treatment422_var,new_treatment522_var,new_treatment622_var,new_treatment722_var,new_treatment822_var,new_treatment922_var,new_treatment1022_var,new_treatment1122_var,new_treatment1222_var,new_treatment1322_var,new_treatment1422_var,new_treatment1522_var)
var23<-c(new_treatment123_var,new_treatment223_var,new_treatment323_var,new_treatment423_var,new_treatment523_var,new_treatment623_var,new_treatment723_var,new_treatment823_var,new_treatment923_var,new_treatment1023_var,new_treatment1123_var,new_treatment1223_var,new_treatment1323_var,new_treatment1423_var,new_treatment1523_var)
var24<-c(new_treatment124_var,new_treatment224_var,new_treatment324_var,new_treatment424_var,new_treatment524_var,new_treatment624_var,new_treatment724_var,new_treatment824_var,new_treatment924_var,new_treatment1024_var,new_treatment1124_var,new_treatment1224_var,new_treatment1324_var,new_treatment1424_var,new_treatment1524_var)
var25<-c(new_treatment125_var,new_treatment225_var,new_treatment325_var,new_treatment425_var,new_treatment525_var,new_treatment625_var,new_treatment725_var,new_treatment825_var,new_treatment925_var,new_treatment1025_var,new_treatment1125_var,new_treatment1225_var,new_treatment1325_var,new_treatment1425_var,new_treatment1525_var)
var26<-c(new_treatment126_var,new_treatment226_var,new_treatment326_var,new_treatment426_var,new_treatment526_var,new_treatment626_var,new_treatment726_var,new_treatment826_var,new_treatment926_var,new_treatment1026_var,new_treatment1126_var,new_treatment1226_var,new_treatment1326_var,new_treatment1426_var,new_treatment1526_var)
var27<-c(new_treatment127_var,new_treatment227_var,new_treatment327_var,new_treatment427_var,new_treatment527_var,new_treatment627_var,new_treatment727_var,new_treatment827_var,new_treatment927_var,new_treatment1027_var,new_treatment1127_var,new_treatment1227_var,new_treatment1327_var,new_treatment1427_var,new_treatment1527_var)
var28<-c(new_treatment128_var,new_treatment228_var,new_treatment328_var,new_treatment428_var,new_treatment528_var,new_treatment628_var,new_treatment728_var,new_treatment828_var,new_treatment928_var,new_treatment1028_var,new_treatment1128_var,new_treatment1228_var,new_treatment1328_var,new_treatment1428_var,new_treatment1528_var)
var29<-c(new_treatment129_var,new_treatment229_var,new_treatment329_var,new_treatment429_var,new_treatment529_var,new_treatment629_var,new_treatment729_var,new_treatment829_var,new_treatment929_var,new_treatment1029_var,new_treatment1129_var,new_treatment1229_var,new_treatment1329_var,new_treatment1429_var,new_treatment1529_var)
var30<-c(new_treatment130_var,new_treatment230_var,new_treatment330_var,new_treatment430_var,new_treatment530_var,new_treatment630_var,new_treatment730_var,new_treatment830_var,new_treatment930_var,new_treatment1030_var,new_treatment1130_var,new_treatment1230_var,new_treatment1330_var,new_treatment1430_var,new_treatment1530_var)




final_treatment<-list(new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment_11,new_treatment_12,new_treatment_13,new_treatment_14,new_treatment_15)

final_treatment<-data.frame(final_treatment)
new1<-as.numeric(final_treatment[1,])
new2<-as.numeric(final_treatment[2,])
new3<-as.numeric(final_treatment[3,])
new4<-as.numeric(final_treatment[4,])
new5<-as.numeric(final_treatment[5,])
new6<-as.numeric(final_treatment[6,])
new7<-as.numeric(final_treatment[7,])
new8<-as.numeric(final_treatment[8,])
new9<-as.numeric(final_treatment[9,])
new10<-as.numeric(final_treatment[10,])
new11<-as.numeric(final_treatment[11,])
new12<-as.numeric(final_treatment[12,])
new13<-as.numeric(final_treatment[13,])
new14<-as.numeric(final_treatment[14,])
new15<-as.numeric(final_treatment[15,])
new16<-as.numeric(final_treatment[16,])
new17<-as.numeric(final_treatment[17,])
new18<-as.numeric(final_treatment[18,])
new19<-as.numeric(final_treatment[19,])
new20<-as.numeric(final_treatment[20,])
new21<-as.numeric(final_treatment[21,])
new22<-as.numeric(final_treatment[22,])
new23<-as.numeric(final_treatment[23,])
new24<-as.numeric(final_treatment[24,])
new25<-as.numeric(final_treatment[25,])
new26<-as.numeric(final_treatment[26,])
new27<-as.numeric(final_treatment[27,])
new28<-as.numeric(final_treatment[28,])
new29<-as.numeric(final_treatment[29,])
new30<-as.numeric(final_treatment[30,])







#the total att#

mean(c(new1[which(new1!=0)],new2[which(new2!=0)],new3[which(new3!=0)],new4[which(new4!=0)],new5[which(new5!=0)],new6[which(new6!=0)],new7[which(new7!=0)],new8[which(new8!=0)],new9[which(new9!=0)],new10[which(new10!=0)],new11[which(new11!=0)],new12[which(new12!=0)],new13[which(new13!=0)],new14[which(new14!=0)],new15[which(new15!=0)],new16[which(new16!=0)],new17[which(new17!=0)],new18[which(new18!=0)],new19[which(new19!=0)],new20[which(new20!=0)],new21[which(new21!=0)],new22[which(new22!=0)],new23[which(new23!=0)],new24[which(new24!=0)],new25[which(new25!=0)],new26[which(new26!=0)],new27[which(new27!=0)],new28[which(new28!=0)],new29[which(new29!=0)],new30[which(new30!=0)]))


L<-length(c(new1[which(new1!=0)],new2[which(new2!=0)],new3[which(new3!=0)],new4[which(new4!=0)],new5[which(new5!=0)],new6[which(new6!=0)],new7[which(new7!=0)],new8[which(new8!=0)],new9[which(new9!=0)],new10[which(new10!=0)],new11[which(new11!=0)],new12[which(new12!=0)],new13[which(new13!=0)],new14[which(new14!=0)],new15[which(new15!=0)],new16[which(new16!=0)],new17[which(new17!=0)],new18[which(new18!=0)],new19[which(new19!=0)],new20[which(new20!=0)],new21[which(new21!=0)],new22[which(new22!=0)],new23[which(new23!=0)],new24[which(new24!=0)],new25[which(new25!=0)],new26[which(new26!=0)],new27[which(new27!=0)],new28[which(new28!=0)],new29[which(new29!=0)],new30[which(new30!=0)]))

( sum( var1[which(new1!=0)],var2[which(new2!=0)],var3[which(new3!=0)],var4[which(new4!=0)],var5[which(new5!=0)],var6[which(new6!=0)],var7[which(new7!=0)],var8[which(new8!=0)],var9[which(new9!=0)],var10[which(new10!=0)],var11[which(new11!=0)],var12[which(new12!=0)],var13[which(new13!=0)],var14[which(new14!=0)],var15[which(new15!=0)],var16[which(new16!=0)],var17[which(new17!=0)],var18[which(new18!=0)],var19[which(new19!=0)],var20[which(new20!=0)],var21[which(new21!=0)],var22[which(new22!=0)],var23[which(new23!=0)],var24[which(new24!=0)],var25[which(new25!=0)],var26[which(new26!=0)],var27[which(new27!=0)],var28[which(new28!=0)],var29[which(new29!=0)],var30[which(new30!=0)]) / (L*L) )^0.5











second_treatment81_var<-second_treatment81_sd^2
second_treatment82_var<-second_treatment82_sd^2
second_treatment83_var<-second_treatment83_sd^2
second_treatment84_var<-second_treatment84_sd^2
second_treatment85_var<-second_treatment85_sd^2
second_treatment86_var<-second_treatment86_sd^2
second_treatment87_var<-second_treatment87_sd^2
second_treatment88_var<-second_treatment88_sd^2
second_treatment89_var<-second_treatment89_sd^2
second_treatment810_var<-second_treatment810_sd^2
second_treatment811_var<-second_treatment811_sd^2
second_treatment812_var<-second_treatment812_sd^2
second_treatment813_var<-second_treatment813_sd^2
second_treatment814_var<-second_treatment814_sd^2
second_treatment815_var<-second_treatment815_sd^2
second_treatment816_var<-second_treatment816_sd^2
second_treatment817_var<-second_treatment817_sd^2
second_treatment818_var<-second_treatment818_sd^2
second_treatment819_var<-second_treatment819_sd^2
second_treatment820_var<-second_treatment820_sd^2
second_treatment821_var<-second_treatment821_sd^2
second_treatment822_var<-second_treatment822_sd^2
second_treatment823_var<-second_treatment823_sd^2
second_treatment824_var<-second_treatment824_sd^2
second_treatment825_var<-second_treatment825_sd^2
second_treatment826_var<-second_treatment826_sd^2
second_treatment827_var<-second_treatment827_sd^2
second_treatment828_var<-second_treatment828_sd^2
second_treatment829_var<-second_treatment839_sd^2
second_treatment830_var<-second_treatment830_sd^2

second_treatment71_var<-second_treatment71_sd^2
second_treatment72_var<-second_treatment72_sd^2
second_treatment73_var<-second_treatment73_sd^2
second_treatment74_var<-second_treatment74_sd^2
second_treatment75_var<-second_treatment75_sd^2
second_treatment76_var<-second_treatment76_sd^2
second_treatment77_var<-second_treatment77_sd^2
second_treatment78_var<-second_treatment78_sd^2
second_treatment79_var<-second_treatment79_sd^2
second_treatment710_var<-second_treatment710_sd^2
second_treatment711_var<-second_treatment711_sd^2
second_treatment712_var<-second_treatment712_sd^2
second_treatment713_var<-second_treatment713_sd^2
second_treatment714_var<-second_treatment714_sd^2
second_treatment715_var<-second_treatment715_sd^2
second_treatment716_var<-second_treatment716_sd^2
second_treatment717_var<-second_treatment717_sd^2
second_treatment718_var<-second_treatment718_sd^2
second_treatment719_var<-second_treatment719_sd^2
second_treatment720_var<-second_treatment720_sd^2
second_treatment721_var<-second_treatment721_sd^2
second_treatment722_var<-second_treatment722_sd^2
second_treatment723_var<-second_treatment723_sd^2
second_treatment724_var<-second_treatment724_sd^2
second_treatment725_var<-second_treatment725_sd^2
second_treatment726_var<-second_treatment726_sd^2
second_treatment727_var<-second_treatment727_sd^2
second_treatment728_var<-second_treatment728_sd^2
second_treatment729_var<-second_treatment739_sd^2
second_treatment730_var<-second_treatment730_sd^2

second_treatment61_var<-second_treatment61_sd^2
second_treatment62_var<-second_treatment62_sd^2
second_treatment63_var<-second_treatment63_sd^2
second_treatment64_var<-second_treatment64_sd^2
second_treatment65_var<-second_treatment65_sd^2
second_treatment66_var<-second_treatment66_sd^2
second_treatment67_var<-second_treatment67_sd^2
second_treatment68_var<-second_treatment68_sd^2
second_treatment69_var<-second_treatment69_sd^2
second_treatment610_var<-second_treatment610_sd^2
second_treatment611_var<-second_treatment611_sd^2
second_treatment612_var<-second_treatment612_sd^2
second_treatment613_var<-second_treatment613_sd^2
second_treatment614_var<-second_treatment614_sd^2
second_treatment615_var<-second_treatment615_sd^2
second_treatment616_var<-second_treatment616_sd^2
second_treatment617_var<-second_treatment617_sd^2
second_treatment618_var<-second_treatment618_sd^2
second_treatment619_var<-second_treatment619_sd^2
second_treatment620_var<-second_treatment620_sd^2
second_treatment621_var<-second_treatment621_sd^2
second_treatment622_var<-second_treatment622_sd^2
second_treatment623_var<-second_treatment623_sd^2
second_treatment624_var<-second_treatment624_sd^2
second_treatment625_var<-second_treatment625_sd^2
second_treatment626_var<-second_treatment626_sd^2
second_treatment627_var<-second_treatment627_sd^2
second_treatment628_var<-second_treatment628_sd^2
second_treatment629_var<-second_treatment639_sd^2
second_treatment630_var<-second_treatment630_sd^2

second_treatment51_var<-second_treatment51_sd^2
second_treatment52_var<-second_treatment52_sd^2
second_treatment53_var<-second_treatment53_sd^2
second_treatment54_var<-second_treatment54_sd^2
second_treatment55_var<-second_treatment55_sd^2
second_treatment56_var<-second_treatment56_sd^2
second_treatment57_var<-second_treatment57_sd^2
second_treatment58_var<-second_treatment58_sd^2
second_treatment59_var<-second_treatment59_sd^2
second_treatment510_var<-second_treatment510_sd^2
second_treatment511_var<-second_treatment511_sd^2
second_treatment512_var<-second_treatment512_sd^2
second_treatment513_var<-second_treatment513_sd^2
second_treatment514_var<-second_treatment514_sd^2
second_treatment515_var<-second_treatment515_sd^2
second_treatment516_var<-second_treatment516_sd^2
second_treatment517_var<-second_treatment517_sd^2
second_treatment518_var<-second_treatment518_sd^2
second_treatment519_var<-second_treatment519_sd^2
second_treatment520_var<-second_treatment520_sd^2
second_treatment521_var<-second_treatment521_sd^2
second_treatment522_var<-second_treatment522_sd^2
second_treatment523_var<-second_treatment523_sd^2
second_treatment524_var<-second_treatment524_sd^2
second_treatment525_var<-second_treatment525_sd^2
second_treatment526_var<-second_treatment526_sd^2
second_treatment527_var<-second_treatment527_sd^2
second_treatment528_var<-second_treatment528_sd^2
second_treatment529_var<-second_treatment539_sd^2
second_treatment530_var<-second_treatment530_sd^2

second_treatment41_var<-second_treatment41_sd^2
second_treatment42_var<-second_treatment42_sd^2
second_treatment43_var<-second_treatment43_sd^2
second_treatment44_var<-second_treatment44_sd^2
second_treatment45_var<-second_treatment45_sd^2
second_treatment46_var<-second_treatment46_sd^2
second_treatment47_var<-second_treatment47_sd^2
second_treatment48_var<-second_treatment48_sd^2
second_treatment49_var<-second_treatment49_sd^2
second_treatment410_var<-second_treatment410_sd^2
second_treatment411_var<-second_treatment411_sd^2
second_treatment412_var<-second_treatment412_sd^2
second_treatment413_var<-second_treatment413_sd^2
second_treatment414_var<-second_treatment414_sd^2
second_treatment415_var<-second_treatment415_sd^2
second_treatment416_var<-second_treatment416_sd^2
second_treatment417_var<-second_treatment417_sd^2
second_treatment418_var<-second_treatment418_sd^2
second_treatment419_var<-second_treatment419_sd^2
second_treatment420_var<-second_treatment420_sd^2
second_treatment421_var<-second_treatment421_sd^2
second_treatment422_var<-second_treatment422_sd^2
second_treatment423_var<-second_treatment423_sd^2
second_treatment424_var<-second_treatment424_sd^2
second_treatment425_var<-second_treatment425_sd^2
second_treatment426_var<-second_treatment426_sd^2
second_treatment427_var<-second_treatment427_sd^2
second_treatment428_var<-second_treatment428_sd^2
second_treatment429_var<-second_treatment439_sd^2
second_treatment430_var<-second_treatment430_sd^2

second_treatment31_var<-second_treatment31_sd^2
second_treatment32_var<-second_treatment32_sd^2
second_treatment33_var<-second_treatment33_sd^2
second_treatment34_var<-second_treatment34_sd^2
second_treatment35_var<-second_treatment35_sd^2
second_treatment36_var<-second_treatment36_sd^2
second_treatment37_var<-second_treatment37_sd^2
second_treatment38_var<-second_treatment38_sd^2
second_treatment39_var<-second_treatment39_sd^2
second_treatment310_var<-second_treatment310_sd^2
second_treatment311_var<-second_treatment311_sd^2
second_treatment312_var<-second_treatment312_sd^2
second_treatment313_var<-second_treatment313_sd^2
second_treatment314_var<-second_treatment314_sd^2
second_treatment315_var<-second_treatment315_sd^2
second_treatment316_var<-second_treatment316_sd^2
second_treatment317_var<-second_treatment317_sd^2
second_treatment318_var<-second_treatment318_sd^2
second_treatment319_var<-second_treatment319_sd^2
second_treatment320_var<-second_treatment320_sd^2
second_treatment321_var<-second_treatment321_sd^2
second_treatment322_var<-second_treatment322_sd^2
second_treatment323_var<-second_treatment323_sd^2
second_treatment324_var<-second_treatment324_sd^2
second_treatment325_var<-second_treatment325_sd^2
second_treatment326_var<-second_treatment326_sd^2
second_treatment327_var<-second_treatment327_sd^2
second_treatment328_var<-second_treatment328_sd^2
second_treatment329_var<-second_treatment329_sd^2
second_treatment330_var<-second_treatment330_sd^2

second_treatment21_var<-second_treatment21_sd^2
second_treatment22_var<-second_treatment22_sd^2
second_treatment23_var<-second_treatment23_sd^2
second_treatment24_var<-second_treatment24_sd^2
second_treatment25_var<-second_treatment25_sd^2
second_treatment26_var<-second_treatment26_sd^2
second_treatment27_var<-second_treatment27_sd^2
second_treatment28_var<-second_treatment28_sd^2
second_treatment29_var<-second_treatment29_sd^2
second_treatment210_var<-second_treatment210_sd^2
second_treatment211_var<-second_treatment211_sd^2
second_treatment212_var<-second_treatment212_sd^2
second_treatment213_var<-second_treatment213_sd^2
second_treatment214_var<-second_treatment214_sd^2
second_treatment215_var<-second_treatment215_sd^2
second_treatment216_var<-second_treatment216_sd^2
second_treatment217_var<-second_treatment217_sd^2
second_treatment218_var<-second_treatment218_sd^2
second_treatment219_var<-second_treatment219_sd^2
second_treatment220_var<-second_treatment220_sd^2
second_treatment221_var<-second_treatment221_sd^2
second_treatment222_var<-second_treatment222_sd^2
second_treatment223_var<-second_treatment223_sd^2
second_treatment224_var<-second_treatment224_sd^2
second_treatment225_var<-second_treatment225_sd^2
second_treatment226_var<-second_treatment226_sd^2
second_treatment227_var<-second_treatment227_sd^2
second_treatment228_var<-second_treatment228_sd^2
second_treatment229_var<-second_treatment229_sd^2
second_treatment230_var<-second_treatment230_sd^2

second_treatment11_var<-second_treatment11_sd^2
second_treatment12_var<-second_treatment12_sd^2
second_treatment13_var<-second_treatment13_sd^2
second_treatment14_var<-second_treatment14_sd^2
second_treatment15_var<-second_treatment15_sd^2
second_treatment16_var<-second_treatment16_sd^2
second_treatment17_var<-second_treatment17_sd^2
second_treatment18_var<-second_treatment18_sd^2
second_treatment19_var<-second_treatment19_sd^2
second_treatment110_var<-second_treatment110_sd^2
second_treatment111_var<-second_treatment111_sd^2
second_treatment112_var<-second_treatment112_sd^2
second_treatment113_var<-second_treatment113_sd^2
second_treatment114_var<-second_treatment114_sd^2
second_treatment115_var<-second_treatment115_sd^2
second_treatment116_var<-second_treatment116_sd^2
second_treatment117_var<-second_treatment117_sd^2
second_treatment118_var<-second_treatment118_sd^2
second_treatment119_var<-second_treatment119_sd^2
second_treatment120_var<-second_treatment120_sd^2
second_treatment121_var<-second_treatment121_sd^2
second_treatment122_var<-second_treatment122_sd^2
second_treatment123_var<-second_treatment123_sd^2
second_treatment124_var<-second_treatment124_sd^2
second_treatment125_var<-second_treatment125_sd^2
second_treatment126_var<-second_treatment126_sd^2
second_treatment127_var<-second_treatment127_sd^2
second_treatment128_var<-second_treatment128_sd^2
second_treatment129_var<-second_treatment129_sd^2
second_treatment130_var<-second_treatment130_sd^2



var_second1<-c(second_treatment11_var,second_treatment21_var,second_treatment31_var,second_treatment41_var,second_treatment51_var,second_treatment61_var,second_treatment71_var,second_treatment81_var)
var_second2<-c(second_treatment12_var,second_treatment22_var,second_treatment32_var,second_treatment42_var,second_treatment52_var,second_treatment62_var,second_treatment72_var,second_treatment82_var)
var_second3<-c(second_treatment13_var,second_treatment23_var,second_treatment33_var,second_treatment43_var,second_treatment53_var,second_treatment63_var,second_treatment73_var,second_treatment83_var)
var_second4<-c(second_treatment14_var,second_treatment24_var,second_treatment34_var,second_treatment44_var,second_treatment54_var,second_treatment64_var,second_treatment74_var,second_treatment84_var)
var_second5<-c(second_treatment15_var,second_treatment25_var,second_treatment35_var,second_treatment45_var,second_treatment55_var,second_treatment65_var,second_treatment75_var,second_treatment85_var)
var_second6<-c(second_treatment16_var,second_treatment26_var,second_treatment36_var,second_treatment46_var,second_treatment56_var,second_treatment66_var,second_treatment76_var,second_treatment86_var)
var_second7<-c(second_treatment17_var,second_treatment27_var,second_treatment37_var,second_treatment47_var,second_treatment57_var,second_treatment67_var,second_treatment77_var,second_treatment87_var)
var_second8<-c(second_treatment18_var,second_treatment28_var,second_treatment38_var,second_treatment48_var,second_treatment58_var,second_treatment68_var,second_treatment78_var,second_treatment88_var)
var_second9<-c(second_treatment19_var,second_treatment29_var,second_treatment39_var,second_treatment49_var,second_treatment59_var,second_treatment69_var,second_treatment79_var,second_treatment89_var)
var_second10<-c(second_treatment110_var,second_treatment210_var,second_treatment310_var,second_treatment410_var,second_treatment510_var,second_treatment610_var,second_treatment710_var,second_treatment810_var)
var_second11<-c(second_treatment111_var,second_treatment211_var,second_treatment311_var,second_treatment411_var,second_treatment511_var,second_treatment611_var,second_treatment711_var,second_treatment811_var)
var_second12<-c(second_treatment112_var,second_treatment212_var,second_treatment312_var,second_treatment412_var,second_treatment512_var,second_treatment612_var,second_treatment712_var,second_treatment812_var)
var_second13<-c(second_treatment113_var,second_treatment213_var,second_treatment313_var,second_treatment413_var,second_treatment513_var,second_treatment613_var,second_treatment713_var,second_treatment813_var)
var_second14<-c(second_treatment114_var,second_treatment214_var,second_treatment314_var,second_treatment414_var,second_treatment514_var,second_treatment614_var,second_treatment714_var,second_treatment814_var)
var_second15<-c(second_treatment115_var,second_treatment215_var,second_treatment315_var,second_treatment415_var,second_treatment515_var,second_treatment615_var,second_treatment715_var,second_treatment815_var)
var_second16<-c(second_treatment116_var,second_treatment216_var,second_treatment316_var,second_treatment416_var,second_treatment516_var,second_treatment616_var,second_treatment716_var,second_treatment816_var)
var_second17<-c(second_treatment117_var,second_treatment217_var,second_treatment317_var,second_treatment417_var,second_treatment517_var,second_treatment617_var,second_treatment717_var,second_treatment817_var)
var_second18<-c(second_treatment118_var,second_treatment218_var,second_treatment318_var,second_treatment418_var,second_treatment518_var,second_treatment618_var,second_treatment718_var,second_treatment818_var)
var_second19<-c(second_treatment119_var,second_treatment219_var,second_treatment319_var,second_treatment419_var,second_treatment519_var,second_treatment619_var,second_treatment719_var,second_treatment819_var)
var_second20<-c(second_treatment120_var,second_treatment220_var,second_treatment320_var,second_treatment420_var,second_treatment520_var,second_treatment620_var,second_treatment720_var,second_treatment820_var)
var_second21<-c(second_treatment121_var,second_treatment221_var,second_treatment321_var,second_treatment421_var,second_treatment521_var,second_treatment621_var,second_treatment721_var,second_treatment821_var)
var_second22<-c(second_treatment122_var,second_treatment222_var,second_treatment322_var,second_treatment422_var,second_treatment522_var,second_treatment622_var,second_treatment722_var,second_treatment822_var)
var_second23<-c(second_treatment123_var,second_treatment223_var,second_treatment323_var,second_treatment423_var,second_treatment523_var,second_treatment623_var,second_treatment723_var,second_treatment823_var)
var_second24<-c(second_treatment124_var,second_treatment224_var,second_treatment324_var,second_treatment424_var,second_treatment524_var,second_treatment624_var,second_treatment724_var,second_treatment824_var)
var_second25<-c(second_treatment125_var,second_treatment225_var,second_treatment325_var,second_treatment425_var,second_treatment525_var,second_treatment625_var,second_treatment725_var,second_treatment825_var)
var_second26<-c(second_treatment126_var,second_treatment226_var,second_treatment326_var,second_treatment426_var,second_treatment526_var,second_treatment626_var,second_treatment726_var,second_treatment826_var)
var_second27<-c(second_treatment127_var,second_treatment227_var,second_treatment327_var,second_treatment427_var,second_treatment527_var,second_treatment627_var,second_treatment727_var,second_treatment827_var)
var_second28<-c(second_treatment128_var,second_treatment228_var,second_treatment328_var,second_treatment428_var,second_treatment528_var,second_treatment628_var,second_treatment728_var,second_treatment828_var)
var_second29<-c(second_treatment129_var,second_treatment229_var,second_treatment329_var,second_treatment429_var,second_treatment529_var,second_treatment629_var,second_treatment729_var,second_treatment829_var)
var_second30<-c(second_treatment130_var,second_treatment230_var,second_treatment330_var,second_treatment430_var,second_treatment530_var,second_treatment630_var,second_treatment730_var,second_treatment830_var)






## first wave treatment effects


first_treatment1<-c(new1[1:7],new1[8:15]-second1)
first_treatment2<-c(new2[1:7],new2[8:15]-second2)
first_treatment3<-c(new3[1:7],new3[8:15]-second3)
first_treatment5<-c(new5[1:7],new5[8:15]-second5)
first_treatment8<-c(new8[1:7],new8[8:15]-second8)
first_treatment9<-c(new9[1:7],new9[8:15]-second9)
first_treatment10<-c(new10[1:7],new10[8:15]-second10)
first_treatment11<-c(new11[1:7],new11[8:15]-second11)
first_treatment12<-c(new12[1:7],new12[8:15]-second12)
first_treatment15<-c(new15[1:7],new15[8:15]-second15)
first_treatment16<-c(new16[1:7],new16[8:15]-second16)
first_treatment17<-c(new17[1:7],new17[8:15]-second17)
first_treatment18<-c(new18[1:7],new18[8:15]-second18)
first_treatment21<-c(new21[1:7],new21[8:15]-second21)
first_treatment22<-c(new22[1:7],new22[8:15]-second22)
first_treatment26<-c(new26[1:7],new26[8:15]-second26)
first_treatment27<-c(new27[1:7],new27[8:15]-second27)
first_treatment28<-c(new28[1:7],new28[8:15]-second28)
first_treatment30<-c(new30[1:7],new30[8:15]-second30)
first_treatment29<-c(new29[1:7],new29[8:15]-second29)


vvar1<-c(var1[1:7],var1[8:15]+var_second1)
vvar2<-c(var2[1:7],var2[8:15]+var_second2)
vvar3<-c(var3[1:7],var3[8:15]+var_second3)
vvar5<-c(var5[1:7],var5[8:15]+var_second5)
vvar8<-c(var8[1:7],var8[8:15]+var_second8)
vvar9<-c(var9[1:7],var9[8:15]+var_second9)
vvar10<-c(var10[1:7],var10[8:15]+var_second10)
vvar11<-c(var11[1:7],var11[8:15]+var_second11)
vvar12<-c(var12[1:7],var12[8:15]+var_second12)
vvar15<-c(var15[1:7],var15[8:15]+var_second15)
vvar16<-c(var16[1:7],var16[8:15]+var_second16)
vvar17<-c(var17[1:7],var17[8:15]+var_second17)
vvar18<-c(var18[1:7],var18[8:15]+var_second18)
vvar21<-c(var21[1:7],var21[8:15]+var_second21)
vvar22<-c(var22[1:7],var22[8:15]+var_second22)
vvar26<-c(var26[1:7],var26[8:15]+var_second26)
vvar27<-c(var27[1:7],var27[8:15]+var_second27)
vvar28<-c(var28[1:7],var28[8:15]+var_second28)
vvar30<-c(var30[1:7],var30[8:15]+var_second30)
vvar29<-c(var29[1:7],var29[8:15]+var_second29)




mean(c(first_treatment1[which(first_treatment1!=0)], first_treatment2[which(first_treatment2!=0)],first_treatment3[which(first_treatment3!=0)],first_treatment5[which(first_treatment5!=0)],first_treatment8[which(first_treatment8!=0)],first_treatment9[which(first_treatment9!=0)],first_treatment10[which(first_treatment10!=0)],first_treatment11[which(first_treatment11!=0)],first_treatment12[which(first_treatment12!=0)],first_treatment15[which(first_treatment15!=0)],first_treatment16[which(first_treatment16!=0)],first_treatment17[which(first_treatment17!=0)],first_treatment18[which(first_treatment18!=0)],first_treatment21[which(first_treatment21!=0)],first_treatment22[which(first_treatment22!=0)],first_treatment26[which(first_treatment26!=0)],first_treatment27[which(first_treatment27!=0)],first_treatment28[which(first_treatment28!=0)],first_treatment30[which(first_treatment30!=0)],first_treatment29[which(first_treatment29!=0)]  ))

L<-length(c(first_treatment1[which(first_treatment1!=0)], first_treatment2[which(first_treatment2!=0)],first_treatment3[which(first_treatment3!=0)],first_treatment5[which(first_treatment5!=0)],first_treatment8[which(first_treatment8!=0)],first_treatment9[which(first_treatment9!=0)],first_treatment10[which(first_treatment10!=0)],first_treatment11[which(first_treatment11!=0)],first_treatment12[which(first_treatment12!=0)],first_treatment15[which(first_treatment15!=0)],first_treatment16[which(first_treatment16!=0)],first_treatment17[which(first_treatment17!=0)],first_treatment18[which(first_treatment18!=0)],first_treatment21[which(first_treatment21!=0)],first_treatment22[which(first_treatment22!=0)],first_treatment26[which(first_treatment26!=0)],first_treatment27[which(first_treatment27!=0)],first_treatment28[which(first_treatment28!=0)],first_treatment30[which(first_treatment30!=0)],first_treatment29[which(first_treatment29!=0)]  ))

( sum( c(vvar1[which(first_treatment1!=0)], vvar2[which(first_treatment2!=0)],vvar3[which(first_treatment3!=0)],vvar5[which(first_treatment5!=0)],vvar8[which(first_treatment8!=0)],vvar9[which(first_treatment9!=0)],vvar10[which(first_treatment10!=0)],vvar11[which(first_treatment11!=0)],vvar12[which(first_treatment12!=0)],vvar15[which(first_treatment15!=0)],vvar16[which(first_treatment16!=0)],vvar17[which(first_treatment17!=0)],vvar18[which(first_treatment18!=0)],vvar21[which(first_treatment21!=0)],vvar22[which(first_treatment22!=0)],vvar26[which(first_treatment26!=0)],vvar27[which(first_treatment27!=0)],vvar28[which(first_treatment28!=0)],vvar30[which(first_treatment30!=0)],vvar29[which(first_treatment29!=0)] )) / (L*L) )^0.5







#second wave treatment effects#

mean(c(second1[which(second1!=0)],second2[which(second2!=0)],second3[which(second3!=0)],second4[which(second4!=0)],second5[which(second5!=0)],second6[which(second6!=0)],second7[which(second7!=0)],second8[which(second8!=0)],second9[which(second9!=0)],second10[which(second10!=0)],second11[which(second11!=0)],second12[which(second12!=0)],second13[which(second13!=0)],second14[which(second14!=0)],second15[which(second15!=0)],second16[which(second16!=0)],second17[which(second17!=0)],second18[which(second18!=0)],second19[which(second19!=0)],second20[which(second20!=0)],second21[which(second21!=0)],second22[which(second22!=0)],second23[which(second24!=0)],second24[which(second24!=0)],second25[which(second25!=0)],second26[which(second26!=0)],second27[which(second27!=0)],second28[which(second28!=0)],second29[which(second29!=0)],second30[which(second30!=0)]))


L<-length(c(c(second1[which(second1!=0)],second2[which(second2!=0)],second3[which(second3!=0)],second4[which(second4!=0)],second5[which(second5!=0)],second6[which(second6!=0)],second7[which(second7!=0)],second8[which(second8!=0)],second9[which(second9!=0)],second10[which(second10!=0)],second11[which(second11!=0)],second12[which(second12!=0)],second13[which(second13!=0)],second14[which(second14!=0)],second15[which(second15!=0)],second16[which(second16!=0)],second17[which(second17!=0)],second18[which(second18!=0)],second19[which(second19!=0)],second20[which(second20!=0)],second21[which(second21!=0)],second22[which(second22!=0)],second23[which(second24!=0)],second24[which(second24!=0)],second25[which(second25!=0)],second26[which(second26!=0)],second27[which(second27!=0)],second28[which(second28!=0)],second29[which(second29!=0)],second30[which(second30!=0)])))

( sum( var_second1[which(second1!=0)],var_second2[which(second2!=0)],var_second3[which(second3!=0)],var_second4[which(second4!=0)],var_second5[which(second5!=0)],var_second6[which(second6!=0)],var_second7[which(second7!=0)],var_second8[which(second8!=0)],var_second9[which(second9!=0)],var_second10[which(second10!=0)],var_second11[which(second11!=0)],var_second12[which(second12!=0)],var_second13[which(second13!=0)],var_second14[which(second14!=0)],var_second15[which(second15!=0)],var_second16[which(second16!=0)],var_second17[which(second17!=0)],var_second18[which(second18!=0)],var_second19[which(second19!=0)],var_second20[which(second20!=0)],var_second21[which(second21!=0)],var_second22[which(second22!=0)],var_second23[which(second23!=0)],var_second24[which(second24!=0)],var_second25[which(second25!=0)],var_second26[which(second26!=0)],var_second27[which(second27!=0)],var_second28[which(second28!=0)],var_second29[which(second29!=0)],var_second30[which(second30!=0)]) / (L*L) )^0.5




























