

#1990-2021  32 years#

library(haven)
#data_new<-read_dta("E:\\treatment effects vs structure change\\updated\\empiricis\\结婚离婚\\DivorceData(QJE)\\1976 & 1985 data, combined.dta")

data_new<-read_dta("E:\\treatment effects vs structure change\\updated\\empiricis\\结婚离婚\\1949-2020年各省gdp，人均gdp、固定投资、财政收支等面板dta数据.dta")


library(openxlsx)
data<-read.xlsx("E:\\treatment effects vs structure change\\updated\\empiricis\\结婚离婚\\marriage-divorce-remarriage.xlsx")

library("readxl")
data1<-read_xls("E:\\treatment effects vs structure change\\updated\\empiricis\\结婚离婚\\1990-2021年全国30省城镇登记失业率.xls")




#内地居民初婚登记（万对）#
firstm1<-rev(data[which(data[,2]=="北京"),][,9][3:32])
firstm2<-rev(data[which(data[,2]=="天津"),][,9][3:32])
firstm3<-rev(data[which(data[,2]=="河北"),][,9][3:32])
firstm4<-rev(data[which(data[,2]=="山西"),][,9][3:32])
firstm5<-rev(data[which(data[,2]=="内蒙古"),][,9][3:32])
firstm6<-rev(data[which(data[,2]=="辽宁"),][,9][3:32])
firstm7<-rev(data[which(data[,2]=="吉林"),][,9][3:32])
firstm8<-rev(data[which(data[,2]=="黑龙江"),][,9][3:32])
firstm9<-rev(data[which(data[,2]=="上海"),][,9][3:32])
firstm10<-rev(data[which(data[,2]=="江苏"),][,9][3:32])
firstm11<-rev(data[which(data[,2]=="浙江"),][,9][3:32])
firstm12<-rev(data[which(data[,2]=="安徽"),][,9][3:32])
firstm13<-rev(data[which(data[,2]=="福建"),][,9][3:32])
firstm14<-rev(data[which(data[,2]=="江西"),][,9][3:32])
firstm15<-rev(data[which(data[,2]=="山东"),][,9][3:32])
firstm16<-rev(data[which(data[,2]=="河南"),][,9][3:32])
firstm17<-rev(data[which(data[,2]=="湖北"),][,9][3:32])
firstm18<-rev(data[which(data[,2]=="湖南"),][,9][3:32])
firstm19<-rev(data[which(data[,2]=="广东"),][,9][3:32])
firstm20<-rev(data[which(data[,2]=="广西"),][,9][3:32])
firstm21<-rev(data[which(data[,2]=="海南"),][,9][3:32])
firstm22<-rev(data[which(data[,2]=="四川"),][,9][3:32])
firstm23<-rev(data[which(data[,2]=="贵州"),][,9][3:32])
firstm24<-rev(data[which(data[,2]=="云南"),][,9][3:32])
firstm25<-rev(data[which(data[,2]=="西藏"),][,9][3:32])
firstm26<-rev(data[which(data[,2]=="陕西"),][,9][3:32])
firstm27<-rev(data[which(data[,2]=="甘肃"),][,9][3:32])
firstm28<-rev(data[which(data[,2]=="青海"),][,9][3:32])
firstm29<-rev(data[which(data[,2]=="宁夏"),][,9][3:32])
firstm30<-rev(data[which(data[,2]=="新疆"),][,9][3:32])

#内地居民再婚登记（万对）#
secondm1<-rev(data[which(data[,2]=="北京"),][,10][3:32])
secondm2<-rev(data[which(data[,2]=="天津"),][,10][3:32])
secondm3<-rev(data[which(data[,2]=="河北"),][,10][3:32])
secondm4<-rev(data[which(data[,2]=="山西"),][,10][3:32])
secondm5<-rev(data[which(data[,2]=="内蒙古"),][,10][3:32])
secondm6<-rev(data[which(data[,2]=="辽宁"),][,10][3:32])
secondm7<-rev(data[which(data[,2]=="吉林"),][,10][3:32])
secondm8<-rev(data[which(data[,2]=="黑龙江"),][,10][3:32])
secondm9<-rev(data[which(data[,2]=="上海"),][,10][3:32])
secondm10<-rev(data[which(data[,2]=="江苏"),][,10][3:32])
secondm11<-rev(data[which(data[,2]=="浙江"),][,10][3:32])
secondm12<-rev(data[which(data[,2]=="安徽"),][,10][3:32])
secondm13<-rev(data[which(data[,2]=="福建"),][,10][3:32])
secondm14<-rev(data[which(data[,2]=="江西"),][,10][3:32])
secondm15<-rev(data[which(data[,2]=="山东"),][,10][3:32])
secondm16<-rev(data[which(data[,2]=="河南"),][,10][3:32])
secondm17<-rev(data[which(data[,2]=="湖北"),][,10][3:32])
secondm18<-rev(data[which(data[,2]=="湖南"),][,10][3:32])
secondm19<-rev(data[which(data[,2]=="广东"),][,10][3:32])
secondm20<-rev(data[which(data[,2]=="广西"),][,10][3:32])
secondm21<-rev(data[which(data[,2]=="海南"),][,10][3:32])
secondm22<-rev(data[which(data[,2]=="四川"),][,10][3:32])
secondm23<-rev(data[which(data[,2]=="贵州"),][,10][3:32])
secondm24<-rev(data[which(data[,2]=="云南"),][,10][3:32])
secondm25<-rev(data[which(data[,2]=="西藏"),][,10][3:32])
secondm26<-rev(data[which(data[,2]=="陕西"),][,10][3:32])
secondm27<-rev(data[which(data[,2]=="甘肃"),][,10][3:32])
secondm28<-rev(data[which(data[,2]=="青海"),][,10][3:32])
secondm29<-rev(data[which(data[,2]=="宁夏"),][,10][3:32])
secondm30<-rev(data[which(data[,2]=="新疆"),][,10][3:32])

#涉外及港澳台居民登记结婚（万对）#
xiangm1<-rev(data[which(data[,2]=="北京"),][,11][3:32])
xiangm2<-rev(data[which(data[,2]=="天津"),][,11][3:32])
xiangm3<-rev(data[which(data[,2]=="河北"),][,11][3:32])
xiangm4<-rev(data[which(data[,2]=="山西"),][,11][3:32])
xiangm5<-rev(data[which(data[,2]=="内蒙古"),][,11][3:32])
xiangm6<-rev(data[which(data[,2]=="辽宁"),][,11][3:32])
xiangm7<-rev(data[which(data[,2]=="吉林"),][,11][3:32])
xiangm8<-rev(data[which(data[,2]=="黑龙江"),][,11][3:32])
xiangm9<-rev(data[which(data[,2]=="上海"),][,11][3:32])
xiangm10<-rev(data[which(data[,2]=="江苏"),][,11][3:32])
xiangm11<-rev(data[which(data[,2]=="浙江"),][,11][3:32])
xiangm12<-rev(data[which(data[,2]=="安徽"),][,11][3:32])
xiangm13<-rev(data[which(data[,2]=="福建"),][,11][3:32])
xiangm14<-rev(data[which(data[,2]=="江西"),][,11][3:32])
xiangm15<-rev(data[which(data[,2]=="山东"),][,11][3:32])
xiangm16<-rev(data[which(data[,2]=="河南"),][,11][3:32])
xiangm17<-rev(data[which(data[,2]=="湖北"),][,11][3:32])
xiangm18<-rev(data[which(data[,2]=="湖南"),][,11][3:32])
xiangm19<-rev(data[which(data[,2]=="广东"),][,11][3:32])
xiangm20<-rev(data[which(data[,2]=="广西"),][,11][3:32])
xiangm21<-rev(data[which(data[,2]=="海南"),][,11][3:32])
xiangm22<-rev(data[which(data[,2]=="四川"),][,11][3:32])
xiangm23<-rev(data[which(data[,2]=="贵州"),][,11][3:32])
xiangm24<-rev(data[which(data[,2]=="云南"),][,11][3:32])
xiangm25<-rev(data[which(data[,2]=="西藏"),][,11][3:32])
xiangm26<-rev(data[which(data[,2]=="陕西"),][,11][3:32])
xiangm27<-rev(data[which(data[,2]=="甘肃"),][,11][3:32])
xiangm28<-rev(data[which(data[,2]=="青海"),][,11][3:32])
xiangm29<-rev(data[which(data[,2]=="宁夏"),][,11][3:32])
xiangm30<-rev(data[which(data[,2]=="新疆"),][,11][3:32])


#离婚登记（万对）#
d1<-rev(data[which(data[,2]=="北京"),][,12][3:32])
d2<-rev(data[which(data[,2]=="天津"),][,12][3:32])
d3<-rev(data[which(data[,2]=="河北"),][,12][3:32])
d4<-rev(data[which(data[,2]=="山西"),][,12][3:32])
d5<-rev(data[which(data[,2]=="内蒙古"),][,12][3:32])
d6<-rev(data[which(data[,2]=="辽宁"),][,12][3:32])
d7<-rev(data[which(data[,2]=="吉林"),][,12][3:32])
d8<-rev(data[which(data[,2]=="黑龙江"),][,12][3:32])
d9<-rev(data[which(data[,2]=="上海"),][,12][3:32])
d10<-rev(data[which(data[,2]=="江苏"),][,12][3:32])
d11<-rev(data[which(data[,2]=="浙江"),][,12][3:32])
d12<-rev(data[which(data[,2]=="安徽"),][,12][3:32])
d13<-rev(data[which(data[,2]=="福建"),][,12][3:32])
d14<-rev(data[which(data[,2]=="江西"),][,12][3:32])
d15<-rev(data[which(data[,2]=="山东"),][,12][3:32])
d16<-rev(data[which(data[,2]=="河南"),][,12][3:32])
d17<-rev(data[which(data[,2]=="湖北"),][,12][3:32])
d18<-rev(data[which(data[,2]=="湖南"),][,12][3:32])
d19<-rev(data[which(data[,2]=="广东"),][,12][3:32])
d20<-rev(data[which(data[,2]=="广西"),][,12][3:32])
d21<-rev(data[which(data[,2]=="海南"),][,12][3:32])
d22<-rev(data[which(data[,2]=="四川"),][,12][3:32])
d23<-rev(data[which(data[,2]=="贵州"),][,12][3:32])
d24<-rev(data[which(data[,2]=="云南"),][,12][3:32])
d25<-rev(data[which(data[,2]=="西藏"),][,12][3:32])
d26<-rev(data[which(data[,2]=="陕西"),][,12][3:32])
d27<-rev(data[which(data[,2]=="甘肃"),][,12][3:32])
d28<-rev(data[which(data[,2]=="青海"),][,12][3:32])
d29<-rev(data[which(data[,2]=="宁夏"),][,12][3:32])
d30<-rev(data[which(data[,2]=="新疆"),][,12][3:32])

d<-rbind(d1,d2,d3,d4,d5,d6,d7,d8,d9,d10,d11,d12,d13,d14,d15,d16,d17,d18,d19,d20,d21,d22,d23,d24,d25,d26,d27,d28,d29,d30)

year<-c(1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019)

#structure change point#
out<-c()
for (j in 1:30){
test<-c()
for(i in 3:6){
library(strucchange)
test[i]<-c(sctest(d[j,][5:13] ~ year[5:13], type = "Chow",point=i)$p.value)
}
out[j]<-which(test<=0.1)[1]
}
out[is.na(out)]<-0

out1<-out+4-1   #T0#


D1<-ifelse(out1[1]!=3,1,0)*c(rep(0,out1[1]),rep(1,(30-out1[1])))+ifelse(out1[1]==3,1,0)*rep(0,30)
D2<-ifelse(out1[2]!=3,1,0)*c(rep(0,out1[2]),rep(1,(30-out1[2])))+ifelse(out1[2]==3,1,0)*rep(0,30)
D3<-ifelse(out1[3]!=3,1,0)*c(rep(0,out1[3]),rep(1,(30-out1[3])))+ifelse(out1[3]==3,1,0)*rep(0,30)
D4<-ifelse(out1[4]!=3,1,0)*c(rep(0,out1[4]),rep(1,(30-out1[4])))+ifelse(out1[4]==3,1,0)*rep(0,30)
D5<-ifelse(out1[5]!=3,1,0)*c(rep(0,out1[5]),rep(1,(30-out1[5])))+ifelse(out1[5]==3,1,0)*rep(0,30)
D6<-ifelse(out1[6]!=3,1,0)*c(rep(0,out1[6]),rep(1,(30-out1[6])))+ifelse(out1[6]==3,1,0)*rep(0,30)
D7<-ifelse(out1[7]!=3,1,0)*c(rep(0,out1[7]),rep(1,(30-out1[7])))+ifelse(out1[7]==3,1,0)*rep(0,30)
D8<-ifelse(out1[8]!=3,1,0)*c(rep(0,out1[8]),rep(1,(30-out1[8])))+ifelse(out1[8]==3,1,0)*rep(0,30)
D9<-ifelse(out1[9]!=3,1,0)*c(rep(0,out1[9]),rep(1,(30-out1[9])))+ifelse(out1[9]==3,1,0)*rep(0,30)
D10<-ifelse(out1[10]!=3,1,0)*c(rep(0,out1[10]),rep(1,(30-out1[10])))+ifelse(out1[10]==3,1,0)*rep(0,30)
D11<-ifelse(out1[11]!=3,1,0)*c(rep(0,out1[11]),rep(1,(30-out1[11])))+ifelse(out1[11]==3,1,0)*rep(0,30)
D12<-ifelse(out1[12]!=3,1,0)*c(rep(0,out1[12]),rep(1,(30-out1[12])))+ifelse(out1[12]==3,1,0)*rep(0,30)
D13<-ifelse(out1[13]!=3,1,0)*c(rep(0,out1[13]),rep(1,(30-out1[13])))+ifelse(out1[13]==3,1,0)*rep(0,30)
D14<-ifelse(out1[14]!=3,1,0)*c(rep(0,out1[14]),rep(1,(30-out1[14])))+ifelse(out1[14]==3,1,0)*rep(0,30)
D15<-ifelse(out1[15]!=3,1,0)*c(rep(0,out1[15]),rep(1,(30-out1[15])))+ifelse(out1[15]==3,1,0)*rep(0,30)
D16<-ifelse(out1[16]!=3,1,0)*c(rep(0,out1[16]),rep(1,(30-out1[16])))+ifelse(out1[16]==3,1,0)*rep(0,30)
D17<-ifelse(out1[17]!=3,1,0)*c(rep(0,out1[17]),rep(1,(30-out1[17])))+ifelse(out1[17]==3,1,0)*rep(0,30)
D18<-ifelse(out1[18]!=3,1,0)*c(rep(0,out1[18]),rep(1,(30-out1[18])))+ifelse(out1[18]==3,1,0)*rep(0,30)
D19<-ifelse(out1[19]!=3,1,0)*c(rep(0,out1[19]),rep(1,(30-out1[19])))+ifelse(out1[19]==3,1,0)*rep(0,30)
D20<-ifelse(out1[20]!=3,1,0)*c(rep(0,out1[20]),rep(1,(30-out1[20])))+ifelse(out1[20]==3,1,0)*rep(0,30)
D21<-ifelse(out1[21]!=3,1,0)*c(rep(0,out1[21]),rep(1,(30-out1[21])))+ifelse(out1[21]==3,1,0)*rep(0,30)
D22<-ifelse(out1[22]!=3,1,0)*c(rep(0,out1[22]),rep(1,(30-out1[22])))+ifelse(out1[22]==3,1,0)*rep(0,30)
D23<-ifelse(out1[23]!=3,1,0)*c(rep(0,out1[23]),rep(1,(30-out1[23])))+ifelse(out1[23]==3,1,0)*rep(0,30)
D24<-ifelse(out1[24]!=3,1,0)*c(rep(0,out1[24]),rep(1,(30-out1[24])))+ifelse(out1[24]==3,1,0)*rep(0,30)
D25<-ifelse(out1[25]!=3,1,0)*c(rep(0,out1[25]),rep(1,(30-out1[25])))+ifelse(out1[25]==3,1,0)*rep(0,30)
D26<-ifelse(out1[26]!=3,1,0)*c(rep(0,out1[26]),rep(1,(30-out1[26])))+ifelse(out1[26]==3,1,0)*rep(0,30)
D27<-ifelse(out1[27]!=3,1,0)*c(rep(0,out1[27]),rep(1,(30-out1[27])))+ifelse(out1[27]==3,1,0)*rep(0,30)
D28<-ifelse(out1[28]!=3,1,0)*c(rep(0,out1[28]),rep(1,(30-out1[28])))+ifelse(out1[28]==3,1,0)*rep(0,30)
D29<-ifelse(out1[29]!=3,1,0)*c(rep(0,out1[29]),rep(1,(30-out1[29])))+ifelse(out1[29]==3,1,0)*rep(0,30)
D30<-ifelse(out1[30]!=3,1,0)*c(rep(0,out1[30]),rep(1,(30-out1[30])))+ifelse(out1[30]==3,1,0)*rep(0,30)

q2<-c(rep(0,13),rep(1,17))
Tr1<-c(D1,D2,D3,D4+q2,D5,D6+q2,D7+q2,D8,D9,D10,D11,D12,D13+q2,D14+q2,D15,D16,D17,D18,D19+q2,D20+q2,D21,D22,D23+q2,D24+q2,D25+q2,D26,D27,D28,D29,D30)
Tr2<-rep(q2,30)
q3<-c(rep(0,21),rep(1,9))
Tr3<-rep(q3,30)
Y<-c(d1,d2,d3,d4,d5,d6,d7,d8,d9,d10,d11,d12,d13,d14,d15,d16,d17,d18,d19,d20,d21,d22,d23,d24,d25,d26,d27,d28,d29,d30)
abb<-c(rep(1,30),rep(2,30),rep(3,30),rep(4,30),rep(5,30),rep(6,30),rep(7,30),rep(8,30),rep(9,30),rep(10,30),rep(11,30),rep(12,30),rep(13,30),rep(14,30),rep(15,30),rep(16,30),rep(17,30),rep(18,30),rep(19,30),rep(20,30),rep(21,30),rep(22,30),rep(23,30),rep(24,30),rep(25,30),rep(26,30),rep(27,30),rep(28,30),rep(29,30),rep(30,30))
time<-rep(year,30)
Tr<-Tr1+Tr2+Tr3

data_panel<-data.frame(Y,Tr1,Tr2,Tr3,abb,time,Tr)

library(panelView)
panelview(Y ~ Tr, data = data_panel,  index = c("abb","time"), pre.post = TRUE) 









#gdp per people#

x1<-(data_new[which(data_new$prov=="北京"),])$pergdp[42:71]
x2<-(data_new[which(data_new$prov=="天津"),])$pergdp[42:71]
x3<-(data_new[which(data_new$prov=="河北"),])$pergdp[42:71]
x4<-(data_new[which(data_new$prov=="山西"),])$pergdp[42:71]
x5<-(data_new[which(data_new$prov=="内蒙古"),])$pergdp[42:71]
x6<-(data_new[which(data_new$prov=="辽宁"),])$pergdp[42:71]
x7<-(data_new[which(data_new$prov=="吉林"),])$pergdp[42:71]
x8<-(data_new[which(data_new$prov=="黑龙江"),])$pergdp[42:71]
x9<-(data_new[which(data_new$prov=="上海"),])$pergdp[42:71]
x10<-(data_new[which(data_new$prov=="江苏"),])$pergdp[42:71]
x11<-(data_new[which(data_new$prov=="浙江"),])$pergdp[42:71]
x12<-(data_new[which(data_new$prov=="安徽"),])$pergdp[42:71]
x13<-(data_new[which(data_new$prov=="福建"),])$pergdp[42:71]
x14<-(data_new[which(data_new$prov=="江西"),])$pergdp[42:71]
x15<-(data_new[which(data_new$prov=="山东"),])$pergdp[42:71]
x16<-(data_new[which(data_new$prov=="河南"),])$pergdp[42:71]
x17<-(data_new[which(data_new$prov=="湖北"),])$pergdp[42:71]
x18<-(data_new[which(data_new$prov=="湖南"),])$pergdp[42:71]
x19<-(data_new[which(data_new$prov=="广东"),])$pergdp[42:71]
x20<-(data_new[which(data_new$prov=="广西"),])$pergdp[42:71]
x21<-(data_new[which(data_new$prov=="海南"),])$pergdp[42:71]
x22<-(data_new[which(data_new$prov=="四川"),])$pergdp[42:71]
x23<-(data_new[which(data_new$prov=="贵州"),])$pergdp[42:71]
x24<-(data_new[which(data_new$prov=="云南"),])$pergdp[42:71]
x25<-(data_new[which(data_new$prov=="西藏"),])$pergdp[42:71]  
x26<-(data_new[which(data_new$prov=="陕西"),])$pergdp[42:71]
x27<-(data_new[which(data_new$prov=="甘肃"),])$pergdp[42:71]
x28<-(data_new[which(data_new$prov=="青海"),])$pergdp[42:71]
x29<-(data_new[which(data_new$prov=="宁夏"),])$pergdp[42:71]
x30<-(data_new[which(data_new$prov=="新疆"),])$pergdp[42:71]
x<-c(x1,x2,x3,x4,x5,x6,x7,x8,x9,x10,x11,x12,x13,x14,x15,x16,x17,x18,x19,x20,x21,x22,x23,x24,x25,x26,x27,x28,x29,x30)

#population#

z1<-(data_new[which(data_new$prov=="北京"),])$pop[42:71]
z2<-(data_new[which(data_new$prov=="天津"),])$pop[42:71]
z3<-(data_new[which(data_new$prov=="河北"),])$pop[42:71]
z4<-(data_new[which(data_new$prov=="山西"),])$pop[42:71]
z5<-(data_new[which(data_new$prov=="内蒙古"),])$pop[42:71]
z6<-(data_new[which(data_new$prov=="辽宁"),])$pop[42:71]
z7<-(data_new[which(data_new$prov=="吉林"),])$pop[42:71]
z8<-(data_new[which(data_new$prov=="黑龙江"),])$pop[42:71]
z9<-(data_new[which(data_new$prov=="上海"),])$pop[42:71]
z10<-(data_new[which(data_new$prov=="江苏"),])$pop[42:71]
z11<-(data_new[which(data_new$prov=="浙江"),])$pop[42:71]
z12<-(data_new[which(data_new$prov=="安徽"),])$pop[42:71]
z13<-(data_new[which(data_new$prov=="福建"),])$pop[42:71]
z14<-(data_new[which(data_new$prov=="江西"),])$pop[42:71]
z15<-(data_new[which(data_new$prov=="山东"),])$pop[42:71]
z16<-(data_new[which(data_new$prov=="河南"),])$pop[42:71]
z17<-(data_new[which(data_new$prov=="湖北"),])$pop[42:71]
z18<-(data_new[which(data_new$prov=="湖南"),])$pop[42:71]
z19<-(data_new[which(data_new$prov=="广东"),])$pop[42:71]
z20<-(data_new[which(data_new$prov=="广西"),])$pop[42:71]
z21<-(data_new[which(data_new$prov=="海南"),])$pop[42:71]
z22<-(data_new[which(data_new$prov=="四川"),])$pop[42:71]
z23<-(data_new[which(data_new$prov=="贵州"),])$pop[42:71]
z24<-(data_new[which(data_new$prov=="云南"),])$pop[42:71]
z25<-(data_new[which(data_new$prov=="西藏"),])$pop[42:71] 
z26<-(data_new[which(data_new$prov=="陕西"),])$pop[42:71]
z27<-(data_new[which(data_new$prov=="甘肃"),])$pop[42:71]
z28<-(data_new[which(data_new$prov=="青海"),])$pop[42:71]
z29<-(data_new[which(data_new$prov=="宁夏"),])$pop[42:71]
z30<-(data_new[which(data_new$prov=="新疆"),])$pop[42:71]
z<-c(z1,z2,z3,z4,z5,z6,z7,z8,z9,z10,z11,z12,z13,z14,z15,z16,z17,z18,z19,z20,z21,z22,z23,z24,z25,z26,z27,z28,z29,z30)

#unemployment#

w1<-as.numeric(unlist(data1[which(data1[,3]=="北京"),][,7]))[1:30]
w2<-as.numeric(unlist(data1[which(data1[,3]=="天津"),][,7]))[1:30]
w3<-as.numeric(unlist(data1[which(data1[,3]=="河北"),][,7]))[1:30]
w4<-as.numeric(unlist(data1[which(data1[,3]=="山西"),][,7]))[1:30]
w5<-as.numeric(unlist(data1[which(data1[,3]=="内蒙古"),][,7]))[1:30]
w6<-as.numeric(unlist(data1[which(data1[,3]=="辽宁"),][,7]))[1:30]
w7<-as.numeric(unlist(data1[which(data1[,3]=="吉林"),][,7]))[1:30]
w8<-as.numeric(unlist(data1[which(data1[,3]=="黑龙江"),][,7]))[1:30]
w9<-as.numeric(unlist(data1[which(data1[,3]=="上海"),][,7]))[1:30]
w10<-as.numeric(unlist(data1[which(data1[,3]=="江苏"),][,7]))[1:30]
w11<-as.numeric(unlist(data1[which(data1[,3]=="浙江"),][,7]))[1:30]
w12<-as.numeric(unlist(data1[which(data1[,3]=="安徽"),][,7]))[1:30]
w13<-as.numeric(unlist(data1[which(data1[,3]=="福建"),][,7]))[1:30]
w14<-as.numeric(unlist(data1[which(data1[,3]=="江西"),][,7]))[1:30]
w15<-as.numeric(unlist(data1[which(data1[,3]=="山东"),][,7]))[1:30]
w16<-as.numeric(unlist(data1[which(data1[,3]=="河南"),][,7]))[1:30]
w17<-as.numeric(unlist(data1[which(data1[,3]=="湖北"),][,7]))[1:30]
w18<-as.numeric(unlist(data1[which(data1[,3]=="湖南"),][,7]))[1:30]
w19<-as.numeric(unlist(data1[which(data1[,3]=="广东"),][,7]))[1:30]
w20<-as.numeric(unlist(data1[which(data1[,3]=="广西"),][,7]))[1:30]
w21<-as.numeric(unlist(data1[which(data1[,3]=="海南"),][,7]))[1:30]
w22<-as.numeric(unlist(data1[which(data1[,3]=="四川"),][,7]))[1:30]
w23<-as.numeric(unlist(data1[which(data1[,3]=="贵州"),][,7]))[1:30]
w24<-as.numeric(unlist(data1[which(data1[,3]=="云南"),][,7]))[1:30]
w25<-as.numeric(unlist(data1[which(data1[,3]=="西藏"),][,7]))[1:30]
w26<-as.numeric(unlist(data1[which(data1[,3]=="陕西"),][,7]))[1:30]
w27<-as.numeric(unlist(data1[which(data1[,3]=="甘肃"),][,7]))[1:30]
w28<-as.numeric(unlist(data1[which(data1[,3]=="青海"),][,7]))[1:30]
w29<-as.numeric(unlist(data1[which(data1[,3]=="宁夏"),][,7]))[1:30]
w30<-as.numeric(unlist(data1[which(data1[,3]=="新疆"),][,7]))[1:30]
w<-c(w1,w2,w3,w4,w5,w6,w7,w8,w9,w10,w11,w12,w13,w14,w15,w16,w17,w18,w19,w20,w21,w22,w23,w24,w25,w26,w27,w28,w29,w30)




year<-time


data_twfe<-data.frame(Y,Tr1,Tr2,Tr3,abb,year,Tr,w,x,z)

plm<-(plm(Y~Tr1+Tr2+Tr3+x+w+z,data=data_twfe,model="within",effect="time",index = c("year")))
summary(plm)





Tr1<-rbind(D1,D2,D3,D4+q2,D5,D6+q2,D7+q2,D8,D9,D10,D11,D12,D13+q2,D14+q2,D15,D16,D17,D18,D19+q2,D20+q2,D21,D22,D23+q2,D24+q2,D25+q2,D26,D27,D28,D29,D30)
Tr2<-rbind(rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1),rep(q2,1))
q3<-c(rep(0,21),rep(1,9))
Tr3<-rbind(rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1),rep(q3,1))







##===================================================================================================================================================
##===================================================================================================================================================


# The EFFECT OF THE FIRST WAVE  27 treated units#
## pp7,pp17,pp32,pp33,pp37,pp38,pp41,pp42,pp49,pp53,pp55,pp63,pp66,pp76,pp77,pp83,pp86,pp91,pp95,pp96,pp97,pp100,pp108,pp113,pp123,pp124,pp125


TT0<-c( sum(Tr1[1,]==0),sum(Tr1[2,]==0),sum(Tr1[3,]==0),sum(Tr1[4,]==0),sum(Tr1[5,]==0),sum(Tr1[6,]==0),sum(Tr1[7,]==0),sum(Tr1[8,]==0),sum(Tr1[9,]==0),sum(Tr1[10,]==0),sum(Tr1[11,]==0),sum(Tr1[12,]==0),sum(Tr1[13,]==0),sum(Tr1[14,]==0),sum(Tr1[15,]==0),sum(Tr1[16,]==0),sum(Tr1[17,]==0),sum(Tr1[18,]==0),sum(Tr1[19,]==0),sum(Tr1[20,]==0),sum(Tr1[21,]==0),sum(Tr1[22,]==0),sum(Tr1[23,]==0),sum(Tr1[24,]==0),sum(Tr1[25,]==0),sum(Tr1[26,]==0),sum(Tr1[27,]==0),sum(Tr1[28,]==0),sum(Tr1[29,]==0),sum(Tr1[30,]==0) )
TT1<-TT0+1    #treatment date#


T0<-min(TT0)
T1<-min(TT0)+1

T=30
t1<-sort(sample(300:330,T))
t2<-t1^2

x<-rbind(x1,x2,x3,x4,x5,x6,x7,x8,x9,x10,x11,x12,x13,x14,x15,x16,x17,x18,x19,x20,x21,x22,x23,x24,x25,x26,x27,x28,x29,x30)
z<-rbind(z1,z2,z3,z4,z5,z6,z7,z8,z9,z10,z11,z12,z13,z14,z15,z16,z17,z18,z19,z20,z21,z22,z23,z24,z25,z26,z27,z28,z29,z30)
w<-rbind(w1,w2,w3,w4,w5,w6,w7,w8,w9,w10,w11,w12,w13,w14,w15,w16,w17,w18,w19,w20,w21,w22,w23,w24,w25,w26,w27,w28,w29,w30)


ww<-function(){


#step 1: s=1#
s=1

j=1

DD<-c(Tr1[r,][1:(T0+j)] )

yy<-c(d[r,][1:(T0+j)] )


tt1<-c(rep(t1[1:(T0+j)],1))
tt2<-c(rep(t2[1:(T0+j)],1))

zz2<-c( x[r,][1:(T0+j)] )

zz3<-c( z[r,][1:(T0+j)] )

zz4<-c( w[r,][1:(T0+j)] )

abb<-c(rep(1,(T0+j)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)


library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(lm(yy~Y_t,data=data_1))

predict<-rbind(
coe[1]+coe[2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind(Tr1[r,][1:(T0+j)] )

zz2<-rbind( x[r,][1:(T0+j)] )

zz3<-rbind( z[r,][1:(T0+j)] )

zz4<-rbind( w[r,][1:(T0+j)] )



a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][1:(T0+j)] )

yy<-c(d[r,][1:(T0+j)] )

zz2<-c( x[r,][1:(T0+j)] )

zz3<-c( z[r,][1:(T0+j)] )

zz4<-c( w[r,][1:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment1<-new_treatment




##====================================

#bootstrap 1#
#sd 1#

SS<-c()  #bootstrap sample size#
SSS<-c() #bootstrap sample size share#
boot1<-list()
for (b in 1:100){



T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-4),1)

#step 1: s=1#
s=1

j=1

SS[b]<-(T0+j)-S0+1
SSS[b]<-((T0+j)-S0+1)/((T0+j)-1+1)


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )

zz3<-c( z[r,][S0:(T0+j)] )

zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )

zz3<-rbind( z[r,][S0:(T0+j)] )

zz4<-rbind( w[r,][S0:(T0+j)] )



a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )

zz3<-c( z[r,][S0:(T0+j)] )

zz4<-c( w[r,][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment



boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)



var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


var1<-var


R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper1<-c()
lower1<-c()
for(i in 1:1){
upper1[i]<-new_treatment1[i]-Quantile_upper[i]*(var[i]^0.5)
lower1[i]<-new_treatment1[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper1
lower1





#step 2: s=2#

T0<-min(TT0)

s=2

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment2<-new_treatment





##====================================

#bootstrap 2#
#sd 2#

#step 2: s=2#
s=2

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=2

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var2<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper2<-c()
lower2<-c()
for(i in 1:1){
upper2[i]<-new_treatment2[i]-Quantile_upper[i]*(var[i]^0.5)
lower2[i]<-new_treatment2[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper2
lower2










#step 3: s=3#

T0<-min(TT0)

s=3

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment3<-new_treatment





##====================================

#bootstrap 3#
#sd 3#

#step 3: s=3#
s=3

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=3

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var3<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper3<-c()
lower3<-c()
for(i in 1:1){
upper3[i]<-new_treatment3[i]-Quantile_upper[i]*(var[i]^0.5)
lower3[i]<-new_treatment3[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper3
lower3









#step 4: s=4#

T0<-min(TT0)

s=4

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment4<-new_treatment





##====================================

#bootstrap 4#
#sd 4#

#step 4: s=4#
s=4

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=4

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var4<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper4<-c()
lower4<-c()
for(i in 1:1){
upper4[i]<-new_treatment4[i]-Quantile_upper[i]*(var[i]^0.5)
lower4[i]<-new_treatment4[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper4
lower4








#step 5: s=5#

T0<-min(TT0)

s=5

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment5<-new_treatment





##====================================

#bootstrap 5#
#sd 5#

#step 5: s=5#
s=5

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=5

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var5<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper5<-c()
lower5<-c()
for(i in 1:1){
upper5[i]<-new_treatment5[i]-Quantile_upper[i]*(var[i]^0.5)
lower5[i]<-new_treatment5[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper5
lower5







#step 6: s=6#

T0<-min(TT0)

s=6

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment6<-new_treatment





##====================================

#bootstrap 6#
#sd 6#

#step 6: s=6#
s=6

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=6

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var6<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper6<-c()
lower6<-c()
for(i in 1:1){
upper6[i]<-new_treatment6[i]-Quantile_upper[i]*(var[i]^0.5)
lower6[i]<-new_treatment6[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper6
lower6







#step 7: s=7#

T0<-min(TT0)

s=7

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment7<-new_treatment





##====================================

#bootstrap 7#
#sd 7#

#step 7: s=7#
s=7

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=7

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var7<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper7<-c()
lower7<-c()
for(i in 1:1){
upper7[i]<-new_treatment7[i]-Quantile_upper[i]*(var[i]^0.5)
lower7[i]<-new_treatment7[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper7
lower7






#step 8: s=8#

T0<-min(TT0)

s=8

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment8<-new_treatment





##====================================

#bootstrap 8#
#sd 8#

#step 8: s=8#
s=8

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=8

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var8<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper8<-c()
lower8<-c()
for(i in 1:1){
upper8[i]<-new_treatment8[i]-Quantile_upper[i]*(var[i]^0.5)
lower8[i]<-new_treatment8[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper8
lower8






#step 9: s=9#

T0<-min(TT0)

s=9

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment9<-new_treatment





##====================================

#bootstrap 9#
#sd 9#

#step 9: s=9#
s=9

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=9

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var9<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper9<-c()
lower9<-c()
for(i in 1:1){
upper9[i]<-new_treatment9[i]-Quantile_upper[i]*(var[i]^0.5)
lower9[i]<-new_treatment9[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper9
lower9





#step 10: s=10#

T0<-min(TT0)

s=10

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],Tr1[r,][T0+9],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment10<-new_treatment





##====================================

#bootstrap 10#
#sd 10#

#step 10: s=10#
s=10

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=10

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],Tr1[r,][T0+9],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var10<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper10<-c()
lower10<-c()
for(i in 1:1){
upper10[i]<-new_treatment10[i]-Quantile_upper[i]*(var[i]^0.5)
lower10[i]<-new_treatment10[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper10
lower10







#step 11: s=11#

T0<-min(TT0)

s=11

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],Tr1[r,][T0+9],Tr1[r,][T0+10],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment11<-new_treatment





##====================================

#bootstrap 11#
#sd 11#

#step 11: s=11#
s=11

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=11

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],Tr1[r,][T0+9],Tr1[r,][T0+10],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var11<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper11<-c()
lower11<-c()
for(i in 1:1){
upper11[i]<-new_treatment11[i]-Quantile_upper[i]*(var[i]^0.5)
lower11[i]<-new_treatment11[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper11
lower11








#step 12: s=12#

T0<-min(TT0)

s=12

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],Tr1[r,][T0+9],Tr1[r,][T0+10],Tr1[r,][T0+11],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment11,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment12<-new_treatment





##====================================

#bootstrap 12#
#sd 12#

#step 12: s=12#
s=12

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=12

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],Tr1[r,][T0+9],Tr1[r,][T0+10],Tr1[r,][T0+11],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment11,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var12<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper12<-c()
lower12<-c()
for(i in 1:1){
upper12[i]<-new_treatment12[i]-Quantile_upper[i]*(var[i]^0.5)
lower12[i]<-new_treatment12[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper12
lower12










#step 13: s=13#

T0<-min(TT0)

s=13

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],Tr1[r,][T0+9],Tr1[r,][T0+10],Tr1[r,][T0+11],Tr1[r,][T0+12],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment11,new_treatment12,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment13<-new_treatment





##====================================

#bootstrap 13#
#sd 13#

#step 13: s=13#
s=13

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=13

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],Tr1[r,][T0+9],Tr1[r,][T0+10],Tr1[r,][T0+11],Tr1[r,][T0+12],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment11,new_treatment12,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var13<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper13<-c()
lower13<-c()
for(i in 1:1){
upper13[i]<-new_treatment13[i]-Quantile_upper[i]*(var[i]^0.5)
lower13[i]<-new_treatment13[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper13
lower13







#step 14: s=14#

T0<-min(TT0)

s=14

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],Tr1[r,][T0+9],Tr1[r,][T0+10],Tr1[r,][T0+11],Tr1[r,][T0+12],Tr1[r,][T0+13],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment11,new_treatment12,new_treatment13,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment14<-new_treatment





##====================================

#bootstrap 14#
#sd 14#

#step 14: s=14#
s=14

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=14

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],Tr1[r,][T0+9],Tr1[r,][T0+10],Tr1[r,][T0+11],Tr1[r,][T0+12],Tr1[r,][T0+13],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment11,new_treatment12,new_treatment13,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var14<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper14<-c()
lower14<-c()
for(i in 1:1){
upper14[i]<-new_treatment14[i]-Quantile_upper[i]*(var[i]^0.5)
lower14[i]<-new_treatment14[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper14
lower14







#step 15: s=15#

T0<-min(TT0)

s=15

DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],Tr1[r,][T0+9],Tr1[r,][T0+10],Tr1[r,][T0+11],Tr1[r,][T0+12],Tr1[r,][T0+13],Tr1[r,][T0+14],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment11,new_treatment12,new_treatment13,new_treatment14,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

tt1<-rbind(t1[1:(T0+j)])

zz2<-rbind( x[r,][1:(T0+j)] )
 
zz3<-rbind( z[r,][1:(T0+j)] )
 
zz4<-rbind( w[r,][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(t1[1:(T0+j)])

zz2<-c( x[r,][1:(T0+j)] )
 
zz3<-c( z[r,][1:(T0+j)] )
 
zz4<-c( w[r,][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


new_treatment15<-new_treatment





##====================================

#bootstrap 15#
#sd 15#

#step 15: s=15#
s=15

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-3),1)

s=15

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(Tr1[r,][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr1[r,][T0+1],Tr1[r,][T0+2],Tr1[r,][T0+3],Tr1[r,][T0+4],Tr1[r,][T0+5],Tr1[r,][T0+6],Tr1[r,][T0+7],Tr1[r,][T0+8],Tr1[r,][T0+9],Tr1[r,][T0+10],Tr1[r,][T0+11],Tr1[r,][T0+12],Tr1[r,][T0+13],Tr1[r,][T0+14],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( d[r,][1:(T0+s)]-c(rep(0,T0),new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment11,new_treatment12,new_treatment13,new_treatment14,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr1[r,][S0:(T0+j)] )

zz2<-rbind( x[r,][S0:(T0+j)] )
 
zz3<-rbind( z[r,][S0:(T0+j)] )
 
zz4<-rbind( w[r,][S0:(T0+j)] )




a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0


a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr1[r,][S0:(T0+j)] )

yy<-c(d[r,][S0:(T0+j)] )


tt1<-c(rep(t1[S0:(T0+j)],1))
tt2<-c(rep(t2[S0:(T0+j)],1))

zz2<-c( x[r,][S0:(T0+j)] )
 
zz3<-c( z[r,][S0:(T0+j)] )
 
zz4<-c( w[r,][S0:(T0+j)] )

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

var15<-var

R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper15<-c()
lower15<-c()
for(i in 1:1){
upper15[i]<-new_treatment15[i]-Quantile_upper[i]*(var[i]^0.5)
lower15[i]<-new_treatment15[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper15
lower15




new<-( as.numeric(c(new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment11,new_treatment12,new_treatment13,new_treatment14,new_treatment15)) )

var<-( as.numeric(c(var1,var2,var3,var4,var5,var6,var7,var8,var9,var10,var11,var12,var13,var14,var15)) )

upper<-( as.numeric(c(upper1,upper2,upper3,upper4,upper5,upper6,upper7,upper8,upper9,upper10,upper11,upper12,upper13,upper14,upper15)) )

lower<-( as.numeric(c(lower1,lower2,lower3,lower4,lower5,lower6,lower7,lower8,lower9,lower10,lower11,lower12,lower13,lower14,lower15)) )



out1=list(new,var,upper,lower)

return(out1)

}


out1<-c()
for (i in 1:30){
r=i
  out1[[i]] <- ww()
}
 
new<-list()
for(i in 1:30){
new[[i]]<-out1[[i]][[1]]
}

var<-list()
for(i in 1:30){
var[[i]]<-out1[[i]][[2]]
}

upper<-list()
for(i in 1:30){
upper[[i]]<-out1[[i]][[3]]
}

lower<-list()
for(i in 1:30){
lower[[i]]<-out1[[i]][[4]]
}



new1<-new[[1]]
new2<-new[[2]]
new3<-new[[3]]
new4<-new[[4]]
new5<-new[[5]]
new6<-new[[6]]
new7<-new[[7]]
new8<-new[[8]]
new9<-new[[9]]
new10<-new[[10]]
new11<-new[[11]]
new12<-new[[12]]
new13<-new[[13]]
new14<-new[[14]]
new15<-new[[15]]
new16<-new[[16]]
new17<-new[[17]]
new18<-new[[18]]
new19<-new[[19]]
new20<-new[[20]]
new21<-new[[21]]
new22<-new[[22]]
new23<-new[[23]]
new24<-new[[24]]
new25<-new[[25]]
new26<-new[[26]]
new27<-new[[27]]
new28<-new[[28]]
new29<-new[[29]]
new30<-new[[30]]

var1<-var[[1]]
var2<-var[[2]]
var3<-var[[3]]
var4<-var[[4]]
var5<-var[[5]]
var6<-var[[6]]
var7<-var[[7]]
var8<-var[[8]]
var9<-var[[9]]
var10<-var[[10]]
var11<-var[[11]]
var12<-var[[12]]
var13<-var[[13]]
var14<-var[[14]]
var15<-var[[15]]
var16<-var[[16]]
var17<-var[[17]]
var18<-var[[18]]
var19<-var[[19]]
var20<-var[[20]]
var21<-var[[21]]
var22<-var[[22]]
var23<-var[[23]]
var24<-var[[24]]
var25<-var[[25]]
var26<-var[[26]]
var27<-var[[27]]
var28<-var[[28]]
var29<-var[[29]]
var30<-var[[30]]

upper1<-upper[[1]]
upper2<-upper[[2]]
upper3<-upper[[3]]
upper4<-upper[[4]]
upper5<-upper[[5]]
upper6<-upper[[6]]
upper7<-upper[[7]]
upper8<-upper[[8]]
upper9<-upper[[9]]
upper10<-upper[[10]]
upper11<-upper[[11]]
upper12<-upper[[12]]
upper13<-upper[[13]]
upper14<-upper[[14]]
upper15<-upper[[15]]
upper16<-upper[[16]]
upper17<-upper[[17]]
upper18<-upper[[18]]
upper19<-upper[[19]]
upper20<-upper[[20]]
upper21<-upper[[21]]
upper22<-upper[[22]]
upper23<-upper[[23]]
upper24<-upper[[24]]
upper25<-upper[[25]]
upper26<-upper[[26]]
upper27<-upper[[27]]
upper28<-upper[[28]]
upper29<-upper[[29]]
upper30<-upper[[30]]

lower1<-lower[[1]]
lower2<-lower[[2]]
lower3<-lower[[3]]
lower4<-lower[[4]]
lower5<-lower[[5]]
lower6<-lower[[6]]
lower7<-lower[[7]]
lower8<-lower[[8]]
lower9<-lower[[9]]
lower10<-lower[[10]]
lower11<-lower[[11]]
lower12<-lower[[12]]
lower13<-lower[[13]]
lower14<-lower[[14]]
lower15<-lower[[15]]
lower16<-lower[[16]]
lower17<-lower[[17]]
lower18<-lower[[18]]
lower19<-lower[[19]]
lower20<-lower[[20]]
lower21<-lower[[21]]
lower22<-lower[[22]]
lower23<-lower[[23]]
lower24<-lower[[24]]
lower25<-lower[[25]]
lower26<-lower[[26]]
lower27<-lower[[27]]
lower28<-lower[[28]]
lower29<-lower[[29]]
lower30<-lower[[30]]






average<-(new1+new2+new3+new4+new5+new6+new7+new8+new9+new10+new11+new12+new13+new14+new15+new16+new17+new18+new19+new20+new21+new22+new23+new24+new25+new26+new27+new28+new29+new30)/30

average_upper<-(upper1+upper2+upper3+upper4+upper5+upper6+upper7+upper8+upper9+upper10+upper11+upper12+upper13+upper14+upper15+upper16+upper17+upper18+upper19+upper20+upper21+upper22+upper23+upper24+upper25+upper26+upper27+upper28+upper29+upper30)/30

average_lower<-(lower1+lower2+lower3+lower4+lower5+lower6+lower7+lower8+lower9+lower10+lower11+lower12+lower13+lower14+lower15+lower16+lower17+lower18+lower19+lower20+lower21+lower22+lower23+lower24+lower25+lower26+lower27+lower28+lower29+lower30)/30

min<-min(average,average_upper,average_lower)
max<-max(average,average_upper,average_lower)
plot(average,ylim=c(min,max))
par(new=T)
plot(average_upper,pch="",ylim=c(min,max))
lines(average_upper)
par(new=T)
plot(average_lower,pch="",ylim=c(min,max))
lines(average_lower)
abline(h=0,lty=3,col="lightgrey")
abline(h=mean(average),lty=3)

























##===================================================================================================================================================
##===================================================================================================================================================


# The EFFECT OF THE FIRST WAVE  27 treated units#
## pp7,pp17,pp32,pp33,pp37,pp38,pp41,pp42,pp49,pp53,pp55,pp63,pp66,pp76,pp77,pp83,pp86,pp91,pp95,pp96,pp97,pp100,pp108,pp113,pp123,pp124,pp125


TT0<-c( sum(Tr2[1,][10:21]==0),sum(Tr2[2,][10:21]==0),sum(Tr2[3,][10:21]==0),sum(Tr2[4,][10:21]==0),sum(Tr2[5,][10:21]==0),sum(Tr2[6,][10:21]==0),sum(Tr2[7,][10:21]==0),sum(Tr2[8,][10:21]==0),sum(Tr2[9,][10:21]==0),sum(Tr2[10,][10:21]==0),sum(Tr2[11,][10:21]==0),sum(Tr2[12,][10:21]==0),sum(Tr2[13,][10:21]==0),sum(Tr2[14,][10:21]==0),sum(Tr2[15,][10:21]==0),sum(Tr2[16,][10:21]==0),sum(Tr2[17,][10:21]==0),sum(Tr2[18,][10:21]==0),sum(Tr2[19,][10:21]==0),sum(Tr2[20,][10:21]==0),sum(Tr2[21,][10:21]==0),sum(Tr2[22,][10:21]==0),sum(Tr2[23,][10:21]==0),sum(Tr2[24,][10:21]==0),sum(Tr2[25,][10:21]==0),sum(Tr2[26,][10:21]==0),sum(Tr2[27,][10:21]==0),sum(Tr2[28,][10:21]==0),sum(Tr2[29,][10:21]==0),sum(Tr2[30,][10:21]==0) )
TT1<-TT0+1    #treatment date#


T0<-min(TT0)
T1<-min(TT0)+1

T=30
t1<-sort(sample(300:330,T))
t2<-t1^2


x<-rbind(x1,x2,x3,x4,x5,x6,x7,x8,x9,x10,x11,x12,x13,x14,x15,x16,x17,x18,x19,x20,x21,x22,x23,x24,x25,x26,x27,x28,x29,x30)
z<-rbind(z1,z2,z3,z4,z5,z6,z7,z8,z9,z10,z11,z12,z13,z14,z15,z16,z17,z18,z19,z20,z21,z22,z23,z24,z25,z26,z27,z28,z29,z30)
w<-rbind(w1,w2,w3,w4,w5,w6,w7,w8,w9,w10,w11,w12,w13,w14,w15,w16,w17,w18,w19,w20,w21,w22,w23,w24,w25,w26,w27,w28,w29,w30)



ww<-function(){


#step 1: s=1#
s=1

j=1

DD<-c(Tr2[r,][10:21][1:(T0+j)] )

yy<-c(d[r,][10:21][1:(T0+j)] )


tt1<-c(rep(t1[10:21][1:(T0+j)],1))
tt2<-c(rep(t2[10:21][1:(T0+j)],1))

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )

abb<-c(rep(1,(T0+j)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)


library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[10:21][1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0


DD<-rbind(Tr2[r,][10:21][1:(T0+j)] )

yy<-rbind(d[r,][10:21][1:(T0+j)] )

zz2<-rbind( x[r,][10:21][1:(T0+j)] )

zz3<-rbind( z[r,][10:21][1:(T0+j)] )

zz4<-rbind( w[r,][10:21][1:(T0+j)] )



a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))


a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))


a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr2[r,][10:21][1:(T0+j)] )

yy<-c(d[r,][10:21][1:(T0+j)] )


tt1<-c(rep(t1[10:21][1:(T0+j)],1))
tt2<-c(rep(t2[10:21][1:(T0+j)],1))

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


second_treatment1<-new_treatment




##====================================

#bootstrap 1#
#sd 1#

SS<-c()  #bootstrap sample size#
SSS<-c() #bootstrap sample size share#
boot1<-list()
for (b in 1:100){



T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-2),1)

#step 1: s=1#
s=1

j=1

SS[b]<-(T0+j)-S0+1
SSS[b]<-((T0+j)-S0+1)/((T0+j)-1+1)


DD<-c(Tr2[r,][10:21][S0:(T0+j)] )

yy<-c(d[r,][10:21][S0:(T0+j)] )


tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )


abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind(Tr2[r,][10:21][S0:(T0+j)] )

yy<-rbind(d[r,][10:21][S0:(T0+j)] )

zz2<-rbind( x[r,][10:21][S0:(T0+j)] )

zz3<-rbind( z[r,][10:21][S0:(T0+j)] )

zz4<-rbind( w[r,][10:21][S0:(T0+j)] )



a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c(Tr2[r,][10:21][S0:(T0+j)] )

yy<-c(d[r,][10:21][S0:(T0+j)] )


tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)



var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

second_var1<-var


R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper1<-c()
second_lower1<-c()
for(i in 1:1){
second_upper1[i]<-second_treatment1[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower1[i]<-second_treatment1[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper1
second_lower1







#step 2: s=2#

T0<-min(TT0)

s=2

DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],1))
tt2<-c(rep(t2[10:21][1:(T0+j)],1))

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

zz2<-rbind( x[r,][10:21][1:(T0+j)] )

zz3<-rbind( z[r,][10:21][1:(T0+j)] )

zz4<-rbind( w[r,][10:21][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment

second_treatment2<-new_treatment





##====================================

#bootstrap 2#
#sd 2#

#step 2: s=2#
s=2

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=2

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)])

zz2<-rbind( x[r,][10:21][S0:(T0+j)] )

zz3<-rbind( z[r,][10:21][S0:(T0+j)] )

zz4<-rbind( w[r,][10:21][S0:(T0+j)] )



a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))


a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)])) )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

second_var2<-var


R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper2<-c()
second_lower2<-c()
for(i in 1:1){
second_upper2[i]<-second_treatment2[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower2[i]<-second_treatment2[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper2
second_lower2








#step 3: s=3#

T0<-min(TT0)

s=3

DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],Tr2[r,][10:21][T0+2],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,second_treatment2,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],1))
tt2<-c(rep(t2[10:21][1:(T0+j)],1))

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

zz2<-rbind( x[r,][10:21][1:(T0+j)] )

zz3<-rbind( z[r,][10:21][1:(T0+j)] )

zz4<-rbind( w[r,][10:21][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment

second_treatment3<-new_treatment





##====================================

#bootstrap 3#
#sd 3#

#step 3: s=3#
s=3

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=3

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],Tr2[r,][10:21][T0+2],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,second_treatment2,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)])

zz2<-rbind( x[r,][10:21][S0:(T0+j)] )

zz3<-rbind( z[r,][10:21][S0:(T0+j)] )

zz4<-rbind( w[r,][10:21][S0:(T0+j)] )



a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))


a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)])) )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

second_var3<-var


R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper3<-c()
second_lower3<-c()
for(i in 1:1){
second_upper3[i]<-second_treatment3[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower3[i]<-second_treatment3[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper3
second_lower3








#step 4: s=4#

T0<-min(TT0)

s=4

DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],Tr2[r,][10:21][T0+2],Tr2[r,][10:21][T0+3],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,second_treatment2,second_treatment3,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],1))
tt2<-c(rep(t2[10:21][1:(T0+j)],1))

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

zz2<-rbind( x[r,][10:21][1:(T0+j)] )

zz3<-rbind( z[r,][10:21][1:(T0+j)] )

zz4<-rbind( w[r,][10:21][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment

second_treatment4<-new_treatment





##====================================

#bootstrap 4#
#sd 4#

#step 4: s=4#
s=4

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=4

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],Tr2[r,][10:21][T0+2],Tr2[r,][10:21][T0+3],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,second_treatment2,second_treatment3,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)])

zz2<-rbind( x[r,][10:21][S0:(T0+j)] )

zz3<-rbind( z[r,][10:21][S0:(T0+j)] )

zz4<-rbind( w[r,][10:21][S0:(T0+j)] )



a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))


a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)])) )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

second_var4<-var


R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper4<-c()
second_lower4<-c()
for(i in 1:1){
second_upper4[i]<-second_treatment4[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower4[i]<-second_treatment4[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper4
second_lower4




#step 5: s=5#

T0<-min(TT0)

s=5

DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],Tr2[r,][10:21][T0+2],Tr2[r,][10:21][T0+3],Tr2[r,][10:21][T0+4],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,second_treatment2,second_treatment3,second_treatment4,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],1))
tt2<-c(rep(t2[10:21][1:(T0+j)],1))

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

zz2<-rbind( x[r,][10:21][1:(T0+j)] )

zz3<-rbind( z[r,][10:21][1:(T0+j)] )

zz4<-rbind( w[r,][10:21][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment

second_treatment5<-new_treatment





##====================================

#bootstrap 5#
#sd 5#

#step 5: s=5#
s=5

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=5

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],Tr2[r,][10:21][T0+2],Tr2[r,][10:21][T0+3],Tr2[r,][10:21][T0+4],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,second_treatment2,second_treatment3,second_treatment4,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)])

zz2<-rbind( x[r,][10:21][S0:(T0+j)] )

zz3<-rbind( z[r,][10:21][S0:(T0+j)] )

zz4<-rbind( w[r,][10:21][S0:(T0+j)] )



a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))


a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)])) )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

second_var5<-var


R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper5<-c()
second_lower5<-c()
for(i in 1:1){
second_upper5[i]<-second_treatment5[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower5[i]<-second_treatment5[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper5
second_lower5







#step 6: s=6#

T0<-min(TT0)

s=6

DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],Tr2[r,][10:21][T0+2],Tr2[r,][10:21][T0+3],Tr2[r,][10:21][T0+4],Tr2[r,][10:21][T0+5],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,second_treatment2,second_treatment3,second_treatment4,second_treatment5,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],1))
tt2<-c(rep(t2[10:21][1:(T0+j)],1))

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

zz2<-rbind( x[r,][10:21][1:(T0+j)] )

zz3<-rbind( z[r,][10:21][1:(T0+j)] )

zz4<-rbind( w[r,][10:21][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment

second_treatment6<-new_treatment





##====================================

#bootstrap 6#
#sd 6#

#step 6: s=6#
s=6

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=6

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],Tr2[r,][10:21][T0+2],Tr2[r,][10:21][T0+3],Tr2[r,][10:21][T0+4],Tr2[r,][10:21][T0+5],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,second_treatment2,second_treatment3,second_treatment4,second_treatment5,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)])

zz2<-rbind( x[r,][10:21][S0:(T0+j)] )

zz3<-rbind( z[r,][10:21][S0:(T0+j)] )

zz4<-rbind( w[r,][10:21][S0:(T0+j)] )



a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))


a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)])) )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

second_var6<-var


R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper6<-c()
second_lower6<-c()
for(i in 1:1){
second_upper6[i]<-second_treatment6[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower6[i]<-second_treatment6[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper6
second_lower6






#step 7: s=7#

T0<-min(TT0)

s=7

DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],Tr2[r,][10:21][T0+2],Tr2[r,][10:21][T0+3],Tr2[r,][10:21][T0+4],Tr2[r,][10:21][T0+5],Tr2[r,][10:21][T0+6],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,second_treatment2,second_treatment3,second_treatment4,second_treatment5,second_treatment6,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],1))
tt2<-c(rep(t2[10:21][1:(T0+j)],1))

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

zz2<-rbind( x[r,][10:21][1:(T0+j)] )

zz3<-rbind( z[r,][10:21][1:(T0+j)] )

zz4<-rbind( w[r,][10:21][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment

second_treatment7<-new_treatment





##====================================

#bootstrap 7#
#sd 7#

#step 7: s=7#
s=7

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=7

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],Tr2[r,][10:21][T0+2],Tr2[r,][10:21][T0+3],Tr2[r,][10:21][T0+4],Tr2[r,][10:21][T0+5],Tr2[r,][10:21][T0+6],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,second_treatment2,second_treatment3,second_treatment4,second_treatment5,second_treatment6,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)])

zz2<-rbind( x[r,][10:21][S0:(T0+j)] )

zz3<-rbind( z[r,][10:21][S0:(T0+j)] )

zz4<-rbind( w[r,][10:21][S0:(T0+j)] )



a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))


a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)])) )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

second_var7<-var


R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper7<-c()
second_lower7<-c()
for(i in 1:1){
second_upper7[i]<-second_treatment7[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower7[i]<-second_treatment7[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper7
second_lower7






#step 8: s=8#

T0<-min(TT0)

s=8

DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],Tr2[r,][10:21][T0+2],Tr2[r,][10:21][T0+3],Tr2[r,][10:21][T0+4],Tr2[r,][10:21][T0+5],Tr2[r,][10:21][T0+6],Tr2[r,][10:21][T0+7],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,second_treatment2,second_treatment3,second_treatment4,second_treatment5,second_treatment6,second_treatment7,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

tt1<-c(rep(t1[10:21][1:(T0+j)],1))
tt2<-c(rep(t2[10:21][1:(T0+j)],1))

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 
abb<-c(rep(1,(T0+j)) )

year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )
data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

DD<-rbind( DDD[1,][1:(T0+j)])

yy<-rbind(yyy[1,][1:(T0+j)])

zz2<-rbind( x[r,][10:21][1:(T0+j)] )

zz3<-rbind( z[r,][10:21][1:(T0+j)] )

zz4<-rbind( w[r,][10:21][1:(T0+j)] )


a1<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(DD[1,][1:(T0+j)]*Y_t[1,])-sum(DD[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz2[1,][1:(T0+j)]*Y_t[1,])-sum(zz2[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz3[1,][1:(T0+j)]*Y_t[1,])-sum(zz3[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))* (( (T0+j)*sum(zz4[1,][1:(T0+j)]*Y_t[1,])-sum(zz4[1,][1:(T0+j)])*sum(Y_t[1,]) )/( (T0+j)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][1:(T0+j)])

yy<-c(yyy[1,][1:(T0+j)])

zz2<-c( x[r,][10:21][1:(T0+j)] )

zz3<-c( z[r,][10:21][1:(T0+j)] )

zz4<-c( w[r,][10:21][1:(T0+j)] )
 

Y_t<-c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)) )


data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][T1:(T0+j)])-mean(Y_t[1,][1:T0]))-a3_2[1]*coes[3] )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment

second_treatment8<-new_treatment





##====================================

#bootstrap 8#
#sd 8#

#step 8: s=8#
s=8

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-2),1)

s=8

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
Tr2[r,][10:21][1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) - c(rep(0,T0),Tr2[r,][10:21][T0+1],Tr2[r,][10:21][T0+2],Tr2[r,][10:21][T0+3],Tr2[r,][10:21][T0+4],Tr2[r,][10:21][T0+5],Tr2[r,][10:21][T0+6],Tr2[r,][10:21][T0+7],0)*ifelse(TT0[1]<=T0,0,1) )

yyy<-rbind( 
d[r,][10:21][1:(T0+s)]-c(rep(0,T0),second_treatment1,second_treatment2,second_treatment3,second_treatment4,second_treatment5,second_treatment6,second_treatment7,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s)) )



TT0_2<-c( sum(DDD[1,]==0) )
TT1_2<-TT0_2+1    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )

abb<-c(rep(1,(T0+j-S0+1)) )

year<-tt1

data<-data.frame(yy,DD,tt1,tt2,zz2,zz3,zz4,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)


tt1<-t1[S0:(T0+j)]

x_t<-rbind(2*(a_x[1])*tt1+b_x[1])

Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_1<-data.frame(yy,Y_t,abb)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0



DD<-rbind( DDD[1,][S0:(T0+j)])

yy<-rbind(yyy[1,][S0:(T0+j)])

zz2<-rbind( x[r,][10:21][S0:(T0+j)] )

zz3<-rbind( z[r,][10:21][S0:(T0+j)] )

zz4<-rbind( w[r,][10:21][S0:(T0+j)] )



a1<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[1,]*Y_t[1,])-sum(DD[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))


a1[is.nan(a1)]<-0

a3_2<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz2[1,]*Y_t[1,])-sum(zz2[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_2[is.nan(a3_2)]<-0

a3_3<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz3[1,]*Y_t[1,])-sum(zz3[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_3[is.nan(a3_3)]<-0

a3_4<-  (mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz4[1,]*Y_t[1,])-sum(zz4[1,])*sum(Y_t[1,]) )/( (T0+j-S0+1)*sum(Y_t[1,]*Y_t[1,])-sum(Y_t[1,])*sum(Y_t[1,]) ))

a3_4[is.nan(a3_4)]<-0


DD<-c( DDD[1,][S0:(T0+j)])

yy<-c(yyy[1,][S0:(T0+j)])

tt1<-c(rep(t1[10:21][S0:(T0+j)],1))
tt2<-c(rep(t2[10:21][S0:(T0+j)],1))

zz2<-c( x[r,][10:21][S0:(T0+j)] )

zz3<-c( z[r,][10:21][S0:(T0+j)] )

zz4<-c( w[r,][10:21][S0:(T0+j)] )


Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)) )

data_final<-data.frame(yy,DD,zz2,zz3,zz4,Y_t,abb)
 
coes<-coefficients(lm(yy~Y_t+zz2+DD,data=data_final))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1]) 

Y_t[is.nan(Y_t)]<-0

new_treatment<-( (new[1]-coes[2]*(mean(Y_t[1,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1,][1:(T0-S0+1)])) )/a1[1] )
new_treatment[is.na(new_treatment)]<-0
new_treatment


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)


var<-c()
for (k in 1:1){

B<-length(boot[k,])
q=1
xx=sort(as.numeric(boot[k,]))
nob=length(xx)-1 
sum1 = sum((xx[5:(nob+1)]-2*xx[3:(nob-1)]+xx[1:(nob-3)])^2)
sum2 = sum((xx[3:(nob+1)]-2*xx[2:nob]+xx[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

second_var8<-var


R<-list()
for (i in 1:1){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:1){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:1){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:1){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


second_upper8<-c()
second_lower8<-c()
for(i in 1:1){
second_upper8[i]<-second_treatment8[i]-Quantile_upper[i]*(var[i]^0.5)
second_lower8[i]<-second_treatment8[i]+Quantile_lower[i]*(var[i]^0.5)
}

second_upper8
second_lower8






new<-( as.numeric(c(second_treatment1,second_treatment2,second_treatment3,second_treatment4,second_treatment5,second_treatment6,second_treatment7,second_treatment8)) )

var<-( as.numeric(c(second_var1,second_var2,second_var3,second_var4,second_var5,second_var6,second_var7,second_var8)) )

second_upper<-( as.numeric(c(second_upper1,second_upper2,second_upper3,second_upper4,second_upper5,second_upper6,second_upper7,second_upper8)) )

second_lower<-( as.numeric(c(second_lower1,second_lower2,second_lower3,second_lower4,second_lower5,second_lower6,second_lower7,second_lower8)) )



out1=list(new,var,second_upper,second_lower)

return(out1)

}


out1<-c()
for (i in 1:30){
r=i
  out1[[i]] <- ww()
}
 
new<-list()
for(i in 1:30){
new[[i]]<-out1[[i]][[1]]
}

var<-list()
for(i in 1:30){
var[[i]]<-out1[[i]][[2]]
}

second_upper<-list()
for(i in 1:30){
second_upper[[i]]<-out1[[i]][[3]]
}

second_lower<-list()
for(i in 1:30){
second_lower[[i]]<-out1[[i]][[4]]
}



second1<-new[[1]]
second2<-new[[2]]
second3<-new[[3]]
second4<-new[[4]]
second5<-new[[5]]
second6<-new[[6]]
second7<-new[[7]]
second8<-new[[8]]
second9<-new[[9]]
second10<-new[[10]]
second11<-new[[11]]
second12<-new[[12]]
second13<-new[[13]]
second14<-new[[14]]
second15<-new[[15]]
second16<-new[[16]]
second17<-new[[17]]
second18<-new[[18]]
second19<-new[[19]]
second20<-new[[20]]
second21<-new[[21]]
second22<-new[[22]]
second23<-new[[23]]
second24<-new[[24]]
second25<-new[[25]]
second26<-new[[26]]
second27<-new[[27]]
second28<-new[[28]]
second29<-new[[29]]
second30<-new[[30]]

second_var1<-var[[1]]
second_var2<-var[[2]]
second_var3<-var[[3]]
second_var4<-var[[4]]
second_var5<-var[[5]]
second_var6<-var[[6]]
second_var7<-var[[7]]
second_var8<-var[[8]]
second_var9<-var[[9]]
second_var10<-var[[10]]
second_var11<-var[[11]]
second_var12<-var[[12]]
second_var13<-var[[13]]
second_var14<-var[[14]]
second_var15<-var[[15]]
second_var16<-var[[16]]
second_var17<-var[[17]]
second_var18<-var[[18]]
second_var19<-var[[19]]
second_var20<-var[[20]]
second_var21<-var[[21]]
second_var22<-var[[22]]
second_var23<-var[[23]]
second_var24<-var[[24]]
second_var25<-var[[25]]
second_var26<-var[[26]]
second_var27<-var[[27]]
second_var28<-var[[28]]
second_var29<-var[[29]]
second_var30<-var[[30]]

second_upper1<-second_upper[[1]]
second_upper2<-second_upper[[2]]
second_upper3<-second_upper[[3]]
second_upper4<-second_upper[[4]]
second_upper5<-second_upper[[5]]
second_upper6<-second_upper[[6]]
second_upper7<-second_upper[[7]]
second_upper8<-second_upper[[8]]
second_upper9<-second_upper[[9]]
second_upper10<-second_upper[[10]]
second_upper11<-second_upper[[11]]
second_upper12<-second_upper[[12]]
second_upper13<-second_upper[[13]]
second_upper14<-second_upper[[14]]
second_upper15<-second_upper[[15]]
second_upper16<-second_upper[[16]]
second_upper17<-second_upper[[17]]
second_upper18<-second_upper[[18]]
second_upper19<-second_upper[[19]]
second_upper20<-second_upper[[20]]
second_upper21<-second_upper[[21]]
second_upper22<-second_upper[[22]]
second_upper23<-second_upper[[23]]
second_upper24<-second_upper[[24]]
second_upper25<-second_upper[[25]]
second_upper26<-second_upper[[26]]
second_upper27<-second_upper[[27]]
second_upper28<-second_upper[[28]]
second_upper29<-second_upper[[29]]
second_upper30<-second_upper[[30]]

second_lower1<-second_lower[[1]]
second_lower2<-second_lower[[2]]
second_lower3<-second_lower[[3]]
second_lower4<-second_lower[[4]]
second_lower5<-second_lower[[5]]
second_lower6<-second_lower[[6]]
second_lower7<-second_lower[[7]]
second_lower8<-second_lower[[8]]
second_lower9<-second_lower[[9]]
second_lower10<-second_lower[[10]]
second_lower11<-second_lower[[11]]
second_lower12<-second_lower[[12]]
second_lower13<-second_lower[[13]]
second_lower14<-second_lower[[14]]
second_lower15<-second_lower[[15]]
second_lower16<-second_lower[[16]]
second_lower17<-second_lower[[17]]
second_lower18<-second_lower[[18]]
second_lower19<-second_lower[[19]]
second_lower20<-second_lower[[20]]
second_lower21<-second_lower[[21]]
second_lower22<-second_lower[[22]]
second_lower23<-second_lower[[23]]
second_lower24<-second_lower[[24]]
second_lower25<-second_lower[[25]]
second_lower26<-second_lower[[26]]
second_lower27<-second_lower[[27]]
second_lower28<-second_lower[[28]]
second_lower29<-second_lower[[29]]
second_lower30<-second_lower[[30]]






average<-(second1+second2+second3+second4+second5+second6+second7+second8+second9+second10+second11+second12+second13+second14+second15+second16+second17+second18+second19+second20+second21+second22+second23+second24+second25+second26+second27+second28+second29+second30)/30

average_upper<-(second_upper1+second_upper2+second_upper3+second_upper4+second_upper5+second_upper6+second_upper7+second_upper8+second_upper9+second_upper10+second_upper11+second_upper12+second_upper13+second_upper14+second_upper15+second_upper16+second_upper17+second_upper18+second_upper19+second_upper20+second_upper21+second_upper22+second_upper23+second_upper24+second_upper25+second_upper26+second_upper27+second_upper28+second_upper29+second_upper30)/30

average_lower<-(second_lower1+second_lower2+second_lower3+second_lower4+second_lower5+second_lower6+second_lower7+second_lower8+second_lower9+second_lower10+second_lower11+second_lower12+second_lower13+second_lower14+second_lower15+second_lower16+second_lower17+second_lower18+second_lower19+second_lower20+second_lower21+second_lower22+second_lower23+second_lower24+second_lower25+second_lower26+second_lower27+second_lower28+second_lower29+second_lower30)/30

min<-min(average,average_upper,average_lower)
max<-max(average,average_upper,average_lower)
plot(average,ylim=c(min,max))
par(new=T)
plot(average_upper,pch="",ylim=c(min,max))
lines(average_upper)
par(new=T)
plot(average_lower,pch="",ylim=c(min,max))
lines(average_lower)
abline(h=0,lty=3,col="lightgrey")
abline(h=mean(average),lty=3)















##============================================================================================================================================
##============================================================================================================================================




#the final results#






#the total att#

mean(c(new1[which(new1!=0)],new2[which(new2!=0)],new3[which(new3!=0)],new4[which(new4!=0)],new5[which(new5!=0)],new6[which(new6!=0)],new7[which(new7!=0)],new8[which(new8!=0)],new9[which(new9!=0)],new10[which(new10!=0)],new11[which(new11!=0)],new12[which(new12!=0)],new13[which(new13!=0)],new14[which(new14!=0)],new15[which(new15!=0)],new16[which(new16!=0)],new17[which(new17!=0)],new18[which(new18!=0)],new19[which(new19!=0)],new20[which(new20!=0)],new21[which(new21!=0)],new22[which(new22!=0)],new23[which(new23!=0)],new24[which(new24!=0)],new25[which(new25!=0)],new26[which(new26!=0)],new27[which(new27!=0)],new28[which(new28!=0)],new29[which(new29!=0)],new30[which(new30!=0)]))


L<-length(c(new1[which(new1!=0)],new2[which(new2!=0)],new3[which(new3!=0)],new4[which(new4!=0)],new5[which(new5!=0)],new6[which(new6!=0)],new7[which(new7!=0)],new8[which(new8!=0)],new9[which(new9!=0)],new10[which(new10!=0)],new11[which(new11!=0)],new12[which(new12!=0)],new13[which(new13!=0)],new14[which(new14!=0)],new15[which(new15!=0)],new16[which(new16!=0)],new17[which(new17!=0)],new18[which(new18!=0)],new19[which(new19!=0)],new20[which(new20!=0)],new21[which(new21!=0)],new22[which(new22!=0)],new23[which(new23!=0)],new24[which(new24!=0)],new25[which(new25!=0)],new26[which(new26!=0)],new27[which(new27!=0)],new28[which(new28!=0)],new29[which(new29!=0)],new30[which(new30!=0)]))

( sum( var1[which(new1!=0)],var2[which(new2!=0)],var3[which(new3!=0)],var4[which(new4!=0)],var5[which(new5!=0)],var6[which(new6!=0)],var7[which(new7!=0)],var8[which(new8!=0)],var9[which(new9!=0)],var10[which(new10!=0)],var11[which(new11!=0)],var12[which(new12!=0)],var13[which(new13!=0)],var14[which(new14!=0)],var15[which(new15!=0)],var16[which(new16!=0)],var17[which(new17!=0)],var18[which(new18!=0)],var19[which(new19!=0)],var20[which(new20!=0)],var21[which(new21!=0)],var22[which(new22!=0)],var23[which(new23!=0)],var24[which(new24!=0)],var25[which(new25!=0)],var26[which(new26!=0)],var27[which(new27!=0)],var28[which(new28!=0)],var29[which(new29!=0)],var30[which(new30!=0)]) / (L*L) )^0.5













## first wave treatment effects


first_treatment1<-c(new1[1:7],new1[8:15]-second1)
first_treatment2<-c(new2[1:7],new2[8:15]-second2)
first_treatment3<-c(new3[1:7],new3[8:15]-second3)
first_treatment5<-c(new5[1:7],new5[8:15]-second5)
first_treatment8<-c(new8[1:7],new8[8:15]-second8)
first_treatment9<-c(new9[1:7],new9[8:15]-second9)
first_treatment10<-c(new10[1:7],new10[8:15]-second10)
first_treatment11<-c(new11[1:7],new11[8:15]-second11)
first_treatment12<-c(new12[1:7],new12[8:15]-second12)
first_treatment15<-c(new15[1:7],new15[8:15]-second15)
first_treatment16<-c(new16[1:7],new16[8:15]-second16)
first_treatment17<-c(new17[1:7],new17[8:15]-second17)
first_treatment18<-c(new18[1:7],new18[8:15]-second18)
first_treatment21<-c(new21[1:7],new21[8:15]-second21)
first_treatment22<-c(new22[1:7],new22[8:15]-second22)
first_treatment26<-c(new26[1:7],new26[8:15]-second26)
first_treatment27<-c(new27[1:7],new27[8:15]-second27)
first_treatment28<-c(new28[1:7],new28[8:15]-second28)
first_treatment30<-c(new30[1:7],new30[8:15]-second30)
first_treatment29<-c(new29[1:7],new29[8:15]-second29)


vvar1<-c(var1[1:7],var1[8:15]+second_var1)
vvar2<-c(var2[1:7],var2[8:15]+second_var2)
vvar3<-c(var3[1:7],var3[8:15]+second_var3)
vvar5<-c(var5[1:7],var5[8:15]+second_var5)
vvar8<-c(var8[1:7],var8[8:15]+second_var8)
vvar9<-c(var9[1:7],var9[8:15]+second_var9)
vvar10<-c(var10[1:7],var10[8:15]+second_var10)
vvar11<-c(var11[1:7],var11[8:15]+second_var11)
vvar12<-c(var12[1:7],var12[8:15]+second_var12)
vvar15<-c(var15[1:7],var15[8:15]+second_var15)
vvar16<-c(var16[1:7],var16[8:15]+second_var16)
vvar17<-c(var17[1:7],var17[8:15]+second_var17)
vvar18<-c(var18[1:7],var18[8:15]+second_var18)
vvar21<-c(var21[1:7],var21[8:15]+second_var21)
vvar22<-c(var22[1:7],var22[8:15]+second_var22)
vvar26<-c(var26[1:7],var26[8:15]+second_var26)
vvar27<-c(var27[1:7],var27[8:15]+second_var27)
vvar28<-c(var28[1:7],var28[8:15]+second_var28)
vvar30<-c(var30[1:7],var30[8:15]+second_var30)
vvar29<-c(var29[1:7],var29[8:15]+second_var29)




mean(c(first_treatment1[which(first_treatment1!=0)], first_treatment2[which(first_treatment2!=0)],first_treatment3[which(first_treatment3!=0)],first_treatment5[which(first_treatment5!=0)],first_treatment8[which(first_treatment8!=0)],first_treatment9[which(first_treatment9!=0)],first_treatment10[which(first_treatment10!=0)],first_treatment11[which(first_treatment11!=0)],first_treatment12[which(first_treatment12!=0)],first_treatment15[which(first_treatment15!=0)],first_treatment16[which(first_treatment16!=0)],first_treatment17[which(first_treatment17!=0)],first_treatment18[which(first_treatment18!=0)],first_treatment21[which(first_treatment21!=0)],first_treatment22[which(first_treatment22!=0)],first_treatment26[which(first_treatment26!=0)],first_treatment27[which(first_treatment27!=0)],first_treatment28[which(first_treatment28!=0)],first_treatment30[which(first_treatment30!=0)],first_treatment29[which(first_treatment29!=0)]  ))

L<-length(c(first_treatment1[which(first_treatment1!=0)], first_treatment2[which(first_treatment2!=0)],first_treatment3[which(first_treatment3!=0)],first_treatment5[which(first_treatment5!=0)],first_treatment8[which(first_treatment8!=0)],first_treatment9[which(first_treatment9!=0)],first_treatment10[which(first_treatment10!=0)],first_treatment11[which(first_treatment11!=0)],first_treatment12[which(first_treatment12!=0)],first_treatment15[which(first_treatment15!=0)],first_treatment16[which(first_treatment16!=0)],first_treatment17[which(first_treatment17!=0)],first_treatment18[which(first_treatment18!=0)],first_treatment21[which(first_treatment21!=0)],first_treatment22[which(first_treatment22!=0)],first_treatment26[which(first_treatment26!=0)],first_treatment27[which(first_treatment27!=0)],first_treatment28[which(first_treatment28!=0)],first_treatment30[which(first_treatment30!=0)],first_treatment29[which(first_treatment29!=0)]  ))

( sum( c(vvar1[which(first_treatment1!=0)], vvar2[which(first_treatment2!=0)],vvar3[which(first_treatment3!=0)],vvar5[which(first_treatment5!=0)],vvar8[which(first_treatment8!=0)],vvar9[which(first_treatment9!=0)],vvar10[which(first_treatment10!=0)],vvar11[which(first_treatment11!=0)],vvar12[which(first_treatment12!=0)],vvar15[which(first_treatment15!=0)],vvar16[which(first_treatment16!=0)],vvar17[which(first_treatment17!=0)],vvar18[which(first_treatment18!=0)],vvar21[which(first_treatment21!=0)],vvar22[which(first_treatment22!=0)],vvar26[which(first_treatment26!=0)],vvar27[which(first_treatment27!=0)],vvar28[which(first_treatment28!=0)],vvar30[which(first_treatment30!=0)],vvar29[which(first_treatment29!=0)] )) / (L*L) )^0.5







#second wave treatment effects#

mean(c(second1[which(second1!=0)],second2[which(second2!=0)],second3[which(second3!=0)],second4[which(second4!=0)],second5[which(second5!=0)],second6[which(second6!=0)],second7[which(second7!=0)],second8[which(second8!=0)],second9[which(second9!=0)],second10[which(second10!=0)],second11[which(second11!=0)],second12[which(second12!=0)],second13[which(second13!=0)],second14[which(second14!=0)],second15[which(second15!=0)],second16[which(second16!=0)],second17[which(second17!=0)],second18[which(second18!=0)],second19[which(second19!=0)],second20[which(second20!=0)],second21[which(second21!=0)],second22[which(second22!=0)],second23[which(second24!=0)],second24[which(second24!=0)],second25[which(second25!=0)],second26[which(second26!=0)],second27[which(second27!=0)],second28[which(second28!=0)],second29[which(second29!=0)],second30[which(second30!=0)]))


L<-length(c(c(second1[which(second1!=0)],second2[which(second2!=0)],second3[which(second3!=0)],second4[which(second4!=0)],second5[which(second5!=0)],second6[which(second6!=0)],second7[which(second7!=0)],second8[which(second8!=0)],second9[which(second9!=0)],second10[which(second10!=0)],second11[which(second11!=0)],second12[which(second12!=0)],second13[which(second13!=0)],second14[which(second14!=0)],second15[which(second15!=0)],second16[which(second16!=0)],second17[which(second17!=0)],second18[which(second18!=0)],second19[which(second19!=0)],second20[which(second20!=0)],second21[which(second21!=0)],second22[which(second22!=0)],second23[which(second24!=0)],second24[which(second24!=0)],second25[which(second25!=0)],second26[which(second26!=0)],second27[which(second27!=0)],second28[which(second28!=0)],second29[which(second29!=0)],second30[which(second30!=0)])))

( sum( second_var1[which(second1!=0)],second_var2[which(second2!=0)],second_var3[which(second3!=0)],second_var4[which(second4!=0)],second_var5[which(second5!=0)],second_var6[which(second6!=0)],second_var7[which(second7!=0)],second_var8[which(second8!=0)],second_var9[which(second9!=0)],second_var10[which(second10!=0)],second_var11[which(second11!=0)],second_var12[which(second12!=0)],second_var13[which(second13!=0)],second_var14[which(second14!=0)],second_var15[which(second15!=0)],second_var16[which(second16!=0)],second_var17[which(second17!=0)],second_var18[which(second18!=0)],second_var19[which(second19!=0)],second_var20[which(second20!=0)],second_var21[which(second21!=0)],second_var22[which(second22!=0)],second_var23[which(second23!=0)],second_var24[which(second24!=0)],second_var25[which(second25!=0)],second_var26[which(second26!=0)],second_var27[which(second27!=0)],second_var28[which(second28!=0)],second_var29[which(second29!=0)],second_var30[which(second30!=0)]) / (L*L) )^0.5












