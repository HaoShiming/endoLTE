
fbm1d<-function (H,n,T,iseed) 
{
# fast one dimensional fractional Brownian motion (FBM) generator
# output is 'W_t' with t in [0,T] using 'n' equally spaced grid points;
# code uses Fast Fourier Transform (FFT) for speed.
# INPUT:
#          - Hurst parameter 'H' in [0,1]
#          - number of grid points 'n', where 'n' is a power of 2;
#            if the 'n' supplied is not a power of two,
#            then we set n=2^ceil(log2(n)); default is n=2^12;
#          - final time 'T'; default value is T=1;
#          - iseed is the random seed number
# OUTPUT:
#          - Fractional Brownian motion 'W_t' for 't';
#          - time 't' at which FBM is computed;
#            If no output it invoked, then function plots the FBM.
# Example: plot FBM with hurst parameter 0.95 on the interval [0,10]
# [W,t]=fbm1d(0.95,2^12,10); plot(t,W)

# Reference: 
# Kroese, D. P., & Botev, Z. I. (2015). Spatial Process Simulation. 
# In Stochastic Geometry, Spatial Statistics and Random Fields(pp. 369-404)
# Springer International Publishing, DOI: 10.1007/978-3-319-10064-7_12
set.seed(iseed)
r=seq(n+1)
r[1] = 1;
idx=seq(n);
r[-1] = 0.5*((idx+1)^(2*H) - 2*idx^(2*H) + (idx-1)^(2*H))
r=append(r,r[seq(n,2, by = -1)])
lambda=Re(fft(r))/(2*n)
W=fft(sqrt(lambda)*complex(rnorm(2*n),rnorm(2*n)))
W = n^(-H)*cumsum(Re(W[1:n+1]))
W=T^H*W # t=(0:n)/n; #t=t*T;
}




a<-fbm1d(0.7,1.953125/(1/2^8),1.953125,123)


w<-function(){

T=500
Q<-c(0.95,0.955,0.96,0.965,0.97)

q1<-rnorm(T,0,0.04)
out1<-ifelse((q1)>=quantile((q1),sample(Q,1)),1,0)
qq1<-sort(q1)
D1<-sort(out1)

q2<-rnorm(T,0,0.06)
out2<-ifelse(q2>=quantile((q2),sample(Q,1)),1,0)
qq2<-sort(q2)
D2<-sort(out2)

q3<-rnorm(T,0,0.08)
out3<-ifelse(q3>=quantile((q3),sample(Q,1)),1,0)
qq3<-sort(q3)
D3<-sort(out3)

q4<-rnorm(T,0,0.10)
out4<-ifelse(q4>=quantile((q4),sample(Q,1)),1,0)
qq4<-sort(q4)
D4<-sort(out4)

q5<-rnorm(T,0,0.12)
out5<-ifelse(q5>=quantile((q5),sample(Q,1)),1,0)
qq5<-sort(q5)
D5<-sort(out5)

D<-rbind(t(D1),t(D2),t(D3),t(D4),t(D5))

w1<-sort(runif(T))+a
w2<-sort(runif(T))+a
w3<-sort(runif(T))+a
w4<-sort(runif(T))+a
w5<-sort(runif(T))+a
w<-rbind(t(w1),t(w2),t(w3),t(w4),t(w5))

z1<-(runif(T,-0.01,0.01))+a        
z2<-(runif(T,-0.02,0.02))+a           
z3<-(runif(T,-0.03,0.03))+a           
z4<-(runif(T,-0.04,0.04))+a           
z5<-(runif(T,-0.05,0.05))+a           
z<-rbind(t(z1),t(z2),t(z3),t(z4),t(z5))

y_cf1<-(w1)
y_cf2<-(w2)
y_cf3<-(w3)
y_cf4<-(w4)
y_cf5<-(w5)
y_cf<-rbind(t(y_cf1),t(y_cf2),t(y_cf3),t(y_cf4),t(y_cf5))

e1<-15.55*qq1+rnorm(T,0,0.01)
e2<-15.55*qq2+rnorm(T,0,0.01)
e3<-15.55*qq3+rnorm(T,0,0.01)
e4<-15.55*qq4+rnorm(T,0,0.01)
e5<-15.55*qq5+rnorm(T,0,0.01)
e<-rbind(t(e1),t(e2),t(e3),t(e4),t(e5))

tr1<-runif(T,-1,1)
tr2<-runif(T,-2,2)
tr3<-runif(T,-3,3)
tr4<-runif(T,-4,4)
tr5<-runif(T,-5,5)


y1<-y_cf1*11.25+0.1*z1+tr1*D1+e1
y2<-y_cf2*12.25+0.2*z2+tr2*D2+e2
y3<-y_cf3*13.25+0.3*z3+tr3*D3+e3
y4<-y_cf4*14.25+0.4*z4+tr4*D4+e4
y5<-y_cf5*15.25+0.5*z5+tr5*D5+e5

y<-rbind(y1,y2,y3,y4,y5)

y_co<-((y_cf1+y_cf2+y_cf3+y_cf4+y_cf5)/5)*10.25+0.1*((z1+z2+z3+z4+z5)/5)

y_co1<-y_co+runif(T,-1,1)
y_co2<-y_co+runif(T,-1,1)
y_co3<-y_co+runif(T,-1,1)
y_co4<-y_co+runif(T,-1,1)
y_co5<-y_co+runif(T,-1,1)
y_co6<-y_co+runif(T,-1,1)
y_co7<-y_co+runif(T,-1,1)
y_co8<-y_co+runif(T,-1,1)
y_co9<-y_co+runif(T,-1,1)
y_co10<-y_co+runif(T,-1,1)
y_co11<-y_co+runif(T,-1,1)
y_co12<-y_co+runif(T,-1,1)
y_co13<-y_co+runif(T,-1,1)
y_co14<-y_co+runif(T,-1,1)
y_co15<-y_co+runif(T,-1,1)
y_co16<-y_co+runif(T,-1,1)
y_co17<-y_co+runif(T,-1,1)
y_co18<-y_co+runif(T,-1,1)
y_co19<-y_co+runif(T,-1,1)
y_co20<-y_co+runif(T,-1,1)






##twfe estimation
library(plm)
t1<-sort(sample(300:800,T))
abb<-c(rep(1,T),rep(2,T),rep(3,T),rep(4,T),rep(5,T))
time<-rep(t1,5)
YYY<-c(y1,y2,y3,y4,y5)
ZZZ<-c(z1,z2,z3,z4,z5)
DDD<-c(D1,D2,D3,D4,D5)
data_twfe<-data.frame(abb,time,YYY,DDD,ZZZ)
coefficients(plm(YYY~DDD+ZZZ,data=data_twfe,model="within",effect="twoways"))



#before-after estimation#
before_after_treatment<-(
mean(y[1,][(sum(D1==0)+1):(sum(D1==0)+15)])-mean(y[1,][1:(sum(D1==0))])+ 
mean(y[2,][(sum(D2==0)+1):(sum(D1==0)+15)])-mean(y[2,][1:(sum(D2==0))])+ 
mean(y[3,][(sum(D3==0)+1):(sum(D1==0)+15)])-mean(y[3,][1:(sum(D3==0))])+ 
mean(y[4,][(sum(D4==0)+1):(sum(D1==0)+15)])-mean(y[4,][1:(sum(D4==0))])+ 
mean(y[5,][(sum(D5==0)+1):(sum(D1==0)+15)])-mean(y[5,][1:(sum(D5==0))]) )/5



data_twfe<-data.frame(abb,time,YYY,DDD,ZZZ)



TT0<-c( sum(D1==0),sum(D2==0),sum(D3==0),sum(D4==0),sum(D5==0) )
TT1<-c( sum(D1==0)+1,sum(D2==0)+1,sum(D3==0)+1,sum(D4==0)+1,sum(D5==0)+1 )    #treatment date#



T0<-min(TT0)
T1<-min(TT0)+1

t1<-sort(sample(300:800,T))
t2<-t1^2


#step 1: s=1#
s=1

j=1

DD<-c(D1[1:(T0+j)],D2[1:(T0+j)],D3[1:(T0+j)],D4[1:(T0+j)],D5[1:(T0+j)])
yy<-c(y1[1:(T0+j)],y2[1:(T0+j)],y3[1:(T0+j)],y4[1:(T0+j)],y5[1:(T0+j)])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[1:(T0+j)],D2[1:(T0+j)],D3[1:(T0+j)],D4[1:(T0+j)],D5[1:(T0+j)])
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(D1[1:(T0+j)],D2[1:(T0+j)],D3[1:(T0+j)],D4[1:(T0+j)],D5[1:(T0+j)])
yy<-c(y1[1:(T0+j)],y2[1:(T0+j)],y3[1:(T0+j)],y4[1:(T0+j)],y5[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}

new_treatment11<-new_treatment[1]
new_treatment12<-new_treatment[2]
new_treatment13<-new_treatment[3]
new_treatment14<-new_treatment[4]
new_treatment15<-new_treatment[5]

new_treatment1<-new_treatment

bias1<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias1


##====================================

#bootstrap 1#
#sd 1#

SS<-c()  #bootstrap sample size#
SSS<-c() #bootstrap sample size share#
boot1<-list()
for (b in 1:100){



T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

#step 1: s=1#
s=1

j=1

SS[b]<-(T0+j)-S0+1
SSS[b]<-((T0+j)-S0+1)/((T0+j)-1+1)

DD<-c(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
yy<-c(y1[S0:(T0+j)],y2[S0:(T0+j)],y3[S0:(T0+j)],y4[S0:(T0+j)],y5[S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
yy<-c(y1[S0:(T0+j)],y2[S0:(T0+j)],y3[S0:(T0+j)],y4[S0:(T0+j)],y5[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])




var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment11_sd<-var[1]
new_treatment12_sd<-var[2]
new_treatment13_sd<-var[3]
new_treatment14_sd<-var[4]
new_treatment15_sd<-var[5]


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper1<-c()
lower1<-c()
for(i in 1:5){
upper1[i]<-new_treatment1[i]-Quantile_upper[i]*(var[i]^0.5)
lower1[i]<-new_treatment1[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper1
lower1
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-1
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat1<-e_hat




#step 2: s=2#

T0<-min(TT0)

s=2

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


new_treatment21<-new_treatment[1]
new_treatment22<-new_treatment[2]
new_treatment23<-new_treatment[3]
new_treatment24<-new_treatment[4]
new_treatment25<-new_treatment[5]

new_treatment2<-new_treatment

bias2<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias2


##====================================

#bootstrap 2#
#sd 2#

#step 2: s=2#
s=2

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=2

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}


new_treatment21_sd<-var[1]
new_treatment22_sd<-var[2]
new_treatment23_sd<-var[3]
new_treatment24_sd<-var[4]
new_treatment25_sd<-var[5]

new_treatment2+2.825*var^0.5
new_treatment2-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])

R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper2<-c()
lower2<-c()
for(i in 1:5){
upper2[i]<-new_treatment2[i]-Quantile_upper[i]*(var[i]^0.5)
lower2[i]<-new_treatment2[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper2
lower2
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-2
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat2<-e_hat



#step 3: s=3#

s=3
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )



TT0_3<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_3<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_3)
T1<-min(TT0_3)+1

  
j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}




new_treatment31<-new_treatment[1]
new_treatment32<-new_treatment[2]
new_treatment33<-new_treatment[3]
new_treatment34<-new_treatment[4]
new_treatment35<-new_treatment[5]

new_treatment3<-new_treatment


bias3<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias3


##====================================

#bootstrap 3#
#sd 3#

#step 3: s=3#
s=3

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=3

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment31_sd<-var[1]
new_treatment32_sd<-var[2]
new_treatment33_sd<-var[3]
new_treatment34_sd<-var[4]
new_treatment35_sd<-var[5]

new_treatment3+2.825*var^0.5
new_treatment3-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper3<-c()
lower3<-c()
for(i in 1:5){
upper3[i]<-new_treatment3[i]-Quantile_upper[i]*(var[i]^0.5)
lower3[i]<-new_treatment3[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper3
lower3
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-3
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat3<-e_hat





#step 4: s=4#

s=4
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )




TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}




new_treatment41<-new_treatment[1]
new_treatment42<-new_treatment[2]
new_treatment43<-new_treatment[3]
new_treatment44<-new_treatment[4]
new_treatment45<-new_treatment[5]

new_treatment4<-new_treatment

bias4<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias4


##====================================

#bootstrap 4#
#sd 4#

#step 4: s=4#
s=4

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=4

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment41_sd<-var[1]
new_treatment42_sd<-var[2]
new_treatment43_sd<-var[3]
new_treatment44_sd<-var[4]
new_treatment45_sd<-var[5]

new_treatment4+2.825*var^0.5
new_treatment4-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])

R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper4<-c()
lower4<-c()
for(i in 1:5){
upper4[i]<-new_treatment4[i]-Quantile_upper[i]*(var[i]^0.5)
lower4[i]<-new_treatment4[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper4
lower4
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-4
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat4<-e_hat






#step 5: s=5#

s=5
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


new_treatment51<-new_treatment[1]
new_treatment52<-new_treatment[2]
new_treatment53<-new_treatment[3]
new_treatment54<-new_treatment[4]
new_treatment55<-new_treatment[5]

new_treatment5<-new_treatment

bias5<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias5


##====================================

#bootstrap 5#
#sd 5#

#step 5: s=5#
s=5

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=5

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment51_sd<-var[1]
new_treatment52_sd<-var[2]
new_treatment53_sd<-var[3]
new_treatment54_sd<-var[4]
new_treatment55_sd<-var[5]

new_treatment5+2.825*var^0.5
new_treatment5-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper5<-c()
lower5<-c()
for(i in 1:5){
upper5[i]<-new_treatment5[i]-Quantile_upper[i]*(var[i]^0.5)
lower5[i]<-new_treatment5[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper5
lower5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-5
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat5<-e_hat








#step 6: s=6#

s=6
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


new_treatment61<-new_treatment[1]
new_treatment62<-new_treatment[2]
new_treatment63<-new_treatment[3]
new_treatment64<-new_treatment[4]
new_treatment65<-new_treatment[5]

new_treatment6<-new_treatment

bias6<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias6


##====================================

#bootstrap 6#
#sd 6#

#step 6: s=6#
s=6

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=6

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment61_sd<-var[1]
new_treatment62_sd<-var[2]
new_treatment63_sd<-var[3]
new_treatment64_sd<-var[4]
new_treatment65_sd<-var[5]

new_treatment6+2.825*var^0.5
new_treatment6-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])

R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper6<-c()
lower6<-c()
for(i in 1:5){
upper6[i]<-new_treatment6[i]-Quantile_upper[i]*(var[i]^0.5)
lower6[i]<-new_treatment6[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper6
lower6
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-6
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat6<-e_hat










#step 7: s=7#

s=7
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


new_treatment71<-new_treatment[1]
new_treatment72<-new_treatment[2]
new_treatment73<-new_treatment[3]
new_treatment74<-new_treatment[4]
new_treatment75<-new_treatment[5]

new_treatment7<-new_treatment

bias7<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias7


##====================================

#bootstrap 7#
#sd 7#

#step 7: s=7#
s=7

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=7

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment71_sd<-var[1]
new_treatment72_sd<-var[2]
new_treatment73_sd<-var[3]
new_treatment74_sd<-var[4]
new_treatment75_sd<-var[5]

new_treatment7+2.825*var^0.5
new_treatment7-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper7<-c()
lower7<-c()
for(i in 1:5){
upper7[i]<-new_treatment7[i]-Quantile_upper[i]*(var[i]^0.5)
lower7[i]<-new_treatment7[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper7
lower7
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-7
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat7<-e_hat






#step 8: s=8#

s=8
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


new_treatment81<-new_treatment[1]
new_treatment82<-new_treatment[2]
new_treatment83<-new_treatment[3]
new_treatment84<-new_treatment[4]
new_treatment85<-new_treatment[5]

new_treatment8<-new_treatment

bias8<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias8


##====================================

#bootstrap 8#
#sd 8#

#step 8: s=8#
s=8

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=8

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment81_sd<-var[1]
new_treatment82_sd<-var[2]
new_treatment83_sd<-var[3]
new_treatment84_sd<-var[4]
new_treatment85_sd<-var[5]

new_treatment8+2.825*var^0.5
new_treatment8-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper8<-c()
lower8<-c()
for(i in 1:5){
upper8[i]<-new_treatment8[i]-Quantile_upper[i]*(var[i]^0.5)
lower8[i]<-new_treatment8[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper8
lower8
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-8
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat8<-e_hat






#step 9: s=9#

s=9
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


new_treatment91<-new_treatment[1]
new_treatment92<-new_treatment[2]
new_treatment93<-new_treatment[3]
new_treatment94<-new_treatment[4]
new_treatment95<-new_treatment[5]

new_treatment9<-new_treatment

bias9<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias9


##====================================

#bootstrap 9#
#sd 9#

#step 9: s=9#
s=9

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=9

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment91_sd<-var[1]
new_treatment92_sd<-var[2]
new_treatment93_sd<-var[3]
new_treatment94_sd<-var[4]
new_treatment95_sd<-var[5]

new_treatment9+2.825*var^0.5
new_treatment9-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper9<-c()
lower9<-c()
for(i in 1:5){
upper9[i]<-new_treatment9[i]-Quantile_upper[i]*(var[i]^0.5)
lower9[i]<-new_treatment9[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper9
lower9
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-9
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat9<-e_hat








#step 10: s=10#

s=10
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


new_treatment101<-new_treatment[1]
new_treatment102<-new_treatment[2]
new_treatment103<-new_treatment[3]
new_treatment104<-new_treatment[4]
new_treatment105<-new_treatment[5]

new_treatment10<-new_treatment

bias10<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias10


##====================================

#bootstrap 10#
#sd 10#

#step 10: s=10#
s=10

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=10

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment101_sd<-var[1]
new_treatment102_sd<-var[2]
new_treatment103_sd<-var[3]
new_treatment104_sd<-var[4]
new_treatment105_sd<-var[5]

new_treatment10+2.825*var^0.5
new_treatment10-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper10<-c()
lower10<-c()
for(i in 1:5){
upper10[i]<-new_treatment10[i]-Quantile_upper[i]*(var[i]^0.5)
lower10[i]<-new_treatment10[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper10
lower10
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-10
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat10<-e_hat







#step 11: s=11#

s=11
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment_11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment_11[is.na(new_treatment_11)]<-0
new_treatment_11

new_treatment[i]<-new_treatment_11

}


new_treatment111<-new_treatment[1]
new_treatment112<-new_treatment[2]
new_treatment113<-new_treatment[3]
new_treatment114<-new_treatment[4]
new_treatment115<-new_treatment[5]

new_treatment_11<-new_treatment

bias11<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias11


##====================================

#bootstrap 11#
#sd 11#

#step 11: s=11#
s=11

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=11

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment_<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment[i]<-new_treatment_

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment111_sd<-var[1]
new_treatment112_sd<-var[2]
new_treatment113_sd<-var[3]
new_treatment114_sd<-var[4]
new_treatment115_sd<-var[5]

new_treatment_11+2.825*var^0.5
new_treatment_11-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper11<-c()
lower11<-c()
for(i in 1:5){
upper11[i]<-new_treatment_11[i]-Quantile_upper[i]*(var[i]^0.5)
lower11[i]<-new_treatment_11[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper11
lower11
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-11
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat11<-e_hat





#step 12: s=12#

s=12
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment111,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment112,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment113,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment114,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment115,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment11<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment11[is.na(new_treatment11)]<-0
new_treatment11

new_treatment[i]<-new_treatment11

}


new_treatment121<-new_treatment[1]
new_treatment122<-new_treatment[2]
new_treatment123<-new_treatment[3]
new_treatment124<-new_treatment[4]
new_treatment125<-new_treatment[5]

new_treatment_12<-new_treatment

bias12<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias12


##====================================

#bootstrap 12#
#sd 12#

#step 12: s=12#
s=12

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=12

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment111,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment112,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment113,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment114,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment115,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment_<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment[i]<-new_treatment_

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment121_sd<-var[1]
new_treatment122_sd<-var[2]
new_treatment123_sd<-var[3]
new_treatment124_sd<-var[4]
new_treatment125_sd<-var[5]

new_treatment_12+2.825*var^0.5
new_treatment_12-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper12<-c()
lower12<-c()
for(i in 1:5){
upper12[i]<-new_treatment_12[i]-Quantile_upper[i]*(var[i]^0.5)
lower12[i]<-new_treatment_12[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper12
lower12
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-12
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat12<-e_hat





#step 13: s=13#

s=13
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],D1[T0+12],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],D2[T0+12],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],D3[T0+12],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],D4[T0+12],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],D5[T0+12],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment111,new_treatment121,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment112,new_treatment122,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment113,new_treatment123,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment114,new_treatment124,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment115,new_treatment125,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment_<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment[i]<-new_treatment_

}


new_treatment131<-new_treatment[1]
new_treatment132<-new_treatment[2]
new_treatment133<-new_treatment[3]
new_treatment134<-new_treatment[4]
new_treatment135<-new_treatment[5]

new_treatment_13<-new_treatment

bias13<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias13


##====================================

#bootstrap 13#
#sd 13#

#step 13: s=13#
s=13

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=13

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],D1[T0+12],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],D2[T0+12],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],D3[T0+12],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],D4[T0+12],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],D5[T0+12],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment111,new_treatment121,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment112,new_treatment122,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment113,new_treatment123,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment114,new_treatment124,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment115,new_treatment125,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment_<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment[i]<-new_treatment_

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment131_sd<-var[1]
new_treatment132_sd<-var[2]
new_treatment133_sd<-var[3]
new_treatment134_sd<-var[4]
new_treatment135_sd<-var[5]

new_treatment_13+2.825*var^0.5
new_treatment_13-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper13<-c()
lower13<-c()
for(i in 1:5){
upper13[i]<-new_treatment_13[i]-Quantile_upper[i]*(var[i]^0.5)
lower13[i]<-new_treatment_13[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper13
lower13
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-13
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat13<-e_hat






#step 14: s=14#

s=14
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],D1[T0+12],D1[T0+13],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],D2[T0+12],D2[T0+13],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],D3[T0+12],D3[T0+13],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],D4[T0+12],D4[T0+13],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],D5[T0+12],D5[T0+13],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment111,new_treatment121,new_treatment131,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment112,new_treatment122,new_treatment132,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment113,new_treatment123,new_treatment133,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment114,new_treatment124,new_treatment134,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment115,new_treatment125,new_treatment135,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment_<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment[i]<-new_treatment_

}


new_treatment141<-new_treatment[1]
new_treatment142<-new_treatment[2]
new_treatment143<-new_treatment[3]
new_treatment144<-new_treatment[4]
new_treatment145<-new_treatment[5]

new_treatment_14<-new_treatment

bias14<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias14


##====================================

#bootstrap 14#
#sd 14#

#step 14: s=14#
s=14

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){


T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=14

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],D1[T0+12],D1[T0+13],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],D2[T0+12],D2[T0+13],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],D3[T0+12],D3[T0+13],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],D4[T0+12],D4[T0+13],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],D5[T0+12],D5[T0+13],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment111,new_treatment121,new_treatment131,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment112,new_treatment122,new_treatment132,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment113,new_treatment123,new_treatment133,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment114,new_treatment124,new_treatment134,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment115,new_treatment125,new_treatment135,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment_<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment[i]<-new_treatment_

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment141_sd<-var[1]
new_treatment142_sd<-var[2]
new_treatment143_sd<-var[3]
new_treatment144_sd<-var[4]
new_treatment145_sd<-var[5]

new_treatment_14+2.825*var^0.5
new_treatment_14-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper14<-c()
lower14<-c()
for(i in 1:5){
upper14[i]<-new_treatment_14[i]-Quantile_upper[i]*(var[i]^0.5)
lower14[i]<-new_treatment_14[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper14
lower14
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-14
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat14<-e_hat





#step 15: s=15#

s=15
T0<-min(TT0)

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],D1[T0+12],D1[T0+13],D1[T0+14],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],D2[T0+12],D2[T0+13],D2[T0+14],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],D3[T0+12],D3[T0+13],D3[T0+14],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],D4[T0+12],D4[T0+13],D4[T0+14],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],D5[T0+12],D5[T0+13],D5[T0+14],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment111,new_treatment121,new_treatment131,new_treatment141,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment112,new_treatment122,new_treatment132,new_treatment142,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment113,new_treatment123,new_treatment133,new_treatment143,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment114,new_treatment124,new_treatment134,new_treatment144,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment115,new_treatment125,new_treatment135,new_treatment145,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )



TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1  #forward step#

DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
tt1<-c(t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)],t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)],t2[1:(T0+j)])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[1:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0
predict[is.na(predict)]<-0

new<-c( 
mean(predict[1,][T1:(T0+j)])-mean(predict[1,][1:T0]),
mean(predict[2,][T1:(T0+j)])-mean(predict[2,][1:T0]),
mean(predict[3,][T1:(T0+j)])-mean(predict[3,][1:T0]),
mean(predict[4,][T1:(T0+j)])-mean(predict[4,][1:T0]),
mean(predict[5,][T1:(T0+j)])-mean(predict[5,][1:T0]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-DDD
zz<-rbind(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(DD[i,][1:(T0+j)]*Y_t[i,])-sum(DD[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))* (( (T0+j)*sum(zz[i,][1:(T0+j)]*Y_t[i,])-sum(zz[i,][1:(T0+j)])*sum(Y_t[i,]) )/( (T0+j)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,],DDD[2,],DDD[3,],DDD[4,],DDD[5,])
yy<-c(yyy[1,],yyy[2,],yyy[3,],yyy[4,],yyy[5,])
zz<-c(z1[1:(T0+j)],z2[1:(T0+j)],z3[1:(T0+j)],z4[1:(T0+j)],z5[1:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j)),rep(2,(T0+j)),rep(3,(T0+j)),rep(4,(T0+j)),rep(5,(T0+j)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment_<-( (new[i]-coes[i,2]*(mean(Y_t[i,][T1:(T0+j)])-mean(Y_t[i,][1:T0]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment[i]<-new_treatment_

}


new_treatment151<-new_treatment[1]
new_treatment152<-new_treatment[2]
new_treatment153<-new_treatment[3]
new_treatment154<-new_treatment[4]
new_treatment155<-new_treatment[5]

new_treatment_15<-new_treatment

bias15<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment
bias15


##====================================

#bootstrap 15#
#sd 15#

#step 15: s=15#
s=15

SS<-c()
SSS<-c()
boot1<-list()
for (b in 1:100){

T0<-min(TT0)

S0<-sample(1:(T0-20),1)

s=15

SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],D1[T0+12],D1[T0+13],D1[T0+14],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],D2[T0+12],D2[T0+13],D2[T0+14],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],D3[T0+12],D3[T0+13],D3[T0+14],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],D4[T0+12],D4[T0+13],D4[T0+14],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],D5[T0+12],D5[T0+13],D5[T0+14],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),new_treatment11,new_treatment21,new_treatment31,new_treatment41,new_treatment51,new_treatment61,new_treatment71,new_treatment81,new_treatment91,new_treatment101,new_treatment111,new_treatment121,new_treatment131,new_treatment141,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),new_treatment12,new_treatment22,new_treatment32,new_treatment42,new_treatment52,new_treatment62,new_treatment72,new_treatment82,new_treatment92,new_treatment102,new_treatment112,new_treatment122,new_treatment132,new_treatment142,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),new_treatment13,new_treatment23,new_treatment33,new_treatment43,new_treatment53,new_treatment63,new_treatment73,new_treatment83,new_treatment93,new_treatment103,new_treatment113,new_treatment123,new_treatment133,new_treatment143,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),new_treatment14,new_treatment24,new_treatment34,new_treatment44,new_treatment54,new_treatment64,new_treatment74,new_treatment84,new_treatment94,new_treatment104,new_treatment114,new_treatment124,new_treatment134,new_treatment144,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),new_treatment15,new_treatment25,new_treatment35,new_treatment45,new_treatment55,new_treatment65,new_treatment75,new_treatment85,new_treatment95,new_treatment105,new_treatment115,new_treatment125,new_treatment135,new_treatment145,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1


j=1

DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
tt1<-c(t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)],t1[S0:(T0+j)])
tt2<-c(t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)],t2[S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data<-data.frame(yy,DD,tt1,tt2,zz,abb,year)

library(plm)

a_x<-2*(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])               
a_y<-2*(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,2])
            
                                                                            
b_x<-(pvcm(DD~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3])                
b_y<-(pvcm(yy~tt2+tt1,data=data,index=c("abb","year"),model="within")$coefficients[,3]) 
  
A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

tt1<-t1[S0:(T0+j)]
x_t<-rbind(2*(a_x[1])*tt1+b_x[1],2*(a_x[2])*tt1+b_x[2],2*(a_x[3])*tt1+b_x[3],2*(a_x[4])*tt1+b_x[4],2*(a_x[5])*tt1+b_x[5])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )

Y_t[is.nan(Y_t)]<-0

abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_1<-data.frame(yy,Y_t,abb,year)

coe<-coefficients(pvcm(yy~Y_t,data=data_1,index=c("abb"),model="within"))

predict<-rbind(
coe[1,1]+coe[1,2]*(a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],
coe[2,1]+coe[2,2]*(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
coe[3,1]+coe[3,2]*(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],
coe[4,1]+coe[4,2]*(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
coe[5,1]+coe[5,2]*(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5] )

predict[is.nan(predict)]<-0

new<-c( 
mean(predict[1,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[1,][1:(T0-S0+1)]),
mean(predict[2,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[2,][1:(T0-S0+1)]),
mean(predict[3,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[3,][1:(T0-S0+1)]),
mean(predict[4,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[4,][1:(T0-S0+1)]),
mean(predict[5,][(T0-S0+2):(T0-S0+1+j)])-mean(predict[5,][1:(T0-S0+1)]) )


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])

Y_t[is.nan(Y_t)]<-0

DD<-rbind(D1[S0:(T0+j)],D2[S0:(T0+j)],D3[S0:(T0+j)],D4[S0:(T0+j)],D5[S0:(T0+j)])
zz<-rbind(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])

a1<-c()
for(i in 1:5){
a1[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD[i,]*Y_t[i,])-sum(DD[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a1[is.nan(a1)]<-0

a3<-c()
for(i in 1:5){
a3[i]<-  (mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz[i,]*Y_t[i,])-sum(zz[i,])*sum(Y_t[i,]) )/( (T0+j-S0+1)*sum(Y_t[i,]*Y_t[i,])-sum(Y_t[i,])*sum(Y_t[i,]) ))
}

a3[is.nan(a3)]<-0


DD<-c(DDD[1,][S0:(T0+j)],DDD[2,][S0:(T0+j)],DDD[3,][S0:(T0+j)],DDD[4,][S0:(T0+j)],DDD[5,][S0:(T0+j)])
yy<-c(yyy[1,][S0:(T0+j)],yyy[2,][S0:(T0+j)],yyy[3,][S0:(T0+j)],yyy[4,][S0:(T0+j)],yyy[5,][S0:(T0+j)])
zz<-c(z1[S0:(T0+j)],z2[S0:(T0+j)],z3[S0:(T0+j)],z4[S0:(T0+j)],z5[S0:(T0+j)])
Y_t<-as.numeric( c((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5]) )
Y_t[is.nan(Y_t)]<-0
abb<-c(rep(1,(T0+j-S0+1)),rep(2,(T0+j-S0+1)),rep(3,(T0+j-S0+1)),rep(4,(T0+j-S0+1)),rep(5,(T0+j-S0+1)))
year<-tt1
data_final<-data.frame(yy,DD,zz,Y_t,abb,year)
 
coes<-coefficients(pvcm(yy~Y_t+zz+DD,data=data_final,index=c("abb"),model="within"))


Y_t<-rbind((a_y[1]*x_t[1,]+a_x[1]*b_y[1]-a_y[1]*b_x[1])/a_x[1],(a_y[2]*x_t[2,]+a_x[2]*b_y[2]-a_y[2]*b_x[2])/a_x[2],
(a_y[3]*x_t[3,]+a_x[3]*b_y[3]-a_y[3]*b_x[3])/a_x[3],(a_y[4]*x_t[4,]+a_x[4]*b_y[4]-a_y[4]*b_x[4])/a_x[4],
(a_y[5]*x_t[5,]+a_x[5]*b_y[5]-a_y[5]*b_x[5])/a_x[5])
Y_t[is.nan(Y_t)]<-0

new_treatment<-c()
for (i in 1:5){
new_treatment_<-( (new[i]-coes[i,2]*(mean(Y_t[i,][(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[i,][1:(T0-S0+1)]))-a3[i]*coes[i,3] )/a1[i] )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment[i]<-new_treatment_

}


boot1[b]<-list(new_treatment)

}

boot<-data.frame(boot1)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

new_treatment151_sd<-var[1]
new_treatment152_sd<-var[2]
new_treatment153_sd<-var[3]
new_treatment154_sd<-var[4]
new_treatment155_sd<-var[5]

new_treatment_15+2.825*var^0.5
new_treatment_15-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper15<-c()
lower15<-c()
for(i in 1:5){
upper15[i]<-new_treatment_15[i]-Quantile_upper[i]*(var[i]^0.5)
lower15[i]<-new_treatment_15[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper15
lower15
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-15
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat15<-e_hat






ee_hat<-list(e_hat1+1,e_hat2+1,e_hat3+1,e_hat4+1,e_hat5+1,e_hat6+1,e_hat7+1,e_hat8+1,e_hat9+1,e_hat10+1,e_hat11+1,e_hat12+1,e_hat13+1,e_hat14+1,e_hat15+1)
ee_hat<-data.frame(ee_hat)



upper_total<-list(upper1,upper2,upper3,upper4,upper5,upper6,upper7,upper8,upper9,upper10,upper11,upper12,upper13,upper14,upper15)
lower_total<-list(lower1,lower2,lower3,lower4,lower5,lower6,lower7,lower8,lower9,lower10,lower11,lower12,lower13,lower14,lower15)
upper_total<-data.frame(upper_total)
lower_total<-data.frame(lower_total)


tr<-rbind(tr1,tr2,tr3,tr4,tr5)
D<-rbind(D1,D2,D3,D4,D5)

cr_new_1<-as.numeric(ifelse(  (lower_total[1,]-ee_hat[1,])<=(tr[1,]*D[1,])[(min(TT0)+1):(min(TT0)+15)]&(tr[1,]*D[1,])[(min(TT0)+1):(min(TT0)+15)]<= (upper_total[1,]+ee_hat[1,]) ,1,0  ))
cr_new_2<-as.numeric(ifelse(  (lower_total[2,]-ee_hat[2,])<=(tr[2,]*D[2,])[(min(TT0)+1):(min(TT0)+15)]&(tr[2,]*D[2,])[(min(TT0)+1):(min(TT0)+15)]<= (upper_total[2,]+ee_hat[2,]) ,1,0  ))
cr_new_3<-as.numeric(ifelse(  (lower_total[3,]-ee_hat[3,])<=(tr[3,]*D[3,])[(min(TT0)+1):(min(TT0)+15)]&(tr[3,]*D[3,])[(min(TT0)+1):(min(TT0)+15)]<= (upper_total[3,]+ee_hat[3,]) ,1,0  ))
cr_new_4<-as.numeric(ifelse(  (lower_total[4,]-ee_hat[4,])<=(tr[4,]*D[4,])[(min(TT0)+1):(min(TT0)+15)]&(tr[4,]*D[4,])[(min(TT0)+1):(min(TT0)+15)]<= (upper_total[4,]+ee_hat[4,]) ,1,0  ))
cr_new_5<-as.numeric(ifelse(  (lower_total[5,]-ee_hat[5,])<=(tr[5,]*D[5,])[(min(TT0)+1):(min(TT0)+15)]&(tr[5,]*D[5,])[(min(TT0)+1):(min(TT0)+15)]<= (upper_total[5,]+ee_hat[5,]) ,1,0  ))

cr_new<-c(cr_new_1,cr_new_2,cr_new_3,cr_new_4,cr_new_5)


cr_new_mean1<-mean(c( sum(cr_new_1[1]==1)/length(cr_new_1[1]),sum(cr_new_2[1]==1)/length(cr_new_2[1]),sum(cr_new_3[1]==1)/length(cr_new_3[1]),sum(cr_new_4[1]==1)/length(cr_new_4[1]),sum(cr_new_5[1]==1)/length(cr_new_5[1]) ))
cr_new_mean2<-mean(c( sum(cr_new_1[1:2]==1)/length(cr_new_1[1:2]),sum(cr_new_2[1:2]==1)/length(cr_new_2[1:2]),sum(cr_new_3[1:2]==1)/length(cr_new_3[1:2]),sum(cr_new_4[1:2]==1)/length(cr_new_4[1:2]),sum(cr_new_5[1:2]==1)/length(cr_new_5[1:2]) ))
cr_new_mean3<-mean(c( sum(cr_new_1[1:3]==1)/length(cr_new_1[1:3]),sum(cr_new_2[1:3]==1)/length(cr_new_2[1:3]),sum(cr_new_3[1:3]==1)/length(cr_new_3[1:3]),sum(cr_new_4[1:3]==1)/length(cr_new_4[1:3]),sum(cr_new_5[1:3]==1)/length(cr_new_5[1:3]) ))
cr_new_mean4<-mean(c( sum(cr_new_1[1:4]==1)/length(cr_new_1[1:4]),sum(cr_new_2[1:4]==1)/length(cr_new_2[1:4]),sum(cr_new_3[1:4]==1)/length(cr_new_3[1:4]),sum(cr_new_4[1:4]==1)/length(cr_new_4[1:4]),sum(cr_new_5[1:4]==1)/length(cr_new_5[1:4]) ))
cr_new_mean5<-mean(c( sum(cr_new_1[1:5]==1)/length(cr_new_1[1:5]),sum(cr_new_2[1:5]==1)/length(cr_new_2[1:5]),sum(cr_new_3[1:5]==1)/length(cr_new_3[1:5]),sum(cr_new_4[1:5]==1)/length(cr_new_4[1:5]),sum(cr_new_5[1:5]==1)/length(cr_new_5[1:5]) ))
cr_new_mean6<-mean(c( sum(cr_new_1[1:6]==1)/length(cr_new_1[1:6]),sum(cr_new_2[1:6]==1)/length(cr_new_2[1:6]),sum(cr_new_3[1:6]==1)/length(cr_new_3[1:6]),sum(cr_new_4[1:6]==1)/length(cr_new_4[1:6]),sum(cr_new_5[1:6]==1)/length(cr_new_5[1:6]) ))
cr_new_mean7<-mean(c( sum(cr_new_1[1:7]==1)/length(cr_new_1[1:7]),sum(cr_new_2[1:7]==1)/length(cr_new_2[1:7]),sum(cr_new_3[1:7]==1)/length(cr_new_3[1:7]),sum(cr_new_4[1:7]==1)/length(cr_new_4[1:7]),sum(cr_new_5[1:7]==1)/length(cr_new_5[1:7]) ))
cr_new_mean8<-mean(c( sum(cr_new_1[1:8]==1)/length(cr_new_1[1:8]),sum(cr_new_2[1:8]==1)/length(cr_new_2[1:8]),sum(cr_new_3[1:8]==1)/length(cr_new_3[1:8]),sum(cr_new_4[1:8]==1)/length(cr_new_4[1:8]),sum(cr_new_5[1:8]==1)/length(cr_new_5[1:8]) ))
cr_new_mean9<-mean(c( sum(cr_new_1[1:9]==1)/length(cr_new_1[1:9]),sum(cr_new_2[1:9]==1)/length(cr_new_2[1:9]),sum(cr_new_3[1:9]==1)/length(cr_new_3[1:9]),sum(cr_new_4[1:9]==1)/length(cr_new_4[1:9]),sum(cr_new_5[1:9]==1)/length(cr_new_5[1:9]) ))
cr_new_mean10<-mean(c( sum(cr_new_1[1:10]==1)/length(cr_new_1[1:10]),sum(cr_new_2[1:10]==1)/length(cr_new_2[1:10]),sum(cr_new_3[1:10]==1)/length(cr_new_3[1:10]),sum(cr_new_4[1:10]==1)/length(cr_new_4[1:10]),sum(cr_new_5[1:10]==1)/length(cr_new_5[1:10]) ))
cr_new_mean11<-mean(c( sum(cr_new_1[1:11]==1)/length(cr_new_1[1:11]),sum(cr_new_2[1:11]==1)/length(cr_new_2[1:11]),sum(cr_new_3[1:11]==1)/length(cr_new_3[1:11]),sum(cr_new_4[1:11]==1)/length(cr_new_4[1:11]),sum(cr_new_5[1:11]==1)/length(cr_new_5[1:11]) ))
cr_new_mean12<-mean(c( sum(cr_new_1[1:12]==1)/length(cr_new_1[1:12]),sum(cr_new_2[1:12]==1)/length(cr_new_2[1:12]),sum(cr_new_3[1:12]==1)/length(cr_new_3[1:12]),sum(cr_new_4[1:12]==1)/length(cr_new_4[1:12]),sum(cr_new_5[1:12]==1)/length(cr_new_5[1:12]) ))
cr_new_mean13<-mean(c( sum(cr_new_1[1:13]==1)/length(cr_new_1[1:13]),sum(cr_new_2[1:13]==1)/length(cr_new_2[1:13]),sum(cr_new_3[1:13]==1)/length(cr_new_3[1:13]),sum(cr_new_4[1:13]==1)/length(cr_new_4[1:13]),sum(cr_new_5[1:13]==1)/length(cr_new_5[1:13]) ))
cr_new_mean14<-mean(c( sum(cr_new_1[1:14]==1)/length(cr_new_1[1:14]),sum(cr_new_2[1:14]==1)/length(cr_new_2[1:14]),sum(cr_new_3[1:14]==1)/length(cr_new_3[1:14]),sum(cr_new_4[1:14]==1)/length(cr_new_4[1:14]),sum(cr_new_5[1:14]==1)/length(cr_new_5[1:14]) ))
cr_new_mean15<-mean(c( sum(cr_new_1[1:15]==1)/length(cr_new_1[1:15]),sum(cr_new_2[1:15]==1)/length(cr_new_2[1:15]),sum(cr_new_3[1:15]==1)/length(cr_new_3[1:15]),sum(cr_new_4[1:15]==1)/length(cr_new_4[1:15]),sum(cr_new_5[1:15]==1)/length(cr_new_5[1:15]) ))


cr_new_mean<-c(cr_new_mean1,cr_new_mean2,cr_new_mean3,cr_new_mean4,cr_new_mean5,cr_new_mean6,cr_new_mean7,cr_new_mean8,cr_new_mean9,cr_new_mean10,cr_new_mean11,cr_new_mean12,cr_new_mean13,cr_new_mean14,cr_new_mean15)

plot(cr_new_mean,pch="")
lines(cr_new_mean,lwd=5,col="red")
abline(v=6,lty=3)


cr_new_CI<-cr_new







#sharp bound#

total<-list(new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment_11,new_treatment_12,new_treatment_13,new_treatment_14,new_treatment_15)
total<-data.frame(total)


cr_new_1<-as.numeric(ifelse(  (total[1,]-ee_hat[1,])<=(tr[1,]*D[1,])[(min(TT0)+1):(min(TT0)+15)]&(tr[1,]*D[1,])[(min(TT0)+1):(min(TT0)+15)]<= (total[1,]+ee_hat[1,]) ,1,0  ))
cr_new_2<-as.numeric(ifelse(  (total[2,]-ee_hat[2,])<=(tr[2,]*D[2,])[(min(TT0)+1):(min(TT0)+15)]&(tr[2,]*D[2,])[(min(TT0)+1):(min(TT0)+15)]<= (total[2,]+ee_hat[2,]) ,1,0  ))
cr_new_3<-as.numeric(ifelse(  (total[3,]-ee_hat[3,])<=(tr[3,]*D[3,])[(min(TT0)+1):(min(TT0)+15)]&(tr[3,]*D[3,])[(min(TT0)+1):(min(TT0)+15)]<= (total[3,]+ee_hat[3,]) ,1,0  ))
cr_new_4<-as.numeric(ifelse(  (total[4,]-ee_hat[4,])<=(tr[4,]*D[4,])[(min(TT0)+1):(min(TT0)+15)]&(tr[4,]*D[4,])[(min(TT0)+1):(min(TT0)+15)]<= (total[4,]+ee_hat[4,]) ,1,0  ))
cr_new_5<-as.numeric(ifelse(  (total[5,]-ee_hat[5,])<=(tr[5,]*D[5,])[(min(TT0)+1):(min(TT0)+15)]&(tr[5,]*D[5,])[(min(TT0)+1):(min(TT0)+15)]<= (total[5,]+ee_hat[5,]) ,1,0  ))


cr_new<-c(cr_new_1,cr_new_2,cr_new_3,cr_new_4,cr_new_5)




cr_new_mean1<-mean(c( sum(cr_new_1[1]==1)/length(cr_new_1[1]),sum(cr_new_2[1]==1)/length(cr_new_2[1]),sum(cr_new_3[1]==1)/length(cr_new_3[1]),sum(cr_new_4[1]==1)/length(cr_new_4[1]),sum(cr_new_5[1]==1)/length(cr_new_5[1]) ))
cr_new_mean2<-mean(c( sum(cr_new_1[1:2]==1)/length(cr_new_1[1:2]),sum(cr_new_2[1:2]==1)/length(cr_new_2[1:2]),sum(cr_new_3[1:2]==1)/length(cr_new_3[1:2]),sum(cr_new_4[1:2]==1)/length(cr_new_4[1:2]),sum(cr_new_5[1:2]==1)/length(cr_new_5[1:2]) ))
cr_new_mean3<-mean(c( sum(cr_new_1[1:3]==1)/length(cr_new_1[1:3]),sum(cr_new_2[1:3]==1)/length(cr_new_2[1:3]),sum(cr_new_3[1:3]==1)/length(cr_new_3[1:3]),sum(cr_new_4[1:3]==1)/length(cr_new_4[1:3]),sum(cr_new_5[1:3]==1)/length(cr_new_5[1:3]) ))
cr_new_mean4<-mean(c( sum(cr_new_1[1:4]==1)/length(cr_new_1[1:4]),sum(cr_new_2[1:4]==1)/length(cr_new_2[1:4]),sum(cr_new_3[1:4]==1)/length(cr_new_3[1:4]),sum(cr_new_4[1:4]==1)/length(cr_new_4[1:4]),sum(cr_new_5[1:4]==1)/length(cr_new_5[1:4]) ))
cr_new_mean5<-mean(c( sum(cr_new_1[1:5]==1)/length(cr_new_1[1:5]),sum(cr_new_2[1:5]==1)/length(cr_new_2[1:5]),sum(cr_new_3[1:5]==1)/length(cr_new_3[1:5]),sum(cr_new_4[1:5]==1)/length(cr_new_4[1:5]),sum(cr_new_5[1:5]==1)/length(cr_new_5[1:5]) ))
cr_new_mean6<-mean(c( sum(cr_new_1[1:6]==1)/length(cr_new_1[1:6]),sum(cr_new_2[1:6]==1)/length(cr_new_2[1:6]),sum(cr_new_3[1:6]==1)/length(cr_new_3[1:6]),sum(cr_new_4[1:6]==1)/length(cr_new_4[1:6]),sum(cr_new_5[1:6]==1)/length(cr_new_5[1:6]) ))
cr_new_mean7<-mean(c( sum(cr_new_1[1:7]==1)/length(cr_new_1[1:7]),sum(cr_new_2[1:7]==1)/length(cr_new_2[1:7]),sum(cr_new_3[1:7]==1)/length(cr_new_3[1:7]),sum(cr_new_4[1:7]==1)/length(cr_new_4[1:7]),sum(cr_new_5[1:7]==1)/length(cr_new_5[1:7]) ))
cr_new_mean8<-mean(c( sum(cr_new_1[1:8]==1)/length(cr_new_1[1:8]),sum(cr_new_2[1:8]==1)/length(cr_new_2[1:8]),sum(cr_new_3[1:8]==1)/length(cr_new_3[1:8]),sum(cr_new_4[1:8]==1)/length(cr_new_4[1:8]),sum(cr_new_5[1:8]==1)/length(cr_new_5[1:8]) ))
cr_new_mean9<-mean(c( sum(cr_new_1[1:9]==1)/length(cr_new_1[1:9]),sum(cr_new_2[1:9]==1)/length(cr_new_2[1:9]),sum(cr_new_3[1:9]==1)/length(cr_new_3[1:9]),sum(cr_new_4[1:9]==1)/length(cr_new_4[1:9]),sum(cr_new_5[1:9]==1)/length(cr_new_5[1:9]) ))
cr_new_mean10<-mean(c( sum(cr_new_1[1:10]==1)/length(cr_new_1[1:10]),sum(cr_new_2[1:10]==1)/length(cr_new_2[1:10]),sum(cr_new_3[1:10]==1)/length(cr_new_3[1:10]),sum(cr_new_4[1:10]==1)/length(cr_new_4[1:10]),sum(cr_new_5[1:10]==1)/length(cr_new_5[1:10]) ))
cr_new_mean11<-mean(c( sum(cr_new_1[1:11]==1)/length(cr_new_1[1:11]),sum(cr_new_2[1:11]==1)/length(cr_new_2[1:11]),sum(cr_new_3[1:11]==1)/length(cr_new_3[1:11]),sum(cr_new_4[1:11]==1)/length(cr_new_4[1:11]),sum(cr_new_5[1:11]==1)/length(cr_new_5[1:11]) ))
cr_new_mean12<-mean(c( sum(cr_new_1[1:12]==1)/length(cr_new_1[1:12]),sum(cr_new_2[1:12]==1)/length(cr_new_2[1:12]),sum(cr_new_3[1:12]==1)/length(cr_new_3[1:12]),sum(cr_new_4[1:12]==1)/length(cr_new_4[1:12]),sum(cr_new_5[1:12]==1)/length(cr_new_5[1:12]) ))
cr_new_mean13<-mean(c( sum(cr_new_1[1:13]==1)/length(cr_new_1[1:13]),sum(cr_new_2[1:13]==1)/length(cr_new_2[1:13]),sum(cr_new_3[1:13]==1)/length(cr_new_3[1:13]),sum(cr_new_4[1:13]==1)/length(cr_new_4[1:13]),sum(cr_new_5[1:13]==1)/length(cr_new_5[1:13]) ))
cr_new_mean14<-mean(c( sum(cr_new_1[1:14]==1)/length(cr_new_1[1:14]),sum(cr_new_2[1:14]==1)/length(cr_new_2[1:14]),sum(cr_new_3[1:14]==1)/length(cr_new_3[1:14]),sum(cr_new_4[1:14]==1)/length(cr_new_4[1:14]),sum(cr_new_5[1:14]==1)/length(cr_new_5[1:14]) ))
cr_new_mean15<-mean(c( sum(cr_new_1[1:15]==1)/length(cr_new_1[1:15]),sum(cr_new_2[1:15]==1)/length(cr_new_2[1:15]),sum(cr_new_3[1:15]==1)/length(cr_new_3[1:15]),sum(cr_new_4[1:15]==1)/length(cr_new_4[1:15]),sum(cr_new_5[1:15]==1)/length(cr_new_5[1:15]) ))


cr_new_mean<-c(cr_new_mean1,cr_new_mean2,cr_new_mean3,cr_new_mean4,cr_new_mean5,cr_new_mean6,cr_new_mean7,cr_new_mean8,cr_new_mean9,cr_new_mean10,cr_new_mean11,cr_new_mean12,cr_new_mean13,cr_new_mean14,cr_new_mean15)

plot(cr_new_mean,pch="")
lines(cr_new_mean,lwd=5,col="red")
abline(v=6,lty=3)



cr_new_SB<-cr_new
























#===============================================================================================================================================
#===============================================================================================================================================
  

TT0<-c( sum(D1==0),sum(D2==0),sum(D3==0),sum(D4==0),sum(D5==0) )
TT1<-c( sum(D1==0)+1,sum(D2==0)+1,sum(D3==0)+1,sum(D4==0)+1,sum(D5==0)+1 )    #treatment date#



T0<-min(TT0)
T1<-min(TT0)+1
  

#step 1: j=1#

j=1

#new method#
new_treatment2<-c()
for (i in 1:5){


t1<-sort(sample(300:800,500))
t2<-t1^2

DD<-D[i,][1:(T0+j)]
yy<-y[i,][1:(T0+j)]
tt1<-t1[1:(T0+j)]
tt2<-t2[1:(T0+j)]
zz<-z[i,][1:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}

old_treatment11<-new_treatment2[1]
old_treatment12<-new_treatment2[2]
old_treatment13<-new_treatment2[3]
old_treatment14<-new_treatment2[4]
old_treatment15<-new_treatment2[5]

bias1<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias1

old_treatment1<-new_treatment2


##====================================

#bootstrap 1#
#sd 1#

#step 1: s=1#
s=1

T0<-min(TT0)
T1<-min(TT0)+1

SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)


j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment11_sd<-var[1]
old_treatment12_sd<-var[2]
old_treatment13_sd<-var[3]
old_treatment14_sd<-var[4]
old_treatment15_sd<-var[5]

old_treatment1+2.825*var^0.5
old_treatment1-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper1<-c()
lower1<-c()
for(i in 1:5){
upper1[i]<-old_treatment1[i]-Quantile_upper[i]*(var[i]^0.5)
lower1[i]<-old_treatment1[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper1
lower1
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-1
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old1<-e_hat








 
#step 2: s=2#

T0<-min(TT0)

s=2

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


old_treatment21<-new_treatment2[1]
old_treatment22<-new_treatment2[2]
old_treatment23<-new_treatment2[3]
old_treatment24<-new_treatment2[4]
old_treatment25<-new_treatment2[5]


bias2<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias2

old_treatment2<-new_treatment2


##====================================

#bootstrap 2#
#sd 2#

#step 2: s=2#
s=2

T0<-min(TT0)
T1<-min(TT0)+1


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

s=2


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment21_sd<-var[1]
old_treatment22_sd<-var[2]
old_treatment23_sd<-var[3]
old_treatment24_sd<-var[4]
old_treatment25_sd<-var[5]

old_treatment2+2.825*var^0.5
old_treatment2-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper2<-c()
lower2<-c()
for(i in 1:5){
upper2[i]<-old_treatment2[i]-Quantile_upper[i]*(var[i]^0.5)
lower2[i]<-old_treatment2[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper2
lower2
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-2
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old2<-e_hat




 
#step 3: s=3#

T0<-min(TT0)

s=3

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


old_treatment31<-new_treatment2[1]
old_treatment32<-new_treatment2[2]
old_treatment33<-new_treatment2[3]
old_treatment34<-new_treatment2[4]
old_treatment35<-new_treatment2[5]

bias3<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias3

old_treatment3<-new_treatment2


##====================================

#bootstrap 3#
#sd 3#

#step 3: s=3#
s=3

T0<-min(TT0)
T1<-min(TT0)+1


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1

S0<-sample(1:(T0-20),1)

s=3


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment31_sd<-var[1]
old_treatment32_sd<-var[2]
old_treatment33_sd<-var[3]
old_treatment34_sd<-var[4]
old_treatment35_sd<-var[5]

old_treatment3+2.825*var^0.5
old_treatment3-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper3<-c()
lower3<-c()
for(i in 1:5){
upper3[i]<-old_treatment3[i]-Quantile_upper[i]*(var[i]^0.5)
lower3[i]<-old_treatment3[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper3
lower3
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-3
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old3<-e_hat






 
#step 4: s=4#

T0<-min(TT0)

s=4

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


old_treatment41<-new_treatment2[1]
old_treatment42<-new_treatment2[2]
old_treatment43<-new_treatment2[3]
old_treatment44<-new_treatment2[4]
old_treatment45<-new_treatment2[5]

bias4<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias4

old_treatment4<-new_treatment2


##====================================

#bootstrap 4#
#sd 4#

#step 4: s=4#
s=4

T0<-min(TT0)
T1<-min(TT0)+1


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

s=4


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment41_sd<-var[1]
old_treatment42_sd<-var[2]
old_treatment43_sd<-var[3]
old_treatment44_sd<-var[4]
old_treatment45_sd<-var[5]

old_treatment4+2.825*var^0.5
old_treatment4-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper4<-c()
lower4<-c()
for(i in 1:5){
upper4[i]<-old_treatment4[i]-Quantile_upper[i]*(var[i]^0.5)
lower4[i]<-old_treatment4[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper4
lower4
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-4
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old4<-e_hat





 
#step 5: s=5#

T0<-min(TT0)

s=5

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


old_treatment51<-new_treatment2[1]
old_treatment52<-new_treatment2[2]
old_treatment53<-new_treatment2[3]
old_treatment54<-new_treatment2[4]
old_treatment55<-new_treatment2[5]

bias5<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias5


old_treatment5<-new_treatment2


##====================================

#bootstrap 5#
#sd 5#

#step 5: s=5#
s=5

T0<-min(TT0)
T1<-min(TT0)+1


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){

T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

s=5


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment51_sd<-var[1]
old_treatment52_sd<-var[2]
old_treatment53_sd<-var[3]
old_treatment54_sd<-var[4]
old_treatment55_sd<-var[5]

old_treatment5+2.825*var^0.5
old_treatment5-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper5<-c()
lower5<-c()
for(i in 1:5){
upper5[i]<-old_treatment5[i]-Quantile_upper[i]*(var[i]^0.5)
lower5[i]<-old_treatment5[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper5
lower5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-5
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old5<-e_hat






 
#step 6: s=6#

T0<-min(TT0)

s=6

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


old_treatment61<-new_treatment2[1]
old_treatment62<-new_treatment2[2]
old_treatment63<-new_treatment2[3]
old_treatment64<-new_treatment2[4]
old_treatment65<-new_treatment2[5]

bias6<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias6


old_treatment6<-new_treatment2


##====================================

#bootstrap 6#
#sd 6#

#step 6: s=6#
s=6

T0<-min(TT0)
T1<-min(TT0)+1


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

s=6


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment61_sd<-var[1]
old_treatment62_sd<-var[2]
old_treatment63_sd<-var[3]
old_treatment64_sd<-var[4]
old_treatment65_sd<-var[5]

old_treatment6+2.825*var^0.5
old_treatment6-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper6<-c()
lower6<-c()
for(i in 1:5){
upper6[i]<-old_treatment6[i]-Quantile_upper[i]*(var[i]^0.5)
lower6[i]<-old_treatment6[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper6
lower6
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-6
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old6<-e_hat






 
#step 7: s=7#

T0<-min(TT0)

s=7

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


old_treatment71<-new_treatment2[1]
old_treatment72<-new_treatment2[2]
old_treatment73<-new_treatment2[3]
old_treatment74<-new_treatment2[4]
old_treatment75<-new_treatment2[5]

bias7<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias7


old_treatment7<-new_treatment2


##====================================

#bootstrap 7#
#sd 7#

#step 7: s=7#
s=7

T0<-min(TT0)
T1<-min(TT0)+1


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

s=7


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment71_sd<-var[1]
old_treatment72_sd<-var[2]
old_treatment73_sd<-var[3]
old_treatment74_sd<-var[4]
old_treatment75_sd<-var[5]

old_treatment7+2.825*var^0.5
old_treatment7-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper7<-c()
lower7<-c()
for(i in 1:5){
upper7[i]<-old_treatment7[i]-Quantile_upper[i]*(var[i]^0.5)
lower7[i]<-old_treatment7[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper7
lower7
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-7
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old7<-e_hat





 
#step 8: s=8#

T0<-min(TT0)

s=8

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


old_treatment81<-new_treatment2[1]
old_treatment82<-new_treatment2[2]
old_treatment83<-new_treatment2[3]
old_treatment84<-new_treatment2[4]
old_treatment85<-new_treatment2[5]

bias8<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias8

old_treatment8<-new_treatment2


##====================================

#bootstrap 8#
#sd 8#

#step 8: s=8#
s=8

T0<-min(TT0)
T1<-min(TT0)+1


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

s=8


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment81_sd<-var[1]
old_treatment82_sd<-var[2]
old_treatment83_sd<-var[3]
old_treatment84_sd<-var[4]
old_treatment85_sd<-var[5]

old_treatment8+2.825*var^0.5
old_treatment8-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper8<-c()
lower8<-c()
for(i in 1:5){
upper8[i]<-old_treatment8[i]-Quantile_upper[i]*(var[i]^0.5)
lower8[i]<-old_treatment8[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper8
lower8
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-8
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old8<-e_hat







 
#step 9: s=9#

T0<-min(TT0)

s=9

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


old_treatment91<-new_treatment2[1]
old_treatment92<-new_treatment2[2]
old_treatment93<-new_treatment2[3]
old_treatment94<-new_treatment2[4]
old_treatment95<-new_treatment2[5]

bias9<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias9

old_treatment9<-new_treatment2


##====================================

#bootstrap 9#
#sd 9#

#step 9: s=9#
s=9


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

s=9


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment91_sd<-var[1]
old_treatment92_sd<-var[2]
old_treatment93_sd<-var[3]
old_treatment94_sd<-var[4]
old_treatment95_sd<-var[5]

old_treatment9+2.825*var^0.5
old_treatment9-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper9<-c()
lower9<-c()
for(i in 1:5){
upper9[i]<-old_treatment9[i]-Quantile_upper[i]*(var[i]^0.5)
lower9[i]<-old_treatment9[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper9
lower9
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-9
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old9<-e_hat






 
#step 10: s=10#

T0<-min(TT0)

s=10

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,old_treatment91,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,old_treatment92,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,old_treatment93,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,old_treatment94,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,old_treatment95,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


old_treatment101<-new_treatment2[1]
old_treatment102<-new_treatment2[2]
old_treatment103<-new_treatment2[3]
old_treatment104<-new_treatment2[4]
old_treatment105<-new_treatment2[5]

bias10<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias10

old_treatment10<-new_treatment2


##====================================

#bootstrap 10#
#sd 10#

#step 10: s=10#
s=10


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

s=10


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,old_treatment91,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,old_treatment92,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,old_treatment93,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,old_treatment94,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,old_treatment95,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment22<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment22[is.na(new_treatment22)]<-0
new_treatment22

new_treatment2[i]<-new_treatment22

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment101_sd<-var[1]
old_treatment102_sd<-var[2]
old_treatment103_sd<-var[3]
old_treatment104_sd<-var[4]
old_treatment105_sd<-var[5]

old_treatment10+2.825*var^0.5
old_treatment10-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper10<-c()
lower10<-c()
for(i in 1:5){
upper10[i]<-old_treatment10[i]-Quantile_upper[i]*(var[i]^0.5)
lower10[i]<-old_treatment10[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper10
lower10
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-10
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old10<-e_hat





 
#step 11: s=11#

T0<-min(TT0)

s=11

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,old_treatment91,old_treatment101,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,old_treatment92,old_treatment102,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,old_treatment93,old_treatment103,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,old_treatment94,old_treatment104,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,old_treatment95,old_treatment105,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment_<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment2[i]<-new_treatment_

}


old_treatment111<-new_treatment2[1]
old_treatment112<-new_treatment2[2]
old_treatment113<-new_treatment2[3]
old_treatment114<-new_treatment2[4]
old_treatment115<-new_treatment2[5]

bias11<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias11

old_treatment_11<-new_treatment2


##====================================

#bootstrap 11#
#sd 11#

#step 11: s=11#
s=11

T0<-min(TT0)
T1<-min(TT0)+1


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

s=11


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,old_treatment91,old_treatment101,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,old_treatment92,old_treatment102,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,old_treatment93,old_treatment103,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,old_treatment94,old_treatment104,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,old_treatment95,old_treatment105,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment_<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment2[i]<-new_treatment_

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment111_sd<-var[1]
old_treatment112_sd<-var[2]
old_treatment113_sd<-var[3]
old_treatment114_sd<-var[4]
old_treatment115_sd<-var[5]

old_treatment_11+2.825*var^0.5
old_treatment_11-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper11<-c()
lower11<-c()
for(i in 1:5){
upper11[i]<-old_treatment_11[i]-Quantile_upper[i]*(var[i]^0.5)
lower11[i]<-old_treatment_11[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper11
lower11
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-11
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old11<-e_hat





 
#step 12: s=12#

T0<-min(TT0)

s=12

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,old_treatment91,old_treatment101,old_treatment111,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,old_treatment92,old_treatment102,old_treatment112,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,old_treatment93,old_treatment103,old_treatment113,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,old_treatment94,old_treatment104,old_treatment114,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,old_treatment95,old_treatment105,old_treatment115,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment_<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment2[i]<-new_treatment_

}


old_treatment121<-new_treatment2[1]
old_treatment122<-new_treatment2[2]
old_treatment123<-new_treatment2[3]
old_treatment124<-new_treatment2[4]
old_treatment125<-new_treatment2[5]

bias12<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias12

old_treatment_12<-new_treatment2


##====================================

#bootstrap 12#
#sd 12#

#step 12: s=12#
s=12

T0<-min(TT0)
T1<-min(TT0)+1


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

s=12


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,old_treatment91,old_treatment101,old_treatment111,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,old_treatment92,old_treatment102,old_treatment112,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,old_treatment93,old_treatment103,old_treatment113,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,old_treatment94,old_treatment104,old_treatment114,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,old_treatment95,old_treatment105,old_treatment115,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment_<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment2[i]<-new_treatment_

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment121_sd<-var[1]
old_treatment122_sd<-var[2]
old_treatment123_sd<-var[3]
old_treatment124_sd<-var[4]
old_treatment125_sd<-var[5]

old_treatment_12+2.825*var^0.5
old_treatment_12-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper12<-c()
lower12<-c()
for(i in 1:5){
upper12[i]<-old_treatment_12[i]-Quantile_upper[i]*(var[i]^0.5)
lower12[i]<-old_treatment_12[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper12
lower12
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-12
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old12<-e_hat




 
#step 13: s=13#

T0<-min(TT0)

s=13

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],D1[T0+12],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],D2[T0+12],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],D3[T0+12],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],D4[T0+12],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],D5[T0+12],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,old_treatment91,old_treatment101,old_treatment111,old_treatment121,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,old_treatment92,old_treatment102,old_treatment112,old_treatment122,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,old_treatment93,old_treatment103,old_treatment113,old_treatment123,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,old_treatment94,old_treatment104,old_treatment114,old_treatment124,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,old_treatment95,old_treatment105,old_treatment115,old_treatment125,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment_<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment2[i]<-new_treatment_

}


old_treatment131<-new_treatment2[1]
old_treatment132<-new_treatment2[2]
old_treatment133<-new_treatment2[3]
old_treatment134<-new_treatment2[4]
old_treatment135<-new_treatment2[5]

bias13<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias13

old_treatment_13<-new_treatment2


##====================================

#bootstrap 13#
#sd 13#

#step 13: s=13#
s=13

T0<-min(TT0)
T1<-min(TT0)+1


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

s=13


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],D1[T0+12],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],D2[T0+12],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],D3[T0+12],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],D4[T0+12],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],D5[T0+12],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,old_treatment91,old_treatment101,old_treatment111,old_treatment121,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,old_treatment92,old_treatment102,old_treatment112,old_treatment122,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,old_treatment93,old_treatment103,old_treatment113,old_treatment123,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,old_treatment94,old_treatment104,old_treatment114,old_treatment124,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,old_treatment95,old_treatment105,old_treatment115,old_treatment125,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment_<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment2[i]<-new_treatment_

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment131_sd<-var[1]
old_treatment132_sd<-var[2]
old_treatment133_sd<-var[3]
old_treatment134_sd<-var[4]
old_treatment135_sd<-var[5]

old_treatment_13+2.825*var^0.5
old_treatment_13-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper13<-c()
lower13<-c()
for(i in 1:5){
upper13[i]<-old_treatment_13[i]-Quantile_upper[i]*(var[i]^0.5)
lower13[i]<-old_treatment_13[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper13
lower13
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-13
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old13<-e_hat





 
#step 14: s=14#

T0<-min(TT0)

s=14

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],D1[T0+12],D1[T0+13],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],D2[T0+12],D2[T0+13],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],D3[T0+12],D3[T0+13],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],D4[T0+12],D4[T0+13],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],D5[T0+12],D5[T0+13],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,old_treatment91,old_treatment101,old_treatment111,old_treatment121,old_treatment131,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,old_treatment92,old_treatment102,old_treatment112,old_treatment122,old_treatment132,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,old_treatment93,old_treatment103,old_treatment113,old_treatment123,old_treatment133,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,old_treatment94,old_treatment104,old_treatment114,old_treatment124,old_treatment134,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,old_treatment95,old_treatment105,old_treatment115,old_treatment125,old_treatment135,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment_<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment2[i]<-new_treatment_

}


old_treatment141<-new_treatment2[1]
old_treatment142<-new_treatment2[2]
old_treatment143<-new_treatment2[3]
old_treatment144<-new_treatment2[4]
old_treatment145<-new_treatment2[5]

bias14<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias14

old_treatment_14<-new_treatment2


##====================================

#bootstrap 14#
#sd 14#

#step 14: s=14#
s=14

T0<-min(TT0)
T1<-min(TT0)+1


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){



T0<-min(TT0)
T1<-min(TT0)+1

S0<-sample(1:(T0-20),1)

s=14


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],D1[T0+12],D1[T0+13],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],D2[T0+12],D2[T0+13],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],D3[T0+12],D3[T0+13],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],D4[T0+12],D4[T0+13],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],D5[T0+12],D5[T0+13],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,old_treatment91,old_treatment101,old_treatment111,old_treatment121,old_treatment131,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,old_treatment92,old_treatment102,old_treatment112,old_treatment122,old_treatment132,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,old_treatment93,old_treatment103,old_treatment113,old_treatment123,old_treatment133,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,old_treatment94,old_treatment104,old_treatment114,old_treatment124,old_treatment134,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,old_treatment95,old_treatment105,old_treatment115,old_treatment125,old_treatment135,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment_<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment2[i]<-new_treatment_

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment141_sd<-var[1]
old_treatment142_sd<-var[2]
old_treatment143_sd<-var[3]
old_treatment144_sd<-var[4]
old_treatment145_sd<-var[5]

old_treatment_14+2.825*var^0.5
old_treatment_14-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper14<-c()
lower14<-c()
for(i in 1:5){
upper14[i]<-old_treatment_14[i]-Quantile_upper[i]*(var[i]^0.5)
lower14[i]<-old_treatment_14[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper14
lower14
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])



ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-14
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old14<-e_hat






 
#step 15: s=15#

T0<-min(TT0)

s=15

DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],D1[T0+12],D1[T0+13],D1[T0+14],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],D2[T0+12],D2[T0+13],D2[T0+14],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],D3[T0+12],D3[T0+13],D3[T0+14],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],D4[T0+12],D4[T0+13],D4[T0+14],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],D5[T0+12],D5[T0+13],D5[T0+14],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,old_treatment91,old_treatment101,old_treatment111,old_treatment121,old_treatment131,old_treatment141,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,old_treatment92,old_treatment102,old_treatment112,old_treatment122,old_treatment132,old_treatment142,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,old_treatment93,old_treatment103,old_treatment113,old_treatment123,old_treatment133,old_treatment143,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,old_treatment94,old_treatment104,old_treatment114,old_treatment124,old_treatment134,old_treatment144,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,old_treatment95,old_treatment105,old_treatment115,old_treatment125,old_treatment135,old_treatment145,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1



#new method#
new_treatment2<-c()
for (i in 1:5){


j=1  #forward step#



DD<-c(DDD[i,])
yy<-c(yyy[i,])
tt1<-c(t1[1:(T0+j)])
tt2<-c(t2[1:(T0+j)])
zz<-c(z[i,][1:(T0+j)])

a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)

x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[T1:(T0+j)])-mean(predict(lm(yy~Y_t))[1:T0])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+i)*sum(DD[1:(T0+j)]*Y_t)-sum(DD[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))* (( (T0+j)*sum(zz[1:(T0+j)]*Y_t)-sum(zz[1:(T0+j)])*sum(Y_t) )/( (T0+j)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment_<-as.numeric( (new-coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[2]*(mean(Y_t[T1:(T0+j)])-mean(Y_t[1:T0]))-a3*coefficients(lm(yy[1:(T0+j)]~Y_t[1:(T0+j)]+zz[1:(T0+j)]+DD[1:(T0+j)]))[3])/a1 )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment2[i]<-new_treatment_

}


old_treatment151<-new_treatment2[1]
old_treatment152<-new_treatment2[2]
old_treatment153<-new_treatment2[3]
old_treatment154<-new_treatment2[4]
old_treatment155<-new_treatment2[5]

bias15<-c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])-new_treatment2
bias15

old_treatment_15<-new_treatment2


##====================================

#bootstrap 15#
#sd 15#

#step 15: s=15#
s=15

T0<-min(TT0)
T1<-min(TT0)+1


SS<-c()
SSS<-c()
boot2<-list()
for (b in 1:100){


T0<-min(TT0)
T1<-min(TT0)+1


S0<-sample(1:(T0-20),1)

s=15


SS[b]<-(T0+s)-S0+1
SSS[b]<-((T0+s)-S0+1)/((T0+s)-1+1)


DDD<-rbind(
(D1[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))) - c(rep(0,T0),D1[T0+1],D1[T0+2],D1[T0+3],D1[T0+4],D1[T0+5],D1[T0+6],D1[T0+7],D1[T0+8],D1[T0+9],D1[T0+10],D1[T0+11],D1[T0+12],D1[T0+13],D1[T0+14],0)*ifelse(TT0[1]<=T0,0,1),
(D2[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))) - c(rep(0,T0),D2[T0+1],D2[T0+2],D2[T0+3],D2[T0+4],D2[T0+5],D2[T0+6],D2[T0+7],D2[T0+8],D2[T0+9],D2[T0+10],D2[T0+11],D2[T0+12],D2[T0+13],D2[T0+14],0)*ifelse(TT0[2]<=T0,0,1),
(D3[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))) - c(rep(0,T0),D3[T0+1],D3[T0+2],D3[T0+3],D3[T0+4],D3[T0+5],D3[T0+6],D3[T0+7],D3[T0+8],D3[T0+9],D3[T0+10],D3[T0+11],D3[T0+12],D3[T0+13],D3[T0+14],0)*ifelse(TT0[3]<=T0,0,1),
(D4[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))) - c(rep(0,T0),D4[T0+1],D4[T0+2],D4[T0+3],D4[T0+4],D4[T0+5],D4[T0+6],D4[T0+7],D4[T0+8],D4[T0+9],D4[T0+10],D4[T0+11],D4[T0+12],D4[T0+13],D4[T0+14],0)*ifelse(TT0[4]<=T0,0,1),
(D5[1:(T0+s)]-c(rep(0,T0),1,1,1,1,1,1,1,1,1,1,1,1,1,1,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) - c(rep(0,T0),D5[T0+1],D5[T0+2],D5[T0+3],D5[T0+4],D5[T0+5],D5[T0+6],D5[T0+7],D5[T0+8],D5[T0+9],D5[T0+10],D5[T0+11],D5[T0+12],D5[T0+13],D5[T0+14],0)*ifelse(TT0[5]<=T0,0,1)  )

yyy<-rbind(
(y1[1:(T0+s)]-c(rep(0,T0),old_treatment11,old_treatment21,old_treatment31,old_treatment41,old_treatment51,old_treatment61,old_treatment71,old_treatment81,old_treatment91,old_treatment101,old_treatment111,old_treatment121,old_treatment131,old_treatment141,rep(0,1))*rep(ifelse(TT0[1]<=T0,1,0),(T0+s))),
(y2[1:(T0+s)]-c(rep(0,T0),old_treatment12,old_treatment22,old_treatment32,old_treatment42,old_treatment52,old_treatment62,old_treatment72,old_treatment82,old_treatment92,old_treatment102,old_treatment112,old_treatment122,old_treatment132,old_treatment142,rep(0,1))*rep(ifelse(TT0[2]<=T0,1,0),(T0+s))),
(y3[1:(T0+s)]-c(rep(0,T0),old_treatment13,old_treatment23,old_treatment33,old_treatment43,old_treatment53,old_treatment63,old_treatment73,old_treatment83,old_treatment93,old_treatment103,old_treatment113,old_treatment123,old_treatment133,old_treatment143,rep(0,1))*rep(ifelse(TT0[3]<=T0,1,0),(T0+s))),
(y4[1:(T0+s)]-c(rep(0,T0),old_treatment14,old_treatment24,old_treatment34,old_treatment44,old_treatment54,old_treatment64,old_treatment74,old_treatment84,old_treatment94,old_treatment104,old_treatment114,old_treatment124,old_treatment134,old_treatment144,rep(0,1))*rep(ifelse(TT0[4]<=T0,1,0),(T0+s))),
(y5[1:(T0+s)]-c(rep(0,T0),old_treatment15,old_treatment25,old_treatment35,old_treatment45,old_treatment55,old_treatment65,old_treatment75,old_treatment85,old_treatment95,old_treatment105,old_treatment115,old_treatment125,old_treatment135,old_treatment145,rep(0,1))*rep(ifelse(TT0[5]<=T0,1,0),(T0+s))) )


TT0_2<-c( sum(DDD[1,]==0),sum(DDD[2,]==0),sum(DDD[3,]==0),sum(DDD[4,]==0),sum(DDD[5,]==0) )
TT1_2<-c( sum(DDD[1,]==0)+1,sum(DDD[2,]==0)+1,sum(DDD[3,]==0)+1,sum(DDD[4,]==0)+1,sum(DDD[5,]==0)+1 )    #treatment date#

T0<-min(TT0_2)
T1<-min(TT0_2)+1




j=1

#new method#
new_treatment2<-c()
for (i in 1:5){



DD<-D[i,][S0:(T0+j)]
yy<-y[i,][S0:(T0+j)]
tt1<-t1[S0:(T0+j)]
tt2<-t2[S0:(T0+j)]
zz<-z[i,][S0:(T0+j)]


a_x<-2*(lm(DD~tt2+tt1)$coefficients[2])               
a_y<-2*(lm(yy~tt2+tt1)$coefficients[2])             
                                                                            
b_x<-lm(DD~tt2+tt1)$coefficients[3]                
b_y<-lm(yy~tt2+tt1)$coefficients[3]

A_x<-a_x
B_x<-(-a_x)                                                        
A_y<-a_y
B_y<-(-a_y)



x_t<-2*(a_x)*tt1+b_x
Y_t<-(a_y*x_t+a_x*b_y-a_y*b_x)/a_x
Y_t[is.nan(Y_t)]<-0
new<-mean(predict(lm(yy~Y_t))[(T0-S0+2):(T0-S0+1+j)])-mean(predict(lm(yy~Y_t))[1:(T0-S0+1)])                              #new_gammabeta#
new[is.na(new)]<-0
ols<-(lm(yy~DD+zz-1))$coefficients[1]
#library(robcp)
#structure<-teststat(y)                                  

a1<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(DD*Y_t)-sum(DD)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))
a3<-  (mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))* (( (T0+j-S0+1)*sum(zz*Y_t)-sum(zz)*sum(Y_t) )/( (T0+j-S0+1)*sum(Y_t*Y_t)-sum(Y_t)*sum(Y_t) ))

a1[is.na(a1)]<-0
a3[is.na(a3)]<-0


new_treatment_<-as.numeric( (new-coefficients(lm(yy~Y_t+zz+DD))[2]*(mean(Y_t[(T0-S0+2):(T0-S0+1+j)])-mean(Y_t[1:(T0-S0+1)]))-a3*coefficients(lm(yy~Y_t+zz+DD))[3])/a1 )
new_treatment_[is.na(new_treatment_)]<-0
new_treatment_

new_treatment2[i]<-new_treatment_

}


boot2[b]<-list(new_treatment2)

}

boot<-data.frame(boot2)
boot1<-as.numeric(boot[1,])
boot2<-as.numeric(boot[2,])
boot3<-as.numeric(boot[3,])
boot4<-as.numeric(boot[4,])
boot5<-as.numeric(boot[5,])



var<-c()
for (k in 1:5){

B<-length(boot[k,])
q=1
x=sort(as.numeric(boot[k,]))
nob=length(x)-1 
sum1 = sum((x[5:(nob+1)]-2*x[3:(nob-1)]+x[1:(nob-3)])^2)
sum2 = sum((x[3:(nob+1)]-2*x[2:nob]+x[1:(nob-1)])^2)
D_hat<-0.5*log2(sum1/sum2)
D_hat[is.nan(D_hat)]<-0
d_B<-(B^(2-q*D_hat)*(log(log(log(B))))^0.1)^0.5
var[k]<-(B*d_B^2)^(-0.5) * sum( (sort(as.numeric(boot[k,]))-mean(sort(as.numeric(boot[k,]))))^2 )

}

old_treatment151_sd<-var[1]
old_treatment152_sd<-var[2]
old_treatment153_sd<-var[3]
old_treatment154_sd<-var[4]
old_treatment155_sd<-var[5]

old_treatment_15+2.825*var^0.5
old_treatment_15-2.825*var^0.5
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


R<-list()
for (i in 1:5){
u<-as.numeric(boot[i,]/(var[i]^0.5))
u[is.nan(u)]<-0
R[i]<-list(u)
}

R_sort<-list()
for (i in 1:5){
R_sort[i]<-list(sort(R[[i]]))
}

Quantile_upper<-c()
for (i in 1:5){
k1<-round(B*(0.05/2))
Quantile_upper[i]<-R_sort[[i]][k1]
}

Quantile_lower<-c()
for (i in 1:5){
k2<-round(B*(0.95/2))
Quantile_lower[i]<-R_sort[[i]][k2]
}


upper15<-c()
lower15<-c()
for(i in 1:5){
upper15[i]<-old_treatment_15[i]-Quantile_upper[i]*(var[i]^0.5)
lower15[i]<-old_treatment_15[i]+Quantile_lower[i]*(var[i]^0.5)
}

upper15
lower15
c(tr1[min(TT0)+s]*D1[min(TT0)+s],tr2[min(TT0)+s]*D2[min(TT0)+s],tr3[min(TT0)+s]*D3[min(TT0)+s],tr4[min(TT0)+s]*D4[min(TT0)+s],tr5[min(TT0)+s]*D5[min(TT0)+s])


ee<-c()
for (p in 1:200){
ee[p]<-p/10
}

e_hat<-c()
for (r in 1:5){

ff<-function (x){
 exp(-(x-1)^2/(2*var[r]))
}

out<-c()
for (p in 1:200){
t<-15
out[p]<-0.5*(2/3.1415926)^0.5*integrate( ff , lower=(1+ee[p])*t^(-0.5),upper=Inf)$value
}

e_hat[r]<-ee[which(out<=0.05)[1]]

}

e_hat_old15<-e_hat




ee_hat_old<-list(e_hat_old1+1,e_hat_old2+1,e_hat_old3+1,e_hat_old4+1,e_hat_old5+1,e_hat_old6+1,e_hat_old7+1,e_hat_old8+1,e_hat_old9+1,e_hat_old10+1,e_hat_old11+1,e_hat_old12+1,e_hat_old13+1,e_hat_old14+1,e_hat_old15+1)
ee_hat_old<-data.frame(ee_hat_old)



upper_total<-list(upper1,upper2,upper3,upper4,upper5,upper6,upper7,upper8,upper9,upper10,upper11,upper12,upper13,upper14,upper15)
lower_total<-list(lower1,lower2,lower3,lower4,lower5,lower6,lower7,lower8,lower9,lower10,lower11,lower12,lower13,lower14,lower15)
upper_total<-data.frame(upper_total)
lower_total<-data.frame(lower_total)


tr<-rbind(tr1,tr2,tr3,tr4,tr5)
D<-rbind(D1,D2,D3,D4,D5)


cr_old_1<-as.numeric(ifelse(  (lower_total[1,]-ee_hat_old[1,])<=(tr[1,]*D[1,])[(min(TT0)+1):(min(TT0)+15)]&(tr[1,]*D[1,])[(min(TT0)+1):(min(TT0)+15)]<= (upper_total[1,]+ee_hat_old[1,]) ,1,0  ))
cr_old_2<-as.numeric(ifelse(  (lower_total[2,]-ee_hat_old[2,])<=(tr[2,]*D[2,])[(min(TT0)+1):(min(TT0)+15)]&(tr[2,]*D[2,])[(min(TT0)+1):(min(TT0)+15)]<= (upper_total[2,]+ee_hat_old[2,]) ,1,0  ))
cr_old_3<-as.numeric(ifelse(  (lower_total[3,]-ee_hat_old[3,])<=(tr[3,]*D[3,])[(min(TT0)+1):(min(TT0)+15)]&(tr[3,]*D[3,])[(min(TT0)+1):(min(TT0)+15)]<= (upper_total[3,]+ee_hat_old[3,]) ,1,0  ))
cr_old_4<-as.numeric(ifelse(  (lower_total[4,]-ee_hat_old[4,])<=(tr[4,]*D[4,])[(min(TT0)+1):(min(TT0)+15)]&(tr[4,]*D[4,])[(min(TT0)+1):(min(TT0)+15)]<= (upper_total[4,]+ee_hat_old[4,]) ,1,0  ))
cr_old_5<-as.numeric(ifelse(  (lower_total[5,]-ee_hat_old[5,])<=(tr[5,]*D[5,])[(min(TT0)+1):(min(TT0)+15)]&(tr[5,]*D[5,])[(min(TT0)+1):(min(TT0)+15)]<= (upper_total[5,]+ee_hat_old[5,]) ,1,0  ))

cr_old<-c(cr_old_1,cr_old_2,cr_old_3,cr_old_4,cr_old_5)

cr_old_mean1<-mean(c( sum(cr_old_1[1]==1)/length(cr_old_1[1]),sum(cr_old_2[1]==1)/length(cr_old_2[1]),sum(cr_old_3[1]==1)/length(cr_old_3[1]),sum(cr_old_4[1]==1)/length(cr_old_4[1]),sum(cr_old_5[1]==1)/length(cr_old_5[1]) ))
cr_old_mean2<-mean(c( sum(cr_old_1[1:2]==1)/length(cr_old_1[1:2]),sum(cr_old_2[1:2]==1)/length(cr_old_2[1:2]),sum(cr_old_3[1:2]==1)/length(cr_old_3[1:2]),sum(cr_old_4[1:2]==1)/length(cr_old_4[1:2]),sum(cr_old_5[1:2]==1)/length(cr_old_5[1:2]) ))
cr_old_mean3<-mean(c( sum(cr_old_1[1:3]==1)/length(cr_old_1[1:3]),sum(cr_old_2[1:3]==1)/length(cr_old_2[1:3]),sum(cr_old_3[1:3]==1)/length(cr_old_3[1:3]),sum(cr_old_4[1:3]==1)/length(cr_old_4[1:3]),sum(cr_old_5[1:3]==1)/length(cr_old_5[1:3]) ))
cr_old_mean4<-mean(c( sum(cr_old_1[1:4]==1)/length(cr_old_1[1:4]),sum(cr_old_2[1:4]==1)/length(cr_old_2[1:4]),sum(cr_old_3[1:4]==1)/length(cr_old_3[1:4]),sum(cr_old_4[1:4]==1)/length(cr_old_4[1:4]),sum(cr_old_5[1:4]==1)/length(cr_old_5[1:4]) ))
cr_old_mean5<-mean(c( sum(cr_old_1[1:5]==1)/length(cr_old_1[1:5]),sum(cr_old_2[1:5]==1)/length(cr_old_2[1:5]),sum(cr_old_3[1:5]==1)/length(cr_old_3[1:5]),sum(cr_old_4[1:5]==1)/length(cr_old_4[1:5]),sum(cr_old_5[1:5]==1)/length(cr_old_5[1:5]) ))
cr_old_mean6<-mean(c( sum(cr_old_1[1:6]==1)/length(cr_old_1[1:6]),sum(cr_old_2[1:6]==1)/length(cr_old_2[1:6]),sum(cr_old_3[1:6]==1)/length(cr_old_3[1:6]),sum(cr_old_4[1:6]==1)/length(cr_old_4[1:6]),sum(cr_old_5[1:6]==1)/length(cr_old_5[1:6]) ))
cr_old_mean7<-mean(c( sum(cr_old_1[1:7]==1)/length(cr_old_1[1:7]),sum(cr_old_2[1:7]==1)/length(cr_old_2[1:7]),sum(cr_old_3[1:7]==1)/length(cr_old_3[1:7]),sum(cr_old_4[1:7]==1)/length(cr_old_4[1:7]),sum(cr_old_5[1:7]==1)/length(cr_old_5[1:7]) ))
cr_old_mean8<-mean(c( sum(cr_old_1[1:8]==1)/length(cr_old_1[1:8]),sum(cr_old_2[1:8]==1)/length(cr_old_2[1:8]),sum(cr_old_3[1:8]==1)/length(cr_old_3[1:8]),sum(cr_old_4[1:8]==1)/length(cr_old_4[1:8]),sum(cr_old_5[1:8]==1)/length(cr_old_5[1:8]) ))
cr_old_mean9<-mean(c( sum(cr_old_1[1:9]==1)/length(cr_old_1[1:9]),sum(cr_old_2[1:9]==1)/length(cr_old_2[1:9]),sum(cr_old_3[1:9]==1)/length(cr_old_3[1:9]),sum(cr_old_4[1:9]==1)/length(cr_old_4[1:9]),sum(cr_old_5[1:9]==1)/length(cr_old_5[1:9]) ))
cr_old_mean10<-mean(c( sum(cr_old_1[1:10]==1)/length(cr_old_1[1:10]),sum(cr_old_2[1:10]==1)/length(cr_old_2[1:10]),sum(cr_old_3[1:10]==1)/length(cr_old_3[1:10]),sum(cr_old_4[1:10]==1)/length(cr_old_4[1:10]),sum(cr_old_5[1:10]==1)/length(cr_old_5[1:10]) ))
cr_old_mean11<-mean(c( sum(cr_old_1[1:11]==1)/length(cr_old_1[1:11]),sum(cr_old_2[1:11]==1)/length(cr_old_2[1:11]),sum(cr_old_3[1:11]==1)/length(cr_old_3[1:11]),sum(cr_old_4[1:11]==1)/length(cr_old_4[1:11]),sum(cr_old_5[1:11]==1)/length(cr_old_5[1:11]) ))
cr_old_mean12<-mean(c( sum(cr_old_1[1:12]==1)/length(cr_old_1[1:12]),sum(cr_old_2[1:12]==1)/length(cr_old_2[1:12]),sum(cr_old_3[1:12]==1)/length(cr_old_3[1:12]),sum(cr_old_4[1:12]==1)/length(cr_old_4[1:12]),sum(cr_old_5[1:12]==1)/length(cr_old_5[1:12]) ))
cr_old_mean13<-mean(c( sum(cr_old_1[1:13]==1)/length(cr_old_1[1:13]),sum(cr_old_2[1:13]==1)/length(cr_old_2[1:13]),sum(cr_old_3[1:13]==1)/length(cr_old_3[1:13]),sum(cr_old_4[1:13]==1)/length(cr_old_4[1:13]),sum(cr_old_5[1:13]==1)/length(cr_old_5[1:13]) ))
cr_old_mean14<-mean(c( sum(cr_old_1[1:14]==1)/length(cr_old_1[1:14]),sum(cr_old_2[1:14]==1)/length(cr_old_2[1:14]),sum(cr_old_3[1:14]==1)/length(cr_old_3[1:14]),sum(cr_old_4[1:14]==1)/length(cr_old_4[1:14]),sum(cr_old_5[1:14]==1)/length(cr_old_5[1:14]) ))
cr_old_mean15<-mean(c( sum(cr_old_1[1:15]==1)/length(cr_old_1[1:15]),sum(cr_old_2[1:15]==1)/length(cr_old_2[1:15]),sum(cr_old_3[1:15]==1)/length(cr_old_3[1:15]),sum(cr_old_4[1:15]==1)/length(cr_old_4[1:15]),sum(cr_old_5[1:15]==1)/length(cr_old_5[1:15]) ))


cr_old_mean<-c(cr_old_mean1,cr_old_mean2,cr_old_mean3,cr_old_mean4,cr_old_mean5,cr_old_mean6,cr_old_mean7,cr_old_mean8,cr_old_mean9,cr_old_mean10,cr_old_mean11,cr_old_mean12,cr_old_mean13,cr_old_mean14,cr_old_mean15)

plot(cr_old_mean)


cr_old_CI<-cr_old




#sharp bound#

total<-list(old_treatment1,old_treatment2,old_treatment3,old_treatment4,old_treatment5,old_treatment6,old_treatment7,old_treatment8,old_treatment9,old_treatment10,old_treatment_11,old_treatment_12,old_treatment_13,old_treatment_14,old_treatment_15)
total<-data.frame(total)



cr_old_1<-as.numeric(ifelse(  (total[1,]-ee_hat_old[1,])<=(tr[1,]*D[1,])[(min(TT0)+1):(min(TT0)+15)]&(tr[1,]*D[1,])[(min(TT0)+1):(min(TT0)+15)]<= (total[1,]+ee_hat_old[1,]) ,1,0  ))
cr_old_2<-as.numeric(ifelse(  (total[2,]-ee_hat_old[2,])<=(tr[2,]*D[2,])[(min(TT0)+1):(min(TT0)+15)]&(tr[2,]*D[2,])[(min(TT0)+1):(min(TT0)+15)]<= (total[2,]+ee_hat_old[2,]) ,1,0  ))
cr_old_3<-as.numeric(ifelse(  (total[3,]-ee_hat_old[3,])<=(tr[3,]*D[3,])[(min(TT0)+1):(min(TT0)+15)]&(tr[3,]*D[3,])[(min(TT0)+1):(min(TT0)+15)]<= (total[3,]+ee_hat_old[3,]) ,1,0  ))
cr_old_4<-as.numeric(ifelse(  (total[4,]-ee_hat_old[4,])<=(tr[4,]*D[4,])[(min(TT0)+1):(min(TT0)+15)]&(tr[4,]*D[4,])[(min(TT0)+1):(min(TT0)+15)]<= (total[4,]+ee_hat_old[4,]) ,1,0  ))
cr_old_5<-as.numeric(ifelse(  (total[5,]-ee_hat_old[5,])<=(tr[5,]*D[5,])[(min(TT0)+1):(min(TT0)+15)]&(tr[5,]*D[5,])[(min(TT0)+1):(min(TT0)+15)]<= (total[5,]+ee_hat_old[5,]) ,1,0  ))

cr_old<-c(cr_old_1,cr_old_2,cr_old_3,cr_old_4,cr_old_5)

cr_old_mean1<-mean(c( sum(cr_old_1[1]==1)/length(cr_old_1[1]),sum(cr_old_2[1]==1)/length(cr_old_2[1]),sum(cr_old_3[1]==1)/length(cr_old_3[1]),sum(cr_old_4[1]==1)/length(cr_old_4[1]),sum(cr_old_5[1]==1)/length(cr_old_5[1]) ))
cr_old_mean2<-mean(c( sum(cr_old_1[1:2]==1)/length(cr_old_1[1:2]),sum(cr_old_2[1:2]==1)/length(cr_old_2[1:2]),sum(cr_old_3[1:2]==1)/length(cr_old_3[1:2]),sum(cr_old_4[1:2]==1)/length(cr_old_4[1:2]),sum(cr_old_5[1:2]==1)/length(cr_old_5[1:2]) ))
cr_old_mean3<-mean(c( sum(cr_old_1[1:3]==1)/length(cr_old_1[1:3]),sum(cr_old_2[1:3]==1)/length(cr_old_2[1:3]),sum(cr_old_3[1:3]==1)/length(cr_old_3[1:3]),sum(cr_old_4[1:3]==1)/length(cr_old_4[1:3]),sum(cr_old_5[1:3]==1)/length(cr_old_5[1:3]) ))
cr_old_mean4<-mean(c( sum(cr_old_1[1:4]==1)/length(cr_old_1[1:4]),sum(cr_old_2[1:4]==1)/length(cr_old_2[1:4]),sum(cr_old_3[1:4]==1)/length(cr_old_3[1:4]),sum(cr_old_4[1:4]==1)/length(cr_old_4[1:4]),sum(cr_old_5[1:4]==1)/length(cr_old_5[1:4]) ))
cr_old_mean5<-mean(c( sum(cr_old_1[1:5]==1)/length(cr_old_1[1:5]),sum(cr_old_2[1:5]==1)/length(cr_old_2[1:5]),sum(cr_old_3[1:5]==1)/length(cr_old_3[1:5]),sum(cr_old_4[1:5]==1)/length(cr_old_4[1:5]),sum(cr_old_5[1:5]==1)/length(cr_old_5[1:5]) ))
cr_old_mean6<-mean(c( sum(cr_old_1[1:6]==1)/length(cr_old_1[1:6]),sum(cr_old_2[1:6]==1)/length(cr_old_2[1:6]),sum(cr_old_3[1:6]==1)/length(cr_old_3[1:6]),sum(cr_old_4[1:6]==1)/length(cr_old_4[1:6]),sum(cr_old_5[1:6]==1)/length(cr_old_5[1:6]) ))
cr_old_mean7<-mean(c( sum(cr_old_1[1:7]==1)/length(cr_old_1[1:7]),sum(cr_old_2[1:7]==1)/length(cr_old_2[1:7]),sum(cr_old_3[1:7]==1)/length(cr_old_3[1:7]),sum(cr_old_4[1:7]==1)/length(cr_old_4[1:7]),sum(cr_old_5[1:7]==1)/length(cr_old_5[1:7]) ))
cr_old_mean8<-mean(c( sum(cr_old_1[1:8]==1)/length(cr_old_1[1:8]),sum(cr_old_2[1:8]==1)/length(cr_old_2[1:8]),sum(cr_old_3[1:8]==1)/length(cr_old_3[1:8]),sum(cr_old_4[1:8]==1)/length(cr_old_4[1:8]),sum(cr_old_5[1:8]==1)/length(cr_old_5[1:8]) ))
cr_old_mean9<-mean(c( sum(cr_old_1[1:9]==1)/length(cr_old_1[1:9]),sum(cr_old_2[1:9]==1)/length(cr_old_2[1:9]),sum(cr_old_3[1:9]==1)/length(cr_old_3[1:9]),sum(cr_old_4[1:9]==1)/length(cr_old_4[1:9]),sum(cr_old_5[1:9]==1)/length(cr_old_5[1:9]) ))
cr_old_mean10<-mean(c( sum(cr_old_1[1:10]==1)/length(cr_old_1[1:10]),sum(cr_old_2[1:10]==1)/length(cr_old_2[1:10]),sum(cr_old_3[1:10]==1)/length(cr_old_3[1:10]),sum(cr_old_4[1:10]==1)/length(cr_old_4[1:10]),sum(cr_old_5[1:10]==1)/length(cr_old_5[1:10]) ))
cr_old_mean11<-mean(c( sum(cr_old_1[1:11]==1)/length(cr_old_1[1:11]),sum(cr_old_2[1:11]==1)/length(cr_old_2[1:11]),sum(cr_old_3[1:11]==1)/length(cr_old_3[1:11]),sum(cr_old_4[1:11]==1)/length(cr_old_4[1:11]),sum(cr_old_5[1:11]==1)/length(cr_old_5[1:11]) ))
cr_old_mean12<-mean(c( sum(cr_old_1[1:12]==1)/length(cr_old_1[1:12]),sum(cr_old_2[1:12]==1)/length(cr_old_2[1:12]),sum(cr_old_3[1:12]==1)/length(cr_old_3[1:12]),sum(cr_old_4[1:12]==1)/length(cr_old_4[1:12]),sum(cr_old_5[1:12]==1)/length(cr_old_5[1:12]) ))
cr_old_mean13<-mean(c( sum(cr_old_1[1:13]==1)/length(cr_old_1[1:13]),sum(cr_old_2[1:13]==1)/length(cr_old_2[1:13]),sum(cr_old_3[1:13]==1)/length(cr_old_3[1:13]),sum(cr_old_4[1:13]==1)/length(cr_old_4[1:13]),sum(cr_old_5[1:13]==1)/length(cr_old_5[1:13]) ))
cr_old_mean14<-mean(c( sum(cr_old_1[1:14]==1)/length(cr_old_1[1:14]),sum(cr_old_2[1:14]==1)/length(cr_old_2[1:14]),sum(cr_old_3[1:14]==1)/length(cr_old_3[1:14]),sum(cr_old_4[1:14]==1)/length(cr_old_4[1:14]),sum(cr_old_5[1:14]==1)/length(cr_old_5[1:14]) ))
cr_old_mean15<-mean(c( sum(cr_old_1[1:15]==1)/length(cr_old_1[1:15]),sum(cr_old_2[1:15]==1)/length(cr_old_2[1:15]),sum(cr_old_3[1:15]==1)/length(cr_old_3[1:15]),sum(cr_old_4[1:15]==1)/length(cr_old_4[1:15]),sum(cr_old_5[1:15]==1)/length(cr_old_5[1:15]) ))


cr_old_mean<-c(cr_old_mean1,cr_old_mean2,cr_old_mean3,cr_old_mean4,cr_old_mean5,cr_old_mean6,cr_old_mean7,cr_old_mean8,cr_old_mean9,cr_old_mean10,cr_old_mean11,cr_old_mean12,cr_old_mean13,cr_old_mean14,cr_old_mean15)

plot(cr_old_mean)


cr_old_SB<-cr_old















#===============================================================================================================================================
#===============================================================================================================================================




TT0<-c( sum(D1==0),sum(D2==0),sum(D3==0),sum(D4==0),sum(D5==0) )
TT1<-c( sum(D1==0)+1,sum(D2==0)+1,sum(D3==0)+1,sum(D4==0)+1,sum(D5==0)+1 )    #treatment date#



T0<-min(TT0)
T1<-min(TT0)+1


##

#synthdid#
library(synthdid)    
L=15
synthdid_treatment<-c()
for (i in 1:5){

data<-t(data.frame(y_co1[1:(T0+L)],y_co2[1:(T0+L)],y_co3[1:(T0+L)],y_co4[1:(T0+L)],y_co5[1:(T0+L)],y_co6[1:(T0+L)],y_co7[1:(T0+L)],y_co8[1:(T0+L)],y_co9[1:(T0+L)],y_co10[1:(T0+L)],y_co11[1:(T0+L)],y_co12[1:(T0+L)],y_co13[1:(T0+L)],y_co14[1:(T0+L)],y_co15[1:(T0+L)],y_co16[1:(T0+L)],y_co17[1:(T0+L)],y_co18[1:(T0+L)],y_co19[1:(T0+L)],y_co20[1:(T0+L)],y[1,][1:(T0+L)],y[2,][1:(T0+L)],y[3,][1:(T0+L)],y[4,][1:(T0+L)],y[5,][1:(T0+L)]))

Tr<-c(TT0[1],TT0[2],TT0[3],TT0[4],TT0[5])

data<-rbind(data[1:20,],data[(20+i),])

tau.hat = synthdid_estimate(data, 20, Tr[i])
summary(tau.hat)$period

synthdid_treatment[i]<-tau.hat[1]

}



#gsynth#
library(gsynth)
L=15
T0<-min(TT0)
T=500
x_co<-rep(0,T)[1:(T0+L)]
X<-rbind(D1[1:(T0+L)],D2[1:(T0+L)],D3[1:(T0+L)],D4[1:(T0+L)],D5[1:(T0+L)],rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),
rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),
rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1))
abb<-rbind(rep("tr1",T)[1:(T0+L)],rep("tr2",T)[1:(T0+L)],rep("tr3",T)[1:(T0+L)],rep("tr4",T)[1:(T0+L)],rep("tr5",T)[1:(T0+L)],rep(1,T)[1:(T0+L)],rep(2,T)[1:(T0+L)],rep(3,T)[1:(T0+L)],rep(4,T)[1:(T0+L)],rep(5,T)[1:(T0+L)],rep(6,T)[1:(T0+L)],rep(7,T)[1:(T0+L)],rep(8,T)[1:(T0+L)],rep(9,T)[1:(T0+L)],rep(10,T)[1:(T0+L)],rep(11,T)[1:(T0+L)],rep(12,T)[1:(T0+L)],rep(13,T)[1:(T0+L)],rep(14,T)[1:(T0+L)],rep(15,T)[1:(T0+L)],rep(16,T)[1:(T0+L)],rep(17,T)[1:(T0+L)],rep(18,T)[1:(T0+L)],rep(19,T)[1:(T0+L)],rep(20,T)[1:(T0+L)])
Y<-rbind(y[1,][1:(T0+L)],y[2,][1:(T0+L)],y[3,][1:(T0+L)],y[4,][1:(T0+L)],y[5,][1:(T0+L)],y_co1[1:(T0+L)],y_co2[1:(T0+L)],y_co3[1:(T0+L)],y_co4[1:(T0+L)],y_co5[1:(T0+L)],y_co6[1:(T0+L)],y_co7[1:(T0+L)],y_co8[1:(T0+L)],y_co9[1:(T0+L)],y_co10[1:(T0+L)],y_co11[1:(T0+L)],y_co12[1:(T0+L)],y_co13[1:(T0+L)],y_co14[1:(T0+L)],y_co15[1:(T0+L)],y_co16[1:(T0+L)],y_co17[1:(T0+L)],y_co18[1:(T0+L)],y_co19[1:(T0+L)],y_co20[1:(T0+L)])
t<-rbind(rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),
rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),
rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),
rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),
rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),
rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),
rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),
rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),rep(sort(sample(200:700,T))[1:(T0+L)],1),
rep(sort(sample(200:700,T))[1:(T0+L)],1))

gsynth_treatment<-c()
for (i in 1:5){ 
XX<-c(X[i,],X[6:20,])
YY<-c(Y[i,],Y[6:20,])
ABB<-c(abb[i,],abb[6:20,])
time<-c(t[i,],t[6:20,])
data<-data.frame(XX,YY,ABB,time)

out1 <- gsynth(YY ~ XX, data = data, index = c("ABB","time"),force = "two-way", CV = TRUE, r = c(0, 5), se = TRUE,
 inference = "parametric", nboots = 100, parallel = TRUE)

gsynth_treatment[i]<-out1$att.avg

}





#did_staggered_with controls groups#

L=15
T0<-min(TT0)

library(did)
x_co<-rep(0,T)[1:(T0+L)]
X<-rbind(D1[1:(T0+L)],D2[1:(T0+L)],D3[1:(T0+L)],D4[1:(T0+L)],D5[1:(T0+L)],rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),
rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),
rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1))
abb<-rbind(rep(00,T)[1:(T0+L)],rep(11,T)[1:(T0+L)],rep(22,T)[1:(T0+L)],rep(33,T)[1:(T0+L)],rep(44,T)[1:(T0+L)],rep(1,T)[1:(T0+L)],rep(2,T)[1:(T0+L)],rep(3,T)[1:(T0+L)],rep(4,T)[1:(T0+L)],rep(5,T)[1:(T0+L)],rep(6,T)[1:(T0+L)],rep(7,T)[1:(T0+L)],rep(8,T)[1:(T0+L)],rep(9,T)[1:(T0+L)],rep(10,T)[1:(T0+L)],rep(11,T)[1:(T0+L)],rep(12,T)[1:(T0+L)],rep(13,T)[1:(T0+L)],rep(14,T)[1:(T0+L)],rep(15,T)[1:(T0+L)],rep(16,T)[1:(T0+L)],rep(17,T)[1:(T0+L)],rep(18,T)[1:(T0+L)],rep(19,T)[1:(T0+L)],rep(20,T)[1:(T0+L)])
Y<-rbind(y[1,][1:(T0+L)],y[2,][1:(T0+L)],y[3,][1:(T0+L)],y[4,][1:(T0+L)],y[5,][1:(T0+L)],y_co1[1:(T0+L)],y_co2[1:(T0+L)],y_co3[1:(T0+L)],y_co4[1:(T0+L)],y_co5[1:(T0+L)],y_co6[1:(T0+L)],y_co7[1:(T0+L)],y_co8[1:(T0+L)],y_co9[1:(T0+L)],y_co10[1:(T0+L)],y_co11[1:(T0+L)],y_co12[1:(T0+L)],y_co13[1:(T0+L)],y_co14[1:(T0+L)],y_co15[1:(T0+L)],y_co16[1:(T0+L)],y_co17[1:(T0+L)],y_co18[1:(T0+L)],y_co19[1:(T0+L)],y_co20[1:(T0+L)])
t<-rbind(rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1))

first.treat<-rbind(rep(sum(D1==0)+1,(T0+L)),rep(sum(D2==0)+1,(T0+L)),rep(sum(D3==0)+1,(T0+L)),rep(sum(D4==0)+1,(T0+L)),rep(sum(D5==0)+1,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)))
treat<-rbind(rep(1,(T0+L)),rep(1,(T0+L)),rep(1,(T0+L)),rep(1,(T0+L)),rep(1,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)))

didstaggered_treatment_or<-c()
didstaggered_treatment_dr<-c()
didstaggered_treatment_ipw<-c()

for (i in 1:5){ 

XX<-c(X[i,],X[6:20,])
YY<-c(Y[i,],Y[6:20,])
ABB<-c(abb[i,],abb[6:20,])
TIME<-c(t[i,],t[6:20,])
FIRST.treat<-c(first.treat[i,],first.treat[6:20,])
TREAT<-c(treat[i,],treat[6:20,])

data<-data.frame(YY,XX,ABB,TIME,FIRST.treat,TREAT)

out_or <- att_gt(yname = "YY",   
              gname = "FIRST.treat",  
              idname = "ABB",
              tname = "TIME",
              xformla = ~1,
              data = data,
              est_method = "reg",cband=F,bstrap = F,panel=F)

group_effects_or <- aggte(out_or, type = "group",na.rm = TRUE)
summary(group_effects_or)
didstaggered_treatment_or[i]<-group_effects_or$overall.att

out_dr <- att_gt(yname = "YY",   
              gname = "FIRST.treat",  
              idname = "ABB",
              tname = "TIME",
              xformla = ~1,
              data = data,
              est_method = "dr",cband=F,bstrap = F,panel=F)

group_effects_dr <- aggte(out_dr, type = "group",na.rm = TRUE)
summary(group_effects_dr)

didstaggered_treatment_dr[i]<-group_effects_dr$overall.att

out_ipw <- att_gt(yname = "YY",   
              gname = "FIRST.treat",  
              idname = "ABB",
              tname = "TIME",
              xformla = ~1,
              data = data,
              est_method = "ipw",cband=F,bstrap = F,panel=F)

group_effects_ipw <- aggte(out_ipw, type = "group",na.rm = TRUE)
summary(group_effects_ipw)

didstaggered_treatment_ipw[i]<-group_effects_ipw$overall.att


}

didstaggered_treatment_or
didstaggered_treatment_dr
didstaggered_treatment_ipw



#did_staggered_without controls groups#

library(did)
L=15
T0<-min(TT0)

XX<-c(D1[1:(T0+L)],D2[1:(T0+L)],D3[1:(T0+L)],D4[1:(T0+L)],D5[1:(T0+L)])
ABB<-c(rep(00,T)[1:(T0+L)],rep(11,T)[1:(T0+L)],rep(22,T)[1:(T0+L)],rep(33,T)[1:(T0+L)],rep(44,T)[1:(T0+L)])
YY<-c(y[1,][1:(T0+L)],y[2,][1:(T0+L)],y[3,][1:(T0+L)],y[4,][1:(T0+L)],y[5,][1:(T0+L)])
TIME<-c(rep(sort(sample(1:T,T))[1:(T0+L)],1),rep(sort(sample(1:T,T))[1:(T0+L)],1),rep(sort(sample(1:T,T))[1:(T0+L)],1),rep(sort(sample(1:T,T))[1:(T0+L)],1),rep(sort(sample(1:T,T))[1:(T0+L)],1))

FIRST.treat<-c(rep(sum(D1==0)+1,(T0+L)),rep(sum(D2==0)+1,(T0+L)),rep(sum(D3==0)+1,(T0+L)),rep(sum(D4==0)+1,(T0+L)),rep(sum(D5==0)+1,(T0+L)))
TREAT<-c(rep(1,(T0+L)),rep(1,(T0+L)),rep(1,(T0+L)),rep(1,(T0+L)),rep(1,(T0+L)))

data<-data.frame(YY,XX,ABB,TIME,FIRST.treat,TREAT)


out_orr <- att_gt(yname = "YY",   
              gname = "FIRST.treat",  
              idname = "ABB",
              tname = "TIME",
              xformla = ~1,control_group = c("notyettreated"),
              data = data,
              est_method = "reg",cband=F,bstrap = F,panel=F)

group_effects_orr <- aggte(out_orr, type = "group",na.rm = TRUE)
summary(group_effects_orr)
didstaggered_treatment_orr<-group_effects_orr$overall.att

out_drr <- att_gt(yname = "YY",   
              gname = "FIRST.treat",  
              idname = "ABB",
              tname = "TIME",
              xformla = ~1,control_group = c("notyettreated"),
              data = data,
              est_method = "dr",cband=F,bstrap = F,panel=F)

group_effects_drr <- aggte(out_drr, type = "group",na.rm = TRUE)
summary(group_effects_drr)
didstaggered_treatment_drr<-group_effects_drr$overall.att


out_ipww <- att_gt(yname = "YY",   
              gname = "FIRST.treat",  
              idname = "ABB",
              tname = "TIME",
              xformla = ~1,control_group = c("notyettreated"),
              data = data,
              est_method = "ipw",cband=F,bstrap = F,panel=F)

group_effects_ipww<- aggte(out_ipww, type = "group",na.rm = TRUE)
summary(group_effects_ipww)
didstaggered_treatment_ipww<-group_effects_ipww$overall.att



#did_staggered_with controls groups#
#Sun & Abraham#


library(fixest)
L=15
T0<-min(TT0)

library(did)
x_co<-rep(0,T)[1:(T0+L)]
X<-rbind(D1[1:(T0+L)],D2[1:(T0+L)],D3[1:(T0+L)],D4[1:(T0+L)],D5[1:(T0+L)],rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),
rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1),
rep(x_co,1),rep(x_co,1),rep(x_co,1),rep(x_co,1))
abb<-rbind(rep(00,T)[1:(T0+L)],rep(11,T)[1:(T0+L)],rep(22,T)[1:(T0+L)],rep(33,T)[1:(T0+L)],rep(44,T)[1:(T0+L)],rep(1,T)[1:(T0+L)],rep(2,T)[1:(T0+L)],rep(3,T)[1:(T0+L)],rep(4,T)[1:(T0+L)],rep(5,T)[1:(T0+L)],rep(6,T)[1:(T0+L)],rep(7,T)[1:(T0+L)],rep(8,T)[1:(T0+L)],rep(9,T)[1:(T0+L)],rep(10,T)[1:(T0+L)],rep(11,T)[1:(T0+L)],rep(12,T)[1:(T0+L)],rep(13,T)[1:(T0+L)],rep(14,T)[1:(T0+L)],rep(15,T)[1:(T0+L)],rep(16,T)[1:(T0+L)],rep(17,T)[1:(T0+L)],rep(18,T)[1:(T0+L)],rep(19,T)[1:(T0+L)],rep(20,T)[1:(T0+L)])
Y<-rbind(y[1,][1:(T0+L)],y[2,][1:(T0+L)],y[3,][1:(T0+L)],y[4,][1:(T0+L)],y[5,][1:(T0+L)],y_co1[1:(T0+L)],y_co2[1:(T0+L)],y_co3[1:(T0+L)],y_co4[1:(T0+L)],y_co5[1:(T0+L)],y_co6[1:(T0+L)],y_co7[1:(T0+L)],y_co8[1:(T0+L)],y_co9[1:(T0+L)],y_co10[1:(T0+L)],y_co11[1:(T0+L)],y_co12[1:(T0+L)],y_co13[1:(T0+L)],y_co14[1:(T0+L)],y_co15[1:(T0+L)],y_co16[1:(T0+L)],y_co17[1:(T0+L)],y_co18[1:(T0+L)],y_co19[1:(T0+L)],y_co20[1:(T0+L)])
t<-rbind(rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),rep(sort(sample(1:500,T))[1:(T0+L)],1),
rep(sort(sample(1:500,T))[1:(T0+L)],1))

first.treat<-rbind(rep(sum(D1==0)+1,(T0+L)),rep(sum(D2==0)+1,(T0+L)),rep(sum(D3==0)+1,(T0+L)),rep(sum(D4==0)+1,(T0+L)),rep(sum(D5==0)+1,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)))
treat<-rbind(rep(1,(T0+L)),rep(1,(T0+L)),rep(1,(T0+L)),rep(1,(T0+L)),rep(1,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)),rep(0,(T0+L)))

didstaggered_treatment_sunab<-c()
for (i in 1:5){ 

XX<-c(X[i,],X[6:20,])
YY<-c(Y[i,],Y[6:20,])
ABB<-c(abb[i,],abb[6:20,])
TIME<-c(t[i,],t[6:20,])
FIRST.treat<-c(first.treat[i,],first.treat[6:20,])
TREAT<-c(treat[i,],treat[6:20,])

data<-data.frame(YY,XX,ABB,TIME,FIRST.treat,TREAT)


#didstaggered_treatment_sunab<-feols(YY~sunab(FIRST.treat,TIME)| ABB+TIME, data)
didstaggered_treatment_sunab[i]<-c(summary(feols(YY~sunab(FIRST.treat,TIME)| ABB+TIME, data), agg = "ATT")$coeftable[1])
didstaggered_treatment_sunab

}

L=15
T0<-min(TT0)

tr<-c( mean((tr1*D1)[TT1[1]:(T0+L)]),mean((tr2*D2)[TT1[2]:(T0+L)]),mean((tr3*D3)[TT1[3]:(T0+L)]),mean((tr4*D4)[TT1[4]:(T0+L)]),mean((tr5*D5)[TT1[5]:(T0+L)]) )

bias_plm<-abs(mean(tr)-coefficients(plm(YYY~DDD+ZZZ,data=data_twfe,model="within",effect="twoways"))[1])
bias_synthdid<-mean(abs(tr-synthdid_treatment))
bias_gsynth<-mean(abs(tr-gsynth_treatment))
bias_didstaggered_or<-mean(abs(tr-didstaggered_treatment_or))
bias_didstaggered_dr<-mean(abs(tr-didstaggered_treatment_dr))
bias_didstaggered_ipw<-mean(abs(tr-didstaggered_treatment_ipw))
bias_didstaggered_orr<-mean(abs(tr-didstaggered_treatment_orr))
bias_didstaggered_drr<-mean(abs(tr-didstaggered_treatment_drr))
bias_didstaggered_ipww<-mean(abs(tr-didstaggered_treatment_ipww))
bias_didstaggered_sunab<-mean(abs(tr-didstaggered_treatment_sunab))
bias_before_after<-abs(mean(tr)-before_after_treatment)

new<-list(new_treatment1,new_treatment2,new_treatment3,new_treatment4,new_treatment5,new_treatment6,new_treatment7,new_treatment8,new_treatment9,new_treatment10,new_treatment_11,new_treatment_12,new_treatment_13,new_treatment_14,new_treatment_15)
new<-data.frame(new)
new1<-as.numeric(new[1,])
new2<-as.numeric(new[2,])
new3<-as.numeric(new[3,])
new4<-as.numeric(new[4,])
new5<-as.numeric(new[5,])
new1<-as.numeric(new[1,])[(length(new1)-(length((tr1*D1)[TT1[1]:(T0+L)])-1)):length(new1)]
new2<-as.numeric(new[2,])[(length(new2)-(length((tr2*D2)[TT1[2]:(T0+L)])-1)):length(new2)]
new3<-as.numeric(new[3,])[(length(new3)-(length((tr3*D3)[TT1[3]:(T0+L)])-1)):length(new3)]
new4<-as.numeric(new[4,])[(length(new4)-(length((tr4*D4)[TT1[4]:(T0+L)])-1)):length(new4)]
new5<-as.numeric(new[5,])[(length(new5)-(length((tr5*D5)[TT1[5]:(T0+L)])-1)):length(new5)]

new_hat<-c(mean(new1),mean(new2),mean(new3),mean(new4),mean(new5))


old<-list(old_treatment1,old_treatment2,old_treatment3,old_treatment4,old_treatment5,old_treatment6,old_treatment7,old_treatment8,old_treatment9,old_treatment10,old_treatment_11,old_treatment_12,old_treatment_13,old_treatment_14,old_treatment_15)
old<-data.frame(old)
old1<-as.numeric(old[1,])
old2<-as.numeric(old[2,])
old3<-as.numeric(old[3,])
old4<-as.numeric(old[4,])
old5<-as.numeric(old[5,])
old1<-as.numeric(old[1,])[(length(old1)-(length((tr1*D1)[TT1[1]:(T0+L)])-1)):length(old1)]
old2<-as.numeric(old[2,])[(length(old2)-(length((tr2*D2)[TT1[2]:(T0+L)])-1)):length(old2)]
old3<-as.numeric(old[3,])[(length(old3)-(length((tr3*D3)[TT1[3]:(T0+L)])-1)):length(old3)]
old4<-as.numeric(old[4,])[(length(old4)-(length((tr4*D4)[TT1[4]:(T0+L)])-1)):length(old4)]
old5<-as.numeric(old[5,])[(length(old5)-(length((tr5*D5)[TT1[5]:(T0+L)])-1)):length(old5)]

old_hat<-c(mean(old1),mean(old2),mean(old3),mean(old4),mean(old5))



bias_new<-mean(abs(tr-new_hat))
bias_old<-mean(abs(tr-old_hat))

cr_new1<-mean(cr_new_CI)
cr_old1<-mean(cr_old_CI)

cr_new2<-mean(cr_new_SB)
cr_old2<-mean(cr_old_SB)



out1=list(bias_new,bias_old,bias_plm,bias_synthdid,bias_gsynth,bias_didstaggered_or,bias_didstaggered_dr,bias_didstaggered_ipw,bias_didstaggered_orr,bias_didstaggered_drr,bias_didstaggered_ipww,bias_didstaggered_sunab,bias_before_after,cr_new1,cr_old1,cr_new2,cr_old2)

return(out1)

}



out1<-c()
for (i in 1:1000){

result <- try({
  out1[[i]] <- w()
}, silent = TRUE)
  
  if (!inherits(result, "try-error")) {
    print(result)
  } else {
    print(paste("Iteration", i, "failed, skipping"))
  }

}
 
 
bias_new<-c()
for(i in 1:1000){
bias_new[[i]]<-out1[[i]][[1]]
}
bias_new<-as.numeric(bias_new)

bias_old<-c()
for(i in 1:1000){
bias_old[[i]]<-out1[[i]][[2]]
}
bias_old<-as.numeric(bias_old)
 

bias_plm<-c()
for(i in 1:1000){
bias_plm[[i]]<-out1[[i]][[3]]
}
bias_plm<-as.numeric(bias_plm)
 
bias_synthdid<-c()
for(i in 1:1000){
bias_synthdid[[i]]<-out1[[i]][[4]]
}
bias_synthdid<-as.numeric(bias_synthdid)
 
bias_gsynth<-c()
for(i in 1:1000){
bias_gsynth[[i]]<-out1[[i]][[5]]
}
bias_gsynth<-as.numeric(bias_gsynth)
 
bias_didstaggered_or<-c()
for(i in 1:1000){
bias_didstaggered_or[[i]]<-out1[[i]][[6]]
}
bias_didstaggered_or<-as.numeric(bias_didstaggered_or)

bias_didstaggered_dr<-c()
for(i in 1:1000){
bias_didstaggered_dr[[i]]<-out1[[i]][[7]]
}
bias_didstaggered_dr<-as.numeric(bias_didstaggered_dr)

bias_didstaggered_ipw<-c()
for(i in 1:1000){
bias_didstaggered_ipw[[i]]<-out1[[i]][[8]]
}
bias_didstaggered_ipw<-as.numeric(bias_didstaggered_ipw)
 
bias_didstaggered_orr<-c()
for(i in 1:1000){
bias_didstaggered_orr[[i]]<-out1[[i]][[9]]
}
bias_didstaggered_orr<-as.numeric(bias_didstaggered_orr)

bias_didstaggered_drr<-c()
for(i in 1:1000){
bias_didstaggered_drr[[i]]<-out1[[i]][[10]]
}
bias_didstaggered_drr<-as.numeric(bias_didstaggered_drr)

bias_didstaggered_ipww<-c()
for(i in 1:1000){
bias_didstaggered_ipww[[i]]<-out1[[i]][[11]]
}
bias_didstaggered_ipww<-as.numeric(bias_didstaggered_ipww)
 
bias_didstaggered_sunab<-c()
for(i in 1:1000){
bias_didstaggered_sunab[[i]]<-out1[[i]][[12]]
}
bias_didstaggered_sunab<-as.numeric(bias_didstaggered_sunab)
 
bias_before_after<-c()
for(i in 1:1000){
bias_before_after[[i]]<-out1[[i]][[13]]
}
bias_before_after<-as.numeric(bias_before_after)
 
cr_new1<-c()
for(i in 1:1000){
cr_new1[[i]]<-out1[[i]][[14]]
}
cr_new1<-as.numeric(cr_new1)

cr_old1<-c()
for(i in 1:1000){
cr_old1[[i]]<-out1[[i]][[15]]
}
cr_old1<-as.numeric(cr_old1)

cr_new2<-c()
for(i in 1:1000){
cr_new2[[i]]<-out1[[i]][[16]]
}
cr_new2<-as.numeric(cr_new2)

cr_old2<-c()
for(i in 1:1000){
cr_old2[[i]]<-out1[[i]][[17]]
}
cr_old2<-as.numeric(cr_old2)
  
 


summary(sort(bias_new))
summary(sort(bias_old))
summary(sort(bias_plm))
summary(sort(bias_synthdid))
summary(sort(bias_gsynth))
summary(sort(bias_didstaggered_or))
summary(sort(bias_didstaggered_dr))
summary(sort(bias_didstaggered_ipw))
summary(sort(bias_didstaggered_orr))  ##
summary(sort(bias_didstaggered_drr))  ##
summary(sort(bias_didstaggered_ipww))##
summary(sort(bias_didstaggered_sunab))
summary(sort(bias_before_after))
summary(sort(cr_new1))
summary(sort(cr_old1))
summary(sort(cr_new2))
summary(sort(cr_old2))













